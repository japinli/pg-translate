{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"\u4e3b\u9875","text":""},{"location":"2025/01/24/anatomy-of-locks-reduce/","title":"\u8868\u7ea7\u9501\u5256\u6790\uff1a\u51cf\u5c11\u9501\u5b9a\u5f71\u54cd","text":"<p>\u5e76\u975e\u6240\u6709\u64cd\u4f5c\u90fd\u9700\u8981\u76f8\u540c\u7ea7\u522b\u7684\u9501\u5b9a\uff0cPostgreSQL \u63d0\u4f9b\u4e86\u5de5\u5177\u548c\u6280\u672f\u6765\u6700\u5927\u9650\u5ea6\u5730\u51cf\u5c11\u9501\u5b9a\u7684\u5f71\u54cd\u3002</p> <p>\u6211\u5df2\u7ecf\u5f00\u59cb\u5728\u535a\u5ba2\u4e0a\u64b0\u5199\u6709\u5173 PostgreSQL \u4e2d\u8868\u7ea7\u9501\u7684\u5256\u6790\u3002\u5728\u7b2c\u4e00\u7bc7\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u8ba8\u8bba\u4e86\u6570\u636e\u5e93\u7cfb\u7edf\u4f7f\u7528\u9501\u5b9a\u673a\u5236\u7684\u539f\u56e0\uff0c\u4ee5\u53ca PostgresQL \u5982\u4f55\u5229\u7528 MVCC \u6765\u907f\u514d\u5927\u591a\u6570\u5e76\u53d1\u95ee\u9898\uff0c\u4ece\u800c\u51cf\u5c11\u9501\u5b9a\u7684\u5fc5\u8981\u6027\u3002\u7136\u540e\uff0c\u6211\u4eec\u8ba8\u8bba\u4e86 DDL \u9501\uff0c\u5e76\u89e3\u91ca\u4e86 PostgreSQL \u9501\u961f\u5217\u7684\u5de5\u4f5c\u8fdc\u79bb\u3002</p> <p>\u5728\u8fd9\u7bc7\u540e\u7eed\u6587\u7ae0\u4e2d\uff0c\u6211\u4eec\u5c06\u8ba8\u8bba\u9501\u4e89\u7528\uff0c\u4ee5\u63a2\u7d22\u51cf\u5c11\u751f\u4ea7\u7cfb\u7edf\u4e2d\u9501\u5b9a\u5f71\u54cd\u7684\u65b9\u6cd5\uff0c\u4ee5\u51cf\u5c11\u4e0e DDL \u66f4\u6539\u76f8\u5173\u7684\u6f5c\u5728\u505c\u673a\u98ce\u9669\u3002</p>"},{"location":"2025/01/24/anatomy-of-locks-reduce/#_2","title":"\u9501\u4e89\u7528","text":"<p>\u5f53\u591a\u4e2a\u4e8b\u52a1\u7ade\u4e89\u5bf9\u540c\u4e00\u6570\u636e\u5e93\u8d44\u6e90\uff08\u5982\u8868\u6216\u884c\uff09\u7684\u8bbf\u95ee\u6743\u65f6\uff0c\u5c31\u4f1a\u53d1\u751f\u9501\u4e89\u7528\uff0c\u5e76\u4e14\u81f3\u5c11\u4e00\u4e2a\u4e8b\u52a1\u5fc5\u987b\u7b49\u5f85\uff0c\u56e0\u4e3a\u5b83\u9700\u8981\u7684\u9501\u4e0e\u5176\u4ed6\u4e8b\u52a1\u6301\u6709\u7684\u9501\u51b2\u7a81\u3002\u5728 PostgreSQL \u4e2d\uff0c\u8fd9\u79cd\u60c5\u51b5\u901a\u5e38\u53d1\u751f\u5728\u9700\u8981\u6392\u4ed6\u9501\u7684\u6a21\u5f0f\u4fee\u6539\uff08DDL \u64cd\u4f5c\uff09\u671f\u95f4\uff0c\u6216\u8005\u5728\u540c\u4e00\u884c\u4e0a\u8fdb\u884c\u5927\u91cf\u5e76\u53d1 DML \u64cd\u4f5c\u671f\u95f4\u3002\u5f53\u53d1\u751f\u4e89\u7528\u65f6\uff0c\u4e8b\u52a1\u4f1a\u5f62\u6210\u4e00\u4e2a\u961f\u5217\uff0c\u7b49\u5f85\u8f6e\u5230\u81ea\u5df1\u83b7\u53d6\u6240\u9700\u7684\u9501\u3002\u8f83\u9ad8\u7684\u9501\u4e89\u7528\u53ef\u80fd\u4f1a\u5bfc\u81f4\u541e\u5410\u91cf\u964d\u4f4e\u3001\u5ef6\u8fdf\u589e\u52a0\uff0c\u4e25\u91cd\u65f6\u8fd8\u4f1a\u5bfc\u81f4\u5e94\u7528\u7a0b\u5e8f\u8d85\u65f6\u6216\u505c\u673a\u3002\u8fd9\u5728\u9ad8\u6d41\u91cf\u751f\u4ea7\u7cfb\u7edf\u4e2d\u5c24\u4e3a\u91cd\u8981\uff0c\u56e0\u4e3a\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u67e5\u8be2\u6216\u53d8\u66f4\u6a21\u5f0f\u7684\u65f6\u673a\u4e0d\u5f53\u90fd\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e00\u8fde\u4e32\u7684\u7b49\u5f85\u4e8b\u52a1\uff0c\u4ece\u800c\u6709\u6548\u5730\u963b\u585e\u5bf9\u5173\u952e\u8868\u7684\u8bbf\u95ee\u3002</p>"},{"location":"2025/01/24/anatomy-of-locks-reduce/#_3","title":"\u51cf\u5c11\u9501\u5b9a\u5f71\u54cd","text":"<p>\u5728 PostgreSQL \u4e2d\u8fdb\u884c\u6a21\u5f0f\u66f4\u6539\u6216\u8fd0\u884c\u7ef4\u62a4\u4efb\u52a1\u65f6\uff0c\u5c3d\u91cf\u51cf\u5c11\u9501\u5b9a\u4ee5\u907f\u514d\u963b\u585e\u5176\u4ed6\u67e5\u8be2\u5e76\u964d\u4f4e\u6027\u80fd\u81f3\u5173\u91cd\u8981\u3002\u5e76\u975e\u6240\u6709\u64cd\u4f5c\u90fd\u9700\u8981\u76f8\u540c\u7ea7\u522b\u7684\u9501\u5b9a\uff0cPostgreSQL \u63d0\u4f9b\u4e86\u5de5\u5177\u548c\u6280\u672f\u6765\u6700\u5927\u9650\u5ea6\u5730\u51cf\u5c11\u9501\u5b9a\u7684\u5f71\u54cd\u3002</p>"},{"location":"2025/01/24/anatomy-of-locks-reduce/#concurrently","title":"\u4f7f\u7528 <code>CONCURRENTLY</code> \u547d\u4ee4","text":"<p>\u8bf8\u5982 <code>CREATE INDEX CONCURRENTLY</code> \u6216 <code>ALTER TABLE DETACH PARTITION CONCURRENCY</code> \u7b49\u547d\u4ee4\u76f8\u8f83\u4e8e\u4e0d\u4f7f\u7528 <code>CONCURRENTLY</code> \u7684\u76f8\u540c\u547d\u4ee4\u800c\u5df2\uff0c\u524d\u8005\u83b7\u53d6\u7684\u9501\u9650\u5236\u8f83\u5c11\uff0c\u4ece\u800c\u5141\u8bb8\u5176\u4ed6\u64cd\u4f5c\u7ee7\u7eed\u8fdb\u884c\u3002\u4f46\u662f\uff0c\u8fd9\u4e9b\u547d\u4ee4\u6709\u4ee5\u4e0b\u9650\u5236\uff1a</p> <ul> <li>\u9700\u8981\u66f4\u957f\u7684\u65f6\u95f4\u624d\u80fd\u5b8c\u6210\u3002</li> <li>\u662f\u975e\u4e8b\u52a1\u6027\u7684\uff08\u4e0d\u80fd\u5904\u4e8e\u4e8b\u52a1\u5757\u4e2d\uff0c\u4e0d\u80fd\u56de\u6eda\uff09\u3002</li> <li>\u9700\u8981\u989d\u5916\u5c0f\u5fc3\u5904\u7406\u6545\u969c\uff0c\u8fd9\u53ef\u80fd\u4f1a\u7559\u4e0b\u90e8\u5206\u53d8\u5316\uff08\u6709\u50cf <code>FINALIZE</code> \u8fd9\u6837\u7684\u547d\u4ee4\u6765\u6e05\u7406\u6216\u5b8c\u6210\u5de5\u4f5c\uff09\u3002</li> </ul>"},{"location":"2025/01/24/anatomy-of-locks-reduce/#_4","title":"\u62c6\u5206\u590d\u6742\u64cd\u4f5c","text":"<p>\u51cf\u5c11\u9501\u4e89\u7528\u7684\u6700\u6709\u6548\u7b56\u7565\u4e4b\u4e00\u662f\u5c06\u5927\u578b DDL \u64cd\u4f5c\u5206\u89e3\u4e3a\u66f4\u5c0f\u3001\u963b\u585e\u66f4\u5c11\u7684\u6b65\u9aa4\u3002</p> <p>\u5047\u8bbe\u60a8\u9700\u8981\u6dfb\u52a0\u4e00\u4e2a\u5177\u6709\u9ed8\u8ba4\u503c\u7684 <code>NOT NULL</code> \u5217\uff1a</p> <pre><code>ALTER TABLE mytable ADD COLUMN newcol timestamptz NOT NULL DEFAULT clock_timestamp();\n</code></pre> <p>\u4e0a\u8ff0\u547d\u4ee4\u9700\u8981 <code>ACCESS EXCLUSIVE</code> \u9501\u5e76\u5c06\u91cd\u5199\u6574\u4e2a\u8868\u3002\u5bf9\u4e8e\u5927\u8868\uff0c\u8fd9\u53ef\u80fd\u4f1a\u5bfc\u81f4\u5927\u91cf\u505c\u673a\u65f6\u95f4\uff0c\u56e0\u4e3a\u5b83\uff1a</p> <ul> <li>\u963b\u6b62\u6240\u6709\u5e76\u53d1\u8bbf\u95ee\uff08\u751a\u81f3\u662f <code>SELECT</code>\uff09</li> <li>\u5728\u6574\u4e2a\u8868\u91cd\u5199\u8fc7\u7a0b\u4e2d\u6301\u6709\u9501</li> <li>\u5bf9\u4e8e\u5927\u8868\u53ef\u80fd\u9700\u8981\u51e0\u5206\u949f\u751a\u81f3\u51e0\u5c0f\u65f6</li> </ul> <p>\u6211\u4eec\u53ef\u4ee5\u5c06\u4e0a\u8ff0\u7684\u5355\u4e2a\u7e41\u91cd\u64cd\u4f5c\u5206\u89e3\u4e3a\u4e09\u4e2a\u8f83\u5c11\u963b\u585e\u7684\u6b65\u9aa4\uff1a</p> <pre><code>ALTER TABLE mytable ADD COLUMN newcol timestamptz DEFAULT clock_timestamp();\nUPDATE mytable SET newcol = clock_timestamp() WHERE newcol IS NULL;\nALTER TABLE mytable ALTER COLUMN newcol SET NOT NULL;\n</code></pre> <ol> <li>\u9996\u5148\uff0c\u6dfb\u52a0\u5177\u6709\u9ed8\u8ba4\u503c\u7684\u53ef\u7a7a\u5217\uff1a <pre><code>ALTER TABLE mytable ADD COLUMN newcol timestamptz DEFAULT clock_timestamp();\n</code></pre></li> <li>\u7136\u540e\uff0c\u586b\u5145\u4efb\u4f55 <code>NULL</code> \u503c\uff1a     <pre><code>UPDATE mytable SET newcol = clock_timestamp() WHERE newcol IS NULL;\n</code></pre>     \u5b9e\u9645\u4e0a\uff0c\u60a8\u5e94\u8be5\u6279\u91cf\u8fdb\u884c\u6b64\u66f4\u65b0\uff0c\u8bf7\u8bb0\u4f4f\u4efb\u4f55\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u67e5\u8be2\u90fd\u53ef\u80fd\u5bfc\u81f4\u95ee\u9898\u3002</li> <li>\u6700\u540e\uff0c\u6dfb\u52a0 <code>NOT NULL</code> \u7ea6\u675f\uff1a <pre><code>ALTER TABLE mytable ALTER COLUMN newcol SET NOT NULL;\n</code></pre></li> </ol> <p>\u8fd9\u79cd\u65b9\u6cd5\u6709\u51e0\u4e2a\u4f18\u70b9\uff1a</p> <ul> <li>\u6700\u521d\u7684\u5217\u6dfb\u52a0\u64cd\u4f5c\u975e\u5e38\u5feb\uff0c\u5b83\u53ea\u9700\u8981\u77ed\u6682\u7684 <code>ACCESS EXCLUSIVE</code> \u9501</li> <li>\u6570\u636e\u586b\u5145\u53ef\u4ee5\u4f7f\u7528\u5e38\u89c4 <code>ROW EXCLUSIVE</code> \u9501\u8fdb\u884c\uff0c\u4ece\u800c\u5141\u8bb8\u5e76\u53d1\u64cd\u4f5c</li> <li>\u5982\u679c\u51fa\u73b0\u95ee\u9898\uff0c\u6bcf\u4e2a\u6b65\u9aa4\u90fd\u53ef\u4ee5\u56de\u6eda</li> </ul> <p>\u8fd9\u91cc\u6709\u51e0\u4e2a\u597d\u7684\u505a\u6cd5\u9700\u8981\u6ce8\u610f\u3002\u4e3a\u4e86\u907f\u514d\u4e8b\u52a1\u957f\u65f6\u95f4\u8fd0\u884c\uff0c\u5bf9\u5927\u8868\u8fdb\u884c\u6279\u91cf\u66f4\u65b0\u603b\u662f\u4e00\u4e2a\u597d\u6ce8\u610f\u3002\u5728\u6211\u4eec\u7684\u96f6\u505c\u673a\u3001\u591a\u7248\u672c\u6a21\u5f0f\u53d8\u66f4\u5de5\u5177 pgroll \u4e2d\uff0c\u5f53\u6211\u4eec\u8fdb\u884c\u56de\u586b\u65f6\uff0c\u6211\u4eec\u4f1a\u5206\u6279\u8fdb\u884c\uff0c\u4ee5\u907f\u514d\u5bf9\u8868\u4e2d\u7684\u6bcf\u4e00\u884c\u90fd\u8fdb\u884c\u884c\u9501\u3002\u8be5\u5de5\u5177\u5141\u8bb8\u8bbe\u7f6e\u81ea\u5b9a\u4e49\u56de\u586b\u6279\u91cf\u5927\u5c0f\uff08<code>--backfill-batch-size</code>\uff09\u548c\u5ef6\u8fdf\uff08<code>--backfill-batch-delay</code>\uff09\u6765\u63a7\u5236\u56de\u586b\u7684\u901f\u5ea6\u3002</p> <p>\u8fd9\u79cd\u62c6\u5206 DDL \u64cd\u4f5c\u7684\u6a21\u5f0f\u53ef\u4ee5\u5e94\u7528\u4e8e\u8bb8\u591a\u5176\u4ed6\u6a21\u5f0f\u66f4\u6539\u3002\u4e00\u822c\u539f\u5219\u662f\u627e\u5230\u65b9\u6cd5\u5c06\u9700\u8981 <code>ACCESS EXCLUSIVE</code> \u9501\u7684\u64cd\u4f5c\u5206\u89e3\u4e3a\u66f4\u5c0f\u7684\u6b65\u9aa4\uff0c\u8fd9\u4e9b\u6b65\u9aa4\u53ef\u4ee5\u4f7f\u7528\u9650\u5236\u8f83\u5c11\u7684\u9501\u6216\u6301\u6709\u9501\u66f4\u77ed\u7684\u65f6\u95f4\u3002\u8fd9\u4f1a\u51cf\u5c11\u5f3a\u9501\u7684\u6301\u7eed\u65f6\u95f4\u5e76\u9632\u6b62\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u64cd\u4f5c\u963b\u585e\u5176\u4ed6\u64cd\u4f5c\u3002</p> <p>\u5728\u6267\u884c\u590d\u6742\u64cd\u4f5c\u65f6\uff0c\u5bc6\u5207\u5173\u6ce8\u9501\u4e89\u7528\u603b\u662f\u4e00\u4e2a\u597d\u4e3b\u610f\u3002\u6709\u65f6\u60a8\u751a\u81f3\u53ef\u80fd\u5e0c\u671b\u660e\u786e\u9501\u5b9a\u67d0\u4e9b\u5185\u5bb9\u4ee5\u9632\u6b62\u610f\u5916\u7684\u5e76\u53d1\u8bbf\u95ee\u3002\u5e76\u4e14\u4e0d\u8981\u5fd8\u8bb0\u8bbe\u7f6e\u9002\u5f53\u7684 <code>lock_timeout</code> \u503c\u4ee5\u786e\u4fdd\u4e8b\u52a1\u4e0d\u4f1a\u6c38\u8fdc\u7b49\u5f85\u3002</p>"},{"location":"2025/01/24/anatomy-of-locks-reduce/#_5","title":"\u5355\u72ec\u9a8c\u8bc1\u7ea6\u675f","text":"<p>\u6b63\u5982\u6211\u4eec\u4e4b\u524d\u6240\u8ba8\u8bba\u7684\uff0c\u901a\u8fc7\u8c03\u6574\u67e5\u8be2\uff0c\u6709\u591a\u79cd\u65b9\u6cd5\u53ef\u4ee5\u5b9e\u73b0\u76f8\u540c\u7684\u7ed3\u679c\u3002\u5728\u4e0a\u4e00\u8282\u4e2d\uff0c\u4f5c\u4e3a\u6700\u540e\u4e00\u6b65\uff0c\u6211\u4eec\u4f7f\u7528\u4ee5\u4e0b\u67e5\u8be2\u6dfb\u52a0\u4e86 <code>NOT NULL</code> \u7ea6\u675f\uff1a</p> <pre><code>ALTER TABLE mytable ALTER COLUMN newcol SET NOT NULL;\n</code></pre> <p>\u6b64\u547d\u4ee4\u4ecd\u7136\u9700\u8981\u5f88\u957f\u65f6\u95f4\u5e76\u4e14\u4f1a\u963b\u585e\u5199\u5165\uff0c\u4f46\u5b83\u662f\u4e00\u79cd\u6539\u8fdb\uff0c\u56e0\u4e3a\u4e0e\u539f\u59cb\u547d\u4ee4\u4e0d\u540c\uff0c\u5b83\u4e0d\u4f1a\u963b\u585e\u8bfb\u53d6\uff0c\u5e76\u4e14\u7531\u4e8e\u5b83\u53ea\u8fdb\u884c\u4e00\u6b21\u8868\u626b\u63cf\uff0c\u56e0\u6b64\u5b83\u6bd4\u539f\u59cb\u547d\u4ee4\u82b1\u8d39\u7684\u65f6\u95f4\u66f4\u77ed\u3002</p> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5229\u7528 <code>CHECK</code> \u7ea6\u675f\u8fdb\u4e00\u6b65\u4f18\u5316\u8fd9\u4e00\u70b9\uff1a</p> <pre><code>ALTER TABLE mytable ADD CONSTRAINT mytable_newcol_not_null CHECK (newcol IS NOT NULL) NOT VALID;\nALTER TABLE mytable VALIDATE CONSTRAINT mytable_newcol_not_null;\nALTER TABLE mytable ALTER COLUMN newcol SET NOT NULL; --optional\nALTER TABLE mytable DROP CONSTRAINT mytable_newcol_not_null; --optional\n</code></pre> <ol> <li>\u9996\u5148\uff0c\u6211\u4eec\u53ef\u4ee5\u6dfb\u52a0\u4e00\u4e2a <code>NOT VALID</code> \u68c0\u67e5\u7ea6\u675f\uff1a     <pre><code>ALTER TABLE mytable ADD CONSTRAINT mytable_newcol_not_null CHECK (newcol IS NOT NULL) NOT VALID;\n</code></pre></li> <li>\u7136\u540e\u9a8c\u8bc1\u7ea6\u675f\uff1a     <pre><code>ALTER TABLE mytable VALIDATE CONSTRAINT mytable_newcol_not_null;\n</code></pre> <code>VALIDATE CONSTRAINT</code> \u671f\u95f4\u7684\u626b\u63cf\u4e0d\u4f1a\u963b\u6b62\u5199\u5165\u3002</li> </ol> <p>\u5982\u679c\u60a8\u5e0c\u671b\u5728\u5217\u4e0a\u8bbe\u7f6e <code>NOT NULL</code>\uff08\u800c\u4e0d\u662f <code>CHECK</code> \u7ea6\u675f\uff09\uff0c\u90a3\u4e48\u73b0\u5728\u8bbe\u7f6e\u5b83\u53ea\u662f\u5143\u6570\u636e\u64cd\u4f5c\uff0c\u56e0\u4e3a PostgreSQL \u8db3\u591f\u667a\u80fd\uff0c\u53ef\u4ee5\u8bc6\u522b\u6709\u6548\u7684 <code>CHECK</code> \u7ea6\u675f\uff08\u4f46\u4ecd\u7136\u4f1a\u6267\u884c\u7b80\u77ed\u7684 <code>ACCESS EXCLUSIVE</code> \u9501\uff09\u3002</p> <p>\u62c6\u5206\u64cd\u4f5c\u9700\u8981\u4e13\u4e1a\u77e5\u8bc6\uff0c\u4f46\u901a\u5e38\u9700\u8981\u5c3d\u91cf\u51cf\u5c11\u9501\u5b9a\u3002\u5c1d\u8bd5\u627e\u5230\u9501\u5b9a\u8f83\u5c11\u7684\u65b9\u6cd5\u3002\u5982\u679c\u6ca1\u6709\u666e\u901a SQL \u4e2d\u7684\u91cd\u5ea6\u9501\u5b9a\uff0c\u6709\u4e9b\u4e8b\u60c5\u662f\u4e0d\u53ef\u80fd\u6216\u5f88\u96be\u505a\u5230\u7684\u3002</p>"},{"location":"2025/01/24/anatomy-of-locks-reduce/#postgresql","title":"PostgreSQL \u4e0d\u65ad\u8fdb\u6b65","text":"<p>PostgreSQL \u5bf9 DDL \u8fdb\u884c\u4e86\u8bb8\u591a\u4f18\u5316\uff0c\u5e76\u4e14\u968f\u7740\u6bcf\u4e2a\u7248\u672c\u7684\u53d1\u5e03\u800c\u4e0d\u65ad\u6539\u8fdb\u3002\u8ba9\u6211\u4eec\u770b\u4e00\u4e2a\u4e0e\u4e0a\u8ff0\u793a\u4f8b\u7565\u5fae\u4e0d\u540c\u7684\u793a\u4f8b\uff1a</p> <pre><code>ALTER TABLE mytable ADD COLUMN newcol int NOT NULL DEFAULT 1;\n</code></pre> <p>\u6b64\u547d\u4ee4\u4ecd\u7136\u9700\u8981 <code>ACCESS EXCLUSIVE</code> \u9501\u5e76\u963b\u6b62\u5176\u4ed6\u64cd\u4f5c\u3002\u7136\u800c\uff0c\u5728\u73b0\u4ee3 PostgreSQL \u7248\u672c\u4e2d\uff0c\u5b83\u6267\u884c\u5f97\u975e\u5e38\u5feb\uff0c\u56e0\u4e3a PostgreSQL \u8ba4\u8bc6\u5230\u5e38\u91cf\u9ed8\u8ba4\u503c\uff08\u5982 <code>1</code>\uff09\u53ef\u4ee5\u5b58\u50a8\u4e3a\u5143\u6570\u636e\u800c\u65e0\u9700\u91cd\u5199\u8868\u3002</p> <p>\u76f8\u6bd4\u4e4b\u4e0b\uff0c\u65e7\u7248 PostgreSQL \u4f1a\u89e6\u53d1\u540c\u4e00\u547d\u4ee4\u7684\u5b8c\u6574\u8868\u91cd\u5199\uff0c\u7c7b\u4f3c\u4e8e\u6211\u4eec\u4e4b\u524d\u7684 <code>DEFAULT clock_timestamp()</code> \u793a\u4f8b\u3002\u7279\u522b\u662f\u5bf9\u4e8e\u5927\u8868\u800c\u8a00\uff0c\u6027\u80fd\u5dee\u5f02\u975e\u5e38\u5927\u3002</p> <p>\u5982\u679c\u53ef\u80fd\u7684\u8bdd\uff0c\u8bf7\u59cb\u7ec8\u8fd0\u884c\u6700\u65b0\u7248\u672c\u7684 PostgresQL\uff1a</p> <ul> <li>\u65b0\u7248\u672c\u5305\u62ec\u51cf\u5c11\u6240\u9700\u9501\u6a21\u5f0f\u7684\u4f18\u5316\u3002</li> <li>\u65b0\u589e\u4e86\u53ef\u7528\u4e8e DDL \u64cd\u4f5c\u7684 <code>CONCURRENTLY</code> \u53d8\u4f53</li> <li>\u9501\u5b9a\u673a\u5236\u672c\u8eab\u5f97\u5230\u6539\u8fdb</li> <li>\u4ee5\u524d\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u64cd\u4f5c\u53ef\u80fd\u4f1a\u53d8\u6210\u4ec5\u5feb\u901f\u66f4\u6539\u5143\u6570\u636e</li> </ul> <p>\u8fd0\u884c\u65e7\u7248\u672c\u7684 PostgreSQL \u610f\u5473\u7740\u60a8\u53ef\u80fd\u6b63\u5728\u5904\u7406\u65b0\u7248\u672c\u4e2d\u5df2\u89e3\u51b3\u7684\u9501\u5b9a\u95ee\u9898\u3002\u6bcf\u4e2a\u4e3b\u8981\u7248\u672c\u90fd\u4f1a\u5bf9\u6a21\u5f0f\u4fee\u6539\u64cd\u4f5c\u8fdb\u884c\u6539\u8fdb\uff0c\u901a\u5e38\u4f7f\u5b83\u4eec\u66f4\u5feb\u5e76\u4e14\u5bf9\u751f\u4ea7\u5de5\u4f5c\u8d1f\u8f7d\u7684\u5e72\u6270\u66f4\u5c0f\u3002</p>"},{"location":"2025/01/24/anatomy-of-locks-reduce/#_6","title":"\u7ed3\u8bba\uff1a\u5e73\u8861\u9501\u3001\u6027\u80fd\u548c\u6b63\u786e\u6027","text":"<p>PostgreSQL \u7684\u9501\u7cfb\u7edf\u662f\u786e\u4fdd\u6570\u636e\u4e00\u81f4\u6027\u548c\u5e76\u53d1\u6027\u7684\u5f3a\u5927\u5de5\u5177\uff0c\u4f46\u5b83\u4e5f\u662f\u4e89\u7528\u548c\u74f6\u9888\u7684\u6839\u6e90\u3002\u901a\u8fc7\u4e86\u89e3\u9501\u7684\u7c7b\u578b\u3001\u5b83\u4eec\u7684\u5f71\u54cd\u4ee5\u53ca\u6700\u5c0f\u5316\u5b83\u4eec\u7684\u7b56\u7565\uff0c\u60a8\u53ef\u4ee5\u6709\u6548\u5730\u7ba1\u7406\u9501\u5e76\u4fdd\u6301\u6570\u636e\u5e93\u7684\u6027\u80fd\u3002</p> <p>\u6211\u5c06\u4e8e 1 \u6708 29 \u65e5\u5728\u5e03\u62c9\u683c PostgreSQL \u5f00\u53d1\u8005\u65e5\u548c 2 \u6708 2 \u65e5\u5728 FOSDEM PostgreSQL Devroom \u4e0a\u4ecb\u7ecd\u8fd9\u4e2a\u4e3b\u9898\u3002\u5982\u679c\u60a8\u5728\u573a\uff0c\u8fc7\u6765\u6253\u4e2a\u62db\u547c\u5427\uff01</p> <p>\u4f5c\u8005\uff1aGulcin Yildirim Jelinek \u539f\u6587\uff1ahttps://xata.io/blog/anatomy-of-locks-reduce#reducing-locking-impact</p>"},{"location":"2025/01/20/anatomy-of-table-level-locks-in-postgresql/","title":"PostgreSQL \u4e2d\u8868\u7ea7\u9501\u5256\u6790","text":"<p>\u672c\u6587\u89e3\u91ca\u4e86 PostgreSQL \u4e2d\u7684\u9501\u673a\u5236\uff0c\u91cd\u70b9\u5173\u6ce8\u6570\u636e\u5b9a\u4e49\u8bed\u8a00 (DDL) \u64cd\u4f5c\u6240\u9700\u7684\u8868\u7ea7\u9501\u3002</p>"},{"location":"2025/01/20/anatomy-of-table-level-locks-in-postgresql/#_1","title":"\u9501\u5b9a\u548c\u89e3\u9501\u7684\u827a\u672f\uff1f","text":"<p>\u4eba\u4eec\u5e38\u5e38\u901a\u8fc7\u7c7b\u6bd4\u7269\u7406\u9501\u6765\u7406\u89e3\u6570\u636e\u5e93\u9501\uff0c\u8fd9\u751a\u81f3\u53ef\u80fd\u4fc3\u4f7f\u60a8\u53bb\u8ba2\u9605\u5173\u4e8e\u9501\u7684\u5386\u53f2\u3001\u6ce2\u65af\u9501\u4ee5\u53ca\u5f00\u9501\u6280\u5de7\u7684\u4e66\u7c4d\u3002\u7136\u800c\uff0c\u5927\u591a\u6570\u4eba\u6700\u7ec8\u4f1a\u901a\u8fc7\u6df1\u5165\u7814\u7a76\u201c\u9501\u5b9a\u201d\uff08<code>locking</code>\uff09\u8fd9\u4e2a\u672f\u8bed\u6765\u7406\u89e3 PostgreSQL \u4e2d\u7684\u9501\u6982\u5ff5\uff0c\u800c\u8fd9\u4e2a\u6982\u5ff5\u5b9e\u9645\u4e0a\u548c\u7269\u7406\u9501\u6ca1\u6709\u4ec0\u4e48\u5173\u7cfb\uff0c\u56e0\u4e3a\u7269\u7406\u9501\u4e3b\u8981\u4e0e\u5b89\u5168\u6027\u76f8\u5173\u3002\u800c PostgreSQL \u7684\u9501\u5b8c\u5168\u662f\u4e3a\u4e86\u5e76\u53d1\u63a7\u5236\uff0c\u5176\u6838\u5fc3\u662f\u7ba1\u7406\u4e8b\u52a1\u4e4b\u524d\u7684\u76f8\u4e92\u534f\u4f5c\u2014\u2014\u5141\u8bb8\u4e00\u4e2a\u4e8b\u52a1\u6301\u6709\u9501\u7684\u540c\u65f6\uff0c\u53e6\u4e00\u4e2a\u4e8b\u52a1\u80fd\u591f\u5b8c\u6210\u81ea\u5df1\u7684\u64cd\u4f5c\uff0c\u5e76\u5c3d\u91cf\u907f\u514d\u76f8\u4e92\u963b\u585e\u3002\u4f46\u6b63\u5982\u6211\u4eec\u6240\u77e5\uff0c\u4e16\u754c\u5e76\u4e0d\u603b\u662f\u7406\u60f3\u7684\uff0c\u65e0\u8bba\u662f\u95e8\u9501\u8fd8\u662f <code>AccessSharedLock</code>\u3002</p> <p>\u7136\u800c\uff0c\u65e2\u7136\u6211\u5df2\u7ecf\u4e70\u4e86\u90a3\u4e9b\u5173\u4e8e\u9501\u7684\u4e66\uff0c\u6211\u60f3\u6211\u5e94\u8be5\u53ef\u4ee5\u5bf9\u5f00\u9501\u7684\u827a\u672f\u548c\u6570\u636e\u5e93\u9501\u5b9a\u673a\u5236\u8fdb\u884c\u4e00\u4e9b\u7c7b\u6bd4\u3002\u9996\u5148\u6211\u8981\u8bf4\u7684\u662f\uff1a\u4e3a\u4e86\u80fd\u591f\u64ac\u5f00\u4efb\u4f55\u7c7b\u578b\u7684\u9501\uff0c\u60a8\u9700\u8981\u5bf9\u5b83\u7684\u5185\u90e8\u8fd0\u4f5c\u6709\u6df1\u5165\u7684\u7406\u89e3\uff1b\u4e86\u89e3\u9501\u9500\u3001\u9501\u82af\u4ee5\u53ca\u5b83\u4eec\u76f8\u4e92\u4f5c\u7528\u7684\u673a\u5236\u3002\u901a\u8fc7\u64cd\u7eb5\u5b83\u4eec\uff0c\u60a8\u53ef\u4ee5\u627e\u5230\u4e0d\u7528\u94a5\u5319\u5c31\u80fd\u6253\u5f00\u95e8\u6216\u4fdd\u9669\u7bb1\u7684\u6b63\u786e\u4f4d\u7f6e\uff01\u540c\u6837\u4e3a\u4e86\u80fd\u591f\u7ba1\u7406\u6570\u636e\u5e93\u9501\uff0c\u60a8\u9700\u8981\u4e86\u89e3\u6570\u636e\u5e93\u7684\u5185\u90e8\u5de5\u4f5c\u539f\u7406\uff0c\u5c24\u5176\u662f PostgreSQL \u4e2d\u5e76\u53d1\u7684\u5de5\u4f5c\u539f\u7406\u3002</p>"},{"location":"2025/01/20/anatomy-of-table-level-locks-in-postgresql/#mvcc","title":"MVCC \u7b80\u4ecb","text":"<p>PostgreSQL \u4f7f\u7528\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\uff08Multi-Version Concurrency Control, MVCC\uff09\u6765\u907f\u514d\u4f20\u7edf\u4e0a\u4e0e\u6570\u636e\u5e93\u76f8\u5173\u7684\u8bb8\u591a\u9501\u5b9a\u95ee\u9898\u3002MVCC \u7684\u5de5\u4f5c\u539f\u7406\u662f\uff1a</p> <ul> <li>\u5199\u5165\u65b0\u7684\u6570\u636e\u5e93\u526f\u672c\uff0c\u800c\u4e0d\u662f\u539f\u5730\u4fee\u6539\u884c\u3002</li> <li>\u786e\u4fdd\u8bfb\u53d6\u4e0d\u4f1a\u963b\u585e\u5199\u5165\uff0c\u5e76\u4e14\u5199\u5165\u4e0d\u4f1a\u963b\u585e\u8bfb\u53d6\u3002</li> </ul> <p>\u5f53\u4e8b\u52a1\u66f4\u65b0\u6570\u636e\u65f6\uff0cPostgreSQL \u4f1a\u521b\u5efa\u6539\u884c\u7684\u65b0\u7248\u672c\uff0c\u540c\u65f6\u4fdd\u7559\u65e7\u7248\u672c\u3002\u6bcf\u4e2a\u884c\u7248\u672c\u90fd\u5305\u542b\u7528\u6237\u4e0d\u53ef\u89c1\u4f46\u591a MVCC \u81f3\u5173\u91cd\u8981\u7684\u7cfb\u7edf\u5217\uff1a</p> <ul> <li><code>xmin</code>\uff1a\u521b\u5efa\u6b64\u7248\u672c\u7684\u4e8b\u52a1 ID</li> <li><code>xmax</code>\uff1a\u5220\u9664/\u66f4\u65b0\u6b64\u7248\u672c\u7684\u4e8b\u52a1 ID\uff08\u5982\u679c\u4e3a\u5f53\u524d\u7248\u672c\u5219\u4e3a\u7a7a\uff09</li> <li><code>cmin</code>, <code>cmax</code>\uff1a\u4e8b\u52a1\u4e2d\u7684\u547d\u4ee4 ID</li> <li><code>ctid</code>\uff1a\u884c\u7248\u672c\u7684\u7269\u7406\u4f4d\u7f6e</li> </ul> <p>\u5f53\u4f7f\u7528\u9ed8\u8ba4\u7684\u8bfb\u5df2\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\uff08Read Committed Isolation Level\uff09\u65f6\uff0c\u6bcf\u6b21\u6267\u884c\u8bed\u53e5\u65f6\uff0cPostgreSQL \u90fd\u4f1a\u521b\u5efa\u4e00\u4e2a\u5feb\u7167\u5176\u4e2d\u5305\u542b\uff1a</p> <ul> <li>\u5f53\u524d\u6240\u6709\u6d3b\u8dc3\u4e8b\u52a1 ID</li> <li>\u6700\u65b0\u63d0\u4ea4\u7684\u4e8b\u52a1 ID</li> <li>\u6b63\u5728\u8fdb\u884c\u7684\u4e8b\u52a1\u5217\u8868</li> </ul> <p>\u8ba9\u6211\u4eec\u770b\u770b\u5b83\u5728\u8bfb\u5df2\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\u4e0b\u7684\u5b9e\u9645\u5de5\u4f5c\u539f\u7406\uff1a</p> <p></p> <p>MVCC \u793a\u4f8b</p> <p>\u603b\u800c\u8a00\u4e4b\uff0c\u5b58\u5728\u4e00\u884c\uff0c\u5176\u4e2d Alice \u7684\u5de5\u8d44\u4e3a 50000\u3002\u7b2c\u4e00\u4e2a\u4e8b\u52a1\uff08<code>txid:100</code>\uff09\u542f\u52a8\u5e76\u83b7\u53d6\u5176 <code>SELECT</code> \u8bed\u53e5\u7684\u5feb\u7167\uff0c\u5e76\u770b\u5230 Alice \u7684\u85aa\u6c34\u4e3a 50000\uff0c\u56e0\u4e3a\u8be5\u884c\u7684 <code>xmax</code> \u4e3a\u7a7a\uff08\u610f\u5473\u7740\u5b83\u662f\u5f53\u524d\u7684\uff09\uff0c\u8be5\u884c\u7684 <code>xmin</code>\uff08<code>99</code>\uff09\u5c0f\u4e8e\u6211\u4eec\u7684\u4e8b\u52a1 ID\uff08<code>100</code>\uff09\u5e76\u4e14\u4e8b\u52a1 <code>99</code> \u5df2\u63d0\u4ea4\u3002</p> <p>\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\uff08<code>txid:101</code>\uff09\u5c06\u85aa\u6c34\u66f4\u65b0\u4e3a 60000\u3002\u8fd9\u5c06\u521b\u5efa\u4e24\u4e2a\u884c\u7248\u672c\uff1b\u65e7\u7248\u672c\u6807\u8bb0\u4e3a <code>xmax=101</code>\uff0c\u65b0\u7248\u672c\u6807\u8bb0\u4e3a <code>xmin=101</code>\u3002\u7136\u540e\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u63d0\u4ea4\uff0c\u4f7f\u5176\u66f4\u6539\u5bf9\u4efb\u4f55\u65b0\u5feb\u7167\u90fd\u53ef\u89c1\u3002</p> <p>\u5f53\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u6267\u884c\u5176\u7b2c\u4e8c\u4e2a <code>SELECT</code> \u8bed\u53e5\u65f6\uff08\u5728\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u4e4b\u524d\uff09\uff0c\u5b83\u4ecd\u7136\u770b\u5230\u85aa\u6c34 50000\uff0c\u56e0\u4e3a\u7b2c\u4e8c\u4e2a\u4e8b\u52a1 <code>101</code> \u5c1a\u672a\u63d0\u4ea4\u3002\u5728\u7b2c\u4e8c\u4e2a\u4e8b\u52a1\u63d0\u4ea4\u4e4b\u540e\uff0c\u5f53\u7b2c\u4e00\u4e2a\u4e8b\u52a1\u6267\u884c\u5b83\u7684\u7b2c\u4e09\u4e2a <code>SELECT</code> \u8bed\u53e5\u65f6\uff0c\u83b7\u5f97\u4e00\u4e2a\u65b0\u7684\u5feb\u7167\uff08\u8bfb\u53d6\u5df2\u63d0\u4ea4\u884c\u4e3a\uff09\u5e76\u4e14\u73b0\u5728\u770b\u5230\u85aa\u6c34 60000\uff0c\u56e0\u4e3a\uff1a</p> <ul> <li>\u6bcf\u4e2a\u8bed\u53e5\u83b7\u53d6\u4e00\u4e2a\u65b0\u7684\u5feb\u7167</li> <li>\u4e8b\u52a1 <code>101</code> \u73b0\u5728\u5df2\u7ecf\u63d0\u4ea4</li> <li><code>xmin=101</code> \u7684\u884c\u7248\u672c\u662f\u5f53\u524d\u7248\u672c\uff08<code>xmax</code> \u4e3a\u7a7a\uff09</li> <li><code>xmax=101</code> \u7684\u65e7\u7248\u672c\u5bf9\u4e8e\u65b0\u5feb\u7167\u4e0d\u518d\u53ef\u89c1</li> </ul> <p>\u6b64\u884c\u4e3a\u7279\u5b9a\u4e8e\u8bfb\u5df2\u63d0\u4ea4\u9694\u79bb\u7ea7\u522b\uff0c\u5176\u4e2d\u6bcf\u4e2a\u8bed\u53e5\u90fd\u4f1a\u83b7\u5f97\u4e00\u4e2a\u65b0\u7684\u5feb\u7167\uff0c\u5e76\u4e14\u53ef\u4ee5\u770b\u5230\u6765\u81ea\u5176\u4ed6\u4e8b\u52a1\u7684\u5df2\u63d0\u4ea4\u7684\u66f4\u6539\uff0c\u5373\u4f7f\u5728\u540c\u4e00\u4e2a\u4e8b\u52a1\u4e2d\u4e5f\u662f\u5982\u6b64\u3002</p> <p>\u5f53\u7136\uff0cMVCC \u65b9\u6cd5\u4e5f\u5e26\u6765\u4e86\u4e00\u4e9b\u5f71\u54cd\uff1a</p> <ul> <li>\u6b7b\u4ea1\u5143\u7ec4\u4f1a\u4e0d\u65ad\u79ef\u7d2f\uff0c\u76f4\u5230\u88ab <code>VACUUM</code> \u6e05\u7406</li> <li>\u7531\u4e8e\u4fdd\u7559\u591a\u4e2a\u7248\u672c\uff0c\u6570\u636e\u5e93\u5927\u5c0f\u53ef\u80fd\u4f1a\u6682\u65f6\u589e\u5927</li> <li>\u5b9a\u671f\u8fdb\u884c <code>VACUUM</code> \u7ef4\u62a4\u5bf9\u4e8e\u6027\u80fd\u81f3\u5173\u91cd\u8981</li> </ul> <p>\u6700\u7ec8\u83b7\u5f97\u660e\u663e\u7684\u597d\u5904\u662f\uff0cMVCC \u8bbe\u8ba1\u5141\u8bb8 PostgreSQL \u4e3a\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u67e5\u8be2\u63d0\u4f9b\u4e00\u81f4\u7684\u5feb\u7167\uff08\u5e0c\u671b\u5b83\u4eec\u4e0d\u4f1a\u8fd0\u884c\u592a\u4e45\ud83d\ude04\uff09\uff0c\u4e3a\u6df7\u5408\u8bfb\u5199\u5de5\u4f5c\u8d1f\u8f7d\u63d0\u4f9b\u9ad8\u5e76\u53d1\u6027\uff0c\u5e76\u5728\u4e0d\u8fdb\u884c\u8fc7\u591a\u9501\u5b9a\u7684\u60c5\u51b5\u4e0b\u63d0\u4f9b\u5f3a\u5927\u7684\u9694\u79bb\u6027\u3002</p>"},{"location":"2025/01/20/anatomy-of-table-level-locks-in-postgresql/#_2","title":"\u9501\u5b9a\u7684\u76ee\u7684","text":"<p>\u6240\u6709\u9501\u5b9a\uff0c\u65e0\u8bba\u5176\u7c7b\u578b\u5982\u4f55\uff0c\u90fd\u4f1a\u964d\u4f4e\u541e\u5410\u91cf\uff0c\u5e76\u53ef\u80fd\u589e\u52a0\u5ef6\u8fdf\uff0c\u8fd9\u610f\u5473\u7740\u6027\u80fd\u635f\u5931\uff0c\u56e0\u6b64\u6ca1\u6709\u4ec0\u4e48\u662f\u514d\u8d39\u7684\u3002\u5982\u679c\u6211\u7684\u76ee\u7684\u662f\u786e\u4fdd\u6211\u7684\u6570\u636e\u6ca1\u6709\u635f\u574f\uff0c\u5e76\u4e14\u6bcf\u4e2a\u4eba\u5728\u67e5\u8be2\u65f6\u90fd\u5f97\u5230\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u90a3\u4e48\u6211\u5fc5\u987b\u4fdd\u8bc1\u5f53\u591a\u4e2a\u4e8b\u52a1\u9488\u5bf9\u4e00\u5f20\u8868\u6216\u540c\u4e00\u884c\u65f6\uff0c\u6211\u5fc5\u987b\u9501\u5b9a\u8bbf\u95ee\u4ee5\u786e\u4fdd\u6211\u4eec\u82b1\u4e00\u4e9b\u65f6\u95f4\u6765\u4fdd\u6301\u4e8b\u7269\u7684\u987a\u5e8f\u800c\u4e0d\u662f\u5feb\u901f\u5730\u663e\u793a\u9519\u8bef\u7684\u7ed3\u679c\u3002</p> <p>\u4f46\u662f\u6211\u4eec\u4e5f\u4e0d\u80fd\u4fdd\u7559\u9501\u592a\u4e45\uff0c\u56e0\u4e3a\u8fd9\u4e5f\u4f1a\u5e26\u6765\u540e\u679c\u3002\u8ba9\u6211\u4eec\u60f3\u8c61\u4e00\u4e0b\u4e24\u4e2a\u6781\u7aef\uff1a\u6211\u4eec\u4ece\u4e0d\u9501\u5b9a\u4efb\u4f55\u4e8b\u52a1\u3002\u4e00\u4efd\u957f\u671f\u8fd0\u884c\u7684\u8d22\u52a1\u62a5\u544a\u6b63\u5728\u8ba1\u7b97\u5404\u90e8\u95e8\u7684\u5e73\u5747\u503c\uff0c\u800c\u4eba\u529b\u8d44\u6e90\u90e8\u6b63\u5728\u5904\u7406\u5e74\u7ec8\u52a0\u85aa\uff0c\u4e0e\u6b64\u540c\u65f6\uff0c\u6211\u4eec\u5c1d\u8bd5\u6dfb\u52a0\u4e00\u4e2a\u65b0\u7684\u5ba1\u8ba1\u680f\u3002\u5728 PostgreSQL \u4e2d\uff0c\u5373\u4f7f\u6ca1\u6709\u663e\u793a\u9501\uff0c\u6dfb\u52a0\u5217\u4e5f\u9700\u8981\u5bf9\u8868\u8fdb\u884c <code>AccessExclusiveLock</code>\u3002\u5982\u679c\u6211\u4eec\u4ee5\u67d0\u79cd\u65b9\u5f0f\u7ed5\u8fc7\u8fd9\u4e2a\u95ee\u9898\uff08\u60f3\u8c61\u4e00\u79cd\u5047\u8bbe\u7684\u4e0d\u5b89\u5168\u6a21\u5f0f\uff09\uff0c\u6211\u4eec\u5c06\u4f1a\u770b\u5230\u771f\u6b63\u7684\u6df7\u4e71\uff1a\u7531\u4e8e\u5728\u4e8b\u52a1\u4e2d\u9047\u5230\u4e0d\u540c\u7684\u8868\u7ed3\u6784\uff0c\u85aa\u6c34\u66f4\u65b0\u53ef\u80fd\u4f1a\u5931\u8d25\uff0c\u5e76\u4e14\u7531\u4e8e\u7cfb\u7edf\u76ee\u5f55\u4e0e\u5b9e\u9645\u8868\u6570\u636e\u4e0d\u4e00\u81f4\uff0c\u540e\u7eed\u67e5\u8be2\u53ef\u80fd\u4f1a\u9762\u4e34\u6570\u636e\u635f\u574f\u3002\u867d\u7136\u542c\u8d77\u6765\u5f88\u5fd9\u4e71\uff0c\u4f46\u5982\u679c\u4e0d\u9501\u4efb\u4f55\u4e1c\u897f\u5c31\u4f1a\u9020\u6210\u4e0d\u540c\u7a0b\u5ea6\u7684\u6df7\u4e71\u3002</p> <p>\u73b0\u5728\uff0c\u8ba9\u6211\u4eec\u8003\u8651\u53e6\u4e00\u4e2a\u6781\u7aef\uff1a\u6211\u4eec\u9501\u5b9a\u6bcf\u4e2a\u64cd\u4f5c\uff0c\u6bcf\u4e2a\u64cd\u4f5c\u90fd\u7b49\u5f85\u53e6\u4e00\u4e2a\u64cd\u4f5c\uff1b\u4e00\u4e2a\u64cd\u4f5c\u5b8c\u6210\uff0c\u53e6\u4e00\u4e2a\u64cd\u4f5c\u5f00\u59cb\u3002\u6211\u4eec\u4e3a\u4e00\u4e2a\u6b63\u5728\u8bfb\u53d6\u7684\u67e5\u8be2\u963b\u6b62\u6574\u4e2a\u8868\u3002\u5982\u679c\u4e00\u4e9b\u7528\u6237\u53ef\u80fd\u4f7f\u7528\u5c0f\u578b\u6570\u636e\u5e93\uff0c\u800c\u4ece\u6765\u4e0d\u5fc5\u5728\u540c\u4e00\u65f6\u95f4\u67e5\u8be2\u540c\u4e00\u5f20\u8868\uff0c\u90a3\u4e48\u8fd9\u4e5f\u662f\u53ef\u4ee5\u7684\uff1b\u5c31\u50cf\u8fd0\u884c\u591c\u95f4\u62a5\u544a\u7684\u5355\u7528\u6237\u4f1a\u8ba1\u7cfb\u7edf\u4e00\u6837\u3002</p> <p>\u5f53\u6211\u4eec\u9700\u8981\u540c\u65f6\u4e3a\u591a\u4e2a\u7528\u6237\u63d0\u4f9b\u670d\u52a1\u65f6\uff0c\u6211\u4eec\u5fc5\u987b\u63a5\u53d7\u4e00\u5b9a\u7a0b\u5ea6\u7684\u9694\u79bb\uff0c\u56e0\u6b64\uff0c\u6211\u4eec\u8981\u786e\u4fdd\u540c\u610f\u4e00\u4e2a\u6807\u51c6\uff0c\u4ee5\u786e\u4fdd\u6211\u4eec\u4e0d\u4f1a\u51fa\u73b0\u810f\u8bfb\u6216\u5e7b\u8bfb\u7b49\u60c5\u51b5\u3002\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48 PostgreSQL \u63d0\u4f9b\u4ece\u8bfb\u5df2\u63d0\u4ea4\u5230\u53ef\u5e8f\u5217\u5316\u7684\u4e0d\u540c\u9694\u79bb\u7ea7\u522b\u3002</p>"},{"location":"2025/01/20/anatomy-of-table-level-locks-in-postgresql/#ddl","title":"DDL \u9501","text":"<p>MVCC \u65b9\u6cd5\u4f7f PostgreSQL \u80fd\u591f\u9ad8\u6548\u5730\u6267\u884c\u5e76\u53d1 DML \u64cd\u4f5c\u3002\u5199\u5165\u64cd\u4f5c\u4e0d\u4f1a\u4fee\u6539\u6570\u636e\uff0c\u800c\u662f\u521b\u5efa\u6570\u636e\u7684\u65b0\u526f\u672c\uff0c\u4ece\u800c\u5141\u8bb8\u8bfb\u53d6\u548c\u5199\u5165\u64cd\u4f5c\u4e92\u76f8\u4e0d\u963b\u585e\u5730\u8fdb\u884c\u3002\u7136\u800c\uff0c\u5373\u4f7f\u5728\u57fa\u4e8e MVCC \u7684\u7cfb\u7edf\u4e2d\uff0c\u67d0\u79cd\u7a0b\u5ea6\u7684\u9501\u5b9a\u4e5f\u662f\u4e0d\u53ef\u907f\u514d\u7684\u3002\u8bfb\u53d6\u53ef\u80fd\u4e0d\u4f1a\u963b\u6b62\u5199\u5165\uff0c\u4f46\u5b83\u4eec\u4ecd\u7136\u4f1a\u83b7\u53d6\u8868\u3001\u7c7b\u578b\u548c\u89c6\u56fe\u7b49\u6570\u636e\u5e93\u5bf9\u8c61\u4e0a\u7684\u8f7b\u91cf\u7ea7\u9501\u3002</p> <p>\u56e0\u6b64\uff0cMVCC \u53ef\u4ee5\u4fdd\u62a4\u60a8\u514d\u53d7\u5199\u5165\u963b\u6b62\u8bfb\u53d6\u7684\u5f71\u54cd\uff0c\u4f46\u4e0d\u80fd\u4fdd\u62a4\u60a8\u514d\u53d7 DDL \u547d\u4ee4\u6240\u91c7\u53d6\u7684\u5bf9\u8c61\u9501\u7684\u5f71\u54cd\u3002\u540c\u4e00 DDL \u547d\u4ee4\u7684\u4e0d\u540c\u53d8\u4f53\u53ef\u80fd\u9700\u8981\u4e0d\u540c\u7ea7\u522b\u7684\u9501\u5f3a\u5ea6\u3002</p> <p>\u5bf9\u4e8e DDL \u64cd\u4f5c\uff08\u4f8b\u5982 <code>ALTER TABLE</code> \u6216 <code>VACUUM FULL</code>\uff09\uff0c\u901a\u5e38\u9700\u8981\u66f4\u5f3a\u7684\u9501\uff0c\u8fd9\u53ef\u80fd\u4f1a\u963b\u585e\u5176\u4ed6\u64cd\u4f5c\u3002\u6b64\u7c7b\u64cd\u4f5c\u53ef\u80fd\u4f1a\u963b\u6b62\u5176\u4ed6 DDL \u547d\u4ee4\u3001DML \u64cd\u4f5c\uff0c\u751a\u81f3\u963b\u6b62\u5c1d\u8bd5\u8bbf\u95ee\u540c\u4e00\u5bf9\u8c61\u7684 <code>SELECT</code> \u67e5\u8be2\u3002\u7531\u4e8e\u6bcf\u4e2a DDL \u547d\u4ee4\uff08\u6709\u65f6\u751a\u81f3\u662f\u5b50\u547d\u4ee4\uff09\u90fd\u6709\u81ea\u5df1\u7279\u5b9a\u7684\u9501\u5b9a\u8981\u6c42\uff0c\u56e0\u6b64\u590d\u6742\u6027\u4f1a\u589e\u52a0\uff0c\u4e3a\u6b64\u4e86\u89e3\u7e41\u5fd9\u6570\u636e\u5e93\u4e2d\u6a21\u5f0f\u4fee\u6539\u7684\u542b\u4e49\u81f3\u5173\u91cd\u8981\u3002</p>"},{"location":"2025/01/20/anatomy-of-table-level-locks-in-postgresql/#_3","title":"\u8868\u7ea7\u9501\u6a21\u5f0f","text":"<p>\u8ba9\u6211\u4eec\u770b\u4e00\u4e0b\u5404\u79cd\u8868\u7ea7\u9501\u6a21\u5f0f\uff0c\u6bcf\u79cd\u6a21\u5f0f\u90fd\u670d\u52a1\u4e8e\u4e0d\u540c\u7684\u64cd\u4f5c\uff1a</p> <ul> <li>ACCESS SHARE\uff1a<code>SELECT</code> \u64cd\u4f5c\u4f7f\u7528\u7684\u6700\u57fa\u672c\u7684\u9501\uff0c\u591a\u4e2a\u4e8b\u52a1\u53ef\u4ee5\u540c\u65f6\u6301\u6709\u6b64\u9501\uff0c\u9650\u5236\u6700\u5c11\u3002</li> <li>ROW SHARE\uff1a\u7531 <code>SELECT FOR UPDATE/SHARE</code> \u4f7f\u7528\uff0c\u4e0e\u9664\u6392\u4ed6\u9501\u4e4b\u5916\u7684\u5927\u591a\u6570\u5176\u4ed6\u9501\u517c\u5bb9\u3002</li> <li>ROW EXCLUSIVE\uff1aDML \u64cd\u4f5c (<code>INSERT</code>/<code>UPDATE</code>/<code>DELETE</code>/<code>MERGE</code>) \u5fc5\u9700\u3002</li> <li>SHARE UPDATE EXCLUSIVE\uff1a\u7531 <code>VACUUM</code>\u3001<code>ANALYZE</code> \u548c <code>CREATE INDEX CONCURRENTLY</code> \u7b49\u7ef4\u62a4\u64cd\u4f5c\u4f7f\u7528\uff0c\u4e0e <code>ShareLock</code>\u3001<code>ShareRowExclusiveLock</code>\u3001<code>ExclusiveLock</code> \u548c <code>AccessExclusiveLock</code> \u51b2\u7a81\u3002</li> <li>SHARE\uff1a<code>CREATE INDEX</code> \u9700\u8981\u3002</li> <li>SHARE ROW EXCLUSIVE\uff1a\u521b\u5efa\u89e6\u53d1\u5668\u65f6\u4f7f\u7528\u3002</li> <li>EXCLUSIVE\uff1a\u7c7b\u4f3c\u4e8e <code>REFRESH MATERIALIZED VIEW CONCURRENTLY</code> \u7b49\u64cd\u4f5c\u5fc5\u9700\u3002</li> <li>ACCESS EXCLUSIVE\uff1a\u6700\u5f3a\u7684\u9501\uff0c\u7531 <code>DROP TABLE</code>\u3001<code>TRUNCATE</code>\u3001\u67d0\u4e9b <code>ALTER TABLE</code> \u547d\u4ee4\u548c <code>VACUUM FULL</code> \u7b49\u64cd\u4f5c\u4f7f\u7528\u3002\u6700\u4e25\u683c\uff0c\u963b\u6b62\u6240\u6709\u5e76\u53d1\u8bbf\u95ee\uff0c\u5e76\u4e14\u9700\u8981\u5927\u591a\u6570\u67b6\u6784\u4fee\u6539\u3002</li> </ul> <p>\u6211\u8ba4\u4e3a\uff0c\u77e5\u9053\u54ea\u4e9b\u64cd\u4f5c\u83b7\u5f97\u54ea\u4e9b\u9501\u5f88\u91cd\u8981\uff0c\u4f46\u53ef\u4ee5\u8f7b\u677e\u68c0\u67e5\u3002\u7406\u89e3\u9501\u6a21\u5f0f\u5982\u4f55\u76f8\u4e92\u4f5c\u7528\u53ef\u80fd\u66f4\u4e3a\u91cd\u8981\u3002\u4e0d\u540c\u7684\u9501\u6a21\u5f0f\u4e0e\u5176\u4ed6\u4e0d\u540c\u7684\u6a21\u5f0f\u76f8\u51b2\u7a81\u3002</p> <p></p> <p>\u9501\u51b2\u7a81</p> <p>\u6709\u51e0\u4e2a\u5173\u952e\u70b9\u9700\u8981\u7406\u89e3\uff0c<code>ACCESS EXCLUSIVE</code> \u4e0e\u6240\u6709\u9501\u6a21\u5f0f\u51b2\u7a81\uff0c\u5305\u62ec <code>ACCESS SHARE</code> (<code>SELECT</code>)\u3002PostgreSQL \u8fdb\u884c\u4e86\u8bb8\u591a\u4f18\u5316\uff0c\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\u91c7\u7528\u8f83\u5f31\u7684\u9501\u6a21\u5f0f\u3002\u7136\u800c\uff0c\u6ca1\u6709\u4ec0\u4e48\u662f\u5b8c\u7f8e\u7684\uff0c\u5b83\u4ecd\u7136\u4f1a\u5bf9\u67d0\u4e9b DDL \u64cd\u4f5c\u91c7\u53d6\u5f3a\u9501\u3002\u4e00\u65e6\u4e8b\u52a1\u91c7\u53d6\u5f3a\u9501\uff0c\u5373\u4f7f\u8bed\u53e5\u5df2\u5b8c\u6210\uff0c\u5b83\u4e5f\u4f1a\u6301\u6709\u8be5\u9501\u3002</p> <p>\u4e00\u4e2a\u91cd\u8981\u7684\u6559\u8bad\u662f\uff0cDDL \u64cd\u4f5c\u53ef\u80fd\u4f1a\u5728\u6574\u4e2a\u4e8b\u52a1\u6301\u7eed\u671f\u95f4\u963b\u6b62\u5199\u5165\u548c\u8bfb\u53d6\u3002\u56e0\u6b64\uff0c\u907f\u514d\u5728\u540c\u4e00\u4e8b\u52a1\u4e2d\u6df7\u5408\u4f7f\u7528\u9700\u8981\u5f3a\u9501\u7684\u547d\u4ee4\u81f3\u5173\u91cd\u8981\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u9700\u8981\u6267\u884c\u8868\u66f4\u6539\u548c\u6570\u636e\u66f4\u65b0\uff0c\u6700\u597d\u5c06\u5b83\u4eec\u5206\u6210\u4e0d\u540c\u7684\u4e8b\u52a1\u4ee5\u6700\u5927\u9650\u5ea6\u5730\u51cf\u5c11\u963b\u585e\u3002</p>"},{"location":"2025/01/20/anatomy-of-table-level-locks-in-postgresql/#postgresql_1","title":"\u4e86\u89e3 PostgreSQL \u4e2d\u9501\u961f\u5217","text":"<p>\u5f53\u4e00\u4e2a\u4e8b\u52a1\u8bf7\u6c42\u7684\u9501\u4e0e\u53e6\u4e00\u4e2a\u4e8b\u52a1\u5df2\u7ecf\u6301\u6709\u7684\u9501\u51b2\u7a81\u65f6\uff0c\u5b83\u4f1a\u8fdb\u5165\u9501\u961f\u5217\uff08lock queue\uff09\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8bf7\u6c42\u4e8b\u52a1\u5c06\u65e0\u9650\u671f\u5730\u7b49\u5f85\uff0c\u76f4\u5230\u9501\u53ef\u7528\u3002\u8fd9\u4e9b\u7b49\u5f85\u7684\u9501\u5f62\u6210\u4e00\u4e2a\u961f\u5217\uff0c\u4f46\u4e0d\u5e78\u7684\u662f\uff0c\u8fd9\u4e2a\u961f\u5217\u5728 <code>pg_locks</code> \u7cfb\u7edf\u89c6\u56fe\u4e2d\u4e0d\u80fd\u76f4\u63a5\u770b\u5230\u3002\u76f8\u53cd\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>pg_blocking_pids()</code> \u51fd\u6570\u6765\u8bc6\u522b\u54ea\u4e9b\u540e\u7aef\u6b63\u5728\u963b\u585e\u7279\u5b9a\u540e\u7aef\u3002</p> <p>\u961f\u5217\u4e2d\u4f4d\u4e8e\u524d\u9762\u7684\u9501\u53ef\u80fd\u4f1a\u963b\u585e\u4f4d\u4e8e\u5176\u540e\u9762\u7684\u9501\uff0c\u4ece\u800c\u5bfc\u81f4\u7ea7\u8054\u5ef6\u8fdf\u3002\u4f8b\u5982\uff1a</p> <ol> <li>\u957f\u65f6\u95f4\u8fd0\u884c\u7684 <code>SELECT</code> \u6301\u6709 <code>ACCESS SHARE LOCK</code>\u3002</li> <li><code>ALTER TABLE DETACH PARTITION</code> \u9700\u8981\u77ed\u6682\u7684 <code>ACCESS EXCLUSIVE LOCK</code>\u3002</li> <li>\u4f46\u5b83\u4eec\u53d1\u751f\u51b2\u7a81\uff0c\u56e0\u6b64 <code>ALTER TABLE</code> \u88ab\u653e\u5728\u9501\u961f\u5217\u4e2d\u3002</li> <li>\u53e6\u5916 20 \u4e2a\u540e\u7aef\u6b63\u5728\u5c1d\u8bd5\u6267\u884c\u7b80\u5355\u7684\u4e3b\u952e\u67e5\u627e <code>SELECT</code>\u3002</li> <li>\u4f46\u5b83\u4eec\u4e0e <code>ALTER TABLE</code> \u7684\u9501\u51b2\u7a81\uff0c\u6240\u4ee5\u5b83\u4eec\u6392\u5728 <code>ALTER TABLE</code> \u64cd\u4f5c\u540e\u9762\u3002</li> <li>\u73b0\u5728\uff0c\u5bf9\u7ed9\u5b9a\u8868\u7684\u6240\u6709\u8bbf\u95ee\u90fd\u5df2\u6392\u961f\uff0c\u5e76\u4e14\u76f4\u5230\u957f\u65f6\u95f4\u8fd0\u884c\u7684 <code>SELECT</code> \u548c <code>ALTER TABLE</code> \u90fd\u5b8c\u6210\u4e4b\u524d\u4e0d\u4f1a\u8fdb\u884c\u4efb\u4f55\u5904\u7406\u3002</li> </ol> <p>\u8fd9\u79cd\u7d2f\u79ef\u7684\u7b49\u5f85\u4f1a\u4e25\u91cd\u5f71\u54cd\u6027\u80fd\uff0c\u5c24\u5176\u662f\u5728\u9ad8\u5e76\u53d1\u73af\u5883\u4e2d\u3002\u4f7f\u7528 <code>lock_timeout</code> \u6765\u9650\u5236\u4e8b\u52a1\u7b49\u5f85\u9501\u7684\u65f6\u95f4\u3002\u5bf9\u4e8e DDL \u64cd\u4f5c\uff0c\u8bbe\u7f6e <code>lock_timeout</code> \u901a\u5e38\u8db3\u4ee5\u9632\u6b62\u590d\u6742\u7684\u7b49\u5f85\u573a\u666f\u3002\u4f46\u662f\uff0c\u5728\u5b9e\u73b0\u8d85\u65f6\u65f6\uff0c\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u5fc5\u987b\u51c6\u5907\u597d\u59a5\u5584\u5904\u7406\u6545\u969c\uff0c\u901a\u5e38\u662f\u901a\u8fc7\u4e3a\u8d85\u65f6\u7684 DDL \u64cd\u4f5c\u5b9e\u73b0\u91cd\u8bd5\u903b\u8f91\uff08retry logic\uff09\u3002</p> <p>\u4ece\u4e2d\u5f97\u5230\u7684\u6700\u5927\u542f\u793a\u662f\uff0c\u4efb\u4f55\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u67e5\u8be2\u90fd\u53ef\u80fd\u5728\u6a21\u5f0f\u66f4\u6539\u671f\u95f4\u9020\u6210\u963b\u585e\uff0c\u4f46\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u9002\u5f53\u7684 <code>lock_timeout</code> \u503c\u6765\u51cf\u8f7b\u8fd9\u79cd\u7d2f\u79ef\u7b49\u5f85\u6548\u5e94\u3002</p> <p>\u5982\u679c\u60a8\u60f3\u4e86\u89e3\u66f4\u591a\uff0c\u6211\u4eec\u8fd8\u6709\u4e00\u7bc7\u6709\u5173\u6a21\u5f0f\u66f4\u6539\u548c PostgreSQL \u9501\u961f\u5217\u7684\u7cbe\u5f69\u535a\u5ba2\u6587\u7ae0\u3002</p>"},{"location":"2025/01/20/anatomy-of-table-level-locks-in-postgresql/#_4","title":"\u5c06\u4e00\u5207\u9501\u5b9a\u5728\u4e00\u8d77","text":"<p>\u6211\u6ce8\u610f\u5230\u8fd9\u7bc7\u6587\u7ae0\u5df2\u7ecf\u5f88\u957f\u4e86\uff0c\u4f46\u6211\u8fd8\u6709\u5f88\u591a\u8bdd\u8981\u8bf4\u3002\u56e0\u6b64\uff0c\u6211\u5c06\u5728\u8fd9\u91cc\u7ed3\u675f\u672c\u6587\uff0c\u5e76\u5199\u4e00\u7bc7\u540e\u7eed\u6587\u7ae0\u6765\u8ba8\u8bba\u9501\u4e89\u7528\u4ee5\u53ca\u5982\u4f55\u5728\u5fc5\u8981\u65f6\u5c3d\u91cf\u51cf\u5c11\u9501\u7684\u5f71\u54cd\u3002</p> <p>\u622a\u81f3\u76ee\u524d\uff0c\u6211\u4eec\u5df2\u7ecf\u63a2\u8ba8\u4e86 MVCC \u5982\u4f55\u5e2e\u52a9\u5904\u7406\u5e76\u53d1\u4e8b\u52a1\u4ee5\u53ca\u5404\u79cd\u9501\u6a21\u5f0f\u5982\u4f55\u4fdd\u62a4\u6570\u636e\u5b8c\u6574\u6027\u3002\u6211\u4eec\u5df2\u7ecf\u770b\u5230\uff0c\u9501\u7684\u8303\u56f4\u4ece\u66f4\u5bbd\u677e\u7684 <code>ACCESS SHARE</code> \u5230\u66f4\u4e25\u683c\u7684 <code>ACCESS EXCLUSIVE</code>\uff0c\u6bcf\u79cd\u9501\u5728\u7ef4\u62a4\u6570\u636e\u4e00\u81f4\u6027\u65b9\u9762\u90fd\u53d1\u6325\u7740\u81f3\u5173\u91cd\u8981\u7684\u4f5c\u7528\u3002\u867d\u7136 MVCC \u907f\u514d\u4e86\u8bb8\u591a\u4f20\u7edf\u7684\u9501\u5b9a\u95ee\u9898\uff0c\u4f46\u67d0\u79cd\u7a0b\u5ea6\u7684\u9501\u5b9a\u4ecd\u7136\u4e0d\u53ef\u907f\u514d\u3002\u5173\u952e\u662f\u627e\u5230\u6b63\u786e\u7684\u5e73\u8861\u70b9\uff0c\u9501\u5b9a\u592a\u5c11\u4f1a\u5bfc\u81f4\u6570\u636e\u635f\u574f\u7684\u98ce\u9669\uff0c\u800c\u9501\u5b9a\u592a\u591a\u5219\u4f1a\u9020\u6210\u4e0d\u5fc5\u8981\u7684\u74f6\u9888\u3002</p> <p>\u603b\u800c\u8a00\u4e4b\uff0c\u4ee5\u4e0b\u662f\u672c\u6587\u7684\u8981\u70b9\uff1a</p> <ul> <li>MVCC \u5c06\u4fdd\u62a4\u60a8\u514d\u53d7\u5199\u5165\u963b\u6b62\u8bfb\u53d6\u7684\u635f\u5bb3\uff0c\u4f46\u4e0d\u80fd\u4fdd\u62a4\u60a8\u514d\u53d7 DDL \u6240\u91c7\u53d6\u7684\u5bf9\u8c61\u9501\u7684\u635f\u5bb3\u3002</li> <li>\u540c\u4e00 DDL \u547d\u4ee4\u7684\u4e0d\u540c\u53d8\u4f53\u53ef\u80fd\u9700\u8981\u975e\u5e38\u4e0d\u540c\u7684\u9501\u5f3a\u5ea6\u3002</li> <li>DDL \u53ef\u80fd\u4f1a\u963b\u6b62\u4e8b\u52a1\u6574\u4e2a\u8fd0\u884c\u671f\u95f4\u7684\u5199\u5165\u548c/\u6216\u8bfb\u53d6\u3002</li> <li>\u4e0d\u8981\u5c06\u9700\u8981\u5f3a\u9501\u7684\u547d\u4ee4\u4e0e\u5728\u540c\u4e00\u4e8b\u52a1\u4e2d\u5de5\u4f5c\u7684\u5176\u4ed6\u547d\u4ee4\u6df7\u5408\u3002</li> <li>\u4f7f\u7528 <code>lock_timeout</code> \u6765\u9650\u5236\u7b49\u5f85\u9501\u7684\u65f6\u95f4\u3002</li> <li>\u5bf9 DDL \u547d\u4ee4\u4f7f\u7528 <code>lock_timeout</code> \u901a\u5e38\u5c31\u8db3\u591f\u4e86\u3002\u5fc5\u987b\u80fd\u591f\u5904\u7406\u6545\u969c\uff0c\u4f8b\u5982\u518d\u6b21\u91cd\u8bd5 DDL\u3002</li> </ul> <p>\u6211\u5c06\u4e8e 1 \u6708 17 \u65e5\u5728 PGDay CERN \u4e0a\u4ecb\u7ecd\u8fd9\u4e2a\u4e3b\u9898\uff0c\u5982\u679c\u60a8\u5728\u7684\u8bdd\uff0c\u8bf7\u8fc7\u6765\u6253\u4e2a\u62db\u547c\uff01</p> <p>\u8bf7\u7ee7\u7eed\u5173\u6ce8\u5373\u5c06\u53d1\u5e03\u7684\u6587\u7ae0\u3002</p> <p>\u4f5c\u8005\uff1aGulcin Yildirim Jelinek \u539f\u6587\uff1ahttps://xata.io/blog/anatomy-of-locks</p>"},{"location":"2025/05/27/archive-postgres-partitions-to-iceberg/","title":"\u5c06 PostgreSQL \u5206\u533a\u5f52\u6863\u5230 Iceberg","text":"<p>PostgreSQL \u5185\u7f6e\u4e86\u5206\u533a\u529f\u80fd\uff0c\u60a8\u8fd8\u53ef\u4ee5\u501f\u52a9 <code>pg_partman</code> \u6765\u8fdb\u4e00\u6b65\u534f\u52a9\u7ef4\u62a4\u5206\u533a\u3002\u5982\u679c\u60a8\u7684\u4e3b\u8981\u5de5\u4f5c\u8d1f\u8f7d\u662f\u67e5\u8be2\u4ee5\u65f6\u95f4\u5e8f\u5217\u4e3a\u4e2d\u5fc3\u7684\u5c0f\u578b\u6570\u636e\u5b50\u96c6\uff0c\u5b83\u53ef\u4ee5\u5f88\u597d\u5730\u5bf9\u6570\u636e\u8fdb\u884c\u5206\u533a\uff0c\u4ece\u800c\u8f7b\u677e\u4fdd\u7559\u6709\u9650\u7684\u6570\u636e\u96c6\u5e76\u63d0\u9ad8\u6027\u80fd\u3002\u901a\u5e38\uff0c\u5728\u5b9e\u65bd\u5206\u533a\u65f6\uff0c\u60a8\u53ea\u4fdd\u7559\u4e00\u90e8\u5206\u6570\u636e\uff0c\u7136\u540e\u968f\u7740\u6210\u672c\u7ba1\u7406\u7684\u9700\u8981\u800c\u5220\u9664\u65e7\u6570\u636e\u3002</p> <p>\u4f46\u662f\u5982\u679c\u6211\u4eec\u53ef\u4ee5\u5c06\u65e7\u5206\u533a\u65e0\u7f1d\u79fb\u52a8\u5230 Iceberg \u5e76\u6c38\u4e45\u4fdd\u7559\u6240\u6709\u6570\u636e\uff0c\u540c\u65f6\u53ea\u5728 PostgreSQL \u4e2d\u7ef4\u62a4\u6700\u8fd1\u7684\u5206\u533a\uff0c\u90a3\u4f1a\u600e\u6837\uff1f\u6211\u4eec\u662f\u5426\u53ef\u4ee5\u62e5\u6709\u4e00\u4e2a\u5b8c\u7f8e\u7684\u4e16\u754c\uff1aIceberg \u4e2d\u6709\u5b8c\u6574\u7684\u957f\u671f\u526f\u672c\uff0c\u53ef\u4ee5\u4ece\u6570\u636e\u4ed3\u5e93\u8f7b\u677e\u67e5\u8be2\uff0c\u800c PostgreSQL \u4ecd\u4f5c\u4e3a\u5177\u6709\u6700\u8fd1 30 \u5929\u6570\u636e\u7684\u64cd\u4f5c\u6570\u636e\u5e93\uff1f</p> <p>\u501f\u52a9 Crunchy \u6570\u636e\u4ed3\u5e93\u7684\u6700\u65b0\u590d\u5236\u652f\u6301\uff0c\u8fd9\u53ef\u4ee5\u65e0\u7f1d\u5b9e\u73b0\u3002\u8ba9\u6211\u4eec\u6df1\u5165\u4e86\u89e3\u4e00\u4e0b\u3002</p>","tags":["PostgreSQL","Iceberg"]},{"location":"2025/05/27/archive-postgres-partitions-to-iceberg/#_1","title":"\u5206\u533a\u521b\u5efa","text":"<p>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u521b\u5efa\u5206\u533a\u8868\u3002\u5982\u679c\u60a8\u60f3\u5728\u5bb6\u4e2d\u8ddf\u7740\u64cd\u4f5c\uff0c\u8fd9\u91cc\u6709\u4e00\u4e9b\u4ee3\u7801\u53ef\u4ee5\u8bbe\u7f6e\u4e00\u4e2a\u6a21\u4eff\u7f51\u7edc\u5206\u6790\u6570\u636e\u96c6\u7684\u5206\u533a\u6570\u636e\u793a\u4f8b\u3002</p> <pre><code>CREATE TABLE page_hits (\n    id SERIAL,\n    site_id INT NOT NULL,\n    ingest_time TIMESTAMPTZ NOT NULL,\n    url TEXT NOT NULL,\n    request_country TEXT,\n    ip_address INET,\n    status_code INT,\n    response_time_msec INT,\n    PRIMARY KEY (id, ingest_time)\n) PARTITION BY RANGE (ingest_time);\n</code></pre> <p>\u4e0b\u9762\u7684\u4ee3\u7801\u5c06\u4e3a\u6211\u4eec\u521b\u5efa\u4e00\u7ec4\u8fc7\u53bb 30 \u5929\u7684\u5206\u533a\u3002</p> <pre><code>DO $$\nDECLARE\n  d DATE;\nBEGIN\n  FOR d IN SELECT generate_series(DATE '2025-04-20', DATE '2025-05-19', INTERVAL '1 day') LOOP\n    EXECUTE format($f$\n      CREATE TABLE IF NOT EXISTS page_hits_%s PARTITION OF page_hits\n      FOR VALUES FROM ('%s') TO ('%s');\n    $f$, to_char(d, 'YYYY_MM_DD'), d, d + INTERVAL '1 day');\n  END LOOP;\nEND $$;\n</code></pre> <p>\u60a8\u7684\u6570\u636e\u5e93\u770b\u8d77\u6765\u5e94\u8be5\u662f\u8fd9\u6837\u7684\uff1a</p> <pre><code>List of relations\n Schema |          Name           |       Type        |       Owner\n--------+-------------------------+-------------------+-------------------\n public | page_hits               | partitioned table | postgres\n public | page_hits_2025_04_20    | table             | postgres\n public | page_hits_2025_04_21    | table             | postgres\n ...\n public | page_hits_2025_05_18    | table             | postgres\n public | page_hits_2025_05_19    | table             | postgres\n public | page_hits_id_seq        | sequence          | postgres\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u751f\u6210\u4e00\u4e9b\u793a\u4f8b\u6570\u636e\u3002\u5728\u672c\u4f8b\u4e2d\uff0c\u6211\u4eec\u5c06\u4e3a\u6bcf\u4e2a\u8868\u6bcf\u5929\u751f\u6210 1000 \u884c\u6570\u636e\uff1a</p> <pre><code>DO $$\nDECLARE\n  d DATE;\nBEGIN\n  FOR d IN\n    SELECT generate_series(DATE '2025-04-20', DATE '2025-05-19', '1 day'::INTERVAL)\n  LOOP\n    INSERT INTO page_hits (site_id, ingest_time, url, request_country, ip_address, status_code, response_time_msec)\n    SELECT\n        (RANDOM() * 30)::INT,\n        d + (i || ' seconds')::INTERVAL,\n        'http://example.com/' || substr(md5(random()::text), 1, 12),\n        (ARRAY['China', 'India', 'Indonesia', 'USA', 'Brazil'])[1 + (random() * 4)::INT],\n        inet '10.0.0.0' + (random() * 1000000)::INT,\n        (ARRAY[200, 200, 200, 404, 500])[1 + (random() * 4)::INT],\n        (random() * 300)::INT\n    FROM generate_series(1, 1000) AS s(i);\n  END LOOP;\nEND $$;\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u7684 PostgreSQL \u8bbe\u7f6e\u4e2d\u5df2\u7ecf\u6709\u4e86\u4e00\u4e9b\u6570\u636e\uff0c\u8ba9\u6211\u4eec\u5c06\u5b83\u4eec\u8fde\u63a5\u5230 Crunchy \u6570\u636e\u4ed3\u5e93\u5e76\u8fdb\u884c\u590d\u5236\u3002</p>","tags":["PostgreSQL","Iceberg"]},{"location":"2025/05/27/archive-postgres-partitions-to-iceberg/#iceberg","title":"Iceberg \u590d\u5236","text":"<p>\u5728\u8bbe\u7f6e\u4e2d\uff0c\u60a8\u9700\u8981\u6307\u5b9a\u901a\u8fc7\u6839\u5206\u533a\u53d1\u5e03 - <code>root=true</code>\u3002\u8fd9\u5c06\u4fdd\u7559 PostgreSQL \u4e2d\u7684\u5206\u533a\uff0c\u4f46\u4e0d\u4f1a\u5bf9 Iceberg \u8fdb\u884c\u5206\u533a\uff0c\u56e0\u4e3a\u5b83\u6709\u81ea\u5df1\u7684\u6570\u636e\u6587\u4ef6\u7ec4\u7ec7\u7ed3\u6784\u3002</p> <pre><code>CREATE PUBLICATION hits_to_iceberg\nFOR TABLE page_hits\nWITH (publish_via_partition_root = true);\n</code></pre> <p>\u8bbe\u7f6e\u590d\u5236\u7528\u6237\uff1a</p> <pre><code>-- create a new user\nCREATE USER replication_user WITH REPLICATION PASSWORD '****';\n\n-- grant appropriate permissions\nGRANT SELECT ON ALL TABLES IN SCHEMA public TO replication_user;\n</code></pre> <p>\u5728\u6570\u636e\u4ed3\u5e93\u7aef\uff0c\u8ba2\u9605\u539f\u59cb\u6570\u636e\u3002\u7531\u4e8e\u6211\u4eec\u6307\u5b9a\u4e86 <code>create_tables_using Iceberg</code>\uff0c\u8fd9\u4e9b\u6570\u636e\u5c06\u5b58\u50a8\u5728 Iceberg \u4e2d\u3002</p> <pre><code>CREATE SUBSCRIPTION http_to_iceberg\nCONNECTION 'postgres://replication_user:****@p.qzyqhjdg3fhejocnta3zvleomq.db.postgresbridge.com:5432/postgres?sslmode=require'\nPUBLICATION hits_to_iceberg\nWITH (create_tables_using = 'iceberg', streaming, binary, failover);\n</code></pre> <p>\u8fd9\u662f Iceberg \u8868\u3002</p> <pre><code>                          List of relations\n Schema |          Name           |     Type      |       Owner\n--------+-------------------------+---------------+-------------------\n public | page_hits               | foreign table | postgres\n</code></pre>","tags":["PostgreSQL","Iceberg"]},{"location":"2025/05/27/archive-postgres-partitions-to-iceberg/#postgresql-iceberg_1","title":"\u4ece PostgreSQL \u67e5\u8be2\u5b58\u50a8\u5728 Iceberg \u4e2d\u7684\u6570\u636e","text":"<p>\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u6bcf\u4e2a\u56fd\u5bb6/\u5730\u533a\u7684\u6bcf\u65e5\u6d41\u91cf\u6d1e\u5bdf\uff0c\u7ec6\u5206\u70b9\u51fb\u6b21\u6570\u3001\u6210\u529f\u7387\u3001\u5e73\u5747\u54cd\u5e94\u65f6\u95f4\u548c\u4e3b\u8981\u9519\u8bef\u4ee3\u7801\uff1a</p> <p><pre><code>SELECT\n  date_trunc('day', ingest_time) AS day,\n  request_country,\n  COUNT(*) AS total_hits,\n  ROUND(100.0 * SUM(CASE WHEN status_code = 200 THEN 1 ELSE 0 END) / COUNT(*), 2) AS success_rate_percent,\n  ROUND(AVG(response_time_msec), 2) AS avg_response_time_msec,\n  MODE() WITHIN GROUP (ORDER BY status_code) AS most_common_status\nFROM\n  page_hits\nGROUP BY\n  day, request_country\nORDER BY\n  day, request_country\n;\n</code></pre> Output<pre><code>          day           | request_country | total_hits | success_rate_percent | avg_response_time_msec | most_common_status\n------------------------+-----------------+------------+----------------------+------------------------+--------------------\n 2025-04-20 00:00:00+00 | Brazil          |        128 |                68.75 |                 146.83 |                200\n 2025-04-20 00:00:00+00 | China           |        138 |                65.94 |                 145.67 |                200\n 2025-04-20 00:00:00+00 | India           |        245 |    64.90000000000001 |                  153.8 |                200\n 2025-04-20 00:00:00+00 | Indonesia       |        230 |    64.34999999999999 |                 151.43 |                200\n</code></pre></p>","tags":["PostgreSQL","Iceberg"]},{"location":"2025/05/27/archive-postgres-partitions-to-iceberg/#postgresql","title":"\u5220\u9664\u65e7\u7684 PostgreSQL \u5206\u533a","text":"<p>\u7531\u4e8e\u6570\u636e\u5df2\u88ab\u590d\u5236\u5e76\u4e14\u526f\u672c\u4f4d\u4e8e Iceberg \u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u5728\u7279\u5b9a\u65f6\u95f4\u5220\u9664\u5206\u533a\u4ee5\u91ca\u653e\u4e3b\u64cd\u4f5c PostgreSQL \u6570\u636e\u5e93\u4e0a\u7684\u5b58\u50a8\u548c\u5185\u5b58\u3002</p> <pre><code>--drop partition\nDROP TABLE page_hits_2025_04_20;\n</code></pre> <pre><code>-- show missing partition in the table list\n                            List of relations\n Schema |          Name           |       Type        |       Owner\n--------+-------------------------+-------------------+-------------------\n public | page_hits               | partitioned table | postgres\n public | page_hits_2025_04_21    | table             | postgres\n public | page_hits_2025_04_22    | table             | postgres\n</code></pre> <pre><code>-- query iceberg, data is still there\n          day           | request_country | total_hits | success_rate_percent | avg_response_time_msec | most_common_status\n------------------------+-----------------+------------+----------------------+------------------------+--------------------\n 2025-04-20 00:00:00+00 | Brazil          |        128 |                68.75 |                 146.83 |                200\n 2025-04-20 00:00:00+00 | China           |        138 |                65.94 |                 145.67 |                200\n 2025-04-20 00:00:00+00 | India           |        245 |    64.90000000000001 |                  153.8 |                200\n 2025-04-20 00:00:00+00 | Indonesia       |        230 |    64.34999999999999 |                 151.43 |                200\n</code></pre>","tags":["PostgreSQL","Iceberg"]},{"location":"2025/05/27/archive-postgres-partitions-to-iceberg/#_2","title":"\u603b\u7ed3","text":"<p>\u4ece\u5206\u533a\u5230 Crunchy \u6570\u636e\u4ed3\u5e93\u7684\u903b\u8f91\u590d\u5236</p> <p>\u4ee5\u4e0b\u662f\u7b80\u5355\u7684 PostgreSQL \u5f52\u6863\u65b9\u6cd5\uff0c\u53ef\u5b9e\u73b0\u957f\u671f\u7ecf\u6d4e\u9ad8\u6548\u7684\u6570\u636e\u4fdd\u7559\uff1a</p> <ul> <li>\u5bf9\u9ad8\u541e\u5410\u91cf\u6570\u636e\u8fdb\u884c\u5206\u533a - \u8fd9\u5bf9\u4e8e\u6027\u80fd\u548c\u7ba1\u7406\u6765\u8bf4\u90fd\u662f\u7406\u60f3\u7684\u9009\u62e9\u3002</li> <li>\u5c06\u6570\u636e\u590d\u5236\u5230 Iceberg\uff0c\u4ee5\u4fbf\u4e8e\u62a5\u544a\u548c\u957f\u671f\u5f52\u6863\u3002</li> <li>\u4ee5\u7406\u60f3\u7684\u95f4\u9694\u5220\u9664\u5206\u533a\u3002</li> <li>\u6301\u7eed\u4ece PostgreSQL \u67e5\u8be2\u5f52\u6863\u6570\u636e\u3002</li> </ul> <p>\u4f5c\u8005\uff1aCraig Kerstiens \u539f\u6587\uff1ahttps://www.crunchydata.com/blog/archive-postgres-partitions-to-iceberg#now-drop-the-older-postgres-partition</p>","tags":["PostgreSQL","Iceberg"]},{"location":"2025/05/23/dealing-with-lwlock-lockmanager-wait-events-in-aurora-postgres/","title":"\u5904\u7406 Aurora Postgres \u4e2d\u7684 LWLock:LockManager \u7b49\u5f85\u4e8b\u4ef6","text":"","tags":["PostgreSQL","Locks"]},{"location":"2025/05/23/dealing-with-lwlock-lockmanager-wait-events-in-aurora-postgres/#_1","title":"\u4ec0\u4e48\u662f\u8f7b\u91cf\u7ea7\u9501","text":"<p>PostgreSQL \u901a\u8fc7\u8f7b\u91cf\u7ea7\u9501\uff08Lightweight Locks, LWLocks\uff09\u63a7\u5236\u5bf9\u5171\u4eab\u5185\u5b58\u4e2d\u7684\u6570\u636e\u7ed3\u6784\u7684\u8bbf\u95ee\u3002\u4e0e\u8868\u9501\u6216\u884c\u9501\u4e0d\u540c\uff0c\u8f7b\u91cf\u7ea7\u9501\u901a\u5e38\u6301\u6709\u5f88\u77ed\u7684\u65f6\u95f4\uff0c\u5e76\u4e14\u4e0d\u53d7\u6b63\u5728\u8fdb\u884c\u7684\u4e8b\u52a1\u7684\u7ea6\u675f\u3002\u4f5c\u4e3a\u6570\u636e\u5e93\u5ba2\u6237\u7aef\uff0c\u60a8\u65e0\u6cd5\u76f4\u63a5\u63a7\u5236\u4f55\u65f6\u83b7\u53d6\u8fd9\u4e9b\u9501\u3002\u5b83\u4eec\u5728\u540e\u53f0\u8fd0\u884c\uff0c\u5e76\u4e14\u7531 PostgreSQL \u81ea\u8eab\u7ba1\u7406\u3002</p> <p>\u672c\u6587\u5c06\u63a2\u8ba8 PostgreSQL \u7684\u9501\u7ba1\u7406\u5668\u3001\u8f7b\u91cf\u7ea7\u9501\u3001\u5feb\u901f\u8def\u5f84\u9501\uff08fast-path locking\uff09\u4ee5\u53ca\u5982\u4f55\u5bf9\u6297 <code>LWLock:LockManager</code> \u7b49\u5f85\u4e8b\u4ef6\u3002</p>","tags":["PostgreSQL","Locks"]},{"location":"2025/05/23/dealing-with-lwlock-lockmanager-wait-events-in-aurora-postgres/#_2","title":"\u8f7b\u91cf\u7ea7\u9501\u4e0e\u9501\u7ba1\u7406\u5668","text":"<p>\u6bcf\u5f53\u60a8\u5728 PostgreSQL \u4e2d\u4e0e\u5173\u7cfb\uff08\u8868\u6216\u7d22\u5f15\uff09\u4ea4\u4e92\u65f6\uff0c\u7cfb\u7edf\u90fd\u4f1a\u83b7\u53d6\u8be5\u5173\u7cfb\u7684\u9501\u3002\u8fd9\u4e9b\u9501\u901a\u5e38\u88ab\u79f0\u4e3a\u91cd\u91cf\u7ea7\u9501\u3002\u8fd9\u4f3c\u4e4e\u6709\u6096\u5e38\u7406\uff0c\u4f46\u5373\u4f7f\u662f\u53ea\u8bfb\u67e5\u8be2\u4e5f\u4f1a\u83b7\u53d6 PostgreSQL \u9700\u8981\u8ddf\u8e2a\u7684\u9501\u3002</p> <p>\u4e3a\u4e86\u52a0\u901f\u9501\u83b7\u53d6\uff0cPostgreSQL \u4f7f\u7528\u4e00\u79cd\u79f0\u4e3a\u5feb\u901f\u8def\u5f84\u9501\uff08fast-path locking\uff09\u7684\u673a\u5236\u3002\u6b64\u6280\u672f\u7528\u4e8e\u4f7f\u7528\u201c\u5f31\u201d\u5173\u7cfb\u9501\uff08<code>AccessShareLock</code>\u3001<code>RowShareLock</code> \u6216 <code>RowExclusiveLock</code>\uff09\u7684\u573a\u666f\uff0c\u5e76\u4e14\u4ec5\u5f53\u7cfb\u7edf\u53ef\u4ee5\u5feb\u901f\u9a8c\u8bc1\u4e0d\u5b58\u5728\u51b2\u7a81\u9501\u65f6\u624d\u4f7f\u7528\u3002</p> <p>\u6bcf\u4e2a\u4e8b\u52a1\u5141\u8bb8\u83b7\u53d6 16 \u4e2a\u5feb\u901f\u8def\u5f84\u9501\u3002</p> <pre><code>/*\n * We allow a small number of \"weak\" relation locks (AccessShareLock,\n * RowShareLock, RowExclusiveLock) to be recorded in the PGPROC structure\n * rather than the main lock table.  This eases contention on the lock\n * manager LWLocks.  See storage/lmgr/README for additional details.\n */\n#define     FP_LOCK_SLOTS_PER_BACKEND 16\n</code></pre> <p>\u4e00\u65e6\u8d85\u51fa\u9650\u5236\uff0c\u540e\u7eed\u7684\u9501\u83b7\u53d6\u5c31\u5fc5\u987b\u901a\u8fc7\u9501\u7ba1\u7406\u5668\u3002\u6839\u636e\u5de5\u4f5c\u8d1f\u8f7d\u7684\u7c7b\u578b\uff0c\u8fd9\u53ef\u80fd\u4f1a\u9020\u6210\u9501\u83b7\u53d6\u4e89\u7528\uff0c\u4ece\u800c\u964d\u4f4e\u5de5\u4f5c\u8d1f\u8f7d\u7684\u901f\u5ea6\u3002</p>","tags":["PostgreSQL","Locks"]},{"location":"2025/05/23/dealing-with-lwlock-lockmanager-wait-events-in-aurora-postgres/#fast-path","title":"Fast-Path \u793a\u4f8b","text":"<p>\u4e3a\u4e86\u66f4\u597d\u5730\u7406\u89e3\u5feb\u901f\u8def\u5f84\uff0c\u4eb2\u81ea\u4f53\u9a8c\u4e00\u4e0b\u4f1a\u6709\u6240\u5e2e\u52a9\u3002<code>pg_locks</code> \u89c6\u56fe\u663e\u793a\u6d3b\u52a8\u8fdb\u7a0b\u6301\u6709\u7684\u9501\u7684\u4fe1\u606f\u3002\u5f53\u901a\u8fc7\u5feb\u901f\u8def\u5f84\u83b7\u53d6\u9501\u65f6\uff0c<code>fastpath</code> \u5217\u5c06\u88ab\u8bbe\u7f6e\u4e3a <code>true</code>\u3002</p> <p>\u8ba9\u6211\u4eec\u8fdb\u884c\u4ee5\u4e0b\u5b9e\u9a8c\u3002\u5728\u4e00\u4e2a\u6570\u636e\u5e93\u4f1a\u8bdd\u4e2d\uff0c\u6211\u4eec\u5c06\u542f\u52a8\u4e00\u4e2a\u4e8b\u52a1\uff0c\u7136\u540e\u5728\u4e0d\u540c\u7684\u8868\u4e0a\u6267\u884c\u591a\u4e2a\u9009\u62e9\u67e5\u8be2\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u5c06\u5728\u6bcf\u4e2a\u5173\u7cfb\u4e0a\u83b7\u53d6\u4e00\u4e2a\u9501\u3002\u540c\u65f6\uff0c\u6211\u4eec\u6253\u5f00\u53e6\u4e00\u4e2a\u6570\u636e\u5e93\u4f1a\u8bdd\uff0c\u5e76\u89c2\u5bdf <code>pg_locks</code> \u8868\u3002</p> <p>\u542f\u52a8\u4e00\u4e2a\u65b0\u4e8b\u52a1\u5e76\u6267\u884c <code>select</code> \u8bed\u53e5\u3002\u9488\u5bf9\u6b64\u573a\u666f\uff0c\u6211\u521b\u5efa\u4e86\u591a\u4e2a\u7a7a\u8868\u3002</p> Session 1<pre><code>begin;\nselect * from test1;\n</code></pre> <p>\u5728\u7b2c\u4e8c\u4e2a\u6570\u636e\u5e93\u4f1a\u8bdd\u4e2d\uff0c\u67e5\u770b <code>pg_locks</code>\uff1b</p> <p>Session 2<pre><code>select relation::regclass, locktype, pid, mode, fastpath\nfrom pg_locks\nwhere pid != pg_backend_pid();  -- \u8fc7\u6ee4\u6389\u6b64\u67e5\u8be2\u83b7\u53d6\u7684\u9501\n</code></pre> \u8fdb\u7a0b ID 51 \u5bf9\u5e94\u7684\u662f\u7b2c\u4e00\u4e2a\u6570\u636e\u5e93\u4f1a\u8bdd\u4e2d\u7684\u540e\u7aef\u8fdb\u7a0b\u3002\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u4e24\u4e2a\u9501\u3002<code>AccessShareLock</code> \u662f\u7531 <code>test1</code> \u8868\u4e0a\u7684 <code>select</code> \u8bed\u53e5\u83b7\u53d6\u7684\u3002\u800c <code>ExclusiveLock</code> \u662f\u9488\u5bf9\u865a\u62df\u4e8b\u52a1 ID \u7684\u9501\u3002</p> <pre><code> relation |  locktype  | pid |      mode       | fastpath \n----------+------------+-----+-----------------+----------\n test1    | relation   |  51 | AccessShareLock | t\n          | virtualxid |  51 | ExclusiveLock   | t\n(2 rows)\n</code></pre> <p>\u5728\u7b2c\u4e00\u4e2a\u6570\u636e\u5e93\u4f1a\u8bdd\u4e2d\uff0c\u5982\u679c\u6211\u4eec\u7ee7\u7eed\u5bf9\u5c1a\u672a\u89e6\u53ca\u7684\u5173\u7cfb\u6267\u884c\u989d\u5916\u7684\u9009\u62e9\u8bed\u53e5\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fdb\u7a0b 51 \u83b7\u53d6\u7684\u9501\u6570\u91cf\u5c06\u4f1a\u589e\u52a0\u3002</p> <p>Session 1<pre><code>-- \u7b2c\u4e00\u4e2a\u6570\u636e\u5e93\u4f1a\u8bdd\u4e2d\nselect * from test2;\n</code></pre> <pre><code> relation |  locktype  | pid |      mode       | fastpath \n----------+------------+-----+-----------------+----------\n test2    | relation   |  51 | AccessShareLock | t\n test1    | relation   |  51 | AccessShareLock | t\n          | virtualxid |  51 | ExclusiveLock   | t\n(3 rows)\n</code></pre></p> <p>\u5feb\u901f\u8def\u5f84\u4e0d\u4ec5\u9002\u7528\u4e8e <code>select</code> \u8bed\u53e5\uff0c\u8fd8\u9002\u7528\u4e8e <code>insert</code>\u3001<code>update</code> \u548c <code>delete</code>\u3002</p> Session 1<pre><code>-- \u7b2c\u4e00\u4e2a\u6570\u636e\u5e93\u4f1a\u8bdd\u4e2d\ninsert into test1 (id, value) values (1, 'hello');\nupdate test2 set value = 'hello';\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u53c8\u51fa\u73b0\u4e86\u4e24\u4e2a\u5173\u7cfb\u9501\u3002<code>RowExclusiveLocks</code> \u662f\u5728\u63d2\u5165\u3001\u66f4\u65b0\u6216\u6267\u884c\u5220\u9664\u64cd\u4f5c\u65f6\u83b7\u53d6\u7684\u3002</p> <pre><code> relation |   locktype    | pid |       mode       | fastpath \n----------+---------------+-----+------------------+----------\n test2    | relation      |  51 | AccessShareLock  | t\n test2    | relation      |  51 | RowExclusiveLock | t\n test1    | relation      |  51 | AccessShareLock  | t\n test1    | relation      |  51 | RowExclusiveLock | t\n          | virtualxid    |  51 | ExclusiveLock    | t\n          | transactionid |  51 | ExclusiveLock    | f\n(6 rows)\n</code></pre> <p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6240\u6709\u64cd\u4f5c\u90fd\u5df2\u83b7\u53d6\u5feb\u901f\u8def\u5f84\u9501\u3002\u5982\u679c\u6211\u4eec\u7ee7\u7eed\u5728\u5173\u7cfb\u4e0a\u83b7\u53d6\u65b0\u7684\u9501\uff0c\u6700\u7ec8\u5c06\u8fbe\u5230\u6bcf\u4e2a\u4e8b\u52a1 16 \u4e2a\u5feb\u901f\u8def\u5f84\u9501\u7684\u9650\u5236\u3002\u4e00\u65e6\u8d85\u51fa\u9650\u5236\uff0c\u4efb\u4f55\u65b0\u9501\u7684 <code>fastpath</code> \u5217\u90fd\u4f1a\u88ab\u8bbe\u7f6e\u4e3a <code>false</code>\u3002\u56e0\u6b64\uff0c\u65b0\u7684\u9501\u83b7\u53d6\u5fc5\u987b\u901a\u8fc7\u9501\u7ba1\u7406\u5668\u3002</p> <pre><code> relation |   locktype    | pid |       mode       | fastpath \n----------+---------------+-----+------------------+----------\n...\n test17   | relation      |  51 | AccessShareLock  | f\n(21 rows)\n</code></pre>","tags":["PostgreSQL","Locks"]},{"location":"2025/05/23/dealing-with-lwlock-lockmanager-wait-events-in-aurora-postgres/#_3","title":"\u5927\u91cf\u7d22\u5f15","text":"<p>\u5728\u524d\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u4e13\u6ce8\u4e8e\u6d89\u53ca\u6ca1\u6709\u4efb\u4f55\u7d22\u5f15\u7684\u5355\u4e2a\u8868\u7684\u64cd\u4f5c\u3002\u7136\u800c\uff0c\u5728\u5b9e\u9645\u573a\u666f\u4e2d\uff0c\u7d22\u5f15\u5728\u65e5\u5e38\u67e5\u8be2\u4e2d\u8d77\u7740\u81f3\u5173\u91cd\u8981\u7684\u4f5c\u7528\u3002\u56e0\u6b64\uff0c\u7d22\u5f15\u4e5f\u9700\u8981\u52a0\u9501\u3002\u4e3a\u4e86\u6f14\u793a\u8fd9\u4e00\u70b9\uff0c\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u5305\u542b\u591a\u4e2a\u7d22\u5f15\u7684\u8868\u3002</p> <pre><code>create table many_indexes(\n  id bigserial primary key,\n  a char(100),\n  b char(100),\n  c char(100),\n  d char(100),\n  e char(100),\n  f char(100),\n  g char(100),\n  h char(100),\n  i char(100),\n  j char(100),\n  k char(100),\n  l char(100),\n  m char(100),\n  n char(100),\n  o char(100),\n  p char(100),\n  q char(100)\n);\n</code></pre> <p>\u5047\u8bbe\u8be5\u8868\u7684\u6bcf\u4e00\u5217\u90fd\u5df2\u5efa\u7acb\u7d22\u5f15\u3002\u8ba9\u6211\u4eec\u5bf9\u8be5\u8868\u6267\u884c\u67e5\u8be2\u64cd\u4f5c\uff0c\u770b\u770b\u54ea\u4e9b\u9501\u4f1a\u88ab\u83b7\u53d6\u3002</p> <p><pre><code>begin;\nselect * from many_indexes;\n\n-- in another db session, let's run\nselect relation::regclass, locktype, pid, mode, fastpath\nfrom pg_locks \nwhere pid != pg_backend_pid();\n</code></pre> <pre><code>     relation      |  locktype  | pid |      mode       | fastpath \n-------------------+------------+-----+-----------------+----------\n n_idx             | relation   |  51 | AccessShareLock | t\n m_idx             | relation   |  51 | AccessShareLock | t\n l_idx             | relation   |  51 | AccessShareLock | t\n k_idx             | relation   |  51 | AccessShareLock | t\n j_idx             | relation   |  51 | AccessShareLock | t\n i_idx             | relation   |  51 | AccessShareLock | t\n h_idx             | relation   |  51 | AccessShareLock | t\n g_idx             | relation   |  51 | AccessShareLock | t\n f_idx             | relation   |  51 | AccessShareLock | t\n e_idx             | relation   |  51 | AccessShareLock | t\n d_idx             | relation   |  51 | AccessShareLock | t\n c_idx             | relation   |  51 | AccessShareLock | t\n b_idx             | relation   |  51 | AccessShareLock | t\n a_idx             | relation   |  51 | AccessShareLock | t\n many_indexes_pkey | relation   |  51 | AccessShareLock | t\n many_indexes      | relation   |  51 | AccessShareLock | t\n                   | virtualxid |  51 | ExclusiveLock   | t\n p_idx             | relation   |  51 | AccessShareLock | f\n o_idx             | relation   |  51 | AccessShareLock | f\n q_idx             | relation   |  51 | AccessShareLock | f\n(20 rows)\n</code></pre></p> <p>\u9664\u4e86\u8868\u672c\u8eab\u4e4b\u5916\uff0c\u6240\u6709\u7d22\u5f15\u90fd\u83b7\u53d6\u4e86 <code>AccessShareLock</code> \u9501\u3002\u8bf7\u6ce8\u610f\uff0c\u5bf9\u4e8e\u51e0\u4e2a\u7d22\u5f15\uff0c<code>fastpath</code> \u8bbe\u7f6e\u4e3a <code>false</code>\u3002\u901a\u8fc7\u5bf9\u5177\u6709\u5927\u91cf\u7d22\u5f15\u7684\u5355\u4e2a\u8868\u8fdb\u884c\u67e5\u8be2\uff0c\u6211\u4eec\u80fd\u591f\u8fbe\u5230\u6bcf\u4e2a\u4e8b\u52a1 16 \u4e2a\u5feb\u901f\u8def\u5f84\u9501\u7684\u9650\u5236\u3002</p> <p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u4e13\u6ce8\u4e8e\u9009\u62e9\u5355\u4e2a\u8868\uff0c\u5e76\u89c2\u5bdf\u5230\u7d22\u5f15\u4e5f\u8ba1\u5165\u5feb\u901f\u8def\u5f84\u9501\u9650\u5236\u3002\u7136\u800c\uff0c\u5728\u5173\u7cfb\u6570\u636e\u5e93\u4e2d\uff0c\u4e00\u79cd\u5e38\u89c1\u7684\u8bbf\u95ee\u6a21\u5f0f\u662f\u8fde\u63a5\u591a\u4e2a\u8868\u3002\u5728\u8fde\u63a5\u64cd\u4f5c\u671f\u95f4\uff0c\u6bcf\u4e2a\u6d89\u53ca\u7684\u5173\u7cfb\u90fd\u4f1a\u88ab\u52a0\u9501\uff0c\u5305\u62ec\u6240\u6709\u8868\u53ca\u5176\u5173\u8054\u7684\u7d22\u5f15\u3002</p>","tags":["PostgreSQL","Locks"]},{"location":"2025/05/23/dealing-with-lwlock-lockmanager-wait-events-in-aurora-postgres/#_4","title":"\u9501\u7ba1\u7406\u5668","text":"<p>\u5f53\u65e0\u6cd5\u4f7f\u7528\u5feb\u901f\u8def\u5f84\u65f6\uff0c\u9700\u8981\u5c06\u9501\u8bb0\u5f55\u5728\u5171\u4eab\u5185\u5b58\u54c8\u5e0c\u8868\u4e2d\u3002\u5728 PostgreSQL \u4e2d\uff0c\u54c8\u5e0c\u8868\u88ab\u5206\u4e3a 16 \u4e2a\u5206\u533a\u3002</p> <pre><code>/* Number of partitions the shared lock tables are divided into */\n#define LOG2_NUM_LOCK_PARTITIONS  4\n#define NUM_LOCK_PARTITIONS  (1 &lt;&lt; LOG2_NUM_LOCK_PARTITIONS)\n</code></pre> <p>\u8fd9\u6837\u53ef\u4ee5\u5b9e\u73b0\u66f4\u9ad8\u7684\u5e76\u53d1\u6027\u3002\u53ea\u9700\u8981\u9501\u5b9a\u83b7\u53d6\u5230\u7684\u9501\u6240\u5728\u7684\u5206\u533a\uff0c\u800c\u4e0d\u662f\u6574\u4e2a\u54c8\u5e0c\u8868\u3002</p> <p></p> <p>\u9501\u7ba1\u7406\u5668\u7684\u54c8\u5e0c\u8868\u88ab\u5206\u6210 16 \u4e2a\u5206\u533a\uff0c\u4ee5\u63d0\u9ad8\u5e76\u53d1\u6027</p> <p>\u7136\u800c\uff0c\u5728\u9ad8\u6d41\u91cf\u6570\u636e\u5e93\u4e2d\uff0c\u9891\u7e41\u83b7\u53d6\u975e\u5feb\u901f\u8def\u5f84\u9501\uff0c\u5373\u4f7f\u662f 16 \u4e2a\u5206\u533a\u4e5f\u53ef\u80fd\u6210\u4e3a\u74f6\u9888\u3002\u8fd9\u6b63\u662f <code>LWLock:LockManager</code> \u7b49\u5f85\u4e8b\u4ef6\u6240\u6307\u793a\u7684\uff1a\u4e00\u4e2a\u8fdb\u7a0b\u6b63\u5728\u5c1d\u8bd5\u8bbf\u95ee\u5171\u4eab\u54c8\u5e0c\u8868\u4e2d\u7684\u5206\u533a\uff0c\u4f46\u65e0\u6cd5\u7ee7\u7eed\uff0c\u56e0\u4e3a\u8be5\u5206\u533a\u5df2\u88ab\u9501\u5b9a\u3002</p>","tags":["PostgreSQL","Locks"]},{"location":"2025/05/23/dealing-with-lwlock-lockmanager-wait-events-in-aurora-postgres/#lwlocklockmanager","title":"\u89e6\u53d1 LWLock:LockManager \u7b49\u5f85\u4e8b\u4ef6","text":"<p>\u73b0\u5728\u6211\u4eec\u5df2\u7ecf\u5bf9\u9501\u7ba1\u7406\u5668\u548c\u5feb\u901f\u8def\u5f84\u9501\u6709\u4e86\u57fa\u672c\u7684\u4e86\u89e3\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u505a\u4e00\u4e2a\u5b9e\u9a8c\u3002\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u573a\u666f\uff0c\u6765\u89c2\u5bdf <code>LWLock:LockManager</code> \u7b49\u5f85\u4e8b\u4ef6\u7684\u5b9e\u9645\u8fd0\u4f5c\u3002\u5bf9\u4e8e\u8fd9\u79cd\u60c5\u51b5\uff0c\u6211\u521b\u5efa\u4e86\u4e00\u4e2a Aurora Postgres 15 \u5b9e\u4f8b\u548c\u4e00\u4e2a\u5145\u5f53\u6570\u636e\u5e93\u5ba2\u6237\u7aef\u7684 EC2 \u5b9e\u4f8b\u3002\u6211\u4f7f\u7528\u4e86\u76f8\u5f53\u5927\u7684\u5b9e\u4f8b\uff08EC2 \u5b9e\u4f8b\u4e3a c5.12xlarge\uff0cAurora Postgres \u5b9e\u4f8b\u4e3a db.r6i.4xlarge\uff09\u3002\u6211\u7684\u76ee\u6807\u662f\u8fd0\u884c\u8bb8\u591a\u5e76\u53d1\u7ebf\u7a0b\u5e76\u5e76\u884c\u5904\u7406\u5927\u91cf\u6570\u636e\u5e93\u67e5\u8be2\u3002\u7531\u4e8e <code>LWLock:LockManager</code> \u7b49\u5f85\u4e8b\u4ef6\u662f\u9501\u7ba1\u7406\u5668\u4e89\u7528\u7684\u6807\u5fd7\uff0c\u6211\u5e0c\u671b\u9ad8\u5e76\u884c\u5ea6\u53ef\u4ee5\u66f4\u5bb9\u6613\u5730\u91cd\u73b0\u8be5\u95ee\u9898\u3002</p> <p></p> <p>\u6d4b\u8bd5\u573a\u666f\u8bbe\u7f6e\u3002\u8fd0\u884c <code>pgbench</code> \u7684 EC2 \u5b9e\u4f8b\u5c06\u9488\u5bf9 Aurora Postgres \u6570\u636e\u5e93\u6267\u884c SQL \u67e5\u8be2\u3002</p> <p>\u8be5\u6570\u636e\u5e93\u5305\u542b 20 \u4e2a\u8868\uff0c\u5206\u522b\u547d\u540d\u4e3a <code>test1</code>\u3001<code>test2</code>\uff0c\u4f9d\u6b64\u7c7b\u63a8\uff0c\u76f4\u81f3 <code>test20</code>\u3002\u5c31\u672c\u6d4b\u8bd5\u800c\u8a00\uff0c\u8868\u7ed3\u6784\u5e76\u4e0d\u91cd\u8981\u3002\u6240\u6709\u8868\u5747\u4e3a\u7a7a\u3002</p> <p>\u6211\u4eec\u5c06\u4f7f\u7528 <code>pgbench</code> \u8fd0\u884c\u4ee5\u4e0b SQL \u811a\u672c\u3002</p> <pre><code>begin;\nselect * from test1;\nselect * from test2;\n...\nselect * from test20;\ncommit;\n</code></pre> <p>\u5b83\u6267\u884c\u4e00\u4e2a\u4e8b\u52a1\uff0c\u5728\u6b64\u671f\u95f4\u6240\u6709\u8868\u90fd\u4f1a\u88ab\u9009\u4e2d\u3002\u6211\u4eec\u4e4b\u524d\u4e86\u89e3\u5230\uff0c\u6bcf\u4e2a\u4e8b\u52a1\u6709 16 \u4e2a\u5feb\u901f\u8def\u5f84\u9501\u3002\u83b7\u53d6\u8d85\u8fc7 16 \u4e2a\u9501\u5e94\u8be5\u4f1a\u5bfc\u81f4\u5fc5\u987b\u901a\u8fc7\u9501\u7ba1\u7406\u5668\u83b7\u53d6\u4e00\u4e9b\u9501\u7684\u60c5\u51b5\u3002</p> <p>\u6d4b\u8bd5\u8fc7\u7a0b\u4e2d\uff0c<code>pgbench</code> \u4f1a\u8fd0\u884c 240 \u79d2\uff0c\u521b\u5efa 40 \u4e2a\u7ebf\u7a0b\uff0c800 \u4e2a\u6570\u636e\u5e93\u8fde\u63a5\uff0c\u8fd9\u4e9b\u7ebf\u7a0b\u4f1a\u53cd\u590d\u6267\u884c SQL \u811a\u672c\uff0c\u6a21\u62df\u9ad8\u5e76\u53d1\u7684\u8d1f\u8f7d\u3002</p> <pre><code>pgbench -f test.sql -T 240 -c 800 -j 40 -U postgres \\\n  -h database-2-instance-1.cky0tsfnwec5.eu-central-1.rds.amazonaws.com postgres\n</code></pre> <p>\u5b9e\u9a8c\u7ed3\u675f\u540e\u67e5\u770b RDS Performance Insights\uff0c\u6211\u4eec\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u5230 <code>LWLock:LockManager</code> \u7b49\u5f85\u4e8b\u4ef6\u7684\u5b58\u5728\u3002</p> <p></p> <p>LWLock:LockManager \u7b49\u5f85\u4e8b\u4ef6\u4ee5\u7d2b\u8272\u8868\u793a\u3002\u6700\u5927 vCPU \u6570\u91cf\u4e3a 16\u3002</p> <p>\u4e3a\u4e86\u786e\u4fdd\u6211\u4eec\u5bf9\u5feb\u901f\u8def\u5f84\u9501\u5b9a\u548c\u9501\u7ba1\u7406\u5668\u7684\u7406\u89e3\u662f\u6b63\u786e\u7684\uff0c\u8ba9\u6211\u4eec\u5c06\u6d4b\u8bd5\u811a\u672c\u4e2d\u7684\u9009\u62e9\u8bed\u53e5\u7684\u6570\u91cf\u51cf\u5c11\u5230 16 \u4e2a\u4ee5\u4e0b\u3002</p> <pre><code>begin;\nselect * from test1;\nselect * from test2;\n...\nselect * from test14;\ncommit;\n</code></pre> <p>\u8fd9\u5e94\u8be5\u53ef\u4ee5\u786e\u4fdd\u59cb\u7ec8\u4f7f\u7528\u5feb\u901f\u8def\u5f84\u9501\u5b9a\u3002\u91cd\u65b0\u8fd0\u884c\u6d4b\u8bd5\u65f6\uff0c\u6211\u671f\u671b <code>LWLock:LockManager</code> \u7b49\u5f85\u4e8b\u4ef6\u5e94\u8be5\u4f1a\u6d88\u5931\uff0c\u56e0\u4e3a\u4e0d\u518d\u4f7f\u7528\u9501\u7ba1\u7406\u5668\u6765\u8ddf\u8e2a\u9501\u83b7\u53d6\u3002</p> <p></p> <p>\u4ec5\u4f7f\u7528\u5feb\u901f\u8def\u5f84\u9501\u5b9a\u65f6\u4e0d\u518d\u6709 LWLockManager \u7b49\u5f85\u4e8b\u4ef6</p> <p>\u6b63\u5982\u9884\u671f\u7684\u90a3\u6837\uff0c<code>LWLock:LockManager</code> \u7b49\u5f85\u4e8b\u4ef6\u5df2\u7ecf\u6d88\u5931\u3002</p>","tags":["PostgreSQL","Locks"]},{"location":"2025/05/23/dealing-with-lwlock-lockmanager-wait-events-in-aurora-postgres/#_5","title":"\u8fd9\u5728\u751f\u4ea7\u7cfb\u7edf\u4e2d\u5982\u4f55\u53d1\u751f","text":"<p>\u5982\u679c\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u7a81\u7136\u9047\u5230 <code>LWLock:LockManager</code> \u7b49\u5f85\u4e8b\u4ef6\uff0c\u5bfc\u81f4\u5176\u901f\u5ea6\u53d8\u6162\uff0c\u90a3\u4e48\u6700\u597d\u68c0\u67e5\u4e00\u4e0b\u5e94\u7528\u7a0b\u5e8f\u4ee3\u7801\u4e2d\u7684\u6700\u8fd1\u66f4\u6539\u3002\u4e5f\u8bb8\u7ecf\u5e38\u6267\u884c\u7684\u4ee3\u7801\u8def\u5f84\u5df2\u88ab\u4fee\u6539\uff0c\u5bfc\u81f4\u5b83\u83b7\u53d6\u989d\u5916\u7684\u9501\u3002\u867d\u7136\u4e00\u4e9b\u989d\u5916\u7684\u9501\u4e4d\u4e00\u542c\u53ef\u80fd\u5e76\u4e0d\u5371\u9669\uff0c\u4f46\u5982\u679c\u9891\u7e41\u6267\u884c\u7684\u4e8b\u52a1\u5f00\u59cb\u83b7\u53d6\u66f4\u591a\u975e\u5feb\u901f\u8def\u5f84\u9501\uff0c\u8fd9\u53ef\u80fd\u4f1a\u7ed9\u9501\u7ba1\u7406\u5668\u5e26\u6765\u538b\u529b\u5e76\u4ea7\u751f\u4e89\u7528\u3002</p> <p>PostgreSQL \u4e2d\u4e00\u4e2a\u5e38\u89c1\u7684\u7b56\u7565\u662f\u6309\u65f6\u95f4\u6bb5\u5bf9\u5927\u578b\u8868\u8fdb\u884c\u5206\u533a\u3002\u4f8b\u5982\uff0c<code>orders</code> \u8868\u53ef\u80fd\u4f1a\u6309\u6708\u7ec6\u5206\u3002PostgreSQL \u4e2d\u7684\u5206\u533a\u672c\u8d28\u4e0a\u662f\u4e00\u4e2a\u5177\u6709\u81ea\u5df1\u7d22\u5f15\u7684\u5355\u72ec\u8868\u3002\u56e0\u6b64\uff0c\u5fc5\u987b\u626b\u63cf\u591a\u4e2a\u5206\u533a\u7684\u67e5\u8be2\u4e5f\u5c06\u83b7\u53d6\u66f4\u591a\u9501\uff0c\u8fd9\u53ef\u80fd\u4f1a\u5bfc\u81f4 <code>LockManager</code> \u7b49\u5f85\u4e8b\u4ef6\u3002</p> <p><code>LockManager</code> \u7b49\u5f85\u4e8b\u4ef6\u4e5f\u53ef\u80fd\u7531\u6d41\u91cf\u7a81\u7136\u6fc0\u589e\u89e6\u53d1\u3002\u5e94\u7528\u7a0b\u5e8f\u53ef\u80fd\u62e5\u6709\u7a33\u5b9a\u7684\u975e\u5feb\u901f\u8def\u5f84\u9501\u83b7\u53d6\u57fa\u7ebf\uff0c\u8fd9\u4e0d\u4f1a\u5bfc\u81f4\u4efb\u4f55\u95ee\u9898\u3002\u4f46\u662f\u5f53\u4f20\u5165\u6d41\u91cf\u589e\u52a0\u65f6\uff0c<code>LockManager</code> \u53ef\u80fd\u4f1a\u7a81\u7136\u8fbe\u5230\u6781\u9650\uff0c\u5e76\u4e14\u5f00\u59cb\u51fa\u73b0\u660e\u663e\u7684\u7b49\u5f85\u4e8b\u4ef6\u3002</p>","tags":["PostgreSQL","Locks"]},{"location":"2025/05/23/dealing-with-lwlock-lockmanager-wait-events-in-aurora-postgres/#lockmanager","title":"\u5982\u4f55\u5904\u7406 LockManager \u7b49\u5f85\u4e8b\u4ef6","text":"<p>\u6ca1\u6709\u4e07\u80fd\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u56e0\u4e3a\u6bcf\u4e2a\u5de5\u4f5c\u8d1f\u8f7d\u90fd\u662f\u72ec\u4e00\u65e0\u4e8c\u7684\u3002\u4e0d\u8fc7\uff0c\u4ee5\u4e0b\u662f\u4e00\u4e9b\u53ef\u4ee5\u8003\u8651\u7684\u7b56\u7565\uff1a</p> <ul> <li>\u63a7\u5236\u4e8b\u52a1\u8303\u56f4\uff1a\u968f\u7740\u5e94\u7528\u7a0b\u5e8f\u7684\u589e\u957f\uff0c\u5355\u4e2a\u4e8b\u52a1\u4e2d\u6267\u884c\u7684\u5de5\u4f5c\u91cf\u901a\u5e38\u4f1a\u589e\u52a0\u3002\u8bf7\u8003\u8651\u662f\u5426\u53ef\u4ee5\u7b80\u5316\u67d0\u4e9b\u4e8b\u52a1\u6216\u7f29\u5c0f\u5176\u8303\u56f4\uff0c\u4ee5\u6700\u5927\u9650\u5ea6\u5730\u51cf\u5c11\u9501\u4e89\u7528\u3002</li> <li>\u76d1\u63a7 ORM \u884c\u4e3a\uff1a\u5bf9\u8c61\u5173\u7cfb\u6620\u5c04 (ORM) \u5e93\u53ef\u80fd\u4f1a\u901a\u8fc7\u4e0d\u5fc5\u8981\u5730\u8fde\u63a5\u591a\u4e2a\u8868\u6765\u8fc7\u5ea6\u83b7\u53d6\u6570\u636e\u3002\u8bf7\u68c0\u67e5 ORM \u751f\u6210\u7684\u67e5\u8be2\u6a21\u5f0f\uff0c\u5e76\u5c3d\u53ef\u80fd\u8fdb\u884c\u4f18\u5316\u3002</li> <li>\u4f18\u5316\u8868\u5206\u533a\uff1a\u5982\u679c\u4f7f\u7528\u8868\u5206\u533a\uff0c\u8bf7\u8c28\u614e\u7ba1\u7406\u5206\u533a\u7684\u5927\u5c0f\u548c\u6570\u91cf\u3002\u786e\u4fdd\u67e5\u8be2\u4f7f\u7528\u5206\u533a\u952e\uff0c\u4ee5\u907f\u514d\u626b\u63cf\u591a\u4e2a\u5206\u533a\u3002</li> <li>\u5b9e\u73b0\u5ba2\u6237\u7aef\u7f13\u5b58\uff1a\u5728\u5ba2\u6237\u7aef\u7f13\u5b58\u67e5\u8be2\u7ed3\u679c\u53ef\u4ee5\u51cf\u5c11\u91cd\u590d\u6570\u636e\u5e93\u67e5\u8be2\u548c\u9501\u83b7\u53d6\u7684\u9700\u8981\uff0c\u4ece\u800c\u964d\u4f4e <code>LockManager</code> \u7b49\u5f85\u4e8b\u4ef6\u7684\u53ef\u80fd\u6027\u3002</li> <li>\u8bfb\u5199\u5206\u79bb\uff1a\u5728\u591a\u4e2a\u53ea\u8bfb\u5b9e\u4f8b\u4e4b\u95f4\u5206\u914d\u67e5\u8be2\u8d1f\u8f7d\u53ef\u51cf\u5c11\u6bcf\u4e2a\u5b9e\u4f8b\u7684 <code>LockManager</code> \u8d1f\u8f7d\u3002</li> <li>\u68c0\u67e5\u7d22\u5f15\uff1a\u5b9a\u671f\u68c0\u67e5\u60a8\u7684\u7d22\u5f15\u5e76\u5220\u9664\u4efb\u4f55\u672a\u4f7f\u7528\u7684\u7d22\u5f15\uff0c\u4ee5\u51cf\u5c11\u4e0d\u5fc5\u8981\u7684\u9501\u5b9a\u5f00\u9500\u3002</li> </ul> <p>\u8bd1\u8005\u6ce8</p> <p>\u5728\u5373\u5c06\u53d1\u5e03\u7684 PostgreSQL 18 \u4e2d\u5df2\u7ecf\u5bf9\u8fd9\u90e8\u5206\u8fdb\u884c\u4e86\u4f18\u5316\uff0c\u5176\u6838\u578b\u90e8\u5206\u5728 c4d5cb71d\u3002</p> <p>\u5b83\u901a\u8fc7\u5c06\u56fa\u5b9a\u5927\u5c0f\u7684\u5feb\u901f\u8def\u5f84\u9501\u6570\u7ec4\u66ff\u6362\u4e3a\u52a8\u6001\u5927\u5c0f\u7684\u6570\u7ec4\uff0c\u4f18\u5316 PostgreSQL \u5728\u9ad8\u9501\u9700\u6c42\u573a\u666f\u4e0b\u7684\u6027\u80fd\uff0c\u51cf\u5c11\u5bf9\u5171\u4eab\u9501\u8868\u7684\u4f9d\u8d56\uff0c\u4ece\u800c\u964d\u4f4e\u9501\u7ade\u4e89\u548c\u6027\u80fd\u5f00\u9500\u3002\u8be5\u63d0\u4ea4\u79fb\u9664\u786c\u7f16\u7801\u7684 16 \u4e2a\u9501\u9650\u5236\uff0c\u6539\u4e3a\u5728\u6570\u636e\u5e93\u542f\u52a8\u65f6\u6839\u636e <code>max_locks_per_transaction</code> \u53c2\u6570\u52a8\u6001\u8ba1\u7b97\u5feb\u901f\u8def\u5f84\u9501\u6570\u7ec4\u7684\u5927\u5c0f\u3002\u65b0\u673a\u5236\u5141\u8bb8\u5feb\u901f\u8def\u5f84\u9501\u7684\u6570\u91cf\u8fdc\u8d85\u539f\u6765\u7684 16 \u4e2a\uff08\u4e0a\u9650\u4e3a 1024 \u4e2a\u9501\u7ec4\uff0c\u5373 16k \u4e2a\u9501\uff09\uff0c\u4ece\u800c\u652f\u6301\u9700\u8981\u5927\u91cf\u9501\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5982\u590d\u6742\u67e5\u8be2\u6216\u5206\u533a\u8868\u64cd\u4f5c\u3002</p> <p>\u4f5c\u8005\uff1aIndrek Ots \u539f\u6587\uff1ahttps://blog.indrek.io/articles/dealing-with-lwlock-lockmanager-wait-events-in-aurora-postgres/</p>","tags":["PostgreSQL","Locks"]},{"location":"2025/01/24/group-by-fixing-optimizer-estimates/","title":"GROUP BY: \u4fee\u590d\u4f18\u5316\u5668\u4f30\u8ba1\u503c","text":"<p>\u5982\u679c\u60a8\u4f7f\u7528 PostgreSQL \u8fdb\u884c\u5206\u6790\u6216\u5927\u89c4\u6a21\u805a\u5408\uff0c\u60a8\u53ef\u80fd\u4f1a\u6ce8\u610f\u5230\u89c4\u5212\u5668\u5076\u5c14\u4f1a\u5bf9\u884c\u6570\u505a\u51fa\u9519\u8bef\u7684\u4f30\u8ba1\u3002\u867d\u7136\u8fd9\u5bf9\u4e8e\u5c0f\u89c4\u6a21\u7684\u805a\u5408\u6765\u8bf4\u4e0d\u662f\u95ee\u9898\uff0c\u4f46\u5bf9\u4e8e\u5177\u6709\u8bb8\u591a\u4e0d\u540c\u7ef4\u5ea6\u7684\u5927\u89c4\u6a21\u805a\u5408\u6765\u8bf4\uff0c\u8fd9\u786e\u5b9e\u662f\u4e2a\u95ee\u9898\u3002</p> <p>\u7b80\u800c\u8a00\u4e4b\uff1a<code>GROUP BY</code> \u8bed\u53e5\u5305\u542b\u7684\u5217\u8d8a\u591a\uff0c\u4f18\u5316\u5668\u9ad8\u4f30\u884c\u6570\u7684\u53ef\u80fd\u6027\u5c31\u8d8a\u5927\u3002</p> <p>\u672c\u6587\u89e3\u91ca\u4e86\u5982\u4f55\u5728 PostgreSQL \u4e2d\u5904\u7406\u8fd9\u4e2a\u95ee\u9898\u3002</p>"},{"location":"2025/01/24/group-by-fixing-optimizer-estimates/#postgresql","title":"\u5728 PostgreSQL \u4e2d\u586b\u5145\u793a\u4f8b\u6570\u636e","text":"<p>\u5bf9\u4e8e\u8fd9\u4e2a\u4f8b\u5b50\uff0c\u6211\u521b\u5efa\u4e86\u4e00\u4e2a\u5305\u542b\u51e0\u4e2a\u6574\u6570\u503c\u7684\u5c0f\u8868\uff1a</p> <pre><code>CREATE TABLE t_sample (\n    a   int, \n    b   int, \n    c   int, \n    d   int, \n    e   int, \n    f   int     DEFAULT random()*100000\n);\n</code></pre> <p>\u6b63\u5982\u6211\u4eec\u6240\u770b\u5230\u7684\uff0c\u6211\u4eec\u6709 5 \u4e2a\u6574\u6570\u5217\uff08<code>a-e</code>\uff09\u4ee5\u53ca\u4e00\u4e2a\u5305\u542b\u9ed8\u8ba4\u503c\u7684\u5217\u3002\u5411\u8be5\u8868\u6dfb\u52a0 1000 \u4e07\u884c\u6570\u636e\u7684\u6700\u7b80\u5355\u65b9\u6cd5\u662f\u4f7f\u7528 <code>generate_series</code> \u51fd\u6570\uff1a</p> <pre><code>INSERT INTO t_sample \n    SELECT x % 10, x % 11, x % 12, x % 13, x % 14 \n    FROM generate_series(1, 10000000) AS x;\n</code></pre> <p>\u8fd9\u91cc\u7684\u5173\u952e\u70b9\u662f\u6211\u4eec\u7684\u6570\u636e\u5177\u6709\u4e00\u4e9b\u6709\u8da3\u7684\u5c5e\u6027\u3002\u6bcf\u5217\u53ea\u80fd\u5305\u542b\u4e00\u7ec4\u56fa\u5b9a\u7684\u503c\uff08\u7b2c\u4e00\u5217\u6709 10 \u4e2a\u4e0d\u540c\u7684\u503c\uff0c\u7b2c\u4e8c\u5217\u6709 11 \u4e2a\u4e0d\u540c\u7684\u503c\uff0c\u4f9d\u6b64\u7c7b\u63a8\uff09\u3002</p> <p>\u4e00\u65e6\u6570\u636e\u52a0\u8f7d\u5b8c\u6210\uff0c\u6211\u5c06\u4f7f\u7528 <code>ANALYZE</code> \u547d\u4ee4\u6765\u521b\u5efa\u65b0\u7684\u4f18\u5316\u5668\u7edf\u8ba1\u6570\u636e\uff1a</p> <pre><code>ANALYZE;\n</code></pre>"},{"location":"2025/01/24/group-by-fixing-optimizer-estimates/#_1","title":"\u4f18\u5316\u5668\u7edf\u8ba1\u662f\u4ec0\u4e48\u610f\u601d\uff1f","text":"<p>PostgreSQL \u4f18\u5316\u5668\u5982\u4f55\u5de5\u4f5c\uff1f\u6700\u6839\u672c\u7684\u601d\u60f3\u662f\u5217\u7edf\u8ba1\u3002\u5bf9\u4e8e\u6bcf\u4e00\u5217\uff0cPostgreSQL \u90fd\u4fdd\u5b58\u91cd\u8981\u4fe1\u606f\uff0c\u4f8b\u5982\u4e0d\u540c\u503c\u7684\u6570\u91cf\u3001\u6700\u5e38\u89c1\u7684\u503c\u3001\u76f4\u65b9\u56fe\u7b49\u7b49\uff1a</p> <p><pre><code>SELECT\n    tablename, attname, \n    n_distinct, most_common_vals \nFROM\n    pg_stats \nWHERE\n    tablename = 't_sample'\n    AND attname IN ('a', 'b');\n</code></pre> \u8f93\u51fa<pre><code> tablename | attname | n_distinct |     most_common_vals     \n-----------+---------+------------+--------------------------\n t_sample  | b       |         11 | {9,6,7,5,0,8,10,1,4,3,2}\n t_sample  | a       |         10 | {9,0,4,5,8,1,2,3,6,7}\n(2 rows)\n</code></pre></p> <p>\u8bf7\u6ce8\u610f\uff0c\u6b64\u4fe1\u606f\u9488\u5bf9\u6bcf\u4e00\u5217\u8fdb\u884c\u5b58\u50a8\u3002\u5728\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0cautovacuum \u5c06\u786e\u4fdd\u7edf\u8ba1\u4fe1\u606f\u4fdd\u6301\u6700\u65b0\u3002</p>"},{"location":"2025/01/24/group-by-fixing-optimizer-estimates/#_2","title":"\u5f53\u5217\u76f8\u4e92\u4f9d\u8d56\u65f6","text":"<p>\u4ee5\u4e0b\u67e5\u8be2\u975e\u5e38\u5e38\u89c1\uff1a\u6211\u4eec\u60f3\u8981\u786e\u5b9a\u6bcf\u4e2a\u7ec4\u4e2d\u6709\u591a\u5c11\u4e2a\u6761\u76ee\u3002\u5173\u952e\u7ec6\u8282\u662f <code>GROUP BY</code> \u5b50\u53e5\u5305\u542b\u4e94\u4e2a\u7ef4\u5ea6\u3002</p> <p>\u4e3a\u4e86\u4f7f\u793a\u4f8b\u66f4\u5bb9\u6613\u7406\u89e3\uff0c\u6211\u4eec\u9996\u5148\u7981\u7528 PostgreSQL \u4e2d\u7684\u5e76\u884c\u67e5\u8be2\u3002\u8fd9\u4e0d\u662f\u9488\u5bf9 PostgreSQL \u7684\u4e00\u822c\u6027\u80fd\u5efa\u8bae\uff0c\u800c\u4ec5\u4ec5\u662f\u4e3a\u4e86\u7b80\u5316\u6267\u884c\u8ba1\u5212\uff1a</p> <p><pre><code>SET max_parallel_workers_per_gather TO 0;\nexplain analyze\n    SELECT\n        a, b, c, d, e, count(*) \n    FROM\n        t_sample \n    GROUP BY\n        1, 2, 3, 4, 5;\n</code></pre> \u8f93\u51fa<pre><code>                               QUERY PLAN\n--------------------------------------------------------------------------\n HashAggregate  (cost=982455.57..1102046.81 rows=240240 width=28) \n    (actual time=1638.327..1784.077 rows=60060 loops=1)\n   Group Key: a, b, c, d, e\n   Planned Partitions: 4  Batches: 5  \n    Memory Usage: 8241kB  Disk Usage: 53072kB\n   -&gt;  Seq Scan on t_sample  (cost=0.00..163696.15 rows=10000115 width=20) \n    (actual time=0.051..335.137 rows=10000000 loops=1)\n Planning Time: 0.167 ms\n Execution Time: 1787.892 ms\n(6 rows)\n</code></pre></p> <p>\u8fd9\u91cc\u6700\u5f15\u4eba\u6ce8\u76ee\u7684\u662f\u4ec0\u4e48\uff1f\u5f52\u7ed3\u4e3a\u4e24\u4e2a\u6570\u5b57\uff1a<code>240240</code> \u548c <code>60060</code>\u3002\u7b2c\u4e00\u4e2a\u6570\u5b57\u8868\u793a\u4f18\u5316\u5668\u7684\u4f30\u8ba1\u2014\u2014\u5b83\u5047\u8bbe\u5c06\u8fd4\u56de\u8d85\u8fc7 200,000 \u884c\u3002\u4f46\u5b9e\u9645\u7ed3\u679c\u53ea\u6709 60060 \u884c\u3002\u4e3a\u4ec0\u4e48\u4f1a\u8fd9\u6837\uff1f\u539f\u56e0\u662f <code>a</code>\u3001<code>b</code>\u3001<code>c</code>\u3001<code>d</code>\u3001<code>e</code> \u7684\u67d0\u4e9b\u7ec4\u5408\u6839\u672c\u4e0d\u5b58\u5728\u3002\u7136\u800c\uff0cPostgreSQL \u5e76\u4e0d\u77e5\u9053\u8fd9\u4e00\u70b9\u3002\u8bf7\u8bb0\u4f4f\uff0c\u4f18\u5316\u5668\u7ef4\u62a4\u6709\u5173\u6bcf\u5217\u7684\u7edf\u8ba1\u4fe1\u606f - \u5b83\u5e76\u4e0d\u77e5\u9053\u6240\u6709\u8fd9\u4e9b\u5b9e\u9645\u6392\u5217\u3002</p> <p>PostgreSQL \u5982\u4f55\u5f97\u51fa <code>240240</code>\uff1f\u8003\u8651\u4ee5\u4e0b\u8ba1\u7b97\uff1a</p> <p><pre><code>SELECT 10 * 11 * 12 * 13 * 14;\n</code></pre> \u8f93\u51fa<pre><code> ?column? \n----------\n   240240\n(1 row)\n</code></pre></p> <p>PostgreSQL \u53ea\u662f\u7b80\u5355\u5730\u5c06\u6bcf\u4e2a\u7ef4\u5ea6\u4e2d\u7684\u5143\u7d20\u6570\u91cf\u76f8\u4e58\uff0c\u8fd9\u4f1a\u5bfc\u81f4\u9ad8\u4f30\uff08\u8fd9\u901a\u5e38\u6bd4\u4f4e\u4f30\u7684\u95ee\u9898\u66f4\u5c0f\uff09\u3002</p>"},{"location":"2025/01/24/group-by-fixing-optimizer-estimates/#_3","title":"\u521b\u5efa\u7edf\u8ba1\u6570\u636e\uff1a\u4fee\u6b63\u4f30\u8ba1\u503c","text":"<p>\u89e3\u51b3\u8fd9\u4e9b\u4f30\u8ba1\u95ee\u9898\u7684\u65b9\u6cd5\u662f\u4f7f\u7528\u6269\u5c55\u7edf\u8ba1\u4fe1\u606f\u3002\u4ee5\u4e0b\u547d\u4ee4\u53ef\u7528\u4e8e\u89e3\u51b3\u8be5\u95ee\u9898\uff1a</p> <p><pre><code>blog=# \\h CREATE STATISTICS\n</code></pre> \u8f93\u51fa<pre><code>Command:     CREATE STATISTICS\nDescription: define extended statistics\nSyntax:\nCREATE STATISTICS [ [ IF NOT EXISTS ] statistics_name ]\n    ON ( expression )\n    FROM table_name\n\nCREATE STATISTICS [ [ IF NOT EXISTS ] statistics_name ]\n    [ ( statistics_kind [, ... ] ) ]\n    ON { column_name | ( expression ) }, { column_name | ( expression ) } [, ...]\n    FROM table_name\n\nURL: https://www.postgresql.org/docs/17/sql-createstatistics.html\n</code></pre></p> <p>\u5728\u6211\u4eec\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u9700\u8981 <code>CREATE STATISTICS</code> \u7684 <code>ndistinct</code> \u9009\u9879\uff1a</p> <pre><code>CREATE STATISTICS mystats (ndistinct)\nON a, b, c, d, e\nFROM t_sample;\nANALYZE;\n</code></pre> <p>\u8fd9\u5c06\u521b\u5efa\u6392\u5217\u7684\u7edf\u8ba1\u4fe1\u606f\uff0c\u800c\u4e0d\u4ec5\u4ec5\u662f\u5355\u4e2a\u503c\u548c\u5217\u7684\u7edf\u8ba1\u4fe1\u606f\u3002\u5f53\u6211\u4eec\u518d\u6b21\u8fd0\u884c\u67e5\u8be2\u65f6\uff0c\u6211\u4eec\u5c06\u770b\u5230\u4f30\u8ba1\u503c\u6709\u4e86\u663e\u7740\u6539\u5584\uff1a</p> <p><pre><code>explain analyze\n    SELECT\n        a, b, c, d, e, count(*) \n    FROM\n        t_sample \n    GROUP BY\n        1, 2, 3, 4, 5;\n</code></pre> \u8f93\u51fa<pre><code>                                QUERY PLAN\n----------------------------------------------------------------------------\n HashAggregate  (cost=313697.88..314288.34 rows=59046 width=28) \n    (actual time=1587.681..1733.595 rows=60060 loops=1)\n   Group Key: a, b, c, d, e\n   Batches: 5  Memory Usage: 8241kB  Disk Usage: 53072kB\n   -&gt;  Seq Scan on t_sample  (cost=0.00..163696.15 rows=10000115 width=20) \n    (actual time=0.060..309.344 rows=10000000 loops=1)\n Planning Time: 0.623 ms\n Execution Time: 1737.495 ms\n(6 rows)\n</code></pre></p> <p>\u54c7\uff0c\u8fd9\u592a\u63a5\u8fd1\u4e86\uff1a<code>59046</code> \u4e0e <code>60060</code> \u2014\u2014 PostgreSQL \u662f\u6b63\u786e\u7684\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5b83\u4e0d\u4f1a\u5f71\u54cd\u6027\u80fd\u3002\u7136\u800c\uff0c\u5728\u73b0\u5b9e\u4e16\u754c\u4e2d\uff0c\u4fee\u590d\u7edf\u8ba1\u6570\u636e\u53ef\u80fd\u4f1a\u5bf9\u901f\u5ea6\u548c\u6574\u4f53\u6570\u636e\u5e93\u6548\u7387\u4ea7\u751f\u5de8\u5927\u5f71\u54cd\u3002</p> <p>\u95ee\u9898\u53ef\u80fd\u81ea\u7136\u800c\u7136\u5730\u51fa\u73b0\uff1a\u4f18\u5316\u5668\u4f7f\u7528\u4ec0\u4e48\u4fe1\u606f\u6765\u5f97\u51fa\u5982\u6b64\u51c6\u786e\u7684\u4f30\u8ba1\uff1f\u7b54\u6848\u5982\u4e0b\uff1a</p> <pre><code>blog=# \\x\nExpanded display is on.\nblog=# SELECT * FROM pg_stats_ext;\n-[ RECORD 1 ]----------+----------------------------------------------------------------\nschemaname             | public\ntablename              | t_sample\nstatistics_schemaname  | public\nstatistics_name        | mystats\nstatistics_owner       | hs\nattnames               | {a,b,c,d,e}\nexprs                  | \nkinds                  | {d}\ninherited              | f\nn_distinct             | {\"1, 2\": 110, \"1, 3\": 60, \"1, 4\": 130, \"1, 5\": 70, \n              \"2, 3\": 132, \"2, 4\": 143, \"2, 5\": 154, \"3, 4\": 156, \n              \"3, 5\": 84, \"4, 5\": 182, \"1, 2, 3\": 660, \"1, 2, 4\": 1430, \n              \"1, 2, 5\": 770, \"1, 3, 4\": 780, \"1, 3, 5\": 420, \n              \"1, 4, 5\": 910, \"2, 3, 4\": 1716, \"2, 3, 5\": 924, \n              \"2, 4, 5\": 2002, \"3, 4, 5\": 1092, \"1, 2, 3, 4\": 8576, \n              \"1, 2, 3, 5\": 4621, \"1, 2, 4, 5\": 10026, \"1, 3, 4, 5\": 5457,  \n              \"2, 3, 4, 5\": 11949, \"1, 2, 3, 4, 5\": 59046}\ndependencies           | \nmost_common_vals       | \nmost_common_val_nulls  | \nmost_common_freqs      | \nmost_common_base_freqs | \n</code></pre> <p><code>pg_stats_ext</code> \u89c6\u56fe\u544a\u8bc9\u6211\u4eec PostgreSQL \u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u5982\u4f55\u5904\u7406 <code>n_distinct</code> \u5217\u3002</p>"},{"location":"2025/01/24/group-by-fixing-optimizer-estimates/#_4","title":"\u6700\u540e ...","text":"<p>\u4f18\u5316\u67e5\u8be2\u548c\u4f18\u5316\u5668\u901a\u5e38\u90fd\u662f\u503c\u5f97\u63a2\u7d22\u7684\u6709\u8da3\u8bdd\u9898\u3002\u5982\u679c\u60a8\u60f3\u4e86\u89e3\u66f4\u591a\u5e76\u6df1\u5165\u6316\u6398\uff0c\u8bf7\u8003\u8651\u9605\u8bfb\u6211\u5173\u4e8e PostgreSQL \u67e5\u8be2\u4f18\u5316\u5668\u5de5\u4f5c\u539f\u7406\u7684\u6587\u7ae0\u3002</p> <p>\u4f5c\u8005\uff1aHans-J\u00fcrgen Sch\u00f6nig \u539f\u6587\uff1ahttps://www.cybertec-postgresql.com/en/group-by-fixing-optimizer-estimates/</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/","title":"PostgreSQL \u65e5\u5fd7\uff1a\u60a8\u9700\u8981\u77e5\u9053\u7684\u4e00\u5207","text":"<p>PostgreSQL \u65e5\u5fd7\u662f\u89e3\u51b3\u95ee\u9898\u3001\u8ddf\u8e2a\u6027\u80fd\u548c\u5ba1\u8ba1\u6570\u636e\u5e93\u6d3b\u52a8\u7684\u5b9d\u8d35\u8d44\u6e90\u3002\u5728\u5c06\u5e94\u7528\u7a0b\u5e8f\u90e8\u7f72\u5230\u751f\u4ea7\u73af\u5883\u4e4b\u524d\uff0c\u6709\u5fc5\u8981\u5bf9\u65e5\u5fd7\u914d\u7f6e\u8fdb\u884c\u5fae\u8c03\uff0c\u4ee5\u786e\u4fdd\u8bb0\u5f55\u8db3\u591f\u591a\u7684\u4fe1\u606f\u6765\u8bca\u65ad\u95ee\u9898\uff0c\u540c\u65f6\u4e0d\u4f1a\u51cf\u6162\u57fa\u672c\u6570\u636e\u5e93\u64cd\u4f5c\u7684\u901f\u5ea6\u3002</p> <p>\u4e3a\u4e86\u5b9e\u73b0\u7406\u60f3\u7684\u5e73\u8861\uff0c\u6df1\u5165\u4e86\u89e3\u5404\u79cd PostgreSQL \u65e5\u5fd7\u53c2\u6570\u662f\u81f3\u5173\u91cd\u8981\u7684\u3002\u6709\u4e86\u8fd9\u4e9b\u77e5\u8bc6\uff0c\u518d\u52a0\u4e0a\u5bf9\u65e5\u5fd7\u4f7f\u7528\u65b9\u5f0f\u7684\u7406\u89e3\uff0c\u60a8\u5c31\u53ef\u4ee5\u5f88\u597d\u5730\u5b9a\u5236\u65e5\u5fd7\u8bbe\u7f6e\uff0c\u4ee5\u7cbe\u786e\u6ee1\u8db3\u60a8\u7684\u76d1\u63a7\u548c\u6545\u969c\u5206\u6790\u9700\u6c42\u3002</p> <p>\u5f53\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\u5df2\u7ecf\u51fa\u73b0\u95ee\u9898\u65f6\uff0c\u518d\u6765\u8c03\u6574\u65e5\u5fd7\u53c2\u6570\u662f\u4e0d\u6b63\u786e\u7684\u505a\u6cd5\u3002\u4e3b\u52a8\u5173\u6ce8\u6570\u636e\u5e93\u65e5\u5fd7\u662f\u5145\u5206\u5229\u7528\u5b83\u4eec\u7684\u6700\u4f73\u65b9\u6cd5\u3002</p> <p>\u672c\u6587\u8ba8\u8bba\u4e86\u4e0d\u540c\u7c7b\u578b\u7684 PostgreSQL \u65e5\u5fd7\u3001\u5982\u4f55\u914d\u7f6e PostgreSQL \u63d0\u4f9b\u7684\u8bb8\u591a\u65e5\u5fd7\u53c2\u6570\u4ee5\u53ca\u5982\u4f55\u89e3\u91ca\u65e5\u5fd7\u6d88\u606f\u3002\u672c\u6587\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e9b\u6709\u5173\u5982\u4f55\u4f7f\u7528 PostgreSQL \u65e5\u5fd7\u6765\u89e3\u51b3\u95ee\u9898\u548c\u63d0\u9ad8\u6570\u636e\u5e93\u6027\u80fd\u7684\u63d0\u793a\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_1","title":"\u524d\u63d0","text":"<p>\u60a8\u9700\u8981\u5728\u8ba1\u7b97\u673a\u4e0a\u5b89\u88c5\u5e76\u8fd0\u884c PostgreSQL\u3002\u786e\u4fdd\u60a8\u62e5\u6709 PostgreSQL 15 \u6216\u66f4\u9ad8\u7248\u672c\uff0c\u56e0\u4e3a\u5b83\u5f15\u5165\u4e86\u4ee5 JSON \u683c\u5f0f\u8f93\u51fa\u7ed3\u6784\u5316\u65e5\u5fd7\u7684\u529f\u80fd\u3002</p> <p>\u8981\u68c0\u67e5\u5ba2\u6237\u7aef\u7248\u672c\uff0c\u8bf7\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ psql --version # client version\n</code></pre> Output<pre><code>psql (PostgreSQL) 15.3 (Ubuntu 15.3-1.pgdg22.04+1)\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u67e5\u770b\u670d\u52a1\u5668\u7248\u672c\uff1a</p> <p><pre><code>sudo -u postgres psql -c 'SHOW server_version;'\n</code></pre> Output<pre><code>          server_version\n----------------------------------\n 15.3 (Ubuntu 15.3-1.pgdg22.04+1)\n</code></pre></p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_2","title":"\u642d\u5efa\u793a\u4f8b\u6570\u636e\u5e93","text":"<p>\u4e3a\u4e86\u9075\u5faa\u672c\u6587\u4e2d\u7684\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u8bbe\u7f6e\u6d41\u884c\u7684 Chinook \u793a\u4f8b\u6570\u636e\u5e93 \uff0c\u5b83\u4ee3\u8868\u4e00\u4e2a\u6570\u5b57\u5a92\u4f53\u5546\u5e97\uff0c\u5176\u4e2d\u5305\u62ec\u827a\u672f\u5bb6\u3001\u4e13\u8f91\u3001\u5a92\u4f53\u66f2\u76ee\u3001\u53d1\u7968\u548c\u5ba2\u6237\u7684\u8868\u3002</p> <p>\u9996\u5148\u5c06\u6570\u636e\u5e93\u6587\u4ef6\u4e0b\u8f7d\u5230\u60a8\u7684\u8ba1\u7b97\u673a\uff1a</p> <pre><code>$ curl -LO https://gist.github.com/ayoisaiah/ebf628402706de0b6053699f9e0776ed/raw/43a4ce34a3c7ef397d2cf235f20f9217985f18e1/chinook.sql\n</code></pre> <p>\u63a5\u4e0b\u6765\uff0c\u4f7f\u7528\u9ed8\u8ba4\u7684 <code>postgres</code> \u7528\u6237\u542f\u52a8 <code>psql</code>\uff1a</p> <pre><code>$ sudo -u postgres psql\n</code></pre> <p>\u5982\u4e0b\u6240\u793a\uff0c\u521b\u5efa <code>chinook</code> \u6570\u636e\u5e93\uff1a</p> <pre><code>CREATE DATABASE chinook OWNER postgres;\n</code></pre> Output<pre><code>CREATE DATABASE\n</code></pre> <p>\u8fde\u63a5\u521a\u521a\u521b\u5efa\u7684 <code>chinook</code> \u6570\u636e\u5e93\uff1a</p> <pre><code>\\c chinook\n</code></pre> <p>\u6700\u540e\uff0c\u5bfc\u5165 <code>chinook.sql</code> \u6587\u4ef6\u6765\u521b\u5efa\u8868\u5e76\u586b\u5145\u6570\u636e\uff1a</p> <pre><code>\\i chinook.sql\n</code></pre> <p>\u4e0a\u8ff0\u547d\u4ee4\u6267\u884c\u5b8c\u6210\u540e\uff0c\u60a8\u53ef\u4ee5\u8fd0\u884c\u4ee5\u4e0b\u67e5\u8be2\u6765\u786e\u8ba4\u6570\u636e\u662f\u5426\u5bfc\u5165\uff1a</p> <pre><code>TABLE album LIMIT 10;\n</code></pre> Output<pre><code> albumid |                 title                 | artistid\n---------+---------------------------------------+----------\n       1 | For Those About To Rock We Salute You |        1\n       2 | Balls to the Wall                     |        2\n       3 | Restless and Wild                     |        2\n       4 | Let There Be Rock                     |        1\n       5 | Big Ones                              |        3\n       6 | Jagged Little Pill                    |        4\n       7 | Facelift                              |        5\n       8 | Warner 25 Anos                        |        6\n       9 | Plays Metallica By Four Cellos        |        7\n      10 | Audioslave                            |        8\n(10 rows)\n</code></pre> <p>\u60a8\u73b0\u5728\u53ef\u4ee5\u9000\u51fa <code>psql</code>\uff1a</p> <pre><code>\\q\n</code></pre> <p>\u73b0\u5728\u60a8\u5df2\u7ecf\u6709\u4e86\u4e00\u4e9b\u53ef\u4ee5\u4f7f\u7528\u7684\u6570\u636e\uff0c\u8ba9\u6211\u4eec\u7ee7\u7eed\u4e0b\u4e00\u90e8\u5206\uff0c\u60a8\u5c06\u4e86\u89e3\u5728\u54ea\u91cc\u53ef\u4ee5\u627e\u5230 PostgreSQL \u670d\u52a1\u5668\u751f\u6210\u7684\u65e5\u5fd7\u3002</p> \u63d0\u793a <p>\u4e3a\u4e86\u6d4b\u8bd5\u76ee\u7684\uff0c\u60a8\u53ef\u4ee5\u5728 <code>psql</code> \u4e2d\u8f93\u5165 <code>SET log_statement = 'all'</code>\uff0c\u4ee5\u4fbf\u6240\u6709\u6570\u636e\u5e93\u67e5\u8be2\u90fd\u8bb0\u5f55\u5728\u670d\u52a1\u5668\u65e5\u5fd7\u4e2d\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#postgresql_1","title":"PostgreSQL \u65e5\u5fd7\u5b58\u50a8\u5728\u54ea\u91cc\uff1f","text":"<p>PostgreSQL \u670d\u52a1\u5668\u9ed8\u8ba4\u5c06\u5176\u65e5\u5fd7\u8f93\u51fa\u5230\u6807\u51c6\u9519\u8bef\u6d41\u3002\u60a8\u53ef\u4ee5\u901a\u8fc7\u5728 <code>psql</code> \u4e2d\u6267\u884c\u4ee5\u4e0b\u67e5\u8be2\u6765\u786e\u8ba4\u8fd9\u4e00\u70b9\uff1a</p> <pre><code>SHOW log_destination;\n</code></pre> Output<pre><code> log_destination\n-----------------\n stderr\n(1 row)\n</code></pre> <p>\u5b83\u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e2a\u65e5\u5fd7\u6536\u96c6\u5668\u8fdb\u7a0b\uff0c\u8d1f\u8d23\u6355\u83b7\u53d1\u9001\u5230\u6807\u51c6\u9519\u8bef\u7684\u65e5\u5fd7\u5e76\u5c06\u5176\u8def\u7531\u5230\u65e5\u5fd7\u6587\u4ef6\u3002\u6b64\u65e5\u5fd7\u6536\u96c6\u5668\u7684\u884c\u4e3a\u7531 <code>logging_collector</code> \u53c2\u6570\u63a7\u5236\u3002</p> <p>\u8ba9\u6211\u4eec\u7ee7\u7eed\u901a\u8fc7 psql \u67e5\u770b <code>logging_collector</code> \u53c2\u6570\u7684\u5f53\u524d\u503c\uff1a</p> <pre><code>SHOW logging_collector;\n</code></pre> Output<pre><code> logging_collector\n-------------------\n off\n(1 row)\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c<code>logging_collector</code> \u662f\u5173\u95ed\u7684\uff0c\u56e0\u6b64 PostgreSQL \u65e5\u5fd7\uff08\u53d1\u9001\u5230\u670d\u52a1\u5668\u7684\u6807\u51c6\u9519\u8bef\u6d41\uff09\u4e0d\u4f1a\u7531\u65e5\u5fd7\u6536\u96c6\u5668\u8fdb\u7a0b\u5904\u7406\u3002\u8fd9\u610f\u5473\u7740\u65e5\u5fd7\u7684\u76ee\u7684\u5730\u53d6\u51b3\u4e8e\u670d\u52a1\u5668\u7684\u6807\u51c6\u9519\u8bef\u8f93\u51fa\u6d41\u7684\u6307\u5411\u4f4d\u7f6e\u3002</p> <p>\u5728 Ubuntu \u4e0a\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>pg_lsclusters</code> \u547d\u4ee4\u6765\u67e5\u627e\u8ba1\u7b97\u673a\u4e0a\u8fd0\u884c\u7684\u6240\u6709 PostgreSQL \u96c6\u7fa4\u7684\u65e5\u5fd7\u6587\u4ef6\uff1a</p> <pre><code>$ pg_lsclusters\n</code></pre> <p>\u65e5\u5fd7\u6587\u4ef6\u5217\u6307\u793a\u6587\u4ef6\u7684\u4f4d\u7f6e\uff1a</p> Output<pre><code>Ver Cluster Port Status Owner    Data directory              Log file\n14  main    5432 online postgres /var/lib/postgresql/15/main /var/log/postgresql/postgresql-15-main.log\n</code></pre> <p>\u5982\u679c\u60a8\u7684\u673a\u5668\u4e0a\u5df2\u542f\u7528 <code>logging_collector</code>\uff0c\u60a8\u53ef\u4ee5\u5728 <code>psql</code> \u4e2d\u6267\u884c\u4ee5\u4e0b\u67e5\u8be2\u6765\u627e\u51fa\u6587\u4ef6\u7684\u4f4d\u7f6e\uff1a</p> <pre><code>SELECT pg_current_logfile();\n</code></pre> Output<pre><code>   pg_current_logfile\n------------------------\n log/postgresql-Thu.log\n(1 row)\n</code></pre> <p>\u6307\u5b9a\u7684\u6587\u4ef6\uff08\u5728\u672c\u4f8b\u4e2d\u4e3a <code>log/postgresql-Thu.log</code>\uff09\u4e0e PostgreSQL \u6570\u636e\u76ee\u5f55\u76f8\u5173\uff0c\u60a8\u53ef\u4ee5\u901a\u8fc7\u8f93\u5165\u4ee5\u4e0b\u67e5\u8be2\u6765\u627e\u5230\u8be5\u76ee\u5f55\uff1a</p> <pre><code>SHOW data_directory;\n</code></pre> Output<pre><code>   data_directory\n---------------------\n /var/lib/pgsql/data\n(1 row)\n</code></pre> <p>\u672c\u4f8b\u4e2d\u65e5\u5fd7\u6587\u4ef6\u7684\u5b8c\u6574\u8def\u5f84\u662f\uff1a</p> <pre><code>/var/lib/pgsql/data/log/postgresql-Thu.log\n</code></pre> <p>\u5f53\u60a8\u5b9a\u4f4d\u4e3a\u5230\u4e86 PostgreSQL \u65e5\u5fd7\u6587\u4ef6\u540e\uff0c\u4fbf\u53ef\u7ee7\u7eed\u4e0b\u4e00\u90e8\u5206\uff0c\u6211\u4eec\u5c06\u5728\u6d4f\u89c8\u6587\u4ef6\u5185\u5bb9\u65f6\u53ef\u80fd\u9047\u5230\u7684\u5404\u79cd\u7c7b\u578b\u7684\u65e5\u5fd7\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#postgresql_2","title":"PostgreSQL \u65e5\u5fd7\u7684\u7c7b\u578b","text":"<p>\u57fa\u4e8e\u60a8\u7684\u914d\u7f6e\uff0c\u60a8\u53ef\u80fd\u4f1a\u5728\u65e5\u5fd7\u6587\u4ef6\u4e2d\u9047\u5230\u5404\u79cd\u7c7b\u578b\u7684 PostgreSQL \u65e5\u5fd7\u3002\u672c\u90e8\u5206\u5c06\u4ecb\u7ecd\u5176\u4e2d\u6700\u91cd\u8981\u7684\u5185\u5bb9\u4ee5\u53ca\u5b83\u4eec\u7684\u5916\u89c2\u3002</p> <p>\u8bf7\u6ce8\u610f\uff0c\u4e3a\u4e86\u7b80\u6d01\u8d77\u89c1\uff0c\u4e0b\u9762\u7684\u793a\u4f8b\u6709\u610f\u7701\u7565\u4e86\u65e5\u5fd7\u884c\u524d\u7f00\uff08\u4ee5\u4e0b <code>&lt;log_message&gt;</code> \u4e4b\u524d\u7684\u6240\u6709\u5185\u5bb9\uff09\u3002\u4ec5\u663e\u793a <code>&lt;log_message&gt;</code> \u90e8\u5206\u3002</p> <pre><code>2023-07-30 08:31:50.628 UTC [2176] postgres@chinook &lt;log_message&gt;\n</code></pre>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#1","title":"1. \u542f\u52a8\u548c\u5173\u95ed\u65e5\u5fd7","text":"<p>\u8fd9\u4e9b\u65e5\u5fd7\u63cf\u8ff0\u4e86 PostgreSQL \u670d\u52a1\u5668\u7684\u542f\u52a8\u548c\u5173\u95ed\u8fc7\u7a0b\u3002\u542f\u52a8\u65e5\u5fd7\u5305\u62ec\u670d\u52a1\u5668\u7248\u672c\u3001IP \u5730\u5740\u3001\u7aef\u53e3\u548c UNIX \u5957\u63a5\u5b57\u3002\u5b83\u4eec\u8fd8\u62a5\u544a\u670d\u52a1\u5668\u4e0a\u6b21\u5173\u95ed\u7684\u65f6\u95f4\u5e76\u8868\u660e\u5176\u5df2\u51c6\u5907\u597d\u63a5\u53d7\u65b0\u7684\u8fde\u63a5\uff1a</p> <pre><code>LOG:  starting PostgreSQL 15.3 (Ubuntu 15.3-0ubuntu0.22.04.1) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 11.3.0-1ubuntu1~22.04.1) 11.3.0, 64-bit\nLOG:  listening on IPv4 address \"127.0.0.1\", port 5432\nLOG:  listening on Unix socket \"/var/run/postgresql/.s.PGSQL.5432\"\nLOG:  database system was shut down at 2023-07-27 17:45:08 UTC\nLOG:  database system is ready to accept connections\n</code></pre> <p>\u53e6\u4e00\u65b9\u9762\uff0c\u5173\u95ed\u65e5\u5fd7\u662f\u63cf\u8ff0\u670d\u52a1\u5668\u5173\u95ed\u7684\u539f\u56e0\u548c\u65b9\u5f0f\uff0c\u8fd9\u5728\u8c03\u67e5\u610f\u5916\u7684\u6570\u636e\u5e93\u6545\u969c\u65f6\u975e\u5e38\u6709\u7528\u3002\u4e0b\u9762\u7684\u65e5\u5fd7\u63cf\u8ff0\u4e86\u5f53 <code>SIGINT</code> \u4fe1\u53f7\u53d1\u9001\u5230\u670d\u52a1\u5668\u65f6\u7684\u5feb\u901f\u5173\u95ed\u8fc7\u7a0b\uff1a</p> <pre><code>LOG:  received fast shutdown request\nLOG:  aborting any active transactions\nLOG:  background worker \"logical replication launcher\" (PID 82894) exited with exit code 1\nLOG:  shutting down\nLOG:  database system is shut down\n</code></pre>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#2","title":"2. \u67e5\u8be2\u65e5\u5fd7","text":"<p>\u8fd9\u4e9b\u65e5\u5fd7\u4ee3\u8868\u9488\u5bf9 PostgreSQL \u6570\u636e\u5e93\u6267\u884c\u7684\u5404\u79cd SQL \u67e5\u8be2\uff0c\u5305\u62ec <code>SELECT</code>\u3001<code>INSERT</code>\u3001<code>UPDATE</code>\u3001<code>DELETE</code> \u7b49\u3002</p> <pre><code>STATEMENT:  select c.firstname, c.lastname, i.invoiceid, i.invoicedate, i.billingcountry\n        from customer as c, invoice as i\n        where c.country = 'Brazil' and\n        select distinct billingcountry from invoice;\nLOG:  statement: select distinct billingcountry from invoice;\nLOG:  statement: select albumid, title from album where artistid = 2;\n</code></pre>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#3","title":"3. \u67e5\u8be2\u6301\u7eed\u65f6\u95f4\u65e5\u5fd7","text":"<p>\u4e0e\u67e5\u8be2\u65e5\u5fd7\u5bc6\u5207\u76f8\u5173\u7684\u662f\u6301\u7eed\u65f6\u95f4\u65e5\u5fd7\uff0c\u5b83\u8ddf\u8e2a\u67e5\u8be2\u5b8c\u6210\u6240\u9700\u7684\u65f6\u95f4\uff1a</p> <pre><code>LOG:  duration: 13.020 ms\nLOG:  duration: 13.504 ms  statement: UPDATE album SET title = 'Audioslave' WHERE albumid = 10;\n</code></pre>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#4","title":"4. \u9519\u8bef\u65e5\u5fd7","text":"<p>\u9519\u8bef\u65e5\u5fd7\u53ef\u5e2e\u52a9\u60a8\u8bc6\u522b\u5bfc\u81f4\u670d\u52a1\u5668\u51fa\u73b0\u9519\u8bef\u60c5\u51b5\u7684\u67e5\u8be2\u3002\u8fd9\u4e9b\u60c5\u51b5\u5305\u62ec\u67e5\u8be2\u7279\u5b9a\u7684\u9519\u8bef\uff08\u4f8b\u5982\u7ea6\u675f\u8fdd\u89c4\u6216\u6570\u636e\u7c7b\u578b\u4e0d\u5339\u914d\uff09\u4ee5\u53ca\u66f4\u4e25\u91cd\u7684\u95ee\u9898\uff08\u4f8b\u5982\u6b7b\u9501\u548c\u8d44\u6e90\u8017\u5c3d\uff09\u3002\u4ee5\u4e0b\u662f\u6b64\u7c7b\u65e5\u5fd7\u7684\u793a\u4f8b\uff1a</p> <pre><code>ERROR:  relation \"custome\" does not exist at character 15\nSTATEMENT:  select * from custome where country = 'Brazil';\nERROR:  duplicate key value violates unique constraint \"pk_album\"\nDETAIL:  Key (albumid)=(10) already exists.\nSTATEMENT:  UPDATE album SET albumid = 10 WHERE albumid = 2;\n</code></pre>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#5","title":"5. \u8fde\u63a5\u548c\u65ad\u5f00\u8fde\u63a5\u65e5\u5fd7","text":"<p>\u6709\u5173\u5ba2\u6237\u7aef\u8fde\u63a5\u548c\u65ad\u5f00\u6570\u636e\u5e93\u7684\u4fe1\u606f\u4e5f\u53ef\u4ee5\u8bb0\u5f55\u5728\u65e5\u5fd7\u4e2d\u3002\u8fd9\u4e9b\u8bb0\u5f55\u5305\u62ec\u6e90 IP \u5730\u5740\u3001\u7528\u6237\u540d\u3001\u6570\u636e\u5e93\u540d\u79f0\u548c\u8fde\u63a5\u72b6\u6001\u3002\u5982\u679c\u53d1\u751f\u65ad\u5f00\u8fde\u63a5\uff0c\u5b83\u4eec\u8fd8\u5305\u62ec\u4f1a\u8bdd\u603b\u65f6\u957f\u3002</p> <pre><code>LOG:  connection received: host=[local]\nLOG:  connection authenticated: identity=\"postgres\" method=peer (/etc/postgresql/15/main/pg_hba.conf:90)\nLOG:  connection authorized: user=postgres database=chinook application_name=psql\nLOG:  disconnection: session time: 0:00:08.602 user=postgres database=chinook host=[local]\n</code></pre>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#6-wal","title":"6. \u68c0\u67e5\u70b9\u548c\u9884\u5199\u65e5\u5fd7 (WAL)","text":"<p>\u68c0\u67e5\u70b9\u8868\u793a\u9884\u5199\u65e5\u5fd7 (WAL) \u5c06\u4fee\u6539\u540e\u7684\u6570\u636e\u4ece\u5185\u5b58\uff08\u5171\u4eab\u7f13\u51b2\u533a\uff09\u5237\u65b0\u5230\u78c1\u76d8\u7684\u65f6\u523b\u3002\u8fd9\u4e9b\u65e5\u5fd7\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>LOG:  checkpoint starting: time\nLOG:  checkpoint complete: wrote 3 buffers (0.0%); 0 WAL file(s) added, 0 removed, 0 recycled; write=0.005 s, sync=0.002 s, total=0.025 s; sync files=2, longest=0.001 s, average=0.001 s; distance=0 kB, estimate=0 kB\n</code></pre>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_3","title":"\u5f00\u542f\u65e5\u5fd7\u6536\u96c6\u5668","text":"<p>\u5982\u524d\u6240\u8ff0\uff0c\u65e5\u5fd7\u6536\u96c6\u5668\u662f\u4e00\u4e2a\u540e\u53f0\u8fdb\u7a0b\uff0c\u5b83\u6355\u83b7\u53d1\u9001\u5230\u6807\u51c6\u9519\u8bef\u7684\u65e5\u5fd7\u6d88\u606f\u5e76\u5c06\u5176\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\u4e2d\u3002\u5f53\u60a8\u542f\u7528\u6536\u96c6\u5668\u65f6\uff0cPostgreSQL \u65e5\u5fd7\u5c06\u4e0d\u518d\u91cd\u5b9a\u5411\u5230 <code>/var/log/postgresql/postgresql-15-main.log</code> \u6587\u4ef6\uff08\u5728 Ubuntu \u4e0a\uff09\uff0c\u800c\u662f\u5b58\u50a8\u5728\u5355\u72ec\u7684\u76ee\u5f55\u4e2d\u3002</p> <p>\u5728\u5f00\u59cb\u4fee\u6539 PostgreSQL \u914d\u7f6e\u4e4b\u524d\uff0c\u60a8\u9700\u8981\u4f7f\u7528\u4ee5\u4e0b\u67e5\u8be2\u5728\u60a8\u7684\u673a\u5668\u4e0a\u627e\u5230\u5b83\u7684\u4f4d\u7f6e\uff1a</p> <pre><code>SHOW config_file;\n</code></pre> Output<pre><code>               config_file\n-----------------------------------------\n /etc/postgresql/15/main/postgresql.conf\n</code></pre> <p>\u4f7f\u7528 root \u6743\u9650\u5728\u60a8\u6700\u559c\u6b22\u7684\u6587\u672c\u7f16\u8f91\u5668\u4e2d\u6253\u5f00\u6587\u4ef6\u8def\u5f84\uff1a</p> <p><pre><code>$ sudo nano /etc/postgresql/15/main/postgresql.conf\n</code></pre> \u8be5\u6587\u4ef6\u5305\u542b\u51e0\u4e2a\u53ef\u914d\u7f6e\u7684\u53c2\u6570\uff0c\u6ce8\u91ca\u4ee5 <code>#</code> \u5b57\u7b26\u5f00\u5934\u3002</p> <p>\u73b0\u5728\uff0c\u627e\u5230 <code>logging_collector</code> \u9009\u9879\uff0c\u53d6\u6d88\u6ce8\u91ca\u8be5\u884c\u5e76\u5c06\u5176\u6253\u5f00\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>logging_collector = on\n</code></pre> <p>\u4fdd\u5b58\u6587\u4ef6\uff0c\u7136\u540e\u5728\u7ec8\u7aef\u4e2d\u91cd\u65b0\u542f\u52a8 PostgreSQL \u670d\u52a1\u5668\uff08\u786e\u4fdd\u5728\u4fee\u6539\u6b64\u6587\u4ef6\u4e2d\u7684\u4efb\u4f55\u8bbe\u7f6e\u540e\u6267\u884c\u6b64\u64cd\u4f5c\uff09\uff1a</p> <pre><code>$ sudo systemctl restart postgresql\n</code></pre> <p>\u4e4b\u540e\uff0c\u67e5\u770b <code>/var/log/postgresql/postgresql-15-main.log</code> \u6587\u4ef6\u4e2d\u7684\u6700\u540e\u51e0\u884c\uff1a</p> <pre><code>$ tail /var/log/postgresql/postgresql-15-main.log\n</code></pre> <p>\u60a8\u5e94\u8be5\u770b\u5230\u4e24\u884c\u5185\u5bb9\uff0c\u786e\u8ba4\u65e5\u5fd7\u6536\u96c6\u5668\u5df2\u6253\u5f00\uff0c\u5e76\u4e14\u5c06\u6765\u7684\u65e5\u5fd7\u8f93\u51fa\u73b0\u5728\u88ab\u653e\u7f6e\u5728 <code>log</code> \u76ee\u5f55\u4e2d\uff1a</p> <pre><code>. . .\nLOG:  redirecting log output to logging collector process\nHINT:  Future log output will appear in directory \"log\".\n</code></pre> <p>\u8be5 <code>log</code> \u7531 <code>log_directory</code> \u53c2\u6570\u63a7\u5236\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_directory = 'log'\n</code></pre> <p>\u4ece\u4e0a\u9762\u7684\u6ce8\u91ca\u4e2d\u53ef\u4ee5\u770b\u51fa\uff0c<code>log_directory</code> \u63a7\u5236\u7740 PostgreSQL \u65e5\u5fd7\u7684\u5199\u5165\u4f4d\u7f6e\u3002\u5f53\u63d0\u4f9b\u76f8\u5bf9\u8def\u5f84\u65f6\uff0c\u5b83\u76f8\u5bf9\u4e8e <code>data_directory</code> \u53c2\u6570\u7684\u503c\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>data_directory = '/var/lib/postgresql/15/main'\n</code></pre> <p>\u56e0\u6b64\uff0c\u6211\u4eec\u53ef\u4ee5\u63a8\u65ad\u65e5\u5fd7\u6587\u4ef6\u5e94\u8be5\u4f4d\u4e8e <code>/var/lib/postgresql/15/main/log/</code> \u76ee\u5f55\u4e2d\u3002\u4f7f\u7528 root \u6743\u9650\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u6765\u67e5\u627e\uff1a</p> <pre><code>$ sudo ls /var/lib/postgresql/15/main/log/\n</code></pre> <p>\u60a8\u5e94\u8be5\u89c2\u5bdf\u5230\u76ee\u5f55\u4e2d\u81f3\u5c11\u6709\u4e00\u4e2a\u65e5\u5fd7\u6587\u4ef6\uff0c\u8868\u660e\u65e5\u5fd7\u6536\u96c6\u5668\u6b63\u5e38\u5de5\u4f5c\uff1a</p> Output<pre><code>postgresql-2023-07-30_172237.log\n</code></pre> <p>\u5728\u4e0b\u4e00\u8282\u4e2d\uff0c\u60a8\u5c06\u5b66\u4e60\u5982\u4f55\u81ea\u5b9a\u4e49\u65e5\u5fd7\u6587\u4ef6\u540d\u548c\u76f8\u5173\u9009\u9879\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_4","title":"\u81ea\u5b9a\u4e49\u65e5\u5fd7\u6587\u4ef6","text":"<p>PostgreSQL \u5141\u8bb8\u901a\u8fc7 <code>log_filename</code> \u53c2\u6570\u81ea\u5b9a\u4e49\u65e5\u5fd7\u6587\u4ef6\u540d\uff0c\u9ed8\u8ba4\u7684\u6587\u4ef6\u540d\u5982\u4e0b\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'\n</code></pre> <p>\u6b64\u914d\u7f6e\u751f\u6210\u5305\u542b\u6587\u4ef6\u521b\u5efa\u65e5\u671f\u548c\u65f6\u95f4\u7684\u6587\u4ef6\u540d\u3002Open Group \u7684 <code>strftime</code> \u89c4\u8303\u4e2d\u5217\u51fa\u4e86\u652f\u6301\u7684 <code>%</code> \u8f6c\u4e49\u3002</p> <p>\u4e3a\u4e86\u4f7f\u672c\u6559\u7a0b\u7b80\u5355\u6613\u61c2\uff0c\u60a8\u53ef\u4ee5\u5c06\u65e5\u5fd7\u6587\u4ef6\u540d\u66f4\u6539\u4e3a\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_filename = 'postgresql-%a.log'\n</code></pre> <p>\u8fd9\u5c06\u751f\u6210\u5177\u6709\u5f53\u5929\u7f29\u5199\u540d\u79f0\u7684\u6587\u4ef6\uff0c\u5982 <code>postgresql-Thu.log</code> \u7b49\u3002\u8bf7\u6ce8\u610f\uff0c\u867d\u7136\u6587\u4ef6\u540d\u4ee5 <code>.log</code> \u7ed3\u5c3e\uff0c\u4f46\u5982\u679c\u542f\u7528\u4e86 JSON \u6216 CSV \u683c\u5f0f\uff0c\u5219\u751f\u6210\u7684\u6587\u4ef6\u5c06\u5206\u522b\u4ee5 <code>.json</code> \u548c <code>.csv</code> \u7ed3\u5c3e\uff08\u4f8b\u5982 <code>postgresql-Thu.json</code>\uff09\u3002</p> <p>\u5982\u679c\u60a8\u60f3\u63a7\u5236\u6bcf\u4e2a\u65e5\u5fd7\u6587\u4ef6\u7684\u521b\u5efa\u65b9\u5f0f\uff0c\u60a8\u53ef\u4ee5\u66f4\u6539 <code>log_file_mode</code> \u53c2\u6570\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_file_mode = 0600 # the default\n</code></pre> <p><code>0600</code> \u6743\u9650\u901a\u5e38\u7528\u4e8e\u53ea\u6709\u6587\u4ef6\u6240\u6709\u8005\u624d\u80fd\u8bbf\u95ee\u548c\u4fee\u6539\u7684\u654f\u611f\u6587\u4ef6\u3002\u901a\u8fc7\u6b64\u8bbe\u7f6e\uff0c\u60a8\u53ea\u80fd\u901a\u8fc7\u5207\u6362\u5230 <code>postgres</code> \u7528\u6237\u6216\u4f7f\u7528 root \u6743\u9650\u6765\u8bbf\u95ee\u3001\u67e5\u770b\u6216\u4fee\u6539\u6b64\u6587\u4ef6\u3002\u8fd9\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u5b89\u5168\u63aa\u65bd\uff0c\u56e0\u4e3a PostgreSQL \u65e5\u5fd7\u901a\u5e38\u5305\u542b\u654f\u611f\u4fe1\u606f\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_5","title":"\u8bbe\u7f6e\u65e5\u5fd7\u6587\u4ef6\u8f6e\u6362","text":"<p>\u60a8\u53ef\u80fd\u5df2\u7ecf\u77e5\u9053\uff0c\u5982\u679c\u6ca1\u6709\u9002\u5f53\u7684\u65e5\u5fd7\u8f6e\u6362\u7b56\u7565\uff0c\u65e5\u5fd7\u6587\u4ef6\u53ef\u80fd\u4f1a\u5f88\u5feb\u8017\u5c3d\u6240\u6709\u78c1\u76d8\u7a7a\u95f4\uff0c\u5bf9\u4e8e\u6253\u5f00\u67e5\u8be2\u65e5\u5fd7\u8bb0\u5f55\u7684 PostgreSQL \u65e5\u5fd7\u5c24\u5176\u5982\u6b64\u3002</p> <p>\u5e78\u8fd0\u7684\u662f\uff0cPostgreSQL \u63d0\u4f9b\u4e86\u4e00\u4e9b\u914d\u7f6e\u9009\u9879\u6765\u63a7\u5236\u5176\u65e5\u5fd7\u6587\u4ef6\u7684\u8f6e\u6362\u65b9\u5f0f\uff1a</p> <ul> <li><code>log_rotation_age</code>\uff1a\u8fd9\u6307\u5b9a\u4e86\u65e5\u5fd7\u6587\u4ef6\u5728\u8f6e\u6362\u4e4b\u524d\u7684\u6700\u5927\u4f7f\u7528\u671f\u9650\u3002\u9ed8\u8ba4\u503c\u4e3a 24 \u5c0f\u65f6 (<code>1d</code>)\u3002\u5b83\u53ef\u4ee5\u63a5\u53d7\u5e26\u6709\u5355\u4f4d\u7684\u6574\u6570\u503c\uff0c\u4f8b\u5982 <code>m</code> \u8868\u793a\u5206\u949f\u3001<code>d</code> \u8868\u793a\u5929\u3001<code>w</code> \u8868\u793a\u5468\u7b49\u3002\u5982\u679c\u672a\u63d0\u4f9b\u5355\u4f4d\uff0c\u5219\u5047\u5b9a\u4e3a\u5206\u949f\u3002\u60a8\u8fd8\u53ef\u4ee5\u901a\u8fc7\u5c06\u5176\u8bbe\u7f6e\u4e3a <code>0</code> \u6765\u7981\u7528\u57fa\u4e8e\u65f6\u95f4\u7684\u65e5\u5fd7\u8f6e\u6362\u3002</li> <li><code>log_rotation_size</code>\uff1a\u6b64\u503c\u51b3\u5b9a\u4e86\u65e5\u5fd7\u6587\u4ef6\u5728\u8f6e\u6362\u4e3a\u65b0\u65e5\u5fd7\u6587\u4ef6\u4e4b\u524d\u7684\u6700\u5927\u5927\u5c0f\u3002\u9ed8\u8ba4\u503c\u4e3a 10 \u5146\u5b57\u8282 (<code>10MB</code>)\u3002\u5982\u679c\u8981\u7981\u7528\u57fa\u4e8e\u5927\u5c0f\u7684\u65e5\u5fd7\u8f6e\u6362\uff0c\u8bf7\u5c06\u5176\u8bbe\u7f6e\u4e3a <code>0</code>\u3002</li> <li><code>log_truncate_on_rotation</code>\uff1a\u4ec5\u5f53\u5bf9\u65e5\u5fd7\u6587\u4ef6\u91c7\u7528\u57fa\u4e8e\u65f6\u95f4\u7684\u8f6e\u6362\u65f6\u6b64\u53c2\u6570\u624d\u9002\u7528\u3002\u5b83\u7528\u4e8e\u8986\u76d6\u4efb\u4f55\u73b0\u6709\u7684\u540c\u540d\u65e5\u5fd7\u6587\u4ef6\uff0c\u800c\u4e0d\u662f\u9644\u52a0\u5230\u6587\u4ef6\u3002\u5f53\u60a8\u7684 <code>log_filename</code> \u53c2\u6570\u7c7b\u4f3c\u4e8e <code>postgresql-%a.log</code> \u65f6\uff0c\u8fd9\u5f88\u6709\u7528\uff0c\u5b83\u4f1a\u751f\u6210\u50cf <code>postgresql-Mon.log</code>\u3001<code>postgresql-Tue.log</code> \u7b49\u6587\u4ef6\u3002\u542f\u7528\u6b64\u9009\u9879\uff08\u4e0e\u5c06 <code>log_rotation_age</code> \u8bbe\u7f6e\u4e3a <code>7d</code> \u4e00\u8d77\uff09\u53ef\u786e\u4fdd\u6bcf\u5468\u7684\u65e5\u5fd7\u8986\u76d6\u524d\u4e00\u5468\u7684\u65e5\u5fd7\uff0c\u4f46\u6587\u4ef6\u540d\u4fdd\u6301\u4e0d\u53d8\u3002</li> </ul> <p>\u5982\u60a8\u6240\u89c1\uff0c\u4e0a\u8ff0\u9009\u9879\u63d0\u4f9b\u4e86\u57fa\u672c\u7684\u65e5\u5fd7\u6587\u4ef6\u8f6e\u6362\u529f\u80fd\u3002 \u5982\u679c\u60a8\u9700\u8981\u66f4\u591a\u81ea\u5b9a\u4e49\u9009\u9879\uff0c\u4f8b\u5982\u81ea\u52a8\u538b\u7f29\u8f6e\u6362\u6587\u4ef6\u7684\u529f\u80fd\uff0c\u8bf7\u5173\u95ed PostgreSQL \u7684\u65e5\u5fd7\u6587\u4ef6\u8f6e\u6362\u9009\u9879\uff0c\u7136\u540e\u4f7f\u7528 <code>logrotate</code> \u7a0b\u5e8f\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_6","title":"\u65e5\u5fd7\u683c\u5f0f","text":"<p>PostgreSQL \u901a\u8fc7 <code>log_destination</code> \u53c2\u6570\u63a7\u5236\u65e5\u5fd7\u683c\u5f0f\uff0c\u9ed8\u8ba4\u503c\u4e3a <code>stderr</code>\u3002\u60a8\u8fd8\u53ef\u4ee5\u4f7f\u7528 <code>jsonlog</code> \u548c <code>csvlog</code> \u9009\u9879\u5206\u522b\u4ee5 JSON \u548c CSV \u683c\u5f0f\u8f93\u51fa\u65e5\u5fd7\u3002\u7a0d\u540e\u5c06\u63d0\u4f9b\u66f4\u591a\u4fe1\u606f\u3002</p> <p>/etc/postgresql/15/main/postgresql.conf<pre><code>log_destination = 'stderr'\n</code></pre> \u5f53 <code>stderr</code> \u542f\u7528\u65f6\uff0c\u60a8\u53ef\u4ee5\u901a\u8fc7 <code>log_line_prefix</code> \u53c2\u6570\u4fee\u6539\u5176\u8f93\u51fa\uff0c\u8be5\u53c2\u6570\u5305\u542b <code>printf</code> \u6837\u5f0f\u7684\u5b57\u7b26\u4e32\uff0c\u7528\u4e8e\u786e\u5b9a\u65e5\u5fd7\u4fe1\u606f\u5934\u9700\u8981\u5305\u542b\u7684\u5185\u5bb9\u3002\u5728 <code>psql</code> \u4e2d\u8f93\u5165\u4ee5\u4e0b\u5185\u5bb9\u6765\u627e\u51fa\u5176\u5f53\u524d\u503c\uff1a</p> <p><pre><code>SHOW log_line_prefix;\n</code></pre> Output<pre><code> log_line_prefix\n------------------\n %m [%p] %q%u@%d\n(1 row)\n</code></pre></p> <p>\u8be5\u503c\u786e\u4fdd\u53d1\u9001\u5230 <code>stderr</code> \u7684\u6bcf\u4e2a\u65e5\u5fd7\u8bb0\u5f55\u90fd\u5305\u542b\u4ee5\u4e0b\u8be6\u7ec6\u4fe1\u606f\uff1a</p> <ul> <li><code>%m</code>\uff1a\u4e8b\u4ef6\u7684\u65f6\u95f4\uff08\u4ee5\u6beb\u79d2\u4e3a\u5355\u4f4d\uff09\u3002</li> <li><code>%p</code>\uff1a\u521b\u5efa\u65e5\u5fd7\u7684\u7279\u5b9a PostgreSQL \u5b9e\u4f8b\u7684\u8fdb\u7a0b ID\u3002</li> <li><code>%q</code>\uff1a\u6b64\u6807\u8bb0\u4e0d\u4ea7\u751f\u4efb\u4f55\u8f93\u51fa\uff0c\u4f46\u4f1a\u901a\u77e5\u540e\u53f0\u8fdb\u7a0b\uff08background processes\uff09\u5ffd\u7565\u6b64\u540e\u7684\u6240\u6709\u5185\u5bb9\u3002\u540e\u7eed\u7684 <code>\uff05u@\uff05d</code> \u4ec5\u5728\u4f1a\u8bdd\u8fdb\u7a0b\uff08backend processes\uff09\u4e2d\u53ef\u7528\u3002</li> <li><code>%u</code>\uff1a\u89e6\u53d1\u4e8b\u4ef6\u7684\u8fde\u63a5\u7528\u6237\u3002</li> <li><code>%d</code>\uff1a\u7528\u6237\u8fde\u63a5\u5230\u7684\u6570\u636e\u5e93\u3002</li> </ul> <p>\u4f7f\u7528\u4e0a\u8ff0\u683c\u5f0f\u751f\u6210\u7684\u65e5\u5fd7\u6761\u76ee\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>2023-07-30 08:31:50.628 UTC [2176] postgres@chinook LOG:  statement: select albumid, title from album where artistid = 2;\n</code></pre> <p>\u6ce8\u610f\uff0c<code>postgres@chinook</code> \u4e4b\u540e\u7684\u6240\u6709\u5185\u5bb9\u4e0d\u53d7 <code>log_line_prefix</code> \u63a7\u5236\uff0c\u5e76\u4e14\u65e0\u6cd5\u81ea\u5b9a\u4e49\u3002\u5b83\u7531\u65e5\u5fd7\u7ea7\u522b\u548c\u65e5\u5fd7\u6d88\u606f\u7ec4\u6210\uff0c\u5728\u672c\u4f8b\u4e2d\u662f <code>SELECT</code> \u8bed\u53e5\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_7","title":"\u81ea\u5b9a\u4e49\u65e5\u5fd7\u683c\u5f0f","text":"<p>\u4fee\u6539 <code>stderr</code> \u65e5\u5fd7\u683c\u5f0f\u7684\u552f\u4e00\u65b9\u6cd5\u662f\u901a\u8fc7 <code>log_line_prefix</code> \u8bbe\u7f6e\u3002\u8bf7\u53c2\u9605\u53ef\u7528\u7684\u8f6c\u4e49\u5e8f\u5217\u7684\u5b8c\u6574\u5217\u8868\u3002\u6211\u4eec\u5efa\u8bae\u5305\u62ec\u4ee5\u4e0b\u53d8\u91cf\uff1a</p> <ul> <li><code>%a</code>\uff1a\u5e94\u7528\u7a0b\u5e8f\u540d\u79f0\uff08\u4f7f\u7528 PostgreSQL \u8fde\u63a5\u5b57\u7b26\u4e32\u4e2d\u7684 <code>application_name</code> \u53c2\u6570\uff09\u3002</li> <li><code>%p</code>\uff1aPostgreSQL \u5b9e\u4f8b\u7684\u8fdb\u7a0b ID\u3002</li> <li><code>%u</code>\uff1a\u5df2\u8fde\u63a5\u7684\u7528\u6237\u540d\u3002</li> <li><code>%d</code>\uff1a\u6570\u636e\u5e93\u540d\u3002</li> <li><code>%m</code>\uff1a\u4e8b\u4ef6\u53d1\u751f\u7684\u65f6\u95f4\uff0c\u4ee5\u6beb\u79d2\u4e3a\u5355\u4f4d\uff08\u5982\u679c\u8fc7\u60a8\u66f4\u559c\u6b22 UNIX \u7eaa\u5143\uff0c\u5219\u4f7f\u7528 <code>%n</code>\uff09\u3002</li> <li><code>%q</code>\uff1a\u5c06\u4ec5\u4f1a\u8bdd\u53d8\u91cf\u4e0e\u5728\u6240\u6709\u4e0a\u4e0b\u6587\u4e2d\u6709\u6548\u7684\u53d8\u91cf\u5206\u5f00\u3002</li> <li><code>%i</code>\uff1a\u6807\u8bc6\u5df2\u6267\u884c\u7684 SQL \u67e5\u8be2\u7684\u547d\u4ee4\u6807\u7b7e\u3002</li> <li><code>%e</code>\uff1a\u76f8\u5173\u7684 PostgreSQL \u9519\u8bef\u4ee3\u7801\u3002</li> <li><code>%c</code>\uff1a\u5f53\u524d\u4f1a\u8bdd ID\u3002</li> </ul> <p>\u4e3a\u4e86\u4f7f\u65e5\u5fd7\u66f4\u6613\u4e8e\u9605\u8bfb\u548c\u89e3\u6790\uff0c\u60a8\u53ef\u4ee5\u5728\u6bcf\u4e2a\u53d8\u91cf\u524d\u52a0\u4e0a\u4e00\u4e2a\u952e\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_line_prefix = 'time=%m pid=%p error=%e sess_id=%c %qtag=%i usr=%u db=%d app=%a '\n</code></pre> <p>\u5efa\u8bae\u5728\u7ed3\u675f\u5f15\u53f7\u524d\u4f7f\u7528\u7a7a\u683c\uff08\u6216\u5176\u4ed6\u5b57\u7b26\uff09\u5c06\u65e5\u5fd7\u524d\u7f00\u4e0e\u5b9e\u9645\u65e5\u5fd7\u6d88\u606f\u5206\u5f00\u3002\u5b8c\u6210\u6b64\u914d\u7f6e\u540e\uff0c\u91cd\u65b0\u542f\u52a8 PostgreSQL \u670d\u52a1\u5668\u540e\u60a8\u5c06\u770b\u5230\u4ee5\u4e0b\u683c\u5f0f\u7684\u65e5\u5fd7\uff1a</p> <pre><code>time=2023-07-30 22:02:27.929 UTC pid=17678 error=00000 sess_id=64c6ddf3.450e LOG:  database system is ready to accept connections\ntime=2023-07-30 22:03:33.613 UTC pid=17769 error=00000 sess_id=64c6de20.4569 tag=idle usr=postgres db=chinook app=psql LOG:  statement: UPDATE album SET title = 'Audioslave' WHERE albumid = 10;\n</code></pre> <p>\u4e0a\u9762\u7684\u7b2c\u4e00\u6761\u8bb0\u5f55\u662f\u7531\u975e\u4f1a\u8bdd\u8fdb\u7a0b\uff08\u53c8\u79f0\u540e\u53f0\u8fdb\u7a0b\uff09\u521b\u5efa\u7684\u3002\u8fd9\u4e9b\u8fdb\u7a0b\u6267\u884c\u7ef4\u62a4\u6d3b\u52a8\u3001\u540e\u53f0\u4efb\u52a1\u548c\u5176\u4ed6\u5185\u90e8\u529f\u80fd\u6765\u652f\u6301\u6570\u636e\u5e93\u7684\u8fd0\u884c\u3002<code>%q</code> \u8f6c\u4e49\u7684\u5305\u542b\u4f1a\u6392\u9664\u5176\u540e\u7684\u6240\u6709\u5185\u5bb9\uff0c\u56e0\u4e3a\u8fd9\u6837\u7684\u5e8f\u5217\u5728\u975e\u4f1a\u8bdd\u8fdb\u7a0b\u4e2d\u65e0\u6548\u3002\u5982\u4e0d\u5305\u542b <code>%q</code>\uff0c\u5219 <code>tag</code>\u3001<code>usr</code>\u3001<code>db</code> \u548c <code>app</code> \u5c06\u51fa\u73b0\u5728\u65e5\u5fd7\u4e2d\u4f46\u4e3a\u7a7a\u3002</p> <p>\u53e6\u4e00\u65b9\u9762\uff0c\u4f1a\u8bdd\u8fdb\u7a0b\uff08\u53c8\u540d\u7528\u6237\u540e\u7aef\u8fdb\u7a0b\uff09\u662f\u76f4\u63a5\u4e0e\u7279\u5b9a\u7528\u6237\u548c\u6570\u636e\u5e93\u7ed1\u5b9a\u7684\u8fdb\u7a0b\uff0c\u5b83\u4eec\u5904\u7406\u5ba2\u6237\u7aef\u5e94\u7528\u7a0b\u5e8f\u53d1\u51fa\u7684\u5b9e\u9645\u67e5\u8be2\u548c\u547d\u4ee4\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6240\u6709\u8f6c\u4e49\u5e8f\u5217\u90fd\u662f\u6709\u6548\u7684\uff0c\u56e0\u6b64 <code>%q</code> \u5c06\u4e0d\u8d77\u4f5c\u7528\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_8","title":"\u81ea\u5b9a\u4e49\u65f6\u533a","text":"<p><code>log_timezone</code> \u53c2\u6570\u63a7\u5236\u7528\u4e8e\u8bb0\u5f55\u65f6\u95f4\u6233\u4fe1\u606f\u7684\u65f6\u533a\u3002Ubuntu \u4e2d\u7684\u9ed8\u8ba4\u503c\u662f Etc/UTC\uff0c\u5373 UTC \u65f6\u95f4\u3002\u5982\u679c\u60a8\u5e0c\u671b\u65f6\u95f4\u4e0e\u670d\u52a1\u5668\u65f6\u95f4\u76f8\u5bf9\u5e94\uff0c\u8bf7\u76f8\u5e94\u5730\u66f4\u6539\u6b64\u503c\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_timezone = 'Europe/Helsinki'\n</code></pre> <p>\u4f46\u662f\uff0c\u6211\u5efa\u8bae\u575a\u6301\u4f7f\u7528 UTC \u65f6\u95f4\uff0c\u4ee5\u4fbf\u4e8e\u65e5\u5fd7\u5173\u8054\u548c\u89c4\u8303\u5316\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#json","title":"JSON \u7ed3\u6784\u5316\u65e5\u5fd7","text":"<p>\u81ea 2008 \u5e74 2 \u6708\u53d1\u5e03 v8.3 \u4ee5\u6765\uff0cPostgreSQL \u5c31\u4e00\u76f4\u652f\u6301 CSV \u683c\u5f0f\u7684\u65e5\u5fd7\u8bb0\u5f55\uff0c\u4f46\u76f4\u5230\u6700\u8fd1\u5728 v15 \u7248\u672c\u4e2d\u624d\u652f\u6301 JSON\u3002\u60a8\u73b0\u5728\u53ef\u4ee5\u901a\u8fc7\u5c06 <code>jsonlog</code> \u6dfb\u52a0\u5230 <code>log_destination</code> \u53c2\u6570\u4e2d\u6765\u5c06 PostgreSQL \u65e5\u5fd7\u683c\u5f0f\u5316\u4e3a JSON \u683c\u5f0f\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_destination = 'stderr,jsonlog'\n</code></pre> <p>\u5f53\u60a8\u91cd\u65b0\u542f\u52a8\u670d\u52a1\u5668\u5e76\u67e5\u770b\u65e5\u5fd7\u76ee\u5f55\u65f6\uff0c\u60a8\u5c06\u89c2\u5bdf\u5230\u4e24\u4e2a\u5177\u6709\u76f8\u540c\u540d\u79f0\u4f46\u4e0d\u540c\u6269\u5c55\u540d\uff08<code>.log</code> \u548c <code>.json</code>\uff09\u7684\u65b0\u65e5\u5fd7\u6587\u4ef6\u3002\u8fd9\u4e9b\u6587\u4ef6\u5305\u542b\u76f8\u540c\u7684\u65e5\u5fd7\uff0c\u4f46\u683c\u5f0f\u4e0d\u540c\u3002<code>.log</code> \u6587\u4ef6\u4e0e\u4ee5\u524d\u4e00\u6837\u9075\u5faa <code>stderr</code> \u683c\u5f0f\uff0c\u800c <code>.json</code> \u6587\u4ef6\u53ef\u9884\u89c1\u5730\u5305\u542b JSON \u65e5\u5fd7\u3002</p> <p>\u4ee5\u4e0b\u662f\u5177\u6709\u76f8\u540c\u65e5\u5fd7\u7684\u4e24\u4e2a\u6587\u4ef6\u7684\u6bd4\u8f83\uff1a</p> /var/lib/postgresql/15/main/log/postgresql-Sun.log<pre><code>time=2023-07-30 22:48:01.817 UTC pid=18254 error=00000 sess_id=64c6e836.474e tag=idle usr=postgres db=chinook app=psql LOG:  statement: SHOW data_directory;\ntime=2023-07-30 22:49:21.808 UTC pid=18254 error=00000 sess_id=64c6e836.474e tag=idle usr=postgres db=chinook app=psql LOG:  statement: TABLE albu limit 10;\ntime=2023-07-30 22:49:21.808 UTC pid=18254 error=42P01 sess_id=64c6e836.474e tag=SELECT usr=postgres db=chinook app=psql ERROR:  relation \"albu\" does not exist at character 7\ntime=2023-07-30 22:49:21.808 UTC pid=18254 error=42P01 sess_id=64c6e836.474e tag=SELECT usr=postgres db=chinook app=psql STATEMENT:  TABLE albu limit 10;\n</code></pre> <p>\u8fd9\u4e9b\u65e5\u5fd7\u6839\u636e\u524d\u9762\u6f14\u793a\u7684 <code>log_line_prefix</code> \u53c2\u6570\u8fdb\u884c\u683c\u5f0f\u5316\u3002\u53e6\u4e00\u65b9\u9762\uff0cJSON \u65e5\u5fd7\u5305\u542b\u9664\u7a7a\u503c\u5b57\u6bb5\u4e4b\u5916\u7684\u6240\u6709\u53ef\u7528\u5b57\u6bb5\uff1a</p> /var/lib/postgresql/15/main/log/postgresql-Sun.json<pre><code>{\"timestamp\":\"2023-07-30 22:48:01.817 UTC\",\"user\":\"postgres\",\"dbname\":\"chinook\",\"pid\":18254,\"remote_host\":\"[local]\",\"session_id\":\"64c6e836.474e\",\"line_num\":1,\"ps\":\"idle\",\"session_start\":\"2023-07-30 22:46:14 UTC\",\"vxid\":\"4/3\",\"txid\":0,\"error_severity\":\"LOG\",\"message\":\"statement: SHOW data_directory;\",\"application_name\":\"psql\",\"backend_type\":\"client backend\",\"query_id\":0}\n{\"timestamp\":\"2023-07-30 22:49:21.808 UTC\",\"user\":\"postgres\",\"dbname\":\"chinook\",\"pid\":18254,\"remote_host\":\"[local]\",\"session_id\":\"64c6e836.474e\",\"line_num\":2,\"ps\":\"idle\",\"session_start\":\"2023-07-30 22:46:14 UTC\",\"vxid\":\"4/4\",\"txid\":0,\"error_severity\":\"LOG\",\"message\":\"statement: TABLE albu limit 10;\",\"application_name\":\"psql\",\"backend_type\":\"client backend\",\"query_id\":0}\n{\"timestamp\":\"2023-07-30 22:49:21.808 UTC\",\"user\":\"postgres\",\"dbname\":\"chinook\",\"pid\":18254,\"remote_host\":\"[local]\",\"session_id\":\"64c6e836.474e\",\"line_num\":3,\"ps\":\"SELECT\",\"session_start\":\"2023-07-30 22:46:14 UTC\",\"vxid\":\"4/4\",\"txid\":0,\"error_severity\":\"ERROR\",\"state_code\":\"42P01\",\"message\":\"relation \\\"albu\\\" does not exist\",\"statement\":\"TABLE albu limit 10;\",\"cursor_position\":7,\"application_name\":\"psql\",\"backend_type\":\"client backend\",\"query_id\":0}\n</code></pre> <p>\u654f\u9510\u7684\u89c2\u5bdf\u8005\u4f1a\u6ce8\u610f\u5230 <code>error=42P01</code> \u4e8b\u4ef6\u5728 <code>stderr</code> \u683c\u5f0f\u4e0b\u5305\u542b\u4e24\u4e2a\u65e5\u5fd7\u6761\u76ee\u3002\u4f46\u662f\uff0c\u540c\u4e00\u4e8b\u4ef6\u4ee5 JSON \u683c\u5f0f\u5219\u53ea\u51fa\u73b0\u5728\u5355\u4e2a\u65e5\u5fd7\u4e2d\u3002</p> <p>\u4ee5 JSON \u683c\u5f0f\u8bb0\u5f55\u65e5\u5fd7\u7684\u660e\u663e\u4f18\u52bf\u662f\u65e5\u5fd7\u53ef\u4ee5\u88ab\u65e5\u5fd7\u7ba1\u7406\u5de5\u5177\u81ea\u52a8\u89e3\u6790\u548c\u5206\u6790\u3002\u4f46\u662f\uff0c\u5b57\u6bb5\u65e0\u6cd5\u4ee5\u4efb\u4f55\u65b9\u5f0f\u8fdb\u884c\u81ea\u5b9a\u4e49\u3002\u60a8\u65e0\u6cd5\u6392\u9664\u5b57\u6bb5\u6216\u81ea\u5b9a\u4e49\u5176\u540d\u79f0\uff0c\u8fd9\u4e00\u70b9\u4e0e <code>stderr</code> \u683c\u5f0f\u4e0d\u540c\uff0c\u540e\u8005\u5728\u8fd9\u65b9\u9762\u66f4\u52a0\u7075\u6d3b\u3002\u5982\u679c\u60a8\u786e\u5b9e\u9700\u8981\u8fd9\u6837\u7684\u529f\u80fd\uff0c\u60a8\u53ef\u4ee5\u91c7\u7528\u65e5\u5fd7\u53d1\u9001\u5668\u6765\u8f6c\u6362\u65e5\u5fd7\uff0c\u7136\u540e\u518d\u5c06\u5176\u53d1\u9001\u5230\u6700\u7ec8\u76ee\u7684\u5730\u3002</p> <p>\u5176\u4f59\u793a\u4f8b\u5c06\u7ee7\u7eed\u4ee5 <code>stderr</code> \u683c\u5f0f\u663e\u793a\uff0c\u4f46\u4e3a\u4e86\u7b80\u6d01\u8d77\u89c1\uff0c\u4e0d\u663e\u793a <code>log_line_prefix</code>\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#postgresql_3","title":"\u5982\u4f55\u8bb0\u5f55 PostgreSQL \u67e5\u8be2","text":"<p><code>log_statement</code> \u53c2\u6570\u63a7\u5236\u5728\u670d\u52a1\u5668\u65e5\u5fd7\u6587\u4ef6\u4e2d\u8bb0\u5f55\u54ea\u4e9b SQL \u67e5\u8be2\u3002\u5176\u6709\u6548\u9009\u9879\u5982\u4e0b\uff1a</p> <ul> <li><code>none (default)</code>\uff1a\u4e0d\u8bb0\u5f55\u4efb\u4f55 SQL \u67e5\u8be2\u3002</li> <li><code>ddl</code>\uff1a\u4ec5\u8bb0\u5f55\u6570\u636e\u5b9a\u4e49\u8bed\u8a00\uff08DDL\uff09\u8bed\u53e5\uff0c\u4f8b\u5982\u4fee\u6539\u6570\u636e\u5e93\u67b6\u6784\u7684 <code>CREATE</code>\uff0c<code>ALTER</code>\uff0c\u548c <code>DROP</code> \u8bed\u53e5\u3002</li> <li><code>mod</code>\uff1a\u9664\u4e86 DDL \u8bed\u53e5\u4e4b\u5916\uff0c\u6b64\u503c\u8fd8\u8bb0\u5f55\u6570\u636e\u4fee\u6539\u8bed\u8a00 (DML) \u8bed\u53e5\uff0c\u4f8b\u5982 <code>INSERT</code>\u3001<code>UPDATE</code> \u548c <code>DELETE</code>\u3002</li> <li><code>all</code>\uff1a\u8bb0\u5f55\u5bf9\u670d\u52a1\u5668\u53d1\u51fa\u7684\u6240\u6709 SQL \u67e5\u8be2\uff0c\u9664\u4e86\u7531\u4e8e\u89e3\u6790\u9519\u8bef\u800c\u5728\u6267\u884c\u9636\u6bb5\u4e4b\u524d\u5931\u8d25\u7684\u67e5\u8be2\uff08\u53c2\u89c1 <code>log_min_error_statement</code>\uff09\u3002</li> </ul> /etc/postgresql/15/main/postgresql.conf<pre><code>log_statement = mod\n</code></pre> <p>\u5728\u751f\u4ea7\u4e2d\u4f7f\u7528 <code>all</code> \u8bbe\u7f6e\u5c06\u5728\u7e41\u5fd9\u7684\u7cfb\u7edf\u4e0a\u751f\u6210\u5927\u91cf\u6570\u636e\uff0c\u8fd9\u53ef\u80fd\u4f1a\u56e0\u5c06\u6bcf\u4e2a\u67e5\u8be2\u5199\u5165\u78c1\u76d8\u7684\u5f00\u9500\u800c\u964d\u4f4e\u6570\u636e\u5e93\u7684\u901f\u5ea6\u3002\u5982\u679c\u60a8\u8bb0\u5f55\u6240\u6709\u67e5\u8be2\u7684\u52a8\u673a\u662f\u4e3a\u4e86\u5ba1\u8ba1\uff0c\u8bf7\u8003\u8651\u4f7f\u7528 pgAudit\uff0c\u56e0\u4e3a\u5b83\u4e3a\u914d\u7f6e\u5ba1\u8ba1\u65e5\u5fd7\u63d0\u4f9b\u4e86\u66f4\u597d\u7684\u63a7\u5236\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_9","title":"\u8bb0\u5f55\u67e5\u8be2\u6301\u7eed\u65f6\u95f4","text":"<p>\u8bb0\u5f55\u67e5\u8be2\u65e5\u5fd7\u7684\u4e3b\u8981\u7528\u4f8b\u4e4b\u4e00\u662f\u8bc6\u522b\u9700\u8981\u4f18\u5316\u7684\u6162\u67e5\u8be2\u3002\u4f46\u662f\uff0c<code>log_statement</code> \u53c2\u6570\u4e0d\u4f1a\u5728\u5176\u8f93\u51fa\u4e2d\u8ddf\u8e2a\u67e5\u8be2\u6301\u7eed\u65f6\u95f4\u3002\u60a8\u9700\u8981\u4f7f\u7528 <code>log_duration</code> \u53c2\u6570\u6765\u5b9e\u73b0\u6b64\u76ee\u7684\u3002\u5b83\u662f\u4e00\u4e2a\u5e03\u5c14\u503c\uff0c\u8868\u793a\u5b83\u53ef\u4ee5\u662f\u5173\u95ed\uff08<code>0</code>\uff09\u6216\u6253\u5f00\uff08<code>1</code>\uff09\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_duration = 1\n</code></pre> <p>\u91cd\u542f\u670d\u52a1\u5668\u5e76\u518d\u6b21\u67e5\u770b\u65e5\u5fd7\uff08\u8bd1\u8005\u6ce8\uff1a\u8fd9\u91cc\u53ef\u4ee5\u76f4\u63a5\u91cd\u65b0\u52a0\u8f7d\u914d\u7f6e\u6587\u4ef6\u5373\u53ef\u751f\u6548\uff09\u3002\u60a8\u5e94\u8be5\u5f00\u59cb\u89c2\u5bdf\u5305\u542b\u4ee5\u6beb\u79d2\u4e3a\u5355\u4f4d\u7684\u6301\u7eed\u65f6\u95f4\u503c\u7684\u6761\u76ee\uff1a</p> <pre><code>LOG:  statement: UPDATE album SET title = 'Audioslave' WHERE albumid = 10;\nLOG:  duration: 18.498 ms\n</code></pre> <p>\u5f53\u6253\u5f00 <code>log_duration</code> \u65f6\uff0c\u670d\u52a1\u5668\u6267\u884c\u7684\u6240\u6709\u8bed\u53e5\u90fd\u4f1a\u751f\u6210\u6301\u7eed\u65f6\u95f4\u65e5\u5fd7\uff0c\u65e0\u4e00\u4f8b\u5916\uff08\u5373\u4f7f\u662f\u7b80\u5355\u7684 <code>SELECT 1</code>\uff09\u3002\u8fd9\u5c06\u4ea7\u751f\u5927\u91cf\u65e5\u5fd7\uff0c\u53ef\u80fd\u635f\u5bb3\u6027\u80fd\u5e76\u4e0d\u5fc5\u8981\u5730\u6d88\u8017\u78c1\u76d8\u7a7a\u95f4\u3002</p> <p><code>log_duration</code> \u7684\u53e6\u4e00\u4e2a\u95ee\u9898\u662f\u5b83\u53d6\u51b3\u4e8e <code>log_statement</code> \u53c2\u6570\uff0c\u60a8\u53ef\u80fd\u4e0d\u77e5\u9053\u54ea\u4e2a\u67e5\u8be2\u4ea7\u751f\u4e86\u6301\u7eed\u65f6\u95f4\u65e5\u5fd7\u3002\u4e3a\u4e86\u6d4b\u8bd5\u8fd9\u4e00\u70b9\uff0c\u8bf7\u5c06 <code>log_statement</code> \u8bbe\u7f6e\u4e3a <code>ddl</code>\uff0c\u5e76\u4fdd\u6301 <code>log_duration</code> \u5904\u4e8e\u542f\u7528\u72b6\u6001\u3002\u91cd\u65b0\u542f\u52a8\u670d\u52a1\u5668\u5e76\u5728 <code>psql</code> \u4e2d\u8f93\u5165\u4ee5\u4e0b\u67e5\u8be2\uff1a</p> <pre><code>UPDATE album SET title = 'Audioslave' WHERE albumid = 10;\n</code></pre> <p>\u67e5\u8be2\u6210\u529f\u5b8c\u6210\u540e\uff0c\u60a8\u5c06\u770b\u5230\u4ee5\u4e0b\u65e5\u5fd7\uff1a</p> <pre><code>LOG:  duration: 13.492 ms\n</code></pre> <p>\u81f3\u5173\u91cd\u8981\u7684\u662f\uff0c\u4ea7\u751f\u8be5\u65e5\u5fd7\u7684\u8bed\u53e5\u6839\u672c\u6ca1\u6709\u88ab\u8bb0\u5f55\u4e0b\u6765\uff0c\u8fd9\u4f7f\u5f97\u5b83\u5b9e\u9645\u4e0a\u6beb\u65e0\u7528\u5904\u3002\u5982\u679c\u5fc5\u987b\u4f7f\u7528 <code>log_duration</code>\uff0c\u8bf7\u786e\u4fdd <code>log_statement</code> \u4e5f\u8bbe\u7f6e\u4e3a <code>all</code>\uff0c\u4ee5\u4fbf\u6bcf\u4e2a\u6301\u7eed\u65f6\u95f4\u65e5\u5fd7\u90fd\u53ef\u4ee5\u4e0e\u751f\u6210\u5b83\u7684\u8bed\u53e5\u76f8\u5173\u8054\u3002</p> <p>\u53e6\u4e00\u79cd\u65b9\u6cd5\u662f\u5173\u95ed <code>log_duration</code> \u5e76\u542f\u7528 <code>log_min_duration_statement</code>\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_duration = 0\nlog_min_duration_statement = 0\n</code></pre> <p><code>log_min_duration_statement</code> \u53c2\u6570\u4e0d\u662f\u5e03\u5c14\u503c\u3002\u5b83\u63a5\u53d7\u4ee5\u6beb\u79d2\u4e3a\u5355\u4f4d\u7684\u6574\u6570\u503c\uff0c\u5e76\u4e3a\u6267\u884c\u65f6\u95f4\u8d85\u8fc7\u6307\u5b9a\u503c\u7684\u67e5\u8be2\u751f\u6210\u65e5\u5fd7\u3002\u5f53\u5b83\u88ab\u8bbe\u7f6e\u4e3a <code>0</code>\uff08\u5982\u4e0a\u6240\u8ff0\uff09\u65f6\uff0c\u6240\u6709\u5df2\u5b8c\u6210\u8bed\u53e5\u7684\u6301\u7eed\u65f6\u95f4\u90fd\u4f1a\u88ab\u8bb0\u5f55\u3002</p> <p>\u5e94\u7528\u4e0a\u9762\u66f4\u65b0\u7684\u914d\u7f6e\u5e76\u91cd\u65b0\u542f\u52a8 PostgreSQL \u670d\u52a1\u5668\uff0c\u4fdd\u6301 <code>log_statement</code> \u5904\u4e8e <code>ddl</code> \u6a21\u5f0f\u3002\u4e4b\u540e\uff0c\u91cd\u590d <code>UPDATE</code> \u67e5\u8be2\u3002\u60a8\u5e94\u8be5\u89c2\u5bdf\u5230\u5982\u4e0b\u6240\u793a\u7684\u6301\u7eed\u65f6\u95f4\u65e5\u5fd7\uff1a</p> <pre><code>LOG:  duration: 13.504 ms  statement: UPDATE album SET title = 'Audioslave' WHERE albumid = 10;\n</code></pre> <p>\u8fd9\u662f\u5bf9 <code>log_duration</code> \u8f93\u51fa\u7684\u6539\u8fdb\uff0c\u56e0\u4e3a\u4ea7\u751f\u6301\u7eed\u65f6\u95f4\u65e5\u5fd7\u7684\u67e5\u8be2\u662f\u53ef\u89c1\u7684\u3002</p> <p>\u4f46\u4ecd\u7136\u5b58\u5728\u4e00\u4e2a\u5f31\u70b9\uff0c\u90a3\u5c31\u662f\u60a8\u65e0\u6cd5\u5728\u67e5\u8be2\u5b8c\u6210\u4e4b\u524d\u5728\u65e5\u5fd7\u6587\u4ef6\u4e2d\u770b\u5230\u8be5\u67e5\u8be2\u3002\u5982\u679c\u670d\u52a1\u5668\u5728\u67e5\u8be2\u5b8c\u6210\u4e4b\u524d\u5d29\u6e83\uff0c\u60a8\u5c06\u4e0d\u77e5\u9053\u5d29\u6e83\u4e4b\u524d\u6b63\u5728\u8fd0\u884c\u54ea\u4e9b\u67e5\u8be2\uff0c\u56e0\u4e3a\u6ca1\u6709\u8bb0\u5f55\u3002</p> <p>\u4f46\u662f\uff0c\u5982\u679c\u67e5\u8be2\u751f\u6210\u81ea\u5df1\u7684\u65e5\u5fd7\uff0c\u65e5\u5fd7\u8bb0\u5f55\u884c\u4e3a\u5c31\u4f1a\u53d1\u751f\u53d8\u5316\u3002\u8981\u89c2\u5bdf\u8fd9\u4e00\u70b9\uff0c\u8bf7\u5c06 <code>log_statement</code> \u66f4\u6539\u4e3a <code>all</code>\uff0c\u7136\u540e\u91cd\u65b0\u542f\u52a8\u670d\u52a1\u5668\u3002\u5728 <code>psql</code> \u4e2d\u8fd0\u884c <code>SELECT pg_sleep(5)</code> \u5e76\u89c2\u5bdf\u65e5\u5fd7\u3002</p> <p>\u60a8\u5e94\u8be5\u7acb\u5373\u770b\u5230\u4ee5\u4e0b\u884c\uff1a</p> <pre><code>LOG:  statement: SELECT pg_sleep(5);\n</code></pre> <p>\u4e94\u79d2\u949f\u540e\uff0c\u4f1a\u51fa\u73b0\u4e0b\u9762\u4e00\u884c\uff1a</p> <pre><code>LOG:  duration: 5005.975 ms\n</code></pre> <p>\u901a\u8fc7\u8fd9\u79cd\u914d\u7f6e\uff0c\u5982\u679c\u5728\u4e94\u79d2\u949f\u8fc7\u53bb\u4e4b\u524d\u53d1\u751f\u95ee\u9898\uff0c\u60a8\u81f3\u5c11\u4f1a\u77e5\u9053\u54ea\u4e9b\u67e5\u8be2\u53ef\u80fd\u5728\u4e8b\u4ef6\u4e2d\u53d1\u6325\u4e86\u4f5c\u7528\u3002</p> <p>PostgreSQL \u6587\u6863\u5efa\u8bae\u60a8\u5728 <code>log_line_prefix</code> \u4e2d\u5305\u542b\u8fdb\u7a0b\u548c\u4f1a\u8bdd ID\uff0c\u4ee5\u4fbf\u60a8\u5728\u8bfb\u53d6\u548c\u5206\u6790\u65e5\u5fd7\u65f6\u53ef\u4ee5\u8f7b\u677e\u5173\u8054\u4e24\u4e2a\u65e5\u5fd7\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_10","title":"\u8bb0\u5f55\u6162\u67e5\u8be2","text":"<p>\u8bb0\u5f55\u670d\u52a1\u5668\u4e0a\u6240\u6709\u67e5\u8be2\u7684\u6301\u7eed\u65f6\u95f4\u5fc5\u7136\u4f1a\u4f7f\u60a8\u7684\u65e5\u5fd7\u6587\u4ef6\u5145\u65a5\u7740\u5927\u91cf\u6ca1\u6709\u591a\u5927\u4ef7\u503c\u7684\u7410\u788e\u65e5\u5fd7\u3002\u4ec5\u8bb0\u5f55\u8fd0\u884c\u7f13\u6162\u7684\u67e5\u8be2\u66f4\u6709\u7528\uff0c\u4ee5\u4fbf\u53ef\u4ee5\u76f8\u5e94\u5730\u8c03\u67e5\u548c\u4f18\u5316\u5b83\u4eec\u3002\u7531\u4e8e\u8bb0\u5f55\u7684\u65e5\u5fd7\u91cf\u5c06\u5927\u5e45\u51cf\u5c11\uff0c\u56e0\u6b64\u5b83\u8fd8\u53ef\u4ee5\u51cf\u8f7b PostgreSQL \u670d\u52a1\u5668\u7684\u538b\u529b\u3002</p> <p>\u6162\u67e5\u8be2\u7684\u4ea7\u751f\u663e\u7136\u662f\u53d6\u51b3\u4e8e\u5e94\u7528\u7a0b\u5e8f\u7684\u7c7b\u578b\u548c\u5177\u4f53\u7684\u5de5\u4f5c\u8d1f\u8f7d\u3002\u786e\u4fdd\u4f7f\u7528\u4e00\u4e2a\u53ef\u4ee5\u6355\u83b7\u53ef\u80fd\u5bfc\u81f4\u6027\u80fd\u74f6\u9888\u7684\u8d44\u6e90\u5bc6\u96c6\u578b\u67e5\u8be2\u7684\u503c\u3002\u8fde\u63a5\u5927\u578b\u8868\u3001\u6267\u884c\u590d\u6742\u8ba1\u7b97\u6216\u6d89\u53ca\u9012\u5f52\u7684\u67e5\u8be2\u662f\u9700\u8981\u76d1\u63a7\u7684\u4e3b\u8981\u5019\u9009\u5bf9\u8c61\u3002</p> <p>\u5bf9\u4e8e\u4ea4\u4e92\u5f0f\u5e94\u7528\u7a0b\u5e8f\u6765\u8bf4\uff0c\u51e0\u767e\u6beb\u79d2\u7684\u9608\u503c\u53ef\u80fd\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u8d77\u70b9\uff0c\u7136\u540e\u60a8\u53ef\u4ee5\u968f\u65f6\u8fdb\u884c\u8c03\u6574\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_min_duration_statement = 250\n</code></pre> <p>\u4f7f\u7528\u6b64\u914d\u7f6e\uff0c\u53ea\u6709\u6267\u884c\u65f6\u95f4\u8d85\u8fc7\u6307\u5b9a\u503c\uff08250ms\uff09\u7684\u67e5\u8be2\u624d\u4f1a\u88ab\u8bb0\u5f55\u3002\u4f8b\u5982\uff1a</p> <pre><code>SELECT pg_sleep(1);\n</code></pre> Output<pre><code>LOG:  statement: SELECT pg_sleep(1);\nLOG:  duration: 1013.675 ms\n</code></pre>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#postgresql_4","title":"PostgreSQL \u4e2d\u7684\u6d88\u606f\u4e25\u91cd\u6027\u7ea7\u522b","text":"<p>PostgreSQL \u4f7f\u7528\u4ee5\u4e0b\u65e5\u5fd7\u7ea7\u522b\u6765\u8868\u660e\u5176\u751f\u6210\u7684\u6bcf\u4e2a\u65e5\u5fd7\u8bb0\u5f55\u7684\u4e25\u91cd\u6027\uff1a</p> <ul> <li><code>DEBUG5</code>\uff0c<code>DEBUG4</code>\uff0c<code>DEBUG3</code>\uff0c<code>DEBUG2</code>\uff0c<code>DEBUG1</code>\uff1a\u8fd9\u4e9b\u7ea7\u522b\u7528\u4e8e\u8bb0\u5f55\u5bf9\u6545\u969c\u6392\u9664\u6709\u7528\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u5176\u4e2d <code>DEBUG5</code> \u662f\u6700\u8be6\u7ec6\u7684\uff0c\u800c <code>DEBUG1</code> \u662f\u6700\u4e0d\u8be6\u7ec6\u7684\u3002</li> <li><code>INFO</code>\uff1a\u62a5\u544a\u7528\u6237\u9690\u5f0f\u8bf7\u6c42\u7684\u4fe1\u606f\u3002</li> <li><code>NOTICE</code>\uff1a\u62a5\u544a\u53ef\u80fd\u5bf9\u7528\u6237\u6709\u5e2e\u52a9\u7684\u8be6\u7ec6\u4fe1\u606f\u3002</li> <li><code>WARNING</code>\uff1a\u8b66\u544a\u6f5c\u5728\u95ee\u9898\uff0c\u4f8b\u5982\u5728\u4e8b\u52a1\u5757\u4e4b\u5916\u4f7f\u7528 <code>COMMIT</code>\u3002</li> <li><code>ERROR</code>\uff1a\u62a5\u544a\u4e2d\u6b62\u5f53\u524d\u547d\u4ee4\u7684\u9519\u8bef\u3002</li> <li><code>LOG</code>\uff1a\u62a5\u544a\u4e00\u822c\u6570\u636e\u5e93\u6d3b\u52a8\u3002</li> <li><code>FATAL</code>\uff1a\u62a5\u544a\u4e2d\u6b62\u5f53\u524d\u4f1a\u8bdd\u4f46\u5176\u4ed6\u4f1a\u8bdd\u4fdd\u6301\u6d3b\u52a8\u72b6\u6001\u7684\u9519\u8bef\u3002</li> <li><code>PANIC</code>\uff1a\u62a5\u544a\u4e2d\u6b62\u6240\u6709\u73b0\u6709\u6570\u636e\u5e93\u4f1a\u8bdd\u7684\u4e25\u91cd\u9519\u8bef\u3002</li> </ul> <p>\u4ee5\u4e0b\u662f\u6807\u6709\u5404\u4e2a\u4e25\u91cd\u6027\u7ea7\u522b\u7684\u6d88\u606f\u7684\u793a\u4f8b\uff1a</p> <pre><code>DEBUG:  server process (PID 13557) exited with exit code 0\nINFO:  vacuuming \"chinook.public.album\"\nNOTICE:  identifier \"very_very_very_very_very_very_very_very_long_table_name_with_more_than_63_characters\" will be truncated to \"very_very_very_very_very_very_very_very_long_table_name_with_mo\"\nWARNING:  SET LOCAL can only be used in transaction blocks\nLOG:  statement: UPDATE album SET title = 'Audioslave' WHERE albumid = 10;\nERROR:  relation \"albu\" does not exist at character 7\nFATAL:  role \"root\" does not exist\nPANIC: database system shutdown requested\n</code></pre> <p>\u9ed8\u8ba4\u65e5\u5fd7\u7ea7\u522b\u901a\u8fc7 <code>log_min_messages</code> \u8bbe\u7f6e\u8bbe\u7f6e\u4e3a <code>WARNING</code>\uff0c\u6211\u5efa\u8bae\u4fdd\u6301\u8fd9\u79cd\u72b6\u6001\u3002</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_min_messages = warning\n</code></pre>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_11","title":"\u51cf\u5c11\u65e5\u5fd7\u8be6\u7ec6\u7a0b\u5ea6","text":"<p>PostgreSQL \u5141\u8bb8\u60a8\u901a\u8fc7 <code>log_error_verbosity</code> \u8bbe\u7f6e\u6765\u63a7\u5236\u4e8b\u4ef6\u65e5\u5fd7\u7684\u8be6\u7ec6\u7a0b\u5ea6\uff0c\u4e0e\u5176\u540d\u79f0\u6240\u6697\u793a\u7684\u4e0d\u540c\uff0c\u8be5\u8bbe\u7f6e\u9002\u7528\u4e8e\u6bcf\u6761\u5df2\u8bb0\u5f55\u7684\u6d88\u606f\u3002\u53ef\u80fd\u7684\u503c\u5305\u62ec <code>terse</code>\u3001<code>default</code> \u548c <code>verbose</code>\u3002</p> <p>\u4f7f\u7528 <code>default</code> \u8bbe\u7f6e\uff0c\u60a8\u5c06\u770b\u5230\u67d0\u4e9b\u67e5\u8be2\u5e26\u6709\u989d\u5916\u7684 <code>DETAIL</code>\u3001<code>HINT</code>\u3001<code>QUERY</code> \u6216 <code>CONTEXT</code> \u4fe1\u606f\u3002</p> <pre><code>LOG:  statement: DROP table album;\nERROR:  cannot drop table album because other objects depend on it\nDETAIL:  constraint fk_trackalbumid on table track depends on table album\nHINT:  Use DROP ... CASCADE to drop the dependent objects too.\nSTATEMENT:  DROP table album;\n</code></pre> <p>\u6b64\u5904\u6240\u6709\u4e94\u4e2a\u6761\u76ee\u5747\u7531\u540c\u4e00\u67e5\u8be2\u4ea7\u751f\u3002\u5982\u679c <code>log_error_verbosity</code> \u8bbe\u7f6e\u4e3a <code>terse</code>\uff0c\u5219\u4f1a\u5220\u9664 <code>DETAIL</code> \u548c <code>HINT</code> \u884c\u3002\u9009\u9879 <code>verbose</code> \u5219\u5c06\u5305\u62ec <code>default</code> \u7684\u6240\u6709\u5185\u5bb9\u4ee5\u53ca\u6709\u5173\u9519\u8bef\u7684\u66f4\u4f4e\u7ea7\u8be6\u7ec6\u4fe1\u606f\uff0c\u4f8b\u5982\u5176\u6e90\u4ee3\u7801\u6587\u4ef6\u540d\u3001\u51fd\u6570\u540d\u79f0\u548c\u884c\u53f7\uff1a</p> <pre><code>LOCATION:  reportDependentObjects, dependency.c:1189\n</code></pre> <p>\u8bf7\u6ce8\u610f\uff0c\u5982\u679c\u60a8\u4ee5 JSON \u683c\u5f0f\u8bb0\u5f55\u65e5\u5fd7\uff0c\u5219 <code>DETAIL</code>\u3001<code>HINT</code> \u548c <code>STATEMENT</code> \u5c06\u5305\u542b\u5728\u540c\u4e00\u4e2a\u65e5\u5fd7\u6761\u76ee\u4e2d\uff0c\u5e76\u4e14 <code>LOCATION</code> \u5c06\u5206\u4e3a <code>func_name</code>\u3001<code>file_name</code> \u548c <code>file_line_num</code> \u5c5e\u6027\uff1a</p> <pre><code>{\"timestamp\":\"2023-08-03 15:56:26.988 UTC\",\"user\":\"postgres\",\"dbname\":\"chinook\",\"pid\":14155,\"remote_host\":\"[local]\",\"session_id\":\"64cbce27.374b\",\"line_num\":5,\"ps\":\"DROP TABLE\",\"session_start\":\"2023-08-03 15:56:23 UTC\",\"vxid\":\"3/8\",\"txid\":16414,\"error_severity\":\"ERROR\",\"state_code\":\"2BP01\",\"message\":\"cannot drop table album because other objects depend on it\",\"detail\":\"constraint fk_trackalbumid on table track depends on table album\",\"hint\":\"Use DROP ... CASCADE to drop the dependent objects too.\",\"statement\":\"DROP table album;\",\"func_name\":\"reportDependentObjects\",\"file_name\":\"dependency.c\",\"file_line_num\":1189,\"application_name\":\"psql\",\"backend_type\":\"client backend\",\"query_id\":0}\n</code></pre>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_12","title":"\u8bb0\u5f55\u8fde\u63a5\u548c\u65ad\u5f00\u8fde\u63a5","text":"<p>\u4ee5\u4e0b\u8bbe\u7f6e\u63a7\u5236 PostgreSQL \u5982\u4f55\u8bb0\u5f55\u5ba2\u6237\u7aef\u8fde\u63a5\u548c\u65ad\u5f00\u8fde\u63a5\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u8fd9\u4e24\u9879\u5747\u5904\u4e8e\u5173\u95ed\u72b6\u6001\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_connections = off\nlog_disconnections = off\n</code></pre> <p>\u5f00\u542f <code>log_connections (1)</code> \u5c06\u8bb0\u5f55\u6bcf\u6b21\u5c1d\u8bd5\u8fde\u63a5\u5230\u670d\u52a1\u5668\u4ee5\u53ca\u5ba2\u6237\u7aef\u8eab\u4efd\u9a8c\u8bc1\u548c\u6388\u6743\u7684\u5b8c\u6210\u60c5\u51b5\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_connections = 1\n</code></pre> <p><pre><code>LOG:  connection received: host=[local]\nLOG:  connection authenticated: identity=\"postgres\" method=peer (/etc/postgresql/15/main/pg_hba.conf:90)\nLOG:  connection authorized: user=postgres database=chinook application_name=psql\n</code></pre> \u4ece\u5b89\u5168\u89d2\u5ea6\u6765\u770b\uff0c\u8fd9\u4e9b\u4fe1\u606f\u5f88\u6709\u7528\uff0c\u56e0\u4e3a\u60a8\u53ef\u4ee5\u770b\u5230\u8c01\u5728\u8fde\u63a5\u5230\u60a8\u7684\u7cfb\u7edf\u4ee5\u53ca\u4ece\u54ea\u91cc\u8fde\u63a5\u3002\u5982\u679c\u4e0e\u670d\u52a1\u5668\u6709\u591a\u4e2a\u77ed\u6682\u7684\u8fde\u63a5\u5e76\u4e14\u672a\u4f7f\u7528\u8fde\u63a5\u6c60\uff0c\u5219\u4f1a\u5bfc\u81f4\u5927\u91cf\u65e5\u5fd7\u3002</p> <p><code>log_disconnections</code> \u53c2\u6570\u7684\u5de5\u4f5c\u539f\u7406\u7c7b\u4f3c\uff0c\u5b83\u5305\u62ec\u4f1a\u8bdd\u6301\u7eed\u65f6\u95f4\uff1a</p> /etc/postgresql/15/main/postgresql.conf<pre><code>log_disconnections = 1\n</code></pre> <pre><code>LOG:  disconnection: session time: 0:00:02.824 user=postgres database=chinook host=[local]\n</code></pre>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_13","title":"\u521b\u5efa\u81ea\u5b9a\u4e49\u65e5\u5fd7\u6d88\u606f","text":"<p>\u5230\u76ee\u524d\u4e3a\u6b62\uff0c\u6211\u4eec\u5df2\u7ecf\u8ba8\u8bba\u4e86 PostgreSQL \u670d\u52a1\u5668\u751f\u6210\u7684\u5404\u79cd\u7c7b\u578b\u7684\u65e5\u5fd7\u4ee5\u53ca\u5982\u4f55\u5b9a\u5236\u5b83\u4eec\u3002\u5982\u679c\u60a8\u60f3\u5728 SQL \u67e5\u8be2\u4e2d\u6216\u5728\u4f7f\u7528 PL/pgSQL \u7f16\u5199\u89e6\u53d1\u51fd\u6570\u65f6\u521b\u5efa\u81ea\u5df1\u7684\u65e5\u5fd7\u6d88\u606f\uff0c\u60a8\u53ef\u4ee5\u6309\u5982\u4e0b\u65b9\u5f0f\u4f7f\u7528 RAISE \u8bed\u53e5\uff1a</p> <pre><code>CREATE OR REPLACE FUNCTION custom_logs_func()\nRETURNS TRIGGER LANGUAGE PLPGSQL AS $$\nBEGIN\n    RAISE LOG 'This is an informational message';\n    RAISE WARNING 'Something unexpected happened';\n    RAISE EXCEPTION 'An unexpected error';\nEND;\n$$;\n\nCREATE OR REPLACE TRIGGER UPDATE_LAST_EDITED_TIME BEFORE UPDATE ON ALBUM\nFOR EACH ROW EXECUTE FUNCTION custom_logs_func();\n</code></pre> <p>\u6839\u636e\u60a8\u7684 <code>log_min_messages</code> \u8bbe\u7f6e\uff0c\u5728\u6267\u884c <code>custom_logs_func()</code> \u65f6\uff0c\u60a8\u5c06\u5728\u65e5\u5fd7\u6587\u4ef6\u4e2d\u89c2\u5bdf\u5230\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <pre><code>LOG:  This is an informational message\nWARNING:  Something unexpected happened\nERROR:  An unexpected error\n</code></pre>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#pgbadger","title":"\u4f7f\u7528 PgBadger \u5206\u6790\u65e5\u5fd7\u6587\u4ef6","text":"<p>PgBadger \u662f PostgreSQL \u65e5\u5fd7\u6587\u4ef6\u7684\u547d\u4ee4\u884c\u65e5\u5fd7\u5206\u6790\u5de5\u5177\u3002\u5b83\u65e8\u5728\u89e3\u6790\u548c\u5206\u6790 PostgreSQL \u65e5\u5fd7\u6587\u4ef6\uff0c\u63d0\u53d6\u6709\u4ef7\u503c\u7684\u89c1\u89e3\u5e76\u751f\u6210\u6709\u5173\u6570\u636e\u5e93\u6d3b\u52a8\u3001\u6027\u80fd\u548c\u4f7f\u7528\u6a21\u5f0f\u7684\u8be6\u7ec6\u62a5\u544a\u3002\u5b83\u53ef\u4ee5\u751f\u6210\u5305\u542b\u5927\u91cf\u7edf\u8ba1\u6570\u636e\u7684\u7efc\u5408 HTML \u62a5\u544a\uff0c\u4f8b\u5982\uff1a</p> <ul> <li>\u89e3\u6790\u548c\u5904\u7406\u7684\u65e5\u5fd7\u6761\u76ee\u603b\u6570\u3002</li> <li>\u6700\u6162\u7684\u67e5\u8be2\u53ca\u5176\u6267\u884c\u65f6\u95f4\u3002</li> <li>\u968f\u65f6\u95f4\u53d8\u5316\u7684\u8fde\u63a5\u6570\u3002</li> <li>\u6700\u5e38\u89c1\u7684\u9519\u8bef\u6d88\u606f\u53ca\u5176\u53d1\u751f\u7684\u6b21\u6570\u3002</li> <li>\u4e8b\u52a1\u7684\u63d0\u4ea4\u548c\u56de\u6eda\u7edf\u8ba1\u4fe1\u606f\u3002</li> <li>\u4e34\u65f6\u6587\u4ef6\u4f7f\u7528\u7387\u6700\u9ad8\u7684\u8868\u3002</li> <li>\u67e5\u8be2\u548c\u4f1a\u8bdd\u6301\u7eed\u65f6\u95f4\u7684\u76f4\u65b9\u56fe\u3002</li> <li>\u6d89\u53ca\u70ed\u95e8\u67e5\u8be2\u7684\u7528\u6237\u548c\u5e94\u7528\u7a0b\u5e8f\u3002</li> <li>\u6700\u8017\u65f6\u7684 <code>prepare</code>/<code>bind</code> \u67e5\u8be2\u3002</li> <li>\u81ea\u52a8\u6e05\u7406\u8fdb\u7a0b\u7684\u6570\u91cf\u53ca\u5176\u6267\u884c\u65f6\u95f4\u3002</li> <li>\u4ee5\u53ca\u66f4\u591a\uff01</li> </ul> <p>\u5b89\u88c5 <code>pgbadger</code> \u540e\uff0c\u8bf7\u67e5\u770b\u5176\u63a8\u8350\u7684\u65e5\u5fd7\u914d\u7f6e\u8bbe\u7f6e\uff0c\u5e76\u5728 PostgreSQL \u914d\u7f6e\u6587\u4ef6\u4e2d\u8fdb\u884c\u76f8\u5e94\u7684\u914d\u7f6e\u3002\u8bf7\u6ce8\u610f\uff0c\u8fd9\u4e9b\u8bbe\u7f6e\u662f\u4e3a\u4e86\u4ea7\u751f\u5c3d\u53ef\u80fd\u591a\u7684\u4fe1\u606f\uff0c\u4ee5\u4fbf pgBadger \u53ef\u4ee5\u6709\u6548\u5730\u5206\u6790\u6570\u636e\u5e93\u6d3b\u52a8\u3002</p> <p>\u8be5\u5de5\u5177\u63d0\u4f9b\u4e86\u8bb8\u591a\u9009\u9879\uff0c\u4f46\u751f\u6210 HTML \u62a5\u544a\u7684\u6700\u57fa\u672c\u8bbe\u7f6e\u662f\u63d0\u4f9b\u914d\u7f6e\u7684\u65e5\u5fd7\u884c\u524d\u7f00\u3001\u65e5\u5fd7\u6587\u4ef6\u4ee5\u53ca\u62a5\u544a\u7684\u6240\u9700\u540d\u79f0/\u4f4d\u7f6e\u3002\u5728\u64b0\u5199\u672c\u6587\u65f6\uff0c\u5b83\u4ec5\u9002\u7528\u4e8e <code>stderr</code> \u548c CSV \u683c\u5f0f\uff0c\u4f46\u4e0d\u9002\u7528\u4e8e JSON\u3002</p> <pre><code>$ sudo pgbadger --prefix 'time=%m pid=%p error=%e sess_id=%c %qtag=%i usr=%u db=%d app=%a ' /var/lib/postgresql/15/main/log/postgresql-Thu.log -o postgresql.html\n</code></pre> Output<pre><code>[========================&gt;] Parsed 289019 bytes of 289019 (100.00%), queries: 102, events: 42\nLOG: Ok, generating html report...\n</code></pre> <p>\u5f53\u60a8\u5728\u6d4f\u89c8\u5668\u4e2d\u6253\u5f00 HTML \u6587\u4ef6\u65f6\uff0c\u60a8\u5e94\u8be5\u4f1a\u770b\u5230\u5982\u4e0b\u62a5\u544a\uff1a</p> <p></p> <p>\u8bf7\u53c2\u9605 PgBadger \u7f51\u7ad9\u4e0a\u7684\u793a\u4f8b\u53ca\u5176\u6587\u6863\u4ee5\u4e86\u89e3\u66f4\u591a\u8be6\u7ec6\u4fe1\u606f\u3002</p>"},{"location":"2024/10/06/postgresql-%E6%97%A5%E5%BF%97%E6%82%A8%E9%9C%80%E8%A6%81%E7%9F%A5%E9%81%93%E7%9A%84%E4%B8%80%E5%88%87/#_14","title":"\u603b\u7ed3","text":"<p>\u5982\u679c\u914d\u7f6e\u6b63\u786e\uff0cPostgreSQL \u65e5\u5fd7\u662f\u6df1\u5165\u4e86\u89e3\u6570\u636e\u5e93\u6d3b\u52a8\u548c\u6027\u80fd\u7684\u6709\u6548\u65b9\u6cd5\u3002\u8fd9\u4e5f\u8bb8\u4e0d\u662f\u4e00\u4ef6\u5149\u9c9c\u7684\u4e8b\u60c5\uff0c\u4f46\u575a\u6301\u4e0b\u53bb\u80af\u5b9a\u4f1a\u83b7\u5f97\u56de\u62a5\u3002\u6b63\u786e\u8bbe\u7f6e\u53ef\u80fd\u9700\u8981\u4e00\u4e9b\u53cd\u590d\u8bd5\u9a8c\uff0c\u4f46\u6211\u5e0c\u671b\u672c\u6587\u80fd\u4e3a\u60a8\u6307\u660e\u6b63\u786e\u7684\u65b9\u5411\u3002</p> <p>\u4f5c\u8005\uff1aAyooluwa Isaiah \u539f\u6587\uff1ahttps://betterstack.com/community/guides/logging/how-to-start-logging-with-postgresql/</p>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/","title":"\u7a7a\u95f2\u4e8b\u52a1\u5bfc\u81f4\u8868\u81a8\u80c0\uff1f\u7b49\u7b49\uff0c\u8fd9\u662f\u4ec0\u4e48\u610f\u601d\uff1f","text":"<p>\u662f\u7684\uff0c\u60a8\u6ca1\u6709\u770b\u9519\u3002\u7a7a\u95f2\u4e8b\u52a1\u53ef\u80fd\u4f1a\u5bfc\u81f4\u4e25\u91cd\u7684\u8868\u81a8\u80c0\uff0c\u800c\u6e05\u7406\u8fdb\u7a0b\u53ef\u80fd\u65e0\u6cd5\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\u3002\u81a8\u80c0\u4f1a\u5bfc\u81f4\u6027\u80fd\u4e0b\u964d\uff0c\u5e76\u4e14\u53ef\u80fd\u968f\u7740\u6b7b\u5143\u7ec4\u7684\u7d2f\u79ef\u5360\u7528\u8d8a\u6765\u8d8a\u591a\u7684\u78c1\u76d8\u7a7a\u95f4\u3002</p> <p>\u672c\u6587\u6df1\u5165\u5206\u6790\u4e86\u7a7a\u95f2\u4e8b\u52a1\u5982\u4f55\u5bfc\u81f4\u8868\u81a8\u80c0\u3001\u4e3a\u4ec0\u4e48\u8fd9\u4f1a\u5e26\u6765\u95ee\u9898\u4ee5\u53ca\u907f\u514d\u8fd9\u79cd\u60c5\u51b5\u7684\u5b9e\u7528\u7b56\u7565\u3002</p>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#_2","title":"\u4ec0\u4e48\u662f\u8868\u81a8\u80c0","text":"<p>\u5f53\u672a\u4f7f\u7528\u6216\u8fc7\u65f6\u7684\u6570\u636e\uff08\u5373\u6b7b\u4ea1\u5143\u7ec4\uff09\u5728\u8868\u548c\u7d22\u5f15\u4e2d\u79ef\u7d2f\u65f6\uff0c\u5c31\u4f1a\u53d1\u751f PostgreSQL \u4e2d\u7684\u8868\u81a8\u80c0\u3002PostgreSQL \u4f7f\u7528\u591a\u7248\u672c\u5e76\u53d1\u63a7\u5236\uff08Multi-Version Concurrency Control, MVCC\uff09\u673a\u5236\u6765\u7ef4\u62a4\u6570\u636e\u4e00\u81f4\u6027\u3002\u6bcf\u6b21\u66f4\u65b0\u6216\u5220\u9664\u90fd\u4f1a\u521b\u5efa\u8bb0\u5f55\u7684\u65b0\u7248\u672c\uff0c\u540c\u65f6\u4fdd\u7559\u65e7\u7248\u672c\uff0c\u76f4\u5230\u901a\u8fc7\u81ea\u52a8\u6e05\u7406\u8fc7\u7a0b\u6216\u624b\u52a8\u6e05\u7406\u5c06\u5176\u6e05\u7406\u5e72\u51c0\u3002</p> <p>\u5f53\u8fd9\u4e9b\u6b7b\u4ea1\u5143\u7ec4\u5806\u79ef\u8d77\u6765\u5e76\u4e14\u6ca1\u6709\u88ab\u6e05\u7406\uff0c\u8868\u548c\u7d22\u5f15\u7684\u5927\u5c0f\u589e\u52a0\u65f6\uff0c\u81a8\u80c0\u5c31\u4f1a\u6210\u4e3a\u95ee\u9898\u3002\u8868\u8d8a\u5927\uff0c\u67e5\u8be2\u901f\u5ea6\u8d8a\u6162\uff0c\u5bfc\u81f4\u6570\u636e\u5e93\u6027\u80fd\u4e0b\u964d\u548c\u5b58\u50a8\u6210\u672c\u589e\u52a0\u3002</p>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#_3","title":"\u7a7a\u95f2\u4e8b\u52a1\u5982\u4f55\u5bfc\u81f4\u8868\u81a8\u80c0","text":"<p>PostgreSQL \u4e2d\u7684\u7a7a\u95f2\u4e8b\u52a1\u662f\u8fde\u63a5\u5230\u6570\u636e\u5e93\u4f46\u5e76\u672a\u4e3b\u52a8\u53d1\u51fa\u67e5\u8be2\u7684\u4f1a\u8bdd\u3002\u7a7a\u95f2\u4e8b\u52a1\u6709\u4e24\u79cd\u4e3b\u8981\u72b6\u6001\uff1a</p> <ol> <li>Idle: \u8fde\u63a5\u5df2\u7ecf\u5efa\u7acb\uff0c\u4f46\u6ca1\u6709\u8fd0\u884c\u4e8b\u52a1\u3002</li> <li>Idle in Transaction: \u4e8b\u52a1\u5df2\u7ecf\u6253\u5f00\uff08\u4f8b\u5982\uff0c\u901a\u8fc7 <code>BEGIN</code> \u8bed\u53e5\uff09\uff0c\u4f46\u5c1a\u672a\u63d0\u4ea4\u6216\u56de\u6eda\u3002</li> </ol> <p>\u8bd1\u8005\u6ce8</p> <p>\u4e2a\u4eba\u89c9\u5f97\u8fd9\u79cd\u8bf4\u6cd5\u4e0d\u592a\u51c6\u786e\uff0cPostgreSQL \u4e2d\u5bf9\u7a7a\u95f2\u4e8b\u52a1\u548c\u7a7a\u95f2\u4f1a\u8bdd\u662f\u6709\u660e\u786e\u533a\u5206\u7684\uff0c\u5bf9\u4e8e\u4e0a\u9762\u7684\u7b2c\u4e00\u79cd\u60c5\u51b5\u6765\u8bf4\u4e0d\u80fd\u7b97\u662f\u7a7a\u95f2\u4e8b\u52a1\u3002</p>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#1-autovacuum","title":"1. Autovacuum \u963b\u585e","text":"<p>Autovacuum \u662f PostgreSQL \u4e2d\u8d1f\u8d23\u6e05\u7406\u6b7b\u4ea1\u5143\u7ec4\u5e76\u56de\u6536\u7a7a\u95f4\u7684\u8fdb\u7a0b\u3002\u4f46\u662f\uff0cAutovacuum \u65e0\u6cd5\u5220\u9664\u5bf9\u4e8e\u6253\u5f00\u7684\u4e8b\u52a1\u6765\u8bf4\u4ecd\u7136\u53ef\u89c1\u7684\u6b7b\u4ea1\u5143\u7ec4\u3002\u5f53\u4e8b\u52a1\u5904\u4e8e <code>idle in transaction</code> \u72b6\u6001\u65f6\uff0c\u5b83\u4fdd\u7559\u4e86\u6570\u636e\u5e93\u7684\u5feb\u7167\uff0c\u4ece\u800c\u9632\u6b62\u5220\u9664\u53ef\u80fd\u4ecd\u9700\u8981\u8bbf\u95ee\u7684\u5143\u7ec4\u3002</p> <p>\u4f8b\u5982\uff1a</p> <ul> <li>\u8868\u66f4\u65b0\u65f6\u4ea7\u751f\u4e86\u6b7b\u4ea1\u5143\u7ec4\u3002</li> <li>Autovacuum \u88ab\u89e6\u53d1\u4f46\u65e0\u6cd5\u5220\u9664\u8fd9\u4e9b\u5143\u7ec4\uff0c\u56e0\u4e3a\u7a7a\u95f2\u4e8b\u52a1\u4fdd\u7559\u7740\u5f15\u7528\u5b83\u4eec\u7684\u5feb\u7167\u3002</li> <li>\u6b7b\u4ea1\u5143\u7ec4\u4ecd\u7136\u5b58\u5728\uff0c\u5bfc\u81f4\u8868\u81a8\u80c0\u3002</li> </ul>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#2","title":"2. \u957f\u671f\u8fd0\u884c\u7684\u7a7a\u95f2\u4e8b\u52a1","text":"<p>\u957f\u65f6\u95f4\u5b58\u5728\u7684\u7a7a\u95f2\u4e8b\u52a1\u6613\u4f7f\u95ee\u9898\u66f4\u52a0\u4e25\u91cd\u3002\u8fd9\u4e9b\u4e8b\u52a1\u6301\u6709\u9501\u6216\u5feb\u7167\uff0c\u963b\u6b62 autovacuum \u7684\u81ea\u52a8\u6e05\u7406\u6d41\u7a0b\uff0c\u751a\u81f3\u963b\u6b62 VACUUM \u7684\u624b\u52a8\u6e05\u7406\u6d41\u7a0b\u3002\u8fd9\u4f1a\u4ea7\u751f\u8fde\u9501\u53cd\u5e94\uff1a</p> <ul> <li>\u6b7b\u4ea1\u5143\u7ec4\u4e0d\u65ad\u7d2f\u79ef\u3002</li> <li>\u7531\u4e8e PostgreSQL \u5fc5\u987b\u626b\u63cf\u81a8\u80c0\u7684\u8868\uff0c\u56e0\u6b64\u67e5\u8be2\u6027\u80fd\u4e0b\u964d\u3002</li> <li>\u5b58\u50a8\u4f7f\u7528\u91cf\u4e0d\u5fc5\u8981\u7684\u589e\u52a0\u3002</li> </ul>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#3","title":"3. \u9501\u4e89\u7528","text":"<p>\u7a7a\u95f2\u4e8b\u52a1\u8fd8\u53ef\u4ee5\u9501\u5b9a\u8868\uff0c\u4ece\u800c\u963b\u6b62\u5176\u4ed6\u4e8b\u52a1\u6709\u6548\u5730\u5b8c\u6210\u63d2\u5165\u3001\u66f4\u65b0\u6216\u5220\u9664\u64cd\u4f5c\u3002\u5982\u679c\u4e8b\u52a1\u88ab\u8feb\u91cd\u8bd5\u6216\u8005\u88ab\u5ef6\u8fdf\uff0c\u8fd9\u79cd\u9501\u4e89\u7528\u53ef\u80fd\u4f1a\u5bfc\u81f4\u66f4\u591a\u7684\u6b7b\u4ea1\u5143\u7ec4\u3002</p>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#4","title":"4. \u7d22\u5f15\u81a8\u80c0","text":"<p>\u6b7b\u4ea1\u5143\u7ec4\u4e0d\u4ec5\u5f71\u54cd\u8868\uff0c\u8fd8\u5f71\u54cd\u7d22\u5f15\u3002\u5f53\u5143\u7ec4\u88ab\u66f4\u65b0\u6216\u5220\u9664\u65f6\uff0c\u76f8\u5e94\u7684\u7d22\u5f15\u6761\u76ee\u88ab\u6807\u8bb0\u4e3a\u65e0\u6548\uff0c\u4f46\u4e0d\u4f1a\u7acb\u5373\u88ab\u5220\u9664\u3002\u7a7a\u95f2\u4e8b\u52a1\u53ef\u80fd\u4f1a\u5ef6\u8fdf\u8fd9\u79cd\u6e05\u7406\uff0c\u5bfc\u81f4\u7d22\u5f15\u81a8\u80c0\uff0c\u4ece\u800c\u964d\u4f4e\u67e5\u8be2\u6027\u80fd\u3002</p>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#_4","title":"\u4e3a\u4ec0\u4e48\u7a7a\u95f2\u4e8b\u52a1\u4f1a\u5e26\u6765\u95ee\u9898","text":"<p>\u7a7a\u95f2\u4e8b\u52a1\u9664\u4e86\u4f1a\u5bfc\u81f4\u8868\u81a8\u80c0\u4e4b\u5916\uff0c\u8fd8\u4f1a\u5bfc\u81f4\u4e00\u7cfb\u5217\u95ee\u9898\uff1a</p> <ol> <li>\u8d44\u6e90\u6d6a\u8d39\uff1a<ul> <li>\u81a8\u80c0\u4e4b\u540e\u7684\u8868\u4f1a\u5360\u7528\u66f4\u591a\u7684\u78c1\u76d8\u7a7a\u95f4\u548c\u5185\u5b58\uff0c\u4ece\u800c\u589e\u52a0\u6210\u672c\u3002</li> <li>\u8f83\u5927\u7684\u8868\u9700\u8981\u66f4\u591a\u7684 I/O\uff0c\u4ece\u800c\u5bfc\u81f4\u67e5\u8be2\u901f\u5ea6\u53d8\u6162\u3002</li> </ul> </li> <li>\u6027\u80fd\u4e0b\u964d\uff1a<ul> <li>\u968f\u7740\u6570\u636e\u5e93\u626b\u63cf\u81a8\u80c0\u7684\u8868\u548c\u7d22\u5f15\uff0c\u67e5\u8be2\u6267\u884c\u65f6\u95f4\u4f1a\u589e\u52a0\u3002</li> <li>autovacuum \u548c analyze \u7b49\u7ef4\u62a4\u4efb\u52a1\u9700\u8981\u66f4\u957f\u65f6\u95f4\u624d\u80fd\u5b8c\u6210\u3002</li> </ul> </li> <li>\u589e\u52a0\u4e8b\u52a1 ID \u73af\u7ed5\u7684\u98ce\u9669\uff1a<ul> <li>\u5728 PostgreSQL \u4e2d\uff0c\u4e8b\u52a1 ID\uff08XID\uff09\u73af\u7ed5\u662f\u56e0\u4e3a\u4e8b\u52a1 ID \u5b58\u50a8\u4e3a 32 \u4f4d\u6574\u6570\uff0c\u8fd9\u610f\u5473\u7740\u5b83\u4eec\u5728\u5927\u7ea6 20 \u4ebf\u6b21\u4e8b\u52a1\u540e\u6700\u7ec8\u4f1a\u201c\u56de\u7ed5\u201d\u3002\u5982\u679c\u4e0d\u901a\u8fc7\u5e38\u89c4 <code>VACUUM</code> \u64cd\u4f5c\u89e3\u51b3\u6b64\u95ee\u9898\uff0c\u8fd9\u53ef\u80fd\u4f1a\u5bfc\u81f4\u6570\u636e\u635f\u574f\uff0c\u56e0\u4e3a\u65e7\u884c\u4f1a\u53d8\u5f97\u4e0d\u53ef\u89c1\u6216\u65b0\u7684\u4e8b\u52a1\u65e0\u6cd5\u7ee7\u7eed\u3002</li> </ul> </li> <li>\u5173\u952e\u64cd\u4f5c\u53d7\u963b\uff1a<ul> <li>\u7531\u4e8e\u7a7a\u95f2\u4e8b\u52a1\u6301\u6709\u7684\u9501\u6216\u5feb\u7167\uff0c\u624b\u52a8\u6e05\u7406\u6216\u7ef4\u62a4\u4efb\u52a1\u53ef\u80fd\u4f1a\u5931\u8d25\u3002</li> </ul> </li> </ol>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#_5","title":"\u5982\u4f55\u907f\u514d\u7a7a\u95f2\u4e8b\u52a1\u5e76\u9632\u6b62\u8868\u81a8\u80c0","text":"<p>\u5e78\u8fd0\u7684\u662f\uff0c\u901a\u8fc7\u4e3b\u52a8\u76d1\u63a7\u3001\u914d\u7f6e\u548c\u5e94\u7528\u7a0b\u5e8f\u8bbe\u8ba1\u53ef\u4ee5\u907f\u514d\u7a7a\u95f2\u4e8b\u52a1\u548c\u7531\u6b64\u5bfc\u81f4\u7684\u81a8\u80c0\u3002\u4ee5\u4e0b\u662f\u4e00\u4e9b\u7b56\u7565\uff1a</p>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#1","title":"1. \u76d1\u63a7\u7a7a\u95f2\u4e8b\u52a1","text":"<p>\u7b2c\u4e00\u6b65\u662f\u8bc6\u522b\u5904\u4e8e <code>idle</code> \u548c <code>idle in transaction</code> \u7684\u4f1a\u8bdd\u3002\u4f7f\u7528\u4ee5\u4e0b\u67e5\u8be2\u6765\u67e5\u627e\u5b83\u4eec\uff1a</p> <pre><code>SELECT\u00a0\n\u00a0\u00a0\u00a0\u00a0pid,\u00a0\n\u00a0\u00a0\u00a0\u00a0usename AS username,\u00a0\n\u00a0\u00a0\u00a0\u00a0state,\u00a0\n\u00a0\u00a0\u00a0\u00a0state_change,\u00a0\n\u00a0\u00a0\u00a0\u00a0query\nFROM\u00a0\n\u00a0\u00a0\u00a0\u00a0pg_stat_activity\nWHERE\u00a0\n\u00a0\u00a0\u00a0\u00a0state IN ('idle', 'idle in transaction');\n</code></pre> <ul> <li>state\uff1a\u663e\u793a\u4e8b\u52a1\u662f\u5426\u5904\u4e8e\u7a7a\u95f2\u6216\u7a7a\u95f2\u4e8b\u52a1\u72b6\u6001\u3002</li> <li>state_change\uff1a\u6307\u793a\u4e8b\u52a1\u4f55\u65f6\u8fdb\u5165\u5176\u5f53\u524d\u72b6\u6001\u3002</li> </ul> <p>\u4f7f\u7528\u6b64\u4fe1\u606f\u6765\u8bc6\u522b\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u7a7a\u95f2\u4f1a\u8bdd\u5e76\u91c7\u53d6\u7ea0\u6b63\u63aa\u65bd\u3002</p>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#2_1","title":"2. \u8bbe\u7f6e\u7a7a\u95f2\u4e8b\u52a1\u8d85\u65f6","text":"<p>PostgreSQL \u63d0\u4f9b\u4e86 <code>idle_in_transaction_session_timeout</code> \u53c2\u6570\u6765\u81ea\u52a8\u7ec8\u7ed3\u7a7a\u95f2\u65f6\u95f4\u8fc7\u957f\u7684\u4e8b\u52a1\u3002\u8fd9\u53ef\u4ee5\u9632\u6b62\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u7a7a\u95f2\u4e8b\u52a1\u6301\u6709\u9501\u548c\u5feb\u7167\u3002</p> <p>\u5728 <code>postgresql.conf</code> \u4e2d\u5168\u5c40\u8bbe\u7f6e\u6b64\u53c2\u6570\uff1a</p> <pre><code>idle_in_transaction_session_timeout = '5min'\n</code></pre> <p>\u6216\u8005\u5c06\u5176\u5e94\u7528\u4e8e\u7279\u5b9a\u89d2\u8272\u6216\u6570\u636e\u5e93\uff1a</p> <pre><code>ALTER ROLE my_user SET idle_in_transaction_session_timeout = '5min';\nALTER DATABASE my_database SET idle_in_transaction_session_timeout = '5min';\n</code></pre> <p>\u5f53\u8fbe\u5230\u6b64\u8d85\u65f6\u65f6\uff0cPostgreSQL \u4f1a\u81ea\u52a8\u7ec8\u6b62\u7a7a\u95f2\u4e8b\u52a1\u5e76\u629b\u51fa\u9519\u8bef\u3002</p>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#3_1","title":"3. \u4f7f\u7528\u8fde\u63a5\u6c60","text":"<p>\u4f7f\u7528 PgBouncer \u6216 Pgpool-II \u7b49\u8fde\u63a5\u6c60\u6765\u7ba1\u7406\u548c\u9650\u5236\u4e0e\u6570\u636e\u5e93\u7684\u8fde\u63a5\u6570\u3002\u8fde\u63a5\u6c60\u53ef\u786e\u4fdd\uff1a</p> <ul> <li>\u8fde\u63a5\u88ab\u6709\u6548\u5730\u91cd\u590d\u5229\u7528\u3002</li> <li>\u7a7a\u95f2\u4f1a\u8bdd\u4e0d\u4f1a\u4e0d\u5fc5\u8981\u5730\u4fdd\u6301\u6253\u5f00\u72b6\u6001\u3002</li> <li>\u8be5\u5e94\u7528\u7a0b\u5e8f\u4ec5\u5728\u9700\u8981\u65f6\u6253\u5f00\u4e8b\u52a1\u3002</li> </ul>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#4_1","title":"4. \u4f18\u5316\u5e94\u7528\u903b\u8f91","text":"<p>\u5927\u591a\u6570\u7a7a\u95f2\u4e8b\u52a1\u90fd\u662f\u7531\u4e0d\u826f\u7684\u5e94\u7528\u7a0b\u5e8f\u8bbe\u8ba1\u5f15\u8d77\u7684\u3002\u786e\u4fdd\u60a8\u7684\u5e94\u7528\u7a0b\u5e8f\uff1a</p> <ul> <li>\u5b8c\u6210\u4e8b\u52a1\u540e\u59cb\u7ec8\u7acb\u5373\u53d1\u51fa <code>COMMIT</code> \u6216 <code>ROLLBACK</code>\u3002</li> <li>\u907f\u514d\u4e0d\u5fc5\u8981\u5730\u542f\u52a8\u4e8b\u52a1\uff08\u4f8b\u5982\uff0c\u907f\u514d\u5728\u6ca1\u6709\u7acb\u5373\u67e5\u8be2\u7684\u60c5\u51b5\u4e0b\u542f\u52a8 <code>BEGIN</code>\uff09\u3002</li> <li>\u4e0d\u4f7f\u7528\u65f6\u5173\u95ed\u6570\u636e\u5e93\u8fde\u63a5\u3002</li> </ul>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#5-autovacuum","title":"5. \u4f18\u5316 Autovacuum","text":"<p>\u867d\u7136\u7a7a\u95f2\u4e8b\u52a1\u4f1a\u963b\u6b62\u81ea\u52a8\u6e05\u7406\uff0c\u4f46\u8c03\u6574\u81ea\u52a8\u6e05\u7406\u53c2\u6570\u53ef\u786e\u4fdd\u66f4\u79ef\u6781\u5730\u89e6\u53d1\u6e05\u7406\u3002\u8bf7\u8003\u8651\u4ee5\u4e0b\u8c03\u6574\uff1a</p> <ul> <li>autovacuum_vacuum_threshold\uff1a\u964d\u4f4e\u8be5\u503c\u53ef\u4ee5\u66f4\u5feb\u5730\u89e6\u53d1\u6e05\u7406\u3002</li> <li>autovacuum_vacuum_scale_factor\uff1a\u51cf\u5c11\u6b64\u503c\u4ee5\u6839\u636e\u8f83\u5c0f\u767e\u5206\u6bd4\u7684\u66f4\u65b0\u884c\u89e6\u53d1\u6e05\u7406\u3002\u8fd9\u4e0e\u4e0a\u8ff0\u53c2\u6570\u4e00\u8d77\u4f7f\u7528\uff0c\u4ee5\u786e\u4fdd\u8868\u683c\u6309\u5176\u5927\u5c0f\u6210\u6bd4\u4f8b\u5904\u7406\u3002</li> </ul> <p>\u4f8b\u5982\uff1a</p> <pre><code>ALTER TABLE my_table SET (\n    autovacuum_vacuum_threshold = 50,\n    autovacuum_vacuum_scale_factor = 0.1\n);\n</code></pre>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#6","title":"6. \u4f7f\u7528\u76d1\u63a7\u5de5\u5177","text":"<p>\u5229\u7528 PostgreSQL \u76d1\u63a7\u89c6\u56fe\uff08\u5982 <code>pg_stat_activity</code>\u3001<code>pg_stat_user_tables</code>\uff09\u6216\u7b2c\u4e09\u65b9\u5de5\u5177\uff08\u5982 pgAdmin \u6216 pgBadger\uff09\u6765\u8ddf\u8e2a\u7a7a\u95f2\u4e8b\u52a1\u548c\u8868\u968f\u65f6\u95f4\u7684\u81a8\u80c0\u3002</p>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#7","title":"7. \u7ec8\u6b62\u6709\u95ee\u9898\u7684\u4f1a\u8bdd","text":"<p>\u5982\u679c\u9700\u8981\uff0c\u60a8\u53ef\u4ee5\u624b\u52a8\u7ec8\u6b62\u963b\u6b62\u5173\u952e\u64cd\u4f5c\u7684\u7a7a\u95f2\u4e8b\u52a1\u3002\u4f7f\u7528\u4ee5\u4e0b\u67e5\u8be2\u7ec8\u6b62\u7a7a\u95f2\u4e8b\u52a1\uff1a</p> <pre><code>SELECT pg_terminate_backend(pid)\nFROM pg_stat_activity\nWHERE state = 'idle in transaction'\nAND state_change &lt; NOW() - INTERVAL '10 minutes';\n</code></pre>"},{"location":"2025/01/17/idle-transactions-cause-table-bloat-wait-what/#_6","title":"\u603b\u7ed3","text":"<p>\u7a7a\u95f2\u4e8b\u52a1\u4e4d\u4e00\u770b\u4f3c\u4e4e\u65e0\u5bb3\uff0c\u4f46\u5b83\u4eec\u53ef\u80fd\u4f1a\u5bfc\u81f4\u8868\u81a8\u80c0\u3001\u963b\u585e\u7ef4\u62a4\u4efb\u52a1\u5e76\u4e0d\u5fc5\u8981\u5730\u6d88\u8017\u8d44\u6e90\uff0c\u4ece\u800c\u6084\u6084\u5bfc\u81f4\u4e25\u91cd\u7684\u6027\u80fd\u95ee\u9898\u3002\u901a\u8fc7\u76d1\u63a7\u3001\u8d85\u65f6\u548c\u5e94\u7528\u7a0b\u5e8f\u4f18\u5316\u4e3b\u52a8\u7ba1\u7406\u7a7a\u95f2\u4e8b\u52a1\u5bf9\u4e8e\u7ef4\u62a4\u9ad8\u6027\u80fd PostgreSQL \u6570\u636e\u5e93\u81f3\u5173\u91cd\u8981\u3002</p> <p>\u901a\u8fc7\u91c7\u7528\u8fd9\u4e9b\u6700\u4f73\u5b9e\u8df5\uff0c\u60a8\u53ef\u4ee5\u9632\u6b62\u7a7a\u95f2\u4e8b\u52a1\u5bf9\u6570\u636e\u5e93\u9020\u6210\u4e25\u91cd\u7834\u574f\uff0c\u5e76\u786e\u4fdd\u7cfb\u7edf\u5e72\u51c0\u3001\u9ad8\u6548\u4e14\u53ef\u6269\u5c55\u3002\u4e0d\u8981\u8ba9\u7a7a\u95f2\u4e8b\u52a1\u6210\u4e3a PostgreSQL \u6027\u80fd\u7684\u65e0\u58f0\u6740\u624b\u2014\u2014\u7acb\u5373\u91c7\u53d6\u884c\u52a8\uff0c\u4fdd\u6301\u6570\u636e\u5e93\u7684\u5065\u5eb7\u548c\u9ad8\u6027\u80fd\u3002</p> <p>\u4f5c\u8005\uff1aUmair Shahid \u539f\u6587\uff1ahttps://stormatics.tech/blogs/idle-transactions-cause-table-bloat-wait-what</p>"},{"location":"2024/12/13/postgresql-%E4%B8%AD-bgwriter_lru_multiplier-%E5%92%8C-checkpoint_completion_target-%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7/","title":"PostgreSQL \u4e2d <code>bgwriter_lru_multiplier</code> \u548c <code>checkpoint_completion_target</code> \u7684\u91cd\u8981\u6027","text":"<p>\u8fd9\u4e9b\u53c2\u6570\u5728\u7ba1\u7406 bgwriter \u548c checkpoint \u64cd\u4f5c\u8d77\u7740\u81f3\u5173\u91cd\u8981\u7684\u4f5c\u7528\u3002\u4ee5\u4e0b\u662f\u5b83\u4eec\u7684\u5de5\u4f5c\u539f\u7406\u5e76\u53ef\u4ee5\u901a\u8fc7\u793a\u4f8b\u8fdb\u884c\u8ba1\u7b97\uff1a</p>"},{"location":"2024/12/13/postgresql-%E4%B8%AD-bgwriter_lru_multiplier-%E5%92%8C-checkpoint_completion_target-%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7/#bgwriter_lru_multiplier","title":"<code>bgwriter_lru_multiplier</code>","text":"<ul> <li> <p>\u76ee\u6807\uff1a</p> <ul> <li>\u63a7\u5236 bgwriter \u8fdb\u7a0b\u5c1d\u8bd5\u7ef4\u62a4\u53ef\u91cd\u7528\u7f13\u51b2\u533a\u7684\u79ef\u6781\u7a0b\u5ea6\u3002</li> <li>\u5982\u679c\u53ef\u7528\u7a7a\u95f4\u4e0d\u8db3\uff0cbgwriter \u8fdb\u7a0b\u5c06\u5c1d\u8bd5\u5237\u5199\u66f4\u591a\u7684\u7f13\u51b2\u533a\uff0c\u5e76\u4e14\u8be5\u53c2\u6570\u51b3\u5b9a\u5b83\u5c06\u6e05\u7406\u591a\u5c11\u4e2a\u989d\u5916\u7684\u7f13\u51b2\u533a\u3002</li> </ul> </li> <li> <p>\u5de5\u4f5c\u539f\u7406\uff1a</p> <ul> <li>bgwriter \u8fdb\u7a0b\u6839\u636e\u5f53\u524d\u7f13\u51b2\u533a\u4f7f\u7528\u60c5\u51b5\u8ba1\u7b97\u6bcf\u8f6e\u5e94\u8be5\u5237\u5199\u591a\u5c11\u4e2a\u7f13\u51b2\u533a\u3002</li> <li>\u8be5\u8ba1\u7b97\u5c06\u8003\u8651\u9700\u8981\u5237\u5199\u7684\u7f13\u51b2\u533a\u6570\u636e\u5e76\u4e58\u4ee5 <code>bgwriter_lru_multiplier</code> \u4ee5\u51b3\u5b9a\u603b\u5171\u9700\u8981\u5237\u5199\u7684\u7f13\u51b2\u533a\u6570\u91cf\u3002</li> </ul> </li> <li> <p>\u8ba1\u7b97\u793a\u4f8b\uff1a</p> <ul> <li>\u5047\u8bbe\u60a8\u6709\u5982\u4e0b\u914d\u7f6e\uff1a<ul> <li><code>bgwriter_lru_maxpages = 1000</code></li> <li><code>bgwriter_lru_multiplier = 2.0</code></li> <li>\u7cfb\u7edf\u4f30\u8ba1\u9700\u8981\u6e05\u7406 500 \u4e2a\u7f13\u51b2\u533a\u6765\u7ef4\u62a4\u7a7a\u95f2\u7f13\u51b2\u6c60\u3002</li> </ul> </li> </ul> </li> </ul> <p>bgwriter \u8fdb\u7a0b\u5c06\u5c1d\u8bd5\u5237\u5199\u7684\u7f13\u51b2\u533a\uff1a</p> <pre><code>buffers_to_write = estimated_needed_buffers * bgwriter_lru_multiplier\n  = 500 * 2.0\n  = 1000 buffers\n\n# \u5982\u679c `bgwriter_lru_maxpages = 1000`\uff0c\u90a3\u4e48\u5728\u6bcf\u4e00\u8f6e\u4e2d\uff0cbgwriter \u8fdb\u7a0b\u5c06\u5c1d\u8bd5\u6700\u591a\n# \u5237\u5199 1000 \u4e2a\u7f13\u51b2\u533a\uff0c\u4e0e\u5141\u8bb8\u7684\u6700\u5927\u9875\u9762\u6570\u4fdd\u6301\u4e00\u81f4\u3002\n</code></pre>"},{"location":"2024/12/13/postgresql-%E4%B8%AD-bgwriter_lru_multiplier-%E5%92%8C-checkpoint_completion_target-%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7/#checkpoint_completion_target","title":"<code>checkpoint_completion_target</code>","text":"<ul> <li> <p>\u76ee\u6807\uff1a</p> <ul> <li>\u786e\u5b9a checkpoint \u5e94\u5206\u5e03\u5728 <code>checkpoint_timeout</code> \u7684\u6bd4\u4f8b\u3002</li> <li>\u901a\u8fc7\u5199\u5165\u64cd\u4f5c\u5206\u6563\u5230\u8f83\u957f\u7684\u65f6\u95f4\u6bb5\u5185\uff08\u800c\u975e\u4e00\u6b21\u6027\u5199\u5165\uff09\u6765\u7f13\u89e3 I/O \u538b\u529b\u3002</li> </ul> </li> <li> <p>\u5de5\u4f5c\u539f\u7406\uff1a</p> <ul> <li>\u503c\u8d8a\u9ad8\u610f\u5473\u7740 checkpoint \u7684 I/O \u64cd\u4f5c\u5728 <code>checkpoint_timeout</code> \u5468\u671f\u5185\u5206\u5e03\u8d8a\u5747\u5300\u3002</li> <li>checkpoint \u5199\u5165\u7684\u5b9e\u9645\u6301\u7eed\u65f6\u95f4\u4e3a <code>checkpoint_timeout * checkpoint_completion_target</code>\u3002</li> </ul> </li> <li> <p>\u8ba1\u7b97\u793a\u4f8b\uff1a</p> <ul> <li>\u5047\u8bbe\u60a8\u6709\u5982\u4e0b\u914d\u7f6e\uff1a<ul> <li><code>checkpoint_timeout = 15 minutes</code></li> <li><code>checkpoint_completion_target = 0.9</code></li> </ul> </li> </ul> </li> </ul> <p>Checkpoint \u76ee\u6807\u5b8c\u6210\u65f6\u95f4\u4e3a\uff1a</p> <pre><code>target_duration = checkpoint_timeout * checkpoint_completion_target\n  = 15 minutes * 0.9\n  = 13.5 minutes\n\n# \u8fd9\u610f\u5473\u7740 PostgreSQL \u5c06\u5c1d\u8bd5\u5c06 checkpoint \u5199\u5165\u5206\u6563\u5230 13.5 \u5206\u949f\u5185\uff0c\u4ee5\u51cf\u5c11 I/O \u5f71\u54cd\u3002\n</code></pre>"},{"location":"2024/12/13/postgresql-%E4%B8%AD-bgwriter_lru_multiplier-%E5%92%8C-checkpoint_completion_target-%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7/#_1","title":"\u793a\u4f8b\u914d\u7f6e","text":"<p>\u6700\u5dee\u914d\u7f6e\uff1a</p> <pre><code># Background Writer Parameters\nbgwriter_delay = 200ms\nbgwriter_lru_maxpages = 10\nbgwriter_lru_multiplier = 1.0\n\n# Checkpointer Parameters\ncheckpoint_timeout = 5min\ncheckpoint_completion_target = 0.5\nmax_wal_size = 1GB\nmin_wal_size = 80MB\n\n# \u95ee\u9898\uff1a bgwriter \u6bcf\u8f6e\u5199\u5165\u7684\u9875\u9762\u592a\u5c11\uff0810 \u9875\uff09\uff0c\u5bfc\u81f4 backend \u5199\u5165\u6d3b\u52a8\u9891\u7e41\u3002\n# checkpoint \u8fc7\u4e8e\u9891\u7e41\uff08\u6bcf 5 \u5206\u949f\u4e00\u6b21\uff09\uff0c\u5b8c\u6210\u901f\u5ea6\u5feb\uff082.5 \u5206\u949f\u5185\uff09\uff0c\u5bfc\u81f4 I/O \u5cf0\u503c\u3002\n</code></pre> <p>\u6539\u8fdb\u7684\u914d\u7f6e\uff1a</p> <pre><code># Background Writer Parameters\nbgwriter_delay = 100ms\nbgwriter_lru_maxpages = 1000\nbgwriter_lru_multiplier = 2.0\n\n# Checkpointer Parameters\ncheckpoint_timeout = 15min\ncheckpoint_completion_target = 0.9\nmax_wal_size = 4GB\nmin_wal_size = 1GB\n\n# \u6536\u76ca\uff1abgwriter \u6bcf\u8f6e\u5199\u5165\u6700\u5927\u53ef\u5230 1000 \u9875\uff0c\u5e76\u5c1d\u8bd5\u7ef4\u62a4\u66f4\u5927\u7684\u53ef\u91cd\u7528\u7f13\u51b2\u533a\uff08\u8ba1\u7b97\u7ed3\u679c\u4e3a 2000\uff09\u3002\n# checkpoint \u7684\u9891\u7387\u66f4\u4f4e\uff0c\u65f6\u95f4\u66f4\u957f\uff0813.5 \u5206\u949f\uff09\uff0c\u4ece\u800c\u964d\u4f4e\u4e86 I/O \u5cf0\u503c\u3002\n</code></pre>"},{"location":"2024/12/13/postgresql-%E4%B8%AD-bgwriter_lru_multiplier-%E5%92%8C-checkpoint_completion_target-%E7%9A%84%E9%87%8D%E8%A6%81%E6%80%A7/#_2","title":"\u603b\u7ed3","text":"<p>\u5408\u7406\u7684\u8c03\u6574 <code>bgwriter_lru_multiplier</code> \u548c <code>checkpoint_completion_target</code> \u5bf9\u4e8e\u5e73\u8861 PostgreSQL \u7684\u6027\u80fd\u548c\u7a33\u5b9a\u6027\u81f3\u5173\u91cd\u8981\u3002</p> <p><code>bgwriter_lru_multiplier</code> \u6709\u52a9\u4e8e\u786e\u5b9a bgwriter \u6e05\u7406\u7f13\u51b2\u533a\u7684\u79ef\u6781\u7a0b\u5ea6\uff0c\u800c <code>checkpoint_completion_target</code> \u53ef\u786e\u4fdd checkpoint \u5206\u6563\u4ee5\u6700\u5927\u9650\u5ea6\u5730\u51cf\u5c11 I/O \u5cf0\u503c\u3002</p> <p>\u6839\u636e\u60a8\u7684\u5de5\u4f5c\u8d1f\u8f7d\u548c\u7cfb\u7edf\u529f\u80fd\u4f18\u5316\u8fd9\u4e9b\u53c2\u6570\uff0c\u60a8\u53ef\u4ee5\u5b9e\u73b0\u66f4\u9ad8\u6548\u3001\u54cd\u5e94\u66f4\u5feb\u7684 PostgreSQL \u73af\u5883\u3002</p> <p>\u4f5c\u8005\uff1aSheikh Wasiu Al Hasib \u539f\u6587\uff1ahttps://medium.com/@wasiualhasib/importance-of-bgwriter-lru-multiplier-and-checkpoint-completion-target-in-postgresql-79cf76fc04d3</p>"},{"location":"2025/02/06/index-scan-doesnt-mean-its-fast/","title":"\u7d22\u5f15\u626b\u63cf\u5e76\u4e0d\u610f\u5473\u7740\u9ad8\u6548","text":"<p>\u6211\u7ecf\u5e38\u770b\u5230\u4eba\u4eec\u5728\u67e5\u770b\u6267\u884c\u8ba1\u5212\u65f6\u5ffd\u7565\u7684\u4e00\u4e2a\u95ee\u9898\uff1a\u4ed6\u4eec\u7684\u6240\u6709\u626b\u63cf\u90fd\u6d89\u53ca\u5230\u7d22\u5f15\uff0c\u56e0\u6b64\u4ed6\u4eec\u8ba4\u4e3a\u67e5\u8be2\u53ef\u80fd\u5df2\u7ecf\u5c3d\u53ef\u80fd\u5feb\uff08\u6216\u9ad8\u6548\uff09\u4e86\u3002</p> <p>\u5927\u90e8\u5206\u4eba\u90fd\u77e5\u9053\uff0c\u5982\u679c\u987a\u5e8f\u626b\u63cf\u4e2d\u6709\u5927\u91cf\u7684\u884c\u88ab\u8fc7\u6ee4\u6389\uff0c\u5219\u8868\u660e\u7d22\u5f15\u53ef\u4ee5\u63d0\u4f9b\u5e2e\u52a9\u3002\u4f46\u662f\u7d22\u5f15\u52a0\u5feb\u901f\u5ea6\u7684\u539f\u56e0\u540c\u6837\u9002\u7528\u4e8e\u5177\u6709\u8fc7\u6ee4\u66f4\u591a\u884c\u7684\u5176\u4ed6\u626b\u63cf\uff0c\u5176\u4e2d\u8fc7\u6ee4\u884c\u66f4\u591a\u7684\u7d22\u5f15\u53ef\u4ee5\u52a0\u5feb\u901f\u5ea6\uff01\u867d\u7136\u6211\u4eec\u7ecf\u5e38\u4f1a\u770b\u5230\u7d22\u5f15\u8fc7\u6ee4\u5668\u663e\u793a <code>Rows Removed by Filter</code>\uff0c\u4f46\u9057\u61be\u7684\u662f\uff0c\u6709\u4e9b\u60c5\u51b5 <code>EXPLAIN</code> \u5e76\u4e0d\u4f1a\u62a5\u544a\uff08\u6211\u4eec\u7a0d\u540e\u4f1a\u8bb2\u5230\uff09\u3002</p> <p>\u5728\u672c\u6587\u4e2d\uff0c\u6211\u4eec\u5c06\u901a\u8fc7\u51e0\u4e2a\u793a\u4f8b\u4ee5\u53ca\u4e00\u4e9b\u9700\u8981\u6ce8\u610f\u7684\u4e8b\u9879\u6765\u8bf4\u660e\u5982\u4f55\u52a0\u5feb\u901f\u5ea6\u3002</p> <p>\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c\u8fd8\u6709\u5176\u4ed6\u65b9\u6cd5\u53ef\u4ee5\u8fdb\u4e00\u6b65\u4f18\u5316\u7d22\u5f15\u7684\u4f7f\u7528\u3002\u6211\u4eec\u8fd8\u901a\u8fc7 pgMustard \u4e2d\u7684 <code>Index Efficiency</code> \u63d0\u793a\u91cd\u70b9\u4ecb\u7ecd\u4e86\u4e00\u4e2a\u8fd9\u6837\u7684\u4f8b\u5b50\uff0c\u5373\u901a\u8fc7\u7d22\u5f15\u91cd\u65b0\u68c0\u67e5\u5220\u9664\u4e86\u5927\u91cf\u884c\u3002\u4f46\u8fd9\u7bc7\u6587\u7ae0\u5df2\u7ecf\u591f\u957f\u4e86\uff0c\u6240\u4ee5\u6211\u4eec\u6539\u5929\u518d\u8ba8\u8bba\u3002</p>"},{"location":"2025/02/06/index-scan-doesnt-mean-its-fast/#_2","title":"\u7559\u610f\u8fc7\u6ee4\u5668\u5220\u9664\u7684\u884c","text":"<p>\u8ba9\u6211\u4eec\u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u7684\u793a\u4f8b\u8868\u6765\u6f14\u793a\uff1a</p> <p><pre><code>CREATE TABLE example (\n   id bigint GENERATED ALWAYS AS IDENTITY PRIMARY KEY,\n   a smallint NOT NULL,\n   b smallint NOT NULL);\n\nINSERT INTO example (a, b)\n   SELECT random (1, 1_000), random (1, 1_000) \n   FROM generate_series(1, 1_000_000);\n\nVACUUM ANALYZE example;\n\nSELECT * FROM example LIMIT 5;\n</code></pre> \u8f93\u51fa<pre><code> id |  a  |  b  \n----+-----+-----\n  1 | 803 | 627\n  2 | 978 | 702\n  3 |  15 | 506\n  4 | 966 | 335\n  5 | 247 | 172\n(5 rows)\n</code></pre> \u73b0\u5728\uff0c\u6211\u4eec\u603b\u5171\u6709\u4e00\u767e\u4e07\u884c\uff0c\u5176\u4e2d\u4e00\u4e2a\u662f\u6574\u6570\u4e3b\u952e\uff0c\u8fd8\u6709\u4e24\u4e2a\u989d\u5916\u7684\u5217 <code>a</code> \u548c <code>b</code>\uff0c\u5b83\u4eec\u5305\u542b 1 \u5230 1000 \u4e4b\u95f4\u7684\u968f\u673a\u6574\u6570\u3002</p> <p>\u8ba9\u6211\u4eec\u770b\u4e00\u4e0b\u51e0\u4e2a\u7d22\u5f15\u9009\u9879\uff0c\u7528\u4e8e\u4f18\u5316\u57fa\u4e8e <code>a</code> \u548c <code>b</code> \u8fdb\u884c\u8fc7\u6ee4\u7684\u7b80\u5355\u67e5\u8be2\uff1a</p> <p><pre><code>CREATE INDEX example_a_idx ON example (a);\n\nEXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS) \nSELECT id FROM example WHERE a = 42 AND b = 42;\n</code></pre> \u8f93\u51fa<pre><code>                                                         QUERY PLAN                                                         \n----------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on public.example  (cost=11.86..2542.34 rows=1 width=8) (actual time=4.024..4.489 rows=1 loops=1)\n   Output: id\n   Recheck Cond: (example.a = 42)\n   Filter: (example.b = 42)\n   Rows Removed by Filter: 1016\n   Heap Blocks: exact=925\n   Buffers: shared hit=928\n   -&gt;  Bitmap Index Scan on example_a_idx  (cost=0.00..11.86 rows=991 width=0) (actual time=0.407..0.407 rows=1017 loops=1)\n         Index Cond: (example.a = 42)\n         Buffers: shared hit=3\n Planning Time: 0.143 ms\n Execution Time: 4.538 ms\n</code></pre></p> <p>\u901a\u8fc7\u5217 <code>a</code> \u4e0a\u7684\u7d22\u5f15\uff0cPostgreSQL \u9009\u62e9\u6267\u884c\u4f4d\u56fe\u7d22\u5f15\u626b\u63cf\u6765\u67e5\u627e <code>a = 42</code> \u7684\u884c\uff0c\u7136\u540e\u5bf9\u5305\u542b\u8fd9\u4e9b\u884c\u7684\u9875\u9762\u8fdb\u884c\u4f4d\u56fe\u5806\u626b\u63cf\uff0c\u4ec5\u7b5b\u9009\u51fa <code>b</code> \u4e5f\u7b49\u4e8e <code>42</code> \u7684\u884c\u3002</p> <p>\u867d\u7136\u8fd9\u603b\u5171\u53ea\u82b1\u8d39\u4e86\u5927\u7ea6 5 \u6beb\u79d2\u3002\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u8fc7\u6ee4\u5668\u5220\u9664\u4e86 1016 \u884c\uff0c\u4f46\u6700\u7ec8\u53ea\u8fd4\u56de\u4e86 1 \u884c\u2014\u2014\u6548\u7387\u4e0d\u9ad8\uff01</p> <p>\u53e6\u4e00\u4e2a\u7ebf\u7d22\uff08\u611f\u8c22 <code>Buffers</code> \u884c\uff09\u662f PostgreSQL \u603b\u5171\u5fc5\u987b\u8bfb\u53d6 928 \u4e2a\u5757\uff08\u7ea6 7MB\uff09\uff0c\u5176\u4e2d\u9664 3 \u4e2a\u5757\u5916\uff0c\u5176\u4f59\u5747\u6765\u81ea <code>Bitmap Heap Scan</code> \u9636\u6bb5\u3002</p> <p>\u7b80\u5355\u7684\u7d22\u5f15\u626b\u63cf\u4f1a\u6bd4\u8fd9\u4e2a\u4f4d\u56fe\u626b\u63cf\u66f4\u597d\u5417\uff1f</p> <p>\u8ba9\u6211\u4eec\u5c1d\u8bd5\u963b\u6b62\u4f4d\u56fe\u626b\u63cf\uff0c\u7136\u540e\u518d\u6b21\u8fd0\u884c\u67e5\u8be2\uff1a</p> <p><pre><code>SET enable_bitmapscan = off;\n\nEXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS) \nSELECT id FROM example WHERE a = 42 AND b = 42;\n</code></pre> \u8f93\u51fa<pre><code>                                                           QUERY PLAN                                                            \n---------------------------------------------------------------------------------------------------------------------------------\n Index Scan using example_a_idx on public.example  (cost=0.42..3655.99 rows=1 width=8) (actual time=1.438..1.682 rows=1 loops=1)\n   Output: id\n   Index Cond: (example.a = 42)\n   Filter: (example.b = 42)\n   Rows Removed by Filter: 1016\n   Buffers: shared hit=928\n Settings: enable_bitmapscan = 'off'\n Planning Time: 0.144 ms\n Execution Time: 1.706 ms\n</code></pre></p> <p>\u8fd9\u66f4\u5feb\uff0c\u5927\u7ea6 2 \u6beb\u79d2\uff0c\u4f46\u6211\u4eec\u4ecd\u7136\u53ef\u4ee5\u770b\u5230\u90a3 1016 \u884c\u88ab\u8fc7\u6ee4\u5668\u5220\u9664\u3002<code>Buffers</code> \u8fd8\u663e\u793a\u6211\u4eec\u4ecd\u7136\u9700\u8981\u8bfb\u53d6 928 \u4e2a\u5757\u3002\u6240\u4ee5\u8fd9\u4e24\u8005\u90fd\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u8ff9\u8c61\uff0c\u8868\u660e\u6211\u4eec\u53ef\u4ee5\u505a\u5f97\u66f4\u597d...</p> <p>\u5982\u679c\u6211\u4eec\u5728 <code>b</code> \u4e5f\u6709\u4e00\u4e2a\u7d22\u5f15\u4f1a\u600e\u4e48\u6837\uff1f</p> <p><pre><code>RESET enable_bitmapscan;\n\nCREATE INDEX example_b_idx ON example (b);\n\nEXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS) \nSELECT id FROM example WHERE a = 42 AND b = 42;\n</code></pre> \u8f93\u51fa<pre><code>                                                            QUERY PLAN                                                            \n----------------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on public.example  (cost=24.00..28.01 rows=1 width=8) (actual time=0.674..0.676 rows=1 loops=1)\n   Output: id\n   Recheck Cond: ((example.a = 42) AND (example.b = 42))\n   Heap Blocks: exact=1\n   Buffers: shared hit=8\n   -&gt;  BitmapAnd  (cost=24.00..24.00 rows=1 width=0) (actual time=0.652..0.653 rows=0 loops=1)\n         Buffers: shared hit=7\n         -&gt;  Bitmap Index Scan on example_a_idx  (cost=0.00..11.86 rows=991 width=0) (actual time=0.259..0.259 rows=1017 loops=1)\n               Index Cond: (example.a = 42)\n               Buffers: shared hit=3\n         -&gt;  Bitmap Index Scan on example_b_idx  (cost=0.00..11.89 rows=995 width=0) (actual time=0.208..0.208 rows=991 loops=1)\n               Index Cond: (example.b = 42)\n               Buffers: shared hit=4\n Planning Time: 0.143 ms\n Execution Time: 0.706 ms\n</code></pre></p> <p>\u73b0\u5728\uff0c\u65f6\u95f4\u5df2\u964d\u81f3 1 \u6beb\u79d2\u4ee5\u4e0b\uff0c\u4f46\u5173\u952e\u7684\u662f <code>Buffers</code> \u6570\u91cf\u5927\u5e45\u51cf\u5c11\uff088 \u4e2a\u5757\uff0c\u5373 64KB\uff09\uff01\u8fd9\u4e00\u6b21\uff0cPostgreSQL \u626b\u63cf\u4e86\u6bcf\u4e2a\u7d22\u5f15\uff08\u5355\u72ec\uff09\uff0c\u7136\u540e\u5bf9\u6bcf\u4e2a\u7ed3\u679c\u4e2d\u7684\u5339\u914d\u884c\u8fdb\u884c AND \u8fd0\u7b97\uff0c\u4ee5\u67e5\u627e\u540c\u65f6\u5339\u914d\u4e24\u4e2a\u6761\u4ef6\u7684\u884c\u3002</p> <p>\u867d\u7136\u4e0d\u518d\u6709\u660e\u786e\u7684 <code>Rows Removed by Filter</code> \u5b57\u6bb5\uff0c\u4f46\u90a3\u4e9b\u4f4d\u56fe\u7d22\u5f15\u626b\u63cf\u4ecd\u7136\u4f1a\u8bfb\u53d6\u4e00\u4e9b\u672a\u8fd4\u56de\u7684\u7d22\u5f15\u6761\u76ee\u3002\u8ba9\u6211\u4eec\u770b\u770b\u662f\u5426\u53ef\u4ee5\u505a\u5f97\u66f4\u597d\uff0c\u901a\u8fc7\u5728 <code>(a, b)</code> \u4e0a\u5c1d\u8bd5\u590d\u5408\u7d22\u5f15\uff0c\u5c06\u6211\u4eec\u9700\u8981\u7684\u6761\u76ee\u5728\u5355\u4e2a\u7d22\u5f15\u7ed3\u6784\u4e2d\u5f7c\u6b64\u76f8\u90bb\u5730\u6392\u5e8f\uff1a</p> <p><pre><code>CREATE INDEX example_a_b_idx ON example (a, b);\n\nEXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS) \nSELECT id FROM example WHERE a = 42 AND b = 42;\n</code></pre> \u8f93\u51fa<pre><code>                                                           QUERY PLAN                                                           \n--------------------------------------------------------------------------------------------------------------------------------\n Index Scan using example_a_b_idx on public.example  (cost=0.42..8.45 rows=1 width=8) (actual time=0.032..0.033 rows=1 loops=1)\n   Output: id\n   Index Cond: ((example.a = 42) AND (example.b = 42))\n   Buffers: shared hit=4\n Planning Time: 0.160 ms\n Execution Time: 0.058 ms\n</code></pre></p> <p>\u6211\u4eec\u603b\u5171\u51cf\u5c11\u4e86 4 \u6b21\u7f13\u51b2\u533a\u547d\u4e2d\uff0c\u800c\u4e14\u901f\u5ea6\u5feb\u4e86\u5f88\u591a\uff01\u6700\u540e\u4e00\u6b21\u5c1d\u8bd5\uff0c\u4e3a\u4e86\u597d\u73a9\uff0c\u8ba9\u6211\u4eec\u5c1d\u8bd5\u5728 (a, b, id) \u4e0a\u4f7f\u7528\u590d\u5408\u7d22\u5f15\uff0c\u4ee5\u5c1d\u8bd5\u4ec5\u8fdb\u884c\u7d22\u5f15\u626b\u63cf\uff1a</p> <p><pre><code>CREATE INDEX example_a_b_id_idx ON example (a, b, id);\n\nEXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS) \nSELECT id FROM example WHERE a = 42 AND b = 42;\n</code></pre> \u8f93\u51fa<pre><code>                                                               QUERY PLAN                                                               \n----------------------------------------------------------------------------------------------------------------------------------------\n Index Only Scan using example_a_b_id_idx on public.example  (cost=0.42..4.44 rows=1 width=8) (actual time=0.029..0.031 rows=1 loops=1)\n   Output: id\n   Index Cond: ((example.a = 42) AND (example.b = 42))\n   Heap Fetches: 0\n   Buffers: shared hit=4\n Planning Time: 0.115 ms\n Execution Time: 0.046 ms\n</code></pre></p> <p>\u5c3d\u7ba1\u907f\u514d\u4e86\u8bbf\u95ee\u5806\uff0c\u4f46\u6211\u4eec\u4ecd\u7136\u603b\u5171\u8bfb\u53d6\u4e86 4 \u4e2a\u5757\uff08\u53ef\u80fd\u662f\u56e0\u4e3a\u7d22\u5f15\u7a0d\u5927\u4e00\u4e9b\uff09\uff0c\u56e0\u6b64\u67e5\u8be2\u901f\u5ea6\u5e76\u6ca1\u6709\u5feb\u591a\u5c11\u3002\u6709\u8da3\uff01</p> <p>\u4ece\u7b2c\u4e00\u4e2a\u67e5\u8be2\u8ba1\u5212\uff08\u5df2\u7ecf\u975e\u5e38\u5feb\u5e76\u4e14\u4f7f\u7528\u7d22\u5f15\uff09\u5f00\u59cb\uff0c\u6211\u4eec\u4ecd\u7136\u8bbe\u6cd5\u5728\u6267\u884c\u65f6\u95f4\u548c\u8bfb\u53d6\u7684\u5757\u6570\u91cf\u4e0a\u5b9e\u73b0\u4e86\u51e0\u4e2a\u6570\u91cf\u7ea7\u7684\u6539\u8fdb\uff0c\u4e3b\u8981\u662f\u901a\u8fc7\u5c1d\u8bd5\u83b7\u53d6\u6211\u4eec\u9700\u8981\u7684\u51c6\u786e\u6570\u636e\u800c\u65e0\u9700\u8bfb\u53d6\u548c\u8fc7\u6ee4\u884c\u3002</p> <p>\u56e0\u6b64\uff0c\u603b\u7ed3\u4e00\u4e0b\uff0c\u65e0\u8bba\u626b\u63cf\u7c7b\u578b\u5982\u4f55\uff0c\u5982\u679c PostgreSQL \u9700\u8981\u8bfb\u53d6\u6bd4\u5176\u9700\u8981\u66f4\u591a\u7684\u6570\u636e\uff0c\u800c\u53c8\u4e0d\u5f97\u4e0d\u5c06\u5176\u8fc7\u6ee4\u6389\uff0c\u90a3\u4e48\u53ef\u80fd\u5b58\u5728\u4e00\u79cd\u66f4\u6709\u6548\u7684\u65b9\u6cd5\u3002\u7559\u610f\u88ab\u8fc7\u6ee4\u5668\u5220\u9664\u7684\u884c\u3002</p> <p>\u4f5c\u4e3a\u53c2\u8003\uff0c\u6211\u5df2\u7ecf\u5728 pgMustard \u4e2d\u5ba1\u67e5\u5e76\u53d1\u5e03\u4e86\u8fd9\u4e94\u4e2a\u67e5\u8be2\u8ba1\u5212\u3002</p> <p></p> <p>\u4e0a\u8ff0\u539f\u59cb\u67e5\u8be2\u8ba1\u5212\u7684\u603b\u65f6\u95f4\u548c\u603b\u7f13\u51b2\u533a\uff0c\u4ee5\u53ca 4 \u6b21\u4f18\u5316\u5c1d\u8bd5\u3002</p>"},{"location":"2025/02/06/index-scan-doesnt-mean-its-fast/#_3","title":"\u7559\u610f\u5faa\u73af","text":"<p>\u91cd\u8981\u7684\u662f\uff0c<code>Rows Removed by Filter</code> \u5b57\u6bb5\u662f\u6bcf\u4e2a\u5faa\u73af\u7684\u5e73\u5747\u503c\uff0c\u56db\u820d\u4e94\u5165\u5230\u6700\u63a5\u8fd1\u7684\u6574\u6570\u3002\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u603b\u662f\u6709 <code>loops=1</code>\uff0c\u6240\u4ee5\u8fd9\u5e76\u4e0d\u76f8\u5173\uff0c\u4f46\u5728\u5176\u4ed6\u67e5\u8be2\u4e2d\uff0c\u7279\u522b\u662f\u6d89\u53ca\u5d4c\u5957\u5faa\u73af\u7684\u67e5\u8be2\u4e2d\uff0c\u5b83\u53ef\u80fd\u662f\u4e00\u4e2a\u91cd\u8981\u7684\u56e0\u7d20\u3002</p> <p>\u5047\u8bbe\u60a8\u770b\u5230 <code>actual [...] rows=1 loops=10000</code> \u548c <code>Rows Removed by Filter: 5</code>\u3002\u8fd9\u610f\u5473\u7740\u5927\u7ea6\u6709 10k \u884c\u88ab\u8fd4\u56de\uff0c\u4f46\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u4e00\u70b9\u8fd8\u9700\u8981\u8bfb\u53d6\u548c\u8fc7\u6ee4\u53e6\u5916 50k \u884c\u30025 \u6bd4 1 \u5df2\u7ecf\u4e0d\u662f\u4e00\u4e2a\u5f88\u597d\u7684\u6548\u7387\u6bd4\uff0c\u4f46\u662f\u5f53\u4e58\u4ee5 10k \u65f6\uff0c\u8282\u7701\u65f6\u95f4\u7684\u6f5c\u529b\u5c31\u53d8\u5f97\u975e\u5e38\u6709\u8da3\uff01</p> <p>\u56e0\u6b64\uff0c\u5982\u679c\u60a8\u53ea\u770b\u5230\u901a\u8fc7\u8fc7\u6ee4\u5668\u5220\u9664\u7684\u884c\u6570\u5f88\u5c11\uff0c\u4f46\u5faa\u73af\u6570\u5f88\u9ad8\uff0c\u90a3\u4e48\u53ef\u80fd\u4ecd\u7136\u6709\u5f88\u5927\u7684\u6539\u8fdb\u673a\u4f1a\uff08\u901a\u8fc7\u4f7f\u7528\u66f4\u597d\u7684\u7d22\u5f15\uff09\u3002</p>"},{"location":"2025/02/06/index-scan-doesnt-mean-its-fast/#_4","title":"\u7d22\u5f15\u5217\u987a\u5e8f\u975e\u5e38\u91cd\u8981","text":"<p>\u76ee\u524d\uff0c\u622a\u6b62\u7248\u672c 17\uff0cPostgreSQL \u4f9d\u7136\u6ca1\u6709\u5b9e\u73b0 <code>Index Skip Scan</code> \u626b\u63cf\uff08\u5c3d\u7ba1\u5df2\u7ecf\u6709\u8fd9\u65b9\u9762\u7684\u5c1d\u8bd5\uff09\u3002\u56e0\u6b64\uff0cbtree \u7d22\u5f15\u4e2d\u7684\u5217\u987a\u5e8f\u5bf9\u4e8e\u6027\u80fd\u6781\u4e3a\u91cd\u8981\u3002</p>"},{"location":"2025/02/06/index-scan-doesnt-mean-its-fast/#_5","title":"\u5373\u4f7f\u4ec5\u5bf9\u5355\u4e2a\u5217\u8fdb\u884c\u8fc7\u6ee4","text":"<p>\u4e00\u4e2a\u5e38\u89c1\u7684\u4f8b\u5b50\u662f <code>(a, b)</code> \u4e0a\u7684\u7d22\u5f15\u4e0d\u80fd\u6709\u6548\u5730\u7528\u4e8e\u4ec5\u5bf9 <code>b</code> \u8fdb\u884c\u8fc7\u6ee4\u7684\u67e5\u8be2\u3002\u4e3a\u4e86\u6f14\u793a\uff0c\u8ba9\u6211\u4eec\u5220\u9664\u4ec5\u5728 <code>b</code> \u4e0a\u521b\u5efa\u7684\u7d22\u5f15\uff0c\u5e76\u963b\u6b62\u5e8f\u5217\u626b\u63cf\uff1a</p> <p><pre><code>DROP INDEX example_b_idx;\n\nSET enable_seqscan = off;\n\nEXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS) \nSELECT id FROM example WHERE b = 42;\n</code></pre> \u8f93\u51fa<pre><code>                                                            QUERY PLAN                                                            \n----------------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on public.example  (cost=17132.67..19669.35 rows=995 width=8) (actual time=38.616..39.629 rows=991 loops=1)\n   Output: id\n   Recheck Cond: (example.b = 42)\n   Heap Blocks: exact=909\n   Buffers: shared hit=3308\n   -&gt;  Bitmap Index Scan on example_a_b_idx  (cost=0.00..17132.42 rows=995 width=0) (actual time=38.443..38.443 rows=991 loops=1)\n         Index Cond: (example.b = 42)\n         Buffers: shared hit=2399\n Settings: enable_seqscan = 'off'\n Planning Time: 0.304 ms\n Execution Time: 39.736 ms\n</code></pre></p> <p>\u5b83\u786e\u5b9e\u4f7f\u7528\u4e86\u6211\u4eec\u7684 <code>example_a_b_idx</code> \u7d22\u5f15\uff0c\u4f46\u8017\u65f6\u5c06\u8fd1 40 \u6beb\u79d2\uff0c\u603b\u5171\u8bfb\u53d6\u4e86 3308 \u4e2a\u5757\uff08\u7ea6 26MB\uff09\u3002</p> <p>\u8ba9\u6211\u4eec\u5c1d\u8bd5\u6dfb\u52a0\u4e00\u4e2a\u987a\u5e8f\u4e3a <code>(b, a)</code> \u7684\u7d22\u5f15\uff0c\u4ee5\u67e5\u770b\u5176\u5bf9\u4e8e\u76f8\u540c\u67e5\u8be2\u7684\u6548\u7387\u5982\u4f55\uff1a</p> <p><pre><code>RESET enable_seqscan;\n\nCREATE INDEX example_b_a_idx ON example (b, a);\n\nEXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS) \nSELECT id FROM example WHERE b = 42;\n</code></pre> \u8f93\u51fa<pre><code>                                                         QUERY PLAN                                                          \n-----------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on public.example  (cost=20.14..2556.81 rows=995 width=8) (actual time=0.649..3.212 rows=991 loops=1)\n   Output: id\n   Recheck Cond: (example.b = 42)\n   Heap Blocks: exact=909\n   Buffers: shared hit=915\n   -&gt;  Bitmap Index Scan on example_b_a_idx  (cost=0.00..19.89 rows=995 width=0) (actual time=0.393..0.394 rows=991 loops=1)\n         Index Cond: (example.b = 42)\n         Buffers: shared hit=6\n Planning Time: 0.232 ms\n Execution Time: 3.406 ms\n</code></pre></p> <p>\u8fd9\u82b1\u8d39\u4e86\u4e0d\u5230 4 \u6beb\u79d2\u7684\u65f6\u95f4\uff0c\u603b\u5171\u8bfb\u53d6\u4e86 915 \u4e2a\u5757\uff08\u7ea6 7MB\uff09\u2014\u2014\u597d\u591a\u4e86\uff01</p> <p>\u9057\u61be\u7684\u662f\uff0cPostgreSQL \u6ca1\u6709\u5728\u4e0a\u9762\u6548\u7387\u8f83\u4f4e\u7684\u8ba1\u5212\u4e2d\u62a5\u544a\u4efb\u4f55 <code>Rows Removed by Filter</code>\uff0c\u5c3d\u7ba1\u8fd9\u5b9e\u9645\u4e0a\u662f\u4f4d\u56fe\u7d22\u5f15\u626b\u63cf\u671f\u95f4\u53d1\u751f\u7684\u60c5\u51b5\u3002\u6211\u4eec\u76ee\u524d\u4e5f\u65e0\u6cd5\u4ece <code>Index Cond</code> \u4e2d\u5224\u65ad\u5b83\u662f\u5426\u88ab\u6709\u6548\u4f7f\u7528\uff0c\u4f46\u6267\u884c\u65f6\u95f4\u3001\u6210\u672c\u548c\u7f13\u51b2\u533a\u90fd\u63d0\u4f9b\u4e86\u5f88\u597d\u7684\u7ebf\u7d22\u3002</p>"},{"location":"2025/02/06/index-scan-doesnt-mean-its-fast/#_6","title":"\u6839\u636e\u591a\u5217\u8fdb\u884c\u7b5b\u9009\u65f6\u7684\u5217\u987a\u5e8f","text":"<p>\u5bf9\u4e8e\u6839\u636e\u7d22\u5f15\u4e2d\u7684\u6240\u6709\u6761\u4ef6\u8fdb\u884c\u7b5b\u9009\u7684\u67e5\u8be2\uff0c\u5217\u987a\u5e8f\u4e5f\u975e\u5e38\u91cd\u8981\u3002</p> <p>\u4e00\u4e2a\u5f88\u597d\u7684\u4f8b\u5b50\u662f\uff0c\u5982\u679c\u5176\u4e2d\u4e00\u4e2a\u8fc7\u6ee4\u5668\u662f\u8303\u56f4\u6761\u4ef6\u3002\u4e3a\u4e86\u6f14\u793a\uff0c\u8ba9\u6211\u4eec\u5c1d\u8bd5\u4e00\u4e2a\u67e5\u8be2\uff0c\u6211\u4eec\u7684\u65b0\u7d22\u5f15 <code>(b, a)</code> \u5e94\u8be5\u53ef\u4ee5\u5f88\u597d\u5730\u6ee1\u8db3\u8be5\u67e5\u8be2\uff1a</p> <p><pre><code>EXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS) \nSELECT id FROM example WHERE b = 42 AND a &lt; 100;\n</code></pre> \u8f93\u51fa<pre><code>                                                        QUERY PLAN                                                         \n---------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on public.example  (cost=5.44..362.73 rows=99 width=8) (actual time=0.128..0.502 rows=116 loops=1)\n   Output: id\n   Recheck Cond: ((example.b = 42) AND (example.a &lt; 100))\n   Heap Blocks: exact=115\n   Buffers: shared hit=118\n   -&gt;  Bitmap Index Scan on example_b_a_idx  (cost=0.00..5.42 rows=99 width=0) (actual time=0.073..0.074 rows=116 loops=1)\n         Index Cond: ((example.b = 42) AND (example.a &lt; 100))\n         Buffers: shared hit=3\n Settings: enable_seqscan = 'off'\n Planning Time: 0.304 ms\n Execution Time: 0.577 ms\n</code></pre></p> <p>\u5c3d\u7ba1\u5b83\u8fd4\u56de\u4e86 116 \u884c\uff0c\u4f46\u5b83\u5728 1 \u6beb\u79d2\u5185\u8fd0\u884c\u5e76\u8bfb\u53d6\u4e86 118 \u4e2a\u5757\uff08\u7ea6 1MB\uff09\u3002</p> <p>\u8ba9\u6211\u4eec\u5220\u9664 <code>(b, a)</code> \u4e0a\u7684\u7d22\u5f15\u5e76\u963b\u6b62\u987a\u5e8f\u626b\u63cf\uff0c\u4ee5\u67e5\u770b <code>(a, b)</code> \u4e0a\u7684\u7d22\u5f15\u5982\u4f55\u6709\u6548\u5730\u5904\u7406\u76f8\u540c\u67e5\u8be2\uff1a</p> <p><pre><code>DROP INDEX example_b_a_idx;\n\nEXPLAIN (ANALYZE, BUFFERS, VERBOSE, SETTINGS) \nSELECT id FROM example WHERE b = 42 AND a &lt; 100;\n</code></pre> \u8f93\u51fa<pre><code>                                                          QUERY PLAN                                                          \n------------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on public.example  (cost=1955.74..2313.03 rows=99 width=8) (actual time=4.721..5.123 rows=116 loops=1)\n   Output: id\n   Recheck Cond: ((example.a &lt; 100) AND (example.b = 42))\n   Heap Blocks: exact=115\n   Buffers: shared hit=355\n   -&gt;  Bitmap Index Scan on example_a_b_idx  (cost=0.00..1955.71 rows=99 width=0) (actual time=4.623..4.624 rows=116 loops=1)\n         Index Cond: ((example.a &lt; 100) AND (example.b = 42))\n         Buffers: shared hit=240\n Planning Time: 0.305 ms\n Execution Time: 5.200 ms\n</code></pre></p> <p>\u8fd9\u82b1\u8d39\u4e86 5 \u6beb\u79d2\u591a\u4e00\u70b9\u7684\u65f6\u95f4\uff0c\u5e76\u8bfb\u53d6\u4e86 355 \u4e2a\u5757\uff08\u7ea6 3MB\uff09\u6765\u6ee1\u8db3\u76f8\u540c\u7684\u67e5\u8be2\u3002</p> <p>\u6839\u636e\u6570\u636e\u5206\u5e03\u548c\u5176\u4ed6\u56e0\u7d20\uff08\u4f8b\u5982 <code>LIMIT</code> \u5b50\u53e5\uff09\uff0c\u8fd9\u79cd\u5dee\u5f02\u53ef\u80fd\u4f1a\u53d8\u5f97\u66f4\u52a0\u6781\u7aef\uff0c\u56e0\u6b64\u5bc6\u5207\u5173\u6ce8\u7d22\u5f15\u4e2d\u5217\u7684\u987a\u5e8f\u975e\u5e38\u91cd\u8981\uff01</p> <p>\u5411 <code>EXPLAIN</code> \u6dfb\u52a0\u66f4\u591a\u4fe1\u606f\u4ee5\u5e2e\u52a9\u53d1\u73b0\u8fd9\u4e9b\u95ee\u9898\u662f PostgreSQL \u793e\u533a\u79ef\u6781\u5f00\u5c55\u7684\u53e6\u4e00\u4e2a\u9886\u57df\uff0c\u56e0\u6b64\u6211\u5e0c\u671b\u5b83\u5728\u4e0d\u4e45\u7684\u5c06\u6765\u4f1a\u5f97\u5230\u6539\u8fdb\u3002Query Doctor \u56e2\u961f\u5728\u6700\u8fd1\u6709\u5173 EXPLAIN \u602a\u7656\u7684\u6587\u7ae0\u4e2d\u5f88\u597d\u5730\u4ecb\u7ecd\u4e86\u8fd9\u4e2a\u7279\u5b9a\u4e3b\u9898\u3002</p>"},{"location":"2025/02/06/index-scan-doesnt-mean-its-fast/#_7","title":"\u603b\u7ed3","text":"<p>\u867d\u7136\u6211\u4eec\u8fd8\u6ca1\u6709\u8ba8\u8bba\u7d22\u5f15\u626b\u63cf\u5bf9\u4e8e\u7ed9\u5b9a\u67e5\u8be2\u6548\u7387\u4f4e\u4e0b\u7684\u6240\u6709\u65b9\u5f0f\uff0c\u4f46\u6211\u4eec\u5df2\u7ecf\u6db5\u76d6\u4e86\u6211\u7ecf\u5e38\u770b\u5230\u7684\u6700\u5e38\u89c1\u7684\u60c5\u51b5\u3002</p> <p>\u6211\u81f3\u5c11\u5e0c\u671b\u60a8\u73b0\u5728\u80fd\u591f\u5bf9\u67e5\u8be2\u8ba1\u5212\u4e2d\u9700\u8981\u6ce8\u610f\u7684\u4e8b\u9879\u6709\u66f4\u591a\u7684\u60f3\u6cd5\uff0c\u4ee5\u5e2e\u52a9\u8bca\u65ad\u8fd9\u4e9b\u7c7b\u578b\u7684\u4f4e\u6548\u7387\uff1a</p> <ol> <li>\u8fc7\u6ee4\u5668\u5220\u9664\u4e86\u5927\u91cf\u884c\uff0c\u5373\u4f7f\u5728\u7d22\u5f15\u626b\u63cf\u7c7b\u578b\u4e2d\u4e5f\u662f\u5982\u6b64</li> <li>\u5faa\u73af\u6b21\u6570\u9ad8\uff0c\u4e58\u4ee5\u8fc7\u6ee4\u5668\u5220\u9664\u7684\u884c\u6570</li> <li>\u7f13\u51b2\u533a\u6570\u91cf\u8f83\u591a\uff0c\u5c24\u5176\u662f\u4e0e\u8fd4\u56de\u7684\u884c\u76f8\u6bd4</li> <li>\u7d22\u5f15\u4e2d\u5217\u7684\u987a\u5e8f\uff0c\u4ee5\u53ca\u662f\u5426\u9002\u5408\u67e5\u8be2</li> </ol> <p>\u4f46\u662f\uff0c\u5982\u679c\u60a8\u53ea\u4ece\u8fd9\u7bc7\u535a\u6587\u4e2d\u5b66\u5230\u4e00\u4ef6\u4e8b\uff0c\u6211\u5e0c\u671b\u90a3\u5c31\u662f\uff0c\u4ec5\u4ec5\u56e0\u4e3a\u60a8\u770b\u5230\u4e86 <code>Index Scan</code> \u8fd9\u4e2a\u8bcd\uff0c\u5e76\u4e0d\u610f\u5473\u7740\u626b\u63cf\u901f\u5ea6\u5c3d\u53ef\u80fd\u5feb\uff01</p> <p>\u4f5c\u8005\uff1aMichael Christofides \u539f\u6587\uff1ahttps://www.pgmustard.com/blog/index-scan-doesnt-mean-its-fast</p>"},{"location":"2024/11/15/overlapping-ranges-in-subsets-in-postgresql/","title":"PostgreSQL \u4e2d\u5b50\u96c6\u7684\u91cd\u53e0\u8303\u56f4","text":"<p>\u5728\u672c\u7cfb\u5217\u7684\u7b2c\u4e00\u90e8\u5206\u4e2d\uff0c\u6211\u4eec\u63a2\u8ba8\u4e86\u91cd\u53e0\u67e5\u8be2\u53ca\u5176\u4f34\u968f\u7684\u95ee\u9898\uff0c\u4ee5\u53ca\u63d0\u9ad8\u5176\u6027\u80fd\u7684\u65b9\u6cd5\u3002\u6700\u540e\uff0c\u6211\u4eec\u6839\u636e\u65f6\u95f4\u6233\u8303\u56f4\u5b9a\u4e49\u4e86\u4e00\u4e2a\u91cd\u53e0\u67e5\u8be2\uff0c\u8fd9\u4f7f\u6211\u4eec\u80fd\u591f\u4f7f\u7528\u4e00\u79cd\u79f0\u4e3a GiST \u7684\u65b0\u7d22\u5f15\u7c7b\u578b\uff0c\u4ece\u800c\u5927\u5927\u52a0\u5feb\u4e86\u8fd9\u4e9b\u7c7b\u578b\u7684\u67e5\u8be2\u901f\u5ea6\u3002\u5728\u7b2c\u4e8c\u90e8\u5206\u4e2d\uff0c\u6211\u4eec\u5c06\u8fdb\u4e00\u6b65\u63d0\u9ad8\u91cd\u53e0\u67e5\u8be2\u6027\u80fd\uff0c\u4f46\u9996\u5148\u8ba9\u6211\u4eec\u4ecb\u7ecd\u4e00\u4e0b\u8303\u56f4\u7c7b\u578b\u7684\u4e00\u4e9b\u5176\u4ed6\u7279\u6027\u3002</p>"},{"location":"2024/11/15/overlapping-ranges-in-subsets-in-postgresql/#_1","title":"\u9002\u5408\u6240\u6709\u573a\u5408","text":"<p>\u6211\u4eec\u7684\u7b2c\u4e00\u90e8\u5206\u67e5\u8be2\u4f7f\u7528\u4e86\u4ee5\u4e0b <code>WHERE</code> \u5b50\u53e5\uff1a</p> <pre><code>WHERE tsrange(o.start_time, o.end_time) &amp;&amp; tsrange(p.enter, p.leave)\n</code></pre> <p><code>tsrange()</code> \u51fd\u6570\u8fd4\u56de\u65f6\u95f4\u6233\u8303\u56f4\u3002\u4f46\u91cd\u53e0\u67e5\u8be2\u4e0d\u4ec5\u9650\u4e8e\u65f6\u95f4\u6233\uff1b\u5b83\u4eec\u4e5f\u53ef\u4ee5\u7531\u6574\u6570\u548c\u6d6e\u70b9\u503c\u6784\u5efa\u3002\u60f3\u8c61\u4e00\u4e2a\u8ddf\u8e2a\u67d0\u79cd\u5546\u54c1\u7684\u6700\u4f4e\u548c\u6700\u9ad8\u4ef7\u683c\u7684\u5957\u5229\u6570\u636e\u5e93\u3002\u5982\u679c\u60a8\u5e0c\u671b\u627e\u5230\u6240\u6709\u4e3a\u4e94\u82b1\u8089\u652f\u4ed8 1.35 \u7f8e\u5143\u5230 1.65 \u7f8e\u5143\u4e4b\u95f4\u7684\u987e\u5ba2\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>numrange()</code> \u51fd\u6570\u6784\u5efa\u4e00\u4e2a\u6570\u5b57\u8303\u56f4\uff1b\u67e5\u8be2 <code>WHERE</code> \u5b50\u53e5\u5c06\u662f\uff1a</p> <pre><code>WHERE numrange(min_price, max_price) &amp;&amp; numrange(1.35, 1.65)\n</code></pre> <p>\u5bf9\u4e8e <code>integer</code> \u548c <code>bigint</code> \u8303\u56f4\uff0c\u6709\u51fd\u6570 <code>int4range()</code> \u548c <code>int8range()</code>\u3002\u53ef\u4ee5\u4f7f\u7528 <code>daterange()</code> \u6784\u5efa\u4ec5\u9650\u65e5\u671f\u7684\u65f6\u95f4\u95f4\u9694\uff08\u4e0d\u542b\u65f6\u95f4\uff09\uff0c\u751a\u81f3\u8fd8\u6709\u4e00\u4e2a <code>tstzrange()</code> \u51fd\u6570\uff0c\u5b83\u4f1a\u8003\u8651\u6d89\u53ca\u7684\u65f6\u95f4\u6233\u503c\u7684\u65f6\u533a\u3002\uff08\u4f46\u8bf7\u8bb0\u4f4f\uff1a\u4e0e\u4f7f\u7528\u201c\u5e26\u65f6\u533a\u201d\u5b9a\u4e49\u7684\u6570\u636e\u5e93\u5217\u4e00\u6837\uff0c\u5b9e\u9645\u65f6\u533a\u4e0d\u4f1a\u88ab\u5b58\u50a8\uff0c\u53ea\u662f\u4e00\u4e2a\u6807\u5fd7\uff0c\u8868\u793a\u65f6\u95f4\u6233\u5e94\u8be5\u5728\u5ba2\u6237\u7aef\u8f6c\u6362\u4e3a\u672c\u5730\u65f6\u95f4\u3002\uff09</p>"},{"location":"2024/11/15/overlapping-ranges-in-subsets-in-postgresql/#_2","title":"\u9632\u6b62\u8868\u884c\u91cd\u53e0","text":"<p>\u91cd\u53e0\u67e5\u8be2\u7684\u5e38\u89c1\u9700\u6c42\u662f\u9632\u6b62\u5305\u542b\u91cd\u53e0\u65f6\u95f4\u6bb5\u7684\u884c\u63d2\u5165\u5230\u8868\u4e2d\uff0c\u7c7b\u4f3c\u4e8e <code>UNIQUE</code> \u9650\u5236\u3002\u4f8b\u5982\uff0c\u4f1a\u8bae\u5ba4\u9884\u8ba2\u5217\u8868\u4e0d\u5141\u8bb8\u540c\u65f6\u9884\u8ba2\uff0c\u6216\u8005\u64ad\u5ba2\u65f6\u95f4\u8868\u53ea\u5141\u8bb8\u5728\u4efb\u4f55\u7ed9\u5b9a\u65f6\u95f4\u64ad\u653e\u4e00\u96c6\u3002\u6b64\u7c7b\u4e1a\u52a1\u903b\u8f91\u53ef\u4ee5\u4f7f\u7528\u89e6\u53d1\u5668\u6216\u5b58\u50a8\u8fc7\u7a0b\u5728\u6570\u636e\u5e93\u4e2d\u5b8c\u6210\u3002\u4f46\u4f7f\u7528 GiST \u5219\u662f\u4e00\u79cd\u66f4\u7b80\u5355\u7684\u65b9\u6cd5\u3002</p> <p>\u4e3a\u4e86\u8bf4\u660e\u8fd9\u4e00\u70b9\uff0c\u8bf7\u8003\u8651\u5373\u5c06\u64ad\u51fa\u7684\u64ad\u5ba2\u5267\u96c6\u7684\u57fa\u672c\u8868\uff0c\u5176\u4e2d\u5305\u542b\u5267\u96c6\u6807\u8bc6\u7b26\u548c\u4e24\u4e2a\u65f6\u95f4\u6233\uff0c\u6307\u793a\u8ba1\u5212\u7684\u5f00\u59cb\u548c\u505c\u6b62\u65f6\u95f4\u3002\u4e3a\u4e86\u9632\u6b62\u4efb\u4f55\u4e24\u884c\u5728\u65f6\u95f4\u4e0a\u91cd\u53e0\uff0c\u8bf7\u4f7f\u7528 <code>exclude</code> \u8fd0\u7b97\u7b26\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>CREATE TABLE episodes (\n episode_id       INTEGER NOT NULL,\n planned_start  TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,\n planned_end   TIMESTAMP(0) WITHOUT TIME ZONE NOT NULL,\n EXCLUDE USING gist (tsrange(planned_start, planned_end) WITH &amp;&amp;)\n);\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5c1d\u8bd5\u63d2\u5165\u4e24\u884c\u76f8\u4e92\u51b2\u7a81\u7684\u884c\u6765\u9a8c\u8bc1\u8fd9\u4e00\u70b9\uff1a</p> <pre><code>INSERT INTO episodes \nVALUES (1, '11/5/2024 08:00 am', '11/5/2024 09:30 am');\nINSERT INTO episodes \nVALUES (2, '11/5/2024 09:00 am', '11/5/2024 11:00 am');\n</code></pre> <p>\u7531\u4e8e\u7b2c 2 \u96c6\u5728\u7b2c 1 \u96c6\u7ed3\u675f\u4e4b\u524d\u5f00\u59cb\uff0c\u7b2c\u4e8c\u6b21\u63d2\u5165\u5931\u8d25\uff0c\u9519\u8bef\u5982\u4e0b\uff1a</p> <pre><code>ERROR: conflicting key value violates exclusion constraint \u2026\n</code></pre> <p>\u4e0e <code>UNIQUE</code> \u7ea6\u675f\u4e00\u6837\uff0c<code>EXCLUDE</code> \u521b\u5efa\u5e95\u5c42\u7d22\u5f15\u6765\u652f\u6301\u7ea6\u675f\uff0c\u8fd9\u610f\u5473\u7740\u60a8\u4e0d\u9700\u8981\u5728\u8868\u5b9a\u4e49\u540e\u9762\u6dfb\u52a0\u5355\u72ec\u7684\u7d22\u5f15\u521b\u5efa\u8bed\u53e5\u3002</p> <p>\u6ce8\u610f</p> <p>\u5b9e\u9645\u4e1a\u52a1\u573a\u666f\u53ef\u80fd\u9700\u8981\u989d\u5916\u7684\u6807\u51c6\u6765\u786e\u5b9a\u91cd\u53e0\u9519\u8bef\u3002\u4f8b\u5982\uff0c\u9152\u5e97\u9884\u8ba2\u7cfb\u7edf\u9700\u8981\u623f\u95f4\u53f7\uff0c\u6216\u8005\u4e0a\u9762\u7684\u64ad\u5ba2\u793a\u4f8b\u53ef\u80fd\u652f\u6301\u591a\u4e2a\u9891\u9053\uff0c\u6bcf\u4e2a\u9891\u9053\u540c\u65f6\u5e7f\u64ad\u3002\u8fd9\u53ef\u4ee5\u5728 EXCLUDE \u8bed\u53e5\u4e2d\u5b8c\u6210\uff0c\u4f46\u5b83\u9700\u8981\u5411 GiST \u6dfb\u52a0 B \u6811\u652f\u6301\uff0c\u5982\u4e0b\u6240\u8ff0\u3002</p>"},{"location":"2024/11/15/overlapping-ranges-in-subsets-in-postgresql/#_3","title":"\u4fee\u6539\u8303\u56f4\u8bed\u53e5","text":"<p>\u5728\u7b2c\u4e00\u90e8\u5206\u4e2d\uff0c\u6211\u4eec\u6ce8\u610f\u5230\u6807\u51c6 SQL \u8bed\u4e49\u5c06\u8303\u56f4\u5b9a\u4e49\u4e3a\u201c\u534a\u5f00\u653e\u201d\u2014\u2014\u8303\u56f4\u7684\u8d77\u70b9\u662f\u5305\u542b\u5728\u8303\u56f4\u5185\uff0c\u4f46\u7ec8\u70b9\u662f\u4e0d\u5305\u542b\u5728\u8303\u56f4\u5185\uff08Joe Celko \u5728\u672c\u6587\u4e2d\u63d0\u5230\u4e86\u534a\u9ad8\u5f00\u3001\u534a\u4f4e\u5f00\u7684\u7406\u5ff5\uff09\u3002\u8fd9\u79cd\u5b58\u50a8\u8303\u56f4\u7684\u65b9\u6cd5\u7b80\u5316\u4e86\u5b58\u50a8\uff0c\u4f46\u5f80\u5f80\u4f1a\u4f7f\u91cd\u53e0\u8ba1\u7b97\u590d\u6742\u5316\uff1a\u4e0b\u5348 5 \u70b9\u7ed3\u675f\u7684\u95f4\u9694\u4e0d\u4f1a\u4e0e\u5728\u540c\u4e00\u65f6\u95f4\u5f00\u59cb\u7684\u95f4\u9694\u91cd\u53e0\uff08\u5c3d\u7ba1\u5b83\u4f1a\u4e0e\u65e9\u4e00\u6beb\u79d2\u5f00\u59cb\u7684\u95f4\u9694\u91cd\u53e0\uff09\u3002\u6240\u6709\u8303\u56f4\u6784\u9020\u51fd\u6570\uff08<code>tsrange()</code>\u3001<code>daterange()</code> \u7b49\uff09\u90fd\u9075\u5faa\u76f8\u540c\u7684\u8bed\u4e49\u3002</p> <p>\u60a8\u53ef\u4ee5\u8f7b\u677e\u5730\u8986\u76d6\u6b64\u884c\u4e3a\u3002\u6784\u9020\u51fd\u6570\u63a5\u53d7\u7b2c\u4e09\u4e2a\u53c2\u6570\uff1a\u4e00\u4e2a\u4e24\u5b57\u7b26\u7684\u5b57\u7b26\u4e32\uff0c\u8868\u793a\u6bcf\u4e2a\u7aef\u70b9\u7684\u72b6\u6001\uff1a\u65b9\u62ec\u53f7\u8868\u793a\u5305\u542b\uff1b\u5706\u62ec\u53f7\u8868\u793a\u4e0d\u5305\u542b\u3002</p> <p>\u4e0b\u8868\u5217\u51fa\u4e86\u5404\u79cd\u53ef\u80fd\u6027\uff1a</p> \u53c2\u6570 \u884c\u4e3a <code>()</code> \u4e24\u4e2a\u7aef\u70b9\u5747\u4e0d\u5305\u542b <code>[]</code> \u4e24\u4e2a\u7aef\u70b9\u5747\u5305\u542b <code>[)</code> \u5305\u542b\u8d77\u70b9\uff0c\u4e0d\u5305\u542b\u7ec8\u70b9\uff0c\u9ed8\u8ba4 <code>(]</code> \u4e0d\u5305\u542b\u8d77\u70b9\uff0c\u5305\u542b\u7ec8\u70b9 <p>\u4e3a\u4e86\u8bf4\u660e\uff0c\u8ba9\u6211\u4eec\u56de\u5230\u64ad\u5ba2\u5267\u96c6\u7684\u793a\u4f8b\u3002\u5728\u5176\u4e2d\uff0c\u6211\u4eec\u4f7f\u7528\u9ed8\u8ba4\u7684\u201c\u534a\u5f00\u653e\u201d\u8bed\u4e49\u521b\u5efa\u4e86\u201c\u65e0\u91cd\u53e0\u201d\u7ea6\u675f\u3002\u8fd9\u4f7f\u5f97\u65b0\u5267\u96c6\u7684\u5f00\u59cb\u65f6\u95f4\u4e0e\u524d\u4e00\u5267\u96c6\u7684\u7ed3\u675f\u65f6\u95f4\u5b8c\u5168\u76f8\u540c\u3002\u4f8b\u5982\uff0c\u5373\u4f7f\u4e00\u96c6\u7684\u7ed3\u675f\u4e0e\u53e6\u4e00\u96c6\u7684\u5f00\u59cb\u76f8\u5339\u914d\uff0c\u4ee5\u4e0b\u4e24\u884c\u4e5f\u4e0d\u91cd\u53e0\uff1a</p> <pre><code>INSERT INTO episodes \nVALUES (3, '11/6/2024 08:00 am', '11/6/2024 09:00 am');\nINSERT INTO episodes \nVALUES (4, '11/6/2024 09:00 am', '11/6/2024 10:00 am');\n</code></pre> <p>\u4f46\u662f\u5728\u521b\u5efa\u7ea6\u675f\u65f6\uff0c\u5982\u679c\u6211\u4eec\u6307\u793a <code>tsrange()</code> \u51fd\u6570\u5305\u542b\u4e24\u4e2a\u7aef\u70b9\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>EXCLUDE USING gist (tsrange(planned_start, planned_end, '[]')\n                    WITH &amp;&amp;)\n</code></pre> <p>\u7531\u4e8e\u8be5\u9650\u5236\uff0c\u7b2c\u4e8c\u6b21 <code>INSERT</code> \u5c06\u5931\u8d25\u3002</p> <p></p>"},{"location":"2024/11/15/overlapping-ranges-in-subsets-in-postgresql/#gist","title":"\u63d0\u5347\u7ee9\u6548\uff1aGiST \u7684\u4e0d\u540c\u7248\u672c","text":"<p>\u73b0\u5728\u8ba9\u6211\u4eec\u56de\u5230\u6211\u4eec\u7684\u91cd\u70b9\uff1a\u63d0\u9ad8\u6027\u80fd\u3002GiST \u7d22\u5f15\u7c7b\u578b\u662f\u901a\u7528\u91cd\u53e0\u67e5\u8be2\u7684\u4e0d\u9519\u9009\u62e9\u3002\u4f46\u901a\u5e38\uff0c\u65f6\u95f4\u5e8f\u5217\u6570\u636e\u5728\u4e00\u7cfb\u5217\u65e5\u671f\u5185\u5206\u5e03\u76f8\u5f53\u5747\u5300\uff0c\u6ca1\u6709\u5927\u91cf\u91cd\u53e0\u503c\u3002\u4e00\u4e2a\u5f88\u597d\u7684\u4f8b\u5b50\u662f\u6211\u4eec\u7b2c\u4e00\u90e8\u5206\u4e2d\u7684\u6837\u672c\u6570\u636e\uff1a\u5b83\u968f\u673a\u5206\u5e03\u5728 20 \u5e74\u7684\u95f4\u9694\u5185\uff0c\u5e76\u4e14\u4efb\u4f55\u7ed9\u5b9a\u7684\u884c\u4ec5\u4e0e\u8868\u4e2d\u5176\u4ed6\u884c\u7684\u4e00\u5c0f\u90e8\u5206\u91cd\u53e0\u3002\u5bf9\u4e8e\u8fd9\u6837\u7684\u6570\u636e\uff0c\u7a7a\u95f4\u5206\u533a\u7684 GiST \u7d22\u5f15\u53ef\u4ee5\u4ea7\u751f\u66f4\u597d\u7684\u6027\u80fd\u3002PostgreSQL \u4e5f\u652f\u6301\u8fd9\u79cd\u7c7b\u578b\u7684\u7d22\u5f15 - \u79f0\u4e3a SP-GiST\u3002</p> <p>\u521b\u5efa SP-GiST \u7d22\u5f15\u7684\u8bed\u53e5\u4e0e\u5e38\u89c4 GiST \u51e0\u4e4e\u76f8\u540c\u3002\u4f7f\u7528\u7b2c\u4e00\u90e8\u5206\u4e2d\u7684 <code>patrons</code> \u793a\u4f8b\u8868\uff0c\u6211\u4eec\u521b\u5efa\u4e86\u4e00\u4e2a\u6b63\u5e38\u7684 GiST \u7d22\u5f15\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>CREATE INDEX ON PATRONS USING gist(tsrange(enter, leave));\n</code></pre> <p>\u5bf9\u4e8e SP-GiST\uff0c\u6211\u4eec\u5c06\u7d22\u5f15\u7c7b\u578b\u66f4\u6539\u4e3a <code>spgist</code> \u5e76\u6307\u5b9a\u4e00\u4e2a\u64cd\u4f5c\u7b26\u7c7b\uff1a</p> <pre><code>CREATE INDEX ON USING spgist(tsrange(enter, leave) range_ops);\n</code></pre> <p>\u8fd9\u91cc\uff0c\u5185\u7f6e\u7684 <code>range_ops</code> \u8fd0\u7b97\u7b26\uff08\u4e0d\u51fa\u6240\u6599\uff09\u610f\u5473\u7740\u6211\u4eec\u8981\u5bf9\u7d22\u5f15\u6267\u884c\u8303\u56f4\u64cd\u4f5c\u3002</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u671f\u671b\u7a7a\u95f4\u5206\u533a\u7248\u672c\u7684 GiST \u7684\u6027\u80fd\u63d0\u9ad8\u591a\u5c11\uff1f\u5728\u6211\u4eec\u7684\u7b2c\u4e00\u90e8\u5206\u6d4b\u8bd5\u6570\u636e\u4e2d\uff0c\u7528 SP-GiST \u66ff\u6362\u65e7\u7684 GiST \u7d22\u5f15\u5c06\u67e5\u8be2\u65f6\u95f4\u4ece 5.2 \u79d2\u51cf\u5c11\u5230 3.7 \u79d2\u2014\u2014\u63d0\u5347\u4e86 30%\u3002\u5728\u6700\u4f73\u60c5\u51b5\u4e0b\uff08\u4f8b\u5982\u4e0d\u5141\u8bb8\u91cd\u53e0\u884c\u7684\u8868\uff09\uff0c\u9884\u671f\u589e\u5e45\u53ef\u80fd\u9ad8\u8fbe 50%\u3002\u4f46\u5728\u91cd\u53e0\u7a0b\u5ea6\u8f83\u9ad8\u7684\u6570\u636e\u96c6\u4e0a\uff0cSP-GiST \u7684\u8868\u73b0\u53ef\u80fd\u4f1a\u66f4\u5dee\u3002\u7528\u60a8\u81ea\u5df1\u7684\u6570\u636e\u8fdb\u884c\u6d4b\u8bd5\uff01</p>"},{"location":"2024/11/15/overlapping-ranges-in-subsets-in-postgresql/#gist-b-","title":"\u4e3a GiST \u6dfb\u52a0 B-\u6811 \u652f\u6301","text":"<p>\u901a\u5e38\uff0c\u91cd\u53e0\u67e5\u8be2\u5177\u6709\u8d85\u51fa\u8303\u56f4\u672c\u8eab\u7684\u6807\u51c6\u3002\u9910\u5385\u9884\u8ba2\u4e0d\u4f1a\u4e0e\u5176\u4ed6\u9884\u8ba2\u91cd\u53e0\uff0c\u9664\u975e\u662f\u540c\u4e00\u5f20\u684c\u5b50\uff1b\u5982\u679c\u75c5\u4eba\u4e0d\u540c\uff0c\u533b\u9662\u53ef\u4ee5\u5728\u540c\u4e00\u65f6\u95f4\u6bb5\u5b89\u6392\u591a\u6b21\u5c31\u8bca\uff0c\u7b49\u7b49\u3002</p> <p>\u56de\u5230\u7b2c\u4e00\u90e8\u5206\u4e2d\u7684\u793a\u4f8b\u4ee3\u7801\uff0c\u5176\u4e2d\u4f7f\u7528\u4e86\u4e00\u4e2a\u535a\u7269\u9986\u7684\u987e\u5ba2\u548c\u5b89\u5168\u4e2d\u65ad\u7684\u793a\u4f8b\uff1a\u5982\u679c\u6570\u636e\u5305\u62ec\u591a\u4e2a\u7ad9\u70b9\u4f1a\u600e\u6837\uff1f\u73b0\u5728\uff0c\u53ea\u6709\u5f53\u987e\u5ba2\u548c\u505c\u7535\u53d1\u751f\u5728\u540c\u4e00\u5730\u70b9\u65f6\uff0c\u624d\u4f1a\u51fa\u73b0\u201c\u91cd\u53e0\u201d\u3002\u8fd9\u4f1a\u5982\u4f55\u6539\u53d8\u60c5\u51b5\uff1f</p> <p>\u8ba9\u6211\u4eec\u91cd\u65b0\u521b\u5efa\u8868\uff0c\u8fd9\u6b21\u6dfb\u52a0\u4e00\u4e2a <code>location_id</code> \u5916\u952e\uff1a</p> <pre><code>CREATE TABLE patrons (\n    patron_id INT NOT NULL GENERATED ALWAYS AS IDENTITY,\n    location_id INT NOT NULL,\n    enter Timestamp(0) NOT NULL,\n    leave Timestamp(0) NOT NULL\n);\nCREATE TABLE outages (\n    location_id INT NOT NULL,\n    start_time Timestamp(0) NOT NULL,\n    end_time Timestamp(0) NOT NULL\n);\n--Note, the code to load these tables is located in the Appendix\n</code></pre> <p>\u6211\u4eec\u5bf9\u91cd\u53e0\u503c\u7684\u67e5\u8be2\u73b0\u5728\u6709\u4e00\u4e2a\u8fde\u63a5\u6761\u4ef6\uff0c\u800c\u4e0d\u662f <code>CROSS JOIN</code>\uff1a</p> <pre><code>SELECT * FROM patrons p\nINNER JOIN outages o \n          ON p.location_id = o.location_id\nWHERE tsrange(o.start_time, o.end_time) &amp;&amp; tsrange(p.enter, p.leave);\n</code></pre> <p>\u7531\u4e8e\u8fd9\u662f\u968f\u673a\u751f\u6210\u7684\u6570\u636e\uff0c\u60a8\u53ef\u80fd\u4f1a\u5f97\u5230\u66f4\u591a\u6216\u66f4\u5c11\u7684\u884c\uff0c\u56e0\u6b64\u60a8\u7684\u6027\u80fd\u53ef\u80fd\u4f1a\u6709\u6240\u4e0d\u540c\u3002</p> <p>\u5982\u679c\u60a8\u4f7f\u7528\u6211\u4eec\u5728\u7b2c\u4e00\u90e8\u5206\u4e2d\u521b\u5efa\u7684\u76f8\u540c GiST \u7d22\u5f15\u8fd0\u884c\u6b64\u67e5\u8be2\uff0c\u5219\u6027\u80fd\u5c06\u4f1a\u4ece\u7cdf\u7cd5\u5230\u6781\u5ea6\u7cdf\u7cd5\uff0c\u5177\u4f53\u53d6\u51b3\u4e8e\u5b58\u5728\u591a\u5c11\u4e2a\u4e0d\u540c\u7684\u4f4d\u7f6e\u503c\u3002\u6211\u4eec\u5047\u8bbe\u6709 20 \u4e2a\u53ef\u80fd\u7684\u4f4d\u7f6e\uff0c\u770b\u770b\u662f\u5426\u53ef\u4ee5\u518d\u6b21\u63d0\u9ad8\u6027\u80fd\u3002</p> <p>\u5bf9\u4e8e\u50cf\u8fd9\u6837\u7684\u53cc\u6761\u4ef6\u67e5\u8be2\uff0c\u6211\u4eec\u7684\u672c\u80fd\u662f\u591a\u5217\u7d22\u5f15\uff0c\u6bcf\u4e2a\u6761\u4ef6\u4e00\u4e2a\u3002\u5e76\u4e14\uff0c\u7531\u4e8e\u65f6\u95f4\u6233\u8303\u56f4\u6bd4 <code>location_id</code> \u66f4\u5177\u4f53\uff08\u4ece\u6280\u672f\u89d2\u5ea6\u6765\u8bf4\uff0c\u5b83\u7684\u57fa\u6570\u66f4\u9ad8\uff09\uff0c\u5b83\u5e94\u8be5\u662f\u7b2c\u4e00\u4e2a\u7d22\u5f15\u7684\u5217\u3002\u8fd9\u4fc3\u4f7f\u6211\u4eec\u5c1d\u8bd5\u8fd9\u4e2a\u547d\u4ee4\uff1a</p> <pre><code>CREATE INDEX ON patrons \nUSING GIST(tsrange(enter,leave), location_id); \n</code></pre> <p>\u6211\u4eec\u7684\u76f4\u89c9\u662f\u6b63\u786e\u7684\uff0c\u4f46\u662f\u5728 PostgreSQL \u7684\u9ed8\u8ba4\u914d\u7f6e\u4e0b\uff0c\u8be5\u8bed\u53e5\u663e\u793a\u9519\u8bef\u3002</p> <pre><code>ERROR: data type integer has no default operator class for access method \"gist\"\n</code></pre> <p>\u5c3d\u7ba1 GiST \u7d22\u5f15\u529f\u80fd\u5f3a\u5927\uff0c\u4f46\u5b83\u4e0d\u652f\u6301\u7b80\u5355\u7684\u64cd\u4f5c\uff0c\u4f8b\u5982\u5b57\u7b26\u4e32\u3001\u65e5\u671f\u6216\uff08\u5728\u672c\u4f8b\u4e2d\uff09\u6574\u6570\u7684\u76f4\u63a5\u6bd4\u8f83\u3002\u5e78\u8fd0\u7684\u662f\uff0cPostgreSQL \u9644\u5e26\u4e86\u4e00\u4e2a\u6269\u5c55\uff0c\u53ef\u5c06 B-\u6811\u7c7b\u578b\u7684\u64cd\u4f5c\u6dfb\u52a0\u5230 GiST\u3002\u6211\u4eec\u9700\u8981\u505a\u7684\u5c31\u662f\u5b89\u88c5\u5b83\uff1a</p> <pre><code>CREATE EXTENSION btree_gist;\n</code></pre> <p>\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u6beb\u65e0\u9519\u8bef\u5730\u521b\u5efa\u4e0a\u8ff0\u7d22\u5f15\uff0c\u5e76\u4e14\u5728\u53d1\u751f\u4e2d\u65ad\u65f6\u521b\u5efa\u7c7b\u4f3c\u7684\u7d22\u5f15\uff1a</p> <pre><code>CREATE INDEX ON outages \n    USING GIST(tsrange(start_time, end_time), location_id);\n</code></pre> <p>\u8fd9\u4e0d\u4ec5\u6062\u590d\u4e86\u7b2c\u4e00\u90e8\u5206\u4e2d\u7f3a\u5c11 <code>location_id</code> \u7684\u67e5\u8be2\u7684\u6027\u80fd\uff1a</p> <pre><code>SELECT *\nFROM patrons p\n        CROSS JOIN outages o\nWHERE tsrange(o.start_time, o.end_time) \n             &amp;&amp; tsrange(p.enter, p.leave);\n</code></pre> <p>\u4f46\u662f\u7a0d\u5fae\u597d\u4e00\u4e9b\uff08\u5728\u6211\u7684\u6d4b\u8bd5\u7cfb\u7edf\u4e0a\u4e3a 4.9 \u79d2\uff0c\u540c\u6837\u4f7f\u7528\u968f\u673a\u751f\u6210\u7684\u6570\u636e\uff0c\u5982\u60a8\u5728\u5b8c\u6574\u811a\u672c\u4e2d\u6240\u770b\u5230\u7684\uff0c\u7528\u4e8e\u586b\u5145\u6d4b\u8bd5\u8868\u3001\u521b\u5efa\u7d22\u5f15\u5e76\u6267\u884c\u4e0b\u9762\u9644\u5f55\u4e00\u4e2d\u7684\u67e5\u8be2\u3002</p> <p>\u6ce8\u610f</p> <p>\u6211\u4eec\u7684 <code>location_id</code> \u662f\u4e00\u4e2a\u4f4e\u57fa\u6570\u503c\uff08\u53ea\u6709 20 \u4e2a\u53ef\u80fd\u7684\u503c\uff0c\u56e0\u4e3a\u6211\u4f7f\u7528 <code>TRUNC(RANDOM()*20)</code>\u6765\u751f\u6210\u5b83\u4eec\uff09\u3002</p> <p>\u5982\u679c\u6709\u66f4\u591a\u4f4d\u7f6e\uff08\u4f8b\u5982 100,000+\uff09\uff0c\u5219\u7d22\u5f15\u53ef\u80fd\u66f4\u9002\u5408\u4ee5 <code>location_id</code> \u4f5c\u4e3a\u7b2c\u4e00\u5217\uff1b\u4f46\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6027\u80fd\u53ef\u80fd\u4e0d\u4f1a\u6bd4\u9ed8\u8ba4\u7684 B-\u6811\u7d22\u5f15\u66f4\u597d\uff0c\u56e0\u4e3a\u8fd9\u4e9b\u7d22\u5f15\u5c31\u662f\u4e3a\u6b64\u573a\u666f\u8bbe\u8ba1\u7684\u3002</p> <p>\u7528\u60a8\u81ea\u5df1\u7684\u6570\u636e\u8fdb\u884c\u6d4b\u8bd5\uff01</p>"},{"location":"2024/11/15/overlapping-ranges-in-subsets-in-postgresql/#sql","title":"\u9644\u5f55\u4e00\uff1a\u793a\u4f8b SQL \u811a\u672c","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u4e9b\u53ef\u7528\u4e8e\u672c\u6587\u4e2d\u793a\u4f8b\u4ee3\u7801\u7684\u6709\u7528\u811a\u672c\uff1a</p> <pre><code>-- create tables\nCREATE TABLE patrons (\n        patron_id INT NOT NULL GENERATED ALWAYS AS IDENTITY,\n        location_id INT NOT NULL,\n        enter Timestamp(0) NOT NULL,\n        leave Timestamp(0) NOT NULL\n);\nCREATE TABLE outages (\n        location_id INT NOT NULL,\n        start_time Timestamp(0) NOT NULL,\n        end_time Timestamp(0) NOT NULL);\n</code></pre> <p>\u4e3a\u4e86\u5b8c\u6210\u67d0\u4e9b\u793a\u4f8b\uff0c\u7279\u522b\u662f\u90a3\u4e9b\u65f6\u95f4\u5f88\u91cd\u8981\u7684\u793a\u4f8b\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528\u6b64\u811a\u672c\u6765\u751f\u6210\u6570\u636e\u3002</p> <pre><code>-- create 1M random patrons and 250K random outages\nINSERT INTO patrons (location_id, enter,leave) (\nSELECT TRUNC(RANDOM()*20), r, \n       r + '1 minute'::INTERVAL * ROUND(RANDOM()+1 * 60) \nFROM (SELECT NOW() - '1 minute'::INTERVAL * \n                ROUND(RANDOM() * 15768000) AS r \n      FROM generate_series(1,1000000)) AS sub);\nINSERT INTO outages (\nSELECT TRUNC(RANDOM()*20), r, \n       r + '1 minute'::INTERVAL * ROUND(RANDOM() * 20) \nFROM (SELECT NOW() - '1 minute'::INTERVAL *\n                    ROUND(RANDOM() * 15768000) AS r \n      FROM generate_series(1,250000)) AS sub);\n-- delete malformed entries from randomly generated data.\nDELETE FROM patrons WHERE enter &gt;= leave;\nDELETE FROM outages WHERE start_time &gt;= end_time;\n</code></pre> <p>\u4e0b\u9762\u5c06\u521b\u5efa\u672c\u6587\u4e2d\u63d0\u5230\u7684\u7d22\u5f15\u3002\u5b83\u4eec\u9700\u8981 <code>btree_gist</code> \u6269\u5c55\u624d\u80fd\u6267\u884c\u3002</p> <pre><code>-- create indexes\nCREATE INDEX ON patrons \n  USING gist(tsrange(enter,leave), location_id);\nCREATE INDEX ON outages \n  USING gist(tsrange(start_time, end_time), location_id);\n-- run test query\nEXPLAIN ANALYZE \nSELECT * \nFROM patrons p\nINNER JOIN outages o ON p.location_id = o.location_id\nWHERE tsrange(o.start_time, o.end_time) \n             &amp;&amp; tsrange(p.enter, p.leave);\n</code></pre> <p>\u4f5c\u8005\uff1aLee Asher \u539f\u6587\uff1ahttps://www.red-gate.com/simple-talk/databases/postgresql/overlapping-ranges-in-subsets-in-postgresql/</p>"},{"location":"2024/11/14/solving-the-overlap-query-problem-in-postgresql/","title":"\u89e3\u51b3 PostgreSQL \u4e2d\u7684\u91cd\u53e0\u67e5\u8be2\u95ee\u9898","text":"<p>\u8303\u56f4\u67e5\u8be2\u662f SQL \u4e2d\u975e\u5e38\u5e38\u89c1\u7684\u4efb\u52a1\uff1a\u9009\u62e9\u5c5e\u4e8e\u67d0\u4e2a\u6307\u5b9a\u8303\u56f4\u5185\u7684\u65e5\u671f\u3001\u6570\u5b57\u751a\u81f3\u6587\u672c\u503c\u3002\u4f8b\u5982\uff1a3 \u6708\u4efd\u7684\u6240\u6709\u8d37\u6b3e\u7533\u8bf7\uff0c\u6216 50 \u7f8e\u5143\u81f3 500 \u7f8e\u5143\u4e4b\u95f4\u7684\u6240\u6709\u9500\u552e\u4ea4\u6613\u3002SQL \u5f00\u53d1\u4eba\u5458\u901a\u5e38\u64c5\u957f\u7f16\u5199\u6b64\u7c7b\u67e5\u8be2\u5e76\u5bf9\u5176\u8fdb\u884c\u7d22\u5f15\u4ee5\u786e\u4fdd\u5176\u6027\u80fd\u826f\u597d\u3002</p> <p>\u4f46\u5f53\u9700\u6c42\u7a0d\u6709\u53d8\u5316\u65f6\u2014\u2014\u6bd4\u8f83\u4e24\u4e2a\u503c\u7684\u8303\u56f4\u4ee5\u627e\u51fa\u5b83\u4eec\u7684\u91cd\u53e0\u4e4b\u5904\u2014\u2014\u60c5\u51b5\u7a81\u7136\u5c31\u5b8c\u5168\u4e0d\u540c\u4e86\u3002\u8fd9\u4e9b\u6240\u8c13\u7684\u201c\u91cd\u53e0\u67e5\u8be2\u201d\u6bd4\u8868\u9762\u4e0a\u770b\u8d77\u6765\u66f4\u68d8\u624b\u3002</p>"},{"location":"2024/11/14/solving-the-overlap-query-problem-in-postgresql/#_1","title":"\u91cd\u53e0\u67e5\u8be2","text":"<p>\u6700\u5e38\u89c1\u7684\u91cd\u53e0\u67e5\u8be2\u6d89\u53ca\u65f6\u95f4\uff08\u65e5\u671f\u548c\u65f6\u95f4\uff09\u8303\u56f4\uff0c\u79f0\u4e3a\u95f4\u9694\uff08<code>intervals</code>\uff09\u3002\u4f8b\u5982\uff0c\u60f3\u8c61\u4e00\u4e0b\u5bf9\u533b\u9662\u75c5\u4eba\u7684\u67e5\u8be2\u3002\u5982\u679c\u60a8\u5e0c\u671b\u67e5\u627e\u516b\u6708\u4efd\u9996\u6b21\u5165\u9662\u7684\u6240\u6709\u60a3\u8005\uff0c\u8fd9\u662f\u4e00\u4e2a\u7b80\u5355\u7684\u8303\u56f4\u67e5\u8be2\u3002\u4f46\u662f\u5982\u679c\u60a8\u5e0c\u671b\u627e\u5230\u4f4f\u9662\u65f6\u95f4\uff08\u53e6\u4e00\u4e2a\u65e5\u671f\u95f4\u9694\uff09\u81f3\u5c11\u90e8\u5206\u4f4d\u4e8e\u516b\u6708\u95f4\u9694\u7684\u6240\u6709\u60a3\u8005\uff0c\u8fd9\u662f\u4e00\u4e2a\u91cd\u53e0\u67e5\u8be2\u3002\u867d\u7136\u7f16\u5199\u8fd9\u6837\u7684\u67e5\u8be2\u5e76\u4e0d\u96be\uff0c\u4f46\u7f16\u5199\u51fa\u6027\u80fd\u826f\u597d\u7684\u67e5\u8be2\u5374\u5f88\u56f0\u96be\u3002\u8ba9\u6211\u4eec\u770b\u770b\u4e3a\u4ec0\u4e48\u3002</p>"},{"location":"2024/11/14/solving-the-overlap-query-problem-in-postgresql/#_2","title":"\u7528\u4f8b\u573a\u666f","text":"<p>\u8ba9\u6211\u4eec\u7814\u7a76\u4e00\u4e2a\u6d89\u53ca\u91cd\u53e0\u67e5\u8be2\u7684\u5b9e\u9645\u95ee\u9898\u3002\u5927\u578b\u535a\u7269\u9986\u7684\u6570\u636e\u5e93\u8ddf\u8e2a\u6240\u6709\u6765\u8bbf\u987e\u5ba2\u8fdb\u51fa\u5efa\u7b51\u7269\u7684\u65f6\u95f4\u3002\u5b83\u8fd8\u5728\u5176\u89c6\u9891\u5b89\u5168\u7cfb\u7edf\u4e2d\u7ef4\u62a4\u6240\u6709\u4e2d\u65ad\u7684\u65f6\u95f4\u3002\u5728\u4e00\u8fde\u4e32\u8f7b\u5fae\u76d7\u7a83\u4e8b\u4ef6\u4e4b\u540e\uff0c\u5b89\u5168\u4e3b\u7ba1\u8981\u6c42\u63d0\u4f9b\u4e00\u4efd\u5728\u4e00\u6b21\u6216\u591a\u6b21\u5b89\u5168\u4e2d\u65ad\u671f\u95f4\u5728\u573a\u7684\u6240\u6709\u987e\u5ba2\u7684\u540d\u5355\u3002\u663e\u7136\uff0c\u6211\u4eec\u6709\u4e00\u4e2a\u65e5\u671f\u65f6\u95f4\u8303\u56f4\uff0c\u5373\u987e\u5ba2\u7684\u505c\u7559\u65f6\u95f4\uff0c\u5fc5\u987b\u5c06\u5176\u4e0e\u53e6\u4e00\u4e2a\u65e5\u671f\u65f6\u95f4\u8303\u56f4\uff08\u8868\u793a\u5b89\u5168\u4e2d\u65ad\u7684\u95f4\u9694\uff09\u8fdb\u884c\u6bd4\u8f83\u3002\u76ee\u6807\u662f\u627e\u5230\u6240\u6709\u91cd\u53e0\u7684\u5b9e\u4f8b\u3002</p>"},{"location":"2024/11/14/solving-the-overlap-query-problem-in-postgresql/#_3","title":"\u6570\u636e\u5e93","text":"<p>\u987e\u5ba2\u8868\uff08<code>patrons</code>\uff09\u5305\u542b\u8868\u793a\u8bbf\u95ee\u6301\u7eed\u65f6\u95f4\u7684\u521d\u59cb\u548c\u6700\u7ec8\u65f6\u95f4\u6233\uff0c\u4ee5\u53ca\u8868\u793a\u5173\u8054\u987e\u5ba2\u7684 ID\u3002\u4e2d\u65ad\u8868\uff08<code>outages</code>\uff09\u5b9a\u4e49\u4e86\u6bcf\u6b21\u4e2d\u65ad\u7684\u5f00\u59cb\u548c\u7ed3\u675f\u65f6\u95f4\u6233\u3002\u4e3a\u4e86\u7b80\u5355\u8d77\u89c1\uff0c\u6211\u4eec\u4e0d\u5305\u62ec\u5176\u4ed6\u5217\u3002</p> <pre><code>CREATE TABLE patrons (\n      patron_id  INT  generated always as identity NOT NULL,\n      enter      Timestamp(0) NOT NULL,\n      leave      Timestamp(0) NOT NULL\n);\nCREATE TABLE outages (\n      location_id INT generated always as identity NOT NULL,\n      start_time  Timestamp(0) NOT NULL,\n      end_time   Timestamp(0) NOT NULL\n);\n</code></pre> <p>\u4e3a\u4e86\u5728\u5927\u578b\u6570\u636e\u96c6\u4e0a\u6d4b\u8bd5\u6027\u80fd\uff0c\u6211\u4eec\u5c06\u4f7f\u7528 20 \u5e74\u7684\u968f\u673a\u6570\u636e\u586b\u5145\u8fd9\u4e24\u4e2a\u8868\u3002\uff08\u586b\u5145\u8868\u683c\u7684\u811a\u672c\u4f4d\u4e8e\u6587\u7ae0\u672b\u5c3e\u7ed3\u8bba\u90e8\u5206\u540e\u9762\u7684\u9644\u5f55\u90e8\u5206\u3002\uff09</p> <p>\u5728 SQL \u4e2d\uff0c\u6bd4\u8f83\u95f4\u9694\u7684\u89c4\u8303\u65b9\u6cd5\u662f\u4f7f\u7528 <code>OVERLAPS</code> \u8fd0\u7b97\u7b26\u3002\u8981\u67e5\u627e\u6240\u6709\u91cd\u53e0\u7684\u60c5\u51b5\uff0c\u53ea\u9700\u5c06\u6bcf\u4e2a\u8868\u4e2d\u7684\u65e5\u671f\u5206\u6210\u95f4\u9694\uff0c\u7136\u540e\u4e0e\u6b64\u8fd0\u7b97\u7b26\u8fdb\u884c\u6bd4\u8f83\uff1a</p> <pre><code>SELECT * \nFROM patrons p\n       CROSS JOIN outages o\nWHERE (p.enter, p.leave) OVERLAPS (o.start_time, o.end_time);\n</code></pre> <p>\u6b64\u67e5\u8be2\u53ef\u4ee5\u5de5\u4f5c--\u81f3\u5c11\u5b83\u5c06\u8fd4\u56de\u9002\u5f53\u7684\u884c--\u4f46\u5b83\u975e\u5e38\u6162\u3002\uff08\u5728\u6211\u7684\u6d4b\u8bd5\u7cfb\u7edf\u4e0a\uff08Windows 11 \u548c PostgreSQL 16\uff0c\u6d4b\u8bd5\u673a\u5668\u662f AMD 5700x CPU\u30012GB SSD\uff09\uff0c\u81f3\u5c11\u9700\u8981 3 \u5206\u949f\uff09\u3002\u9996\u6b21\u5c1d\u8bd5\u4f18\u5316\u67e5\u8be2\u53ef\u80fd\u4f1a\u5bfc\u81f4\u60a8\u5728\u4e2d\u65ad\u5f00\u59cb\u548c\u7ed3\u675f\u65f6\u95f4\u4e0a\u521b\u5efa\u590d\u5408\u7d22\u5f15\uff0c\u5e76\u5728\u8ba2\u9605\u4f1a\u5458\u4e0a\u521b\u5efa\u7c7b\u4f3c\u7684\u7d22\u5f15\uff1a</p> <pre><code>CREATE INDEX ON outages USING BTREE(start_time, end_time);\nCREATE INDEX ON patrons USING BTREE(enter, leave);\n</code></pre> <p>\u8fd9\u5e76\u6ca1\u6709\u4efb\u4f55\u5e2e\u52a9\uff1a\u67e5\u8be2\u540c\u6837\u7f13\u6162\u3002\u7ecf\u8fc7\u4e00\u756a\u7814\u7a76\u53d1\u73b0\uff0c<code>OVERLAPS</code> \u8fd0\u7b97\u7b26\u4e0d\u652f\u6301\u7d22\u5f15\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u6539\u4e3a\u660e\u786e\u6307\u5b9a\u6bd4\u8f83\u3002</p> <p>\u7b2c\u4e00\u6b21\u5c1d\u8bd5\u8fd9\u6837\u7684\u67e5\u8be2\u65f6\uff0c\u60a8\u53ef\u80fd\u4f1a\u5728\u4e00\u5f20\u7eb8\u4e0a\u753b\u7ebf\uff0c\u5e76\u770b\u5230\u4e24\u4e2a\u95f4\u9694\u53ef\u4ee5\u91cd\u53e0\u7684\u56db\u79cd\u4e0d\u540c\u65b9\u5f0f\uff08\u89c1\u4e0b\u56fe\uff09\u3002\u8fd9\u4f7f\u5f97\u67e5\u8be2\u76f8\u5f53\u590d\u6742\uff0c\u4f46\u6211\u4eec\u53ef\u4ee5\u7528\u4e00\u4e9b\u5c0f\u6280\u5de7\u6765\u7b80\u5316\u5b83\u3002\u53ea\u6709\u4e24\u79cd\u65b9\u5f0f\u53ef\u4ee5\u8ba9\u533a\u95f4\u4e0d\u91cd\u53e0\u3002\u5982\u679c\u6211\u4eec\u7f16\u5199\u4e0d\u91cd\u53e0\u7684\u67e5\u8be2\uff0c\u7136\u540e\u7528 <code>NOT</code> \u8fdb\u884c\u53cd\u8f6c\uff0c\u6211\u4eec\u5c31\u4f1a\u5f97\u5230\u6240\u9700\u7684\u7ed3\u679c\u3002</p> <p></p> <p>\u4f8b\u5982\uff0c\u7528\u4e8e\u67e5\u627e <code>interval1</code> \u548c <code>interval2</code> \u6240\u6709\u4e0d\u91cd\u53e0\u60c5\u51b5\u7684 <code>WHERE</code> \u5b50\u53e5\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>WHERE interval1.start &gt; interval2.end\n      OR interval2.start &gt; interval1.end\n</code></pre> <p>\u5982\u679c\u6211\u4eec\u4f7f\u7528 <code>NOT</code> \u53cd\u8f6c\u6574\u4e2a\u67e5\u8be2\uff0c\u6211\u4eec\u5c06\u5f97\u5230\u6240\u6709\u91cd\u53e0\u7684\u60c5\u51b5</p> <pre><code>WHERE NOT (date1.start &gt; date2.end \n           OR date2.start &gt; date1.end)\n</code></pre> <p>\u8fd9\u8fd8\u53ef\u7b80\u5316\uff08\u4f7f\u7528\u5e03\u5c14\u903b\u8f91\u89c4\u5219\uff09\u4e3a\uff1a</p> <pre><code>WHERE date1.start &lt;= date2.end \n      AND date2.start &lt;= date1.end)\n</code></pre> <p>\uff08\u6ce8\u610f\uff1a\u7f16\u5199\u67e5\u8be2\u662f\u4e3a\u4e86\u7b26\u5408\u65f6\u95f4\u95f4\u9694\u7684 SQL \u6807\u51c6\uff0c\u8be5\u6807\u51c6\u89c4\u5b9a\uff0c\u5982\u679c\u4e00\u4e2a\u95f4\u9694\u7684\u5f00\u59cb\u65f6\u95f4\u6b63\u597d\u5728\u53e6\u4e00\u4e2a\u95f4\u9694\u7684\u7ed3\u675f\u65f6\u95f4\uff0c\u5219\u4f1a\u53d1\u751f\u91cd\u53e0\u3002\u8fd9\u610f\u5473\u7740\u5c06\u5305\u542b\u6070\u597d\u91cd\u53e0 0.00 \u79d2\u7684\u503c\u3002\u5982\u679c\u60a8\u5e0c\u671b\u8981\u6c42\u6700\u5c11\u7684\u91cd\u53e0\u91cf\uff0c\u8bf7\u76f8\u5e94\u5730\u8c03\u6574\u60a8\u7684\u67e5\u8be2\uff09</p> <p>\u90a3\u4e48\uff0c\u6211\u4eec\u53d6\u5f97\u4e86\u4ec0\u4e48\u6210\u5c31\uff1f\u597d\u5427\uff0c\u663e\u5f0f\u5f62\u5f0f\u7a0d\u5fae\u5feb\u4e00\u4e9b\uff0826.1 \u79d2\uff09\uff0c\u4f46\u5b9e\u9645\u751f\u4ea7\u8868\u53ef\u80fd\u6bd4\u8fd9\u4e9b\u6837\u672c\u5927\u51e0\u4e2a\u6570\u91cf\u7ea7\u3002\u6211\u4eec\u671f\u671b\u8fd9\u6837\u7684\u67e5\u8be2\u80fd\u591f\u975e\u5e38\u5feb\u3002\u67e5\u770b\u8bbf\u95ee\u8ba1\u5212\uff0c\u6211\u4eec\u770b\u5230 PostgreSQL \u5c06\u8868\u626b\u63cf\u4e0e\u7d22\u5f15\u626b\u63cf\u76f8\u7ed3\u5408 - \u6ca1\u6709\u4f7f\u7528\u7d22\u5f15\u67e5\u627e\u3002</p> <p>\u5728\u6700\u540e\u7684\u7edd\u671b\u4e2d\uff0c\u60a8\u53ef\u80fd\u4f1a\u5c06\u590d\u5408\u7d22\u5f15\u5206\u6210\u4e24\u4e2a\u5355\u72ec\u7684\u7d22\u5f15\uff1a\u6bcf\u4e2a\u65f6\u95f4\u6233\u4e00\u4e2a\u3002\u8fd9\u4e0d\u4ec5\u6ca1\u6709\u5e2e\u52a9\uff0c\u800c\u4e14\uff08\u5982\u679c\u5220\u9664\u539f\u59cb\u7d22\u5f15\uff09\u5b83\u4f1a\u548c\u539f\u59cb <code>OVERLAPS()</code> \u5f62\u5f0f\u4e00\u6837\u6162\u3002\u54ea\u91cc\u51fa\u4e86\u95ee\u9898\uff1f</p>"},{"location":"2024/11/14/solving-the-overlap-query-problem-in-postgresql/#b-","title":"B-\u6811\u7684\u95ee\u9898","text":"<p>\u987e\u540d\u601d\u4e49\uff0cB-\u6811\u7d22\u5f15\u5305\u542b\u7d22\u5f15\u5217\u4e0a\u7684\u503c\u7684\u5206\u652f\u7ed3\u6784\uff1b\u904d\u5386\u6811\u53ef\u4ee5\u627e\u5230\u7279\u5b9a\u503c\u6216\u4efb\u4f55\u8fde\u7eed\u7684\u503c\u8303\u56f4\u3002\u5bf9\u4e8e\u590d\u5408\uff08\u591a\u5217\uff09\u7d22\u5f15\uff0c\u4ec5\u5f53\u7b2c\u4e00\u5217\u5177\u6709\u591a\u4e2a\u76f8\u7b49\u503c\u65f6\uff0c\u7b2c\u4e8c\u5217\u624d\u4f1a\u5f71\u54cd\u6392\u5e8f\uff1a\u7b2c\u4e8c\u5217\u5145\u5f53\u201c\u51b3\u80dc\u5c40\u201d\u7684\u4f5c\u7528\u3002\u7b2c\u4e09\u5217\u4ec5\u5f53\u7b2c\u4e8c\u5217\u51fa\u73b0\u5e73\u5c40\u65f6\u624d\u8d77\u4f5c\u7528\uff0c\u4f9d\u6b64\u7c7b\u63a8\u3002\u8fd9\u5728\u89c6\u89c9\u4e0a\u66f4\u5bb9\u6613\u7406\u89e3\u3002\u53c2\u89c1\u4e0b\u56fe\uff1a</p> <p></p> <p>\u8bf7\u6ce8\u610f\uff0c\u4e0e\u7b80\u5355\u7684\u5355\u5217\u7d22\u5f15\u76f8\u6bd4\uff0c\u6211\u4eec\u7684\u590d\u5408\u7d22\u5f15\uff08\u5f00\u59cb\u65e5\u671f+\u7ed3\u675f\u65e5\u671f\uff09\u5bf9\u884c\u6392\u5e8f\u7684\u5f71\u54cd\u5f88\u5c0f\u3002\u800c\u4e14\uff0c\u8fd9\u4e24\u79cd\u65b9\u6cd5\u90fd\u4e0d\u80fd\u8ba9\u6211\u4eec\u5feb\u901f\u627e\u5230\u6240\u6709\u91cd\u53e0\u503c\u3002\u4e0e\u6211\u4eec\u7684\u67e5\u8be2\u8303\u56f4\u91cd\u53e0\u7684\u884c\uff08\u4ee5\u7eff\u8272\u663e\u793a\uff09\u6ca1\u6709\u6309\u987a\u5e8f\u6392\u5217\uff0c\u56e0\u6b64\u6211\u4eec\u7684\u7d22\u5f15\u6ca1\u6709\u5e2e\u52a9\u3002\u5fc5\u987b\u626b\u63cf\u6574\u4e2a\u8868\u3002</p> <p>\u5f53\u8be5\u95f4\u9694\u662f\u4e00\u4e2a\u56fa\u5b9a\u503c\u65f6\uff0c\u60c5\u51b5\u5df2\u7ecf\u591f\u7cdf\u7cd5\u4e86\uff0c\u4f46\u662f\u5f53\u95f4\u9694\u6765\u81ea\u53e6\u4e00\u4e2a\u8868\uff08\u6216\u539f\u59cb\u8868\u7684\u81ea\u8fde\u63a5\uff09\u65f6\uff0c\u8fd9\u610f\u5473\u7740\u8868 A \u4e2d\u7684\u6bcf\u4e00\u884c\u90fd\u5fc5\u987b\u4e0e\u8868 B \u4e2d\u7684\u6bcf\u4e00\u884c\u5339\u914d\u3002\u4ece\u6280\u672f\u89d2\u5ea6\u6765\u8bf4\uff0c\u8fd9\u662f\u4e8c\u6b21\u6027\u80fd\uff08quadratic performance\uff09\u2014\u2014\u884c\u6570\u589e\u52a0\u4e00\u500d\u610f\u5473\u7740\u67e5\u8be2\u5fc5\u987b\u5b8c\u6210\u56db\u500d\u7684\u5de5\u4f5c\u3002\u5728\u975e\u5e38\u5927\u7684\u8868\u4e0a\uff0c\u8fd9\u6837\u7684\u67e5\u8be2\u751a\u81f3\u4f1a\u62d6\u57ae\u6700\u5f3a\u5927\u7684\u670d\u52a1\u5668\u3002</p>"},{"location":"2024/11/14/solving-the-overlap-query-problem-in-postgresql/#_4","title":"\u5ec9\u4ef7\u4f0e\u4fe9","text":"<p>\u5728\u6211\u4eec\u7814\u7a76\u66f4\u590d\u6742\u7684\u65b9\u6cd5\u4e4b\u524d\uff0c\u901a\u5e38\u6709\u4e00\u79cd\u7b80\u5355\u7684\u65b9\u6cd5\u6765\u201c\u7834\u89e3\u201d\u91cd\u53e0\u67e5\u8be2\u3002\u5176\u60f3\u6cd5\u662f\u4e3a\u67e5\u8be2\u4f18\u5316\u5668\uff08QO, Query Optimizer\uff09\u63d0\u4f9b\u6211\u4eec\u62e5\u6709\u4f46\u5b83\u4e0d\u5177\u5907\u7684\u4fe1\u606f\u3002\u5728\u6211\u4eec\u7684\u793a\u4f8b\u4e2d\uff0c\u8868\u8de8\u8d8a\u591a\u5e74\u7684\u65f6\u95f4\u6233\u503c\uff0c\u4f46\u4efb\u4f55\u5355\u4e2a\u4e8b\u4ef6\u90fd\u8981\u77ed\u5f97\u591a\u3002</p> <p>\u5982\u679c\u6211\u4eec\u53ef\u4ee5\u786e\u5b9a\u4efb\u4e00\u7c7b\u578b\u4e8b\u4ef6\u7684\u6700\u5927\u6301\u7eed\u65f6\u95f4\u5e76\u5c06\u8be5\u4fe1\u606f\u4f20\u9012\u7ed9\u67e5\u8be2\u4f18\u5316\u5668\uff0c\u5b83\u5c31\u53ef\u4ee5\u626b\u63cf\u7d22\u5f15\u7684\u4e00\u5c0f\u90e8\u5206\u3002\u4f8b\u5982\uff0c\u5728\u6211\u4eec\u7684\u6570\u636e\u4e2d\uff0c\u6ca1\u6709\u987e\u5ba2\u7684\u8bbf\u95ee\u65f6\u95f4\u8d85\u8fc7 4 \u5c0f\u65f6\u3002\u6211\u4eec\u53ef\u4ee5\u6309\u7167\u4ee5\u4e0b\u65b9\u5f0f\u5c06\u6b64\u4fe1\u606f\u6dfb\u52a0\u5230\u6211\u4eec\u7684\u67e5\u8be2\u4e2d\uff1a</p> <pre><code>SELECT * \nFROM patrons p\n       CROSS JOIN outages o\nWHERE p.enter &lt;= o.end_time \n  AND p.enter &gt;= o.end_time - '1 hour'::INTERVAL*4 --&lt;&lt;\n  AND p.leave &gt;= o.start_time;\n</code></pre> <p>\u65b0\u7684\u5b50\u53e5\uff08\u540e\u7f00\u4e3a <code>-\u2013&lt;&lt;</code>\uff09\u8868\u793a <code>p.enter</code> \u73b0\u5728\u65e2\u6709\u6700\u5c0f\u503c\uff0c\u4e5f\u6709\u6700\u5927\u503c\u3002\u8fd9\u4f1a\u5c06\u8bed\u53e5\u8f6c\u6362\u4e3a\uff08\u7d22\u5f15\u53ef\u670d\u52a1\u7684\uff09\u8303\u56f4\u67e5\u8be2\u3002</p> <p>\u5047\u8bbe\u60a8\u4ecd\u7136\u6709\u6b64\u5217\u7684\u7d22\u5f15\uff0c\u67e5\u8be2\u65f6\u95f4\u7684\u6548\u679c\u5c06\u975e\u5e38\u663e\u8457\uff1a\u4ece 26 \u79d2\u7f29\u77ed\u5230 0.1 \u79d2\u3002\u54c7\uff01\u7a81\u7136\u6211\u4eec\u5c31\u6709\u4e86\u4e00\u4e2a\u5b9e\u7528\u7684\u67e5\u8be2\u3002</p> <p>\u6211\u4eec\u672c\u53ef\u4ee5\u5bf9\u505c\u7535\u91c7\u53d6\u76f8\u540c\u7684\u63aa\u65bd\uff0c\u800c\u4e0d\u662f\u4e3a\u987e\u5ba2\u8bbe\u7f6e\u6700\u5927\u8303\u56f4\u3002\u6216\u8005\u66f4\u597d\u7684\u662f\uff0c\u540c\u65f6\u4f7f\u7528\u4e24\u4e2a\u8868\u3002\u67e5\u8be2\u4f18\u5316\u5668\u4e0d\u4f1a\u540c\u65f6\u4f7f\u7528\u4e24\u4e2a\u8868\uff0c\u4f46\u5b83\u4f1a\u4f7f\u7528\u5b83\u8ba4\u4e3a\u6700\u9ad8\u6548\u7684\u4e00\u4e2a\u3002</p> <p>\u8fd9\u79cd\u6280\u672f\u7684\u6700\u5927\u4f18\u70b9\u662f\u5b83\u5141\u8bb8\u60a8\u4f7f\u7528\u53ef\u80fd\u5df2\u7ecf\u62e5\u6709\u7684\u7d22\u5f15\u3002\u4f46\u662f\uff0c\u8bf7\u5c0f\u5fc3\uff01\u5982\u679c\u4efb\u4f55\u6570\u636e\u8d85\u8fc7\u6b64\u6700\u5927\u6301\u7eed\u65f6\u95f4\uff0c\u5b83\u5c06\u88ab\u9519\u8bef\u5730\u4ece\u7ed3\u679c\u4e2d\u8fc7\u6ee4\u6389\u3002\u4f8b\u5982\uff0c\u65e0\u8bba\u91cd\u53e0\u591a\u5c11\u6b21\u4e2d\u65ad\uff0c\u6301\u7eed\u65f6\u95f4\u4e3a 6 \u5c0f\u65f6\u7684\u987e\u5ba2\u884c\u5bf9\u4e8e\u6b64\u67e5\u8be2\u90fd\u662f\u4e0d\u53ef\u89c1\u7684\u3002\u5982\u679c\u60a8\u4f7f\u7528\u6b64\u65b9\u6cd5\uff0c\u8bf7\u786e\u4fdd\u6839\u636e\u4e0d\u592a\u53ef\u80fd\u6539\u53d8\u7684\u4e1a\u52a1\u89c4\u5219\u6765\u786e\u5b9a\u6301\u7eed\u65f6\u95f4\uff0c\u800c\u4e0d\u662f\u7b80\u5355\u5730\u5047\u8bbe\u672a\u6765\u4e8b\u4ef6\u4e0e\u8fc7\u53bb\u4e8b\u4ef6\u76f8\u4f3c\u3002</p>"},{"location":"2024/11/14/solving-the-overlap-query-problem-in-postgresql/#gist","title":"GiST\uff1a\u524d\u8fdb\u4e4b\u8def","text":"<p>PostgreSQL \u63d0\u4f9b\u4e86 BTree \u7d22\u5f15\u7684\u66ff\u4ee3\u65b9\u6848\uff0c\u79f0\u4e3a GiST\u3002\u60a8\u53ef\u80fd\u5728\u67e5\u8be2\u4e8c\u7ef4\u6570\u636e\uff08\u5982\u51e0\u4f55\u5bf9\u8c61\u6216\u5730\u7406\u533a\u57df\uff09\u65f6\u9047\u5230\u8fc7 GiST \u7d22\u5f15\u3002\u4f46\u662f\uff0c\u8fd9\u4e9b\u7d22\u5f15\u540c\u6837\u64c5\u957f\u7d22\u5f15\u4e00\u7ef4\u65e5\u671f\u3001\u65f6\u95f4\u548c\u6570\u5b57\u8303\u56f4\u3002GiST\uff0c\u5373\u901a\u7528\u641c\u7d22\u6811\uff0c\u6b63\u662f\u6211\u4eec\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\u6240\u9700\u8981\u7684\u3002</p> <p>\u4e3a\u4e86\u4e3a\u6211\u4eec\u7684\u793a\u4f8b\u521b\u5efa\u5fc5\u8981\u7684\u7d22\u5f15\uff0c\u6211\u4eec\u4f7f\u7528 <code>tsrange()</code> \u51fd\u6570\u5c06\u4e24\u4e2a\u65f6\u95f4\u6233\u5f62\u6210\u4e00\u4e2a\u8303\u56f4\u7c7b\u578b\uff1a</p> <pre><code>CREATE INDEX ON patrons USING GIST(tsrange(enter,leave));\n</code></pre> <p>GiST \u7d22\u5f15\u8fd8\u4f7f\u7528\u7279\u6b8a\u8bed\u6cd5\u6765\u6bd4\u8f83\u91cd\u53e0\u503c\u7684\u8303\u56f4\uff1a<code>&amp;&amp;</code> \u8fd0\u7b97\u7b26\u3002\u4f7f\u7528\u6b64\u8fd0\u7b97\u7b26\uff0c\u6211\u4eec\u7684\u67e5\u8be2\u73b0\u5728\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>SELECT *\nFROM patrons p\nCROSS JOIN outages o\nWHERE tsrange(o.start_time, o.end_time) \n             &amp;&amp; tsrange(p.enter, p.leave);\n</code></pre> <p>\u5c31\u662f\u8fd9\u6837\u3002\u6b64\u67e5\u8be2\u73b0\u5728\u7684\u6267\u884c\u65f6\u95f4\u4e3a 0.56 \u79d2\uff1b\u51e0\u4e4e\u4e0e\u6211\u4eec\u4e0a\u9762\u7684\u201c\u7834\u89e3\u201d\u4e00\u6837\u5feb\u3002\u4e0e\u4e0a\u8ff0\u65b9\u6cd5\u4e0d\u540c\u7684\u662f\uff0c\u8be5\u65b9\u6cd5\u5728\u6240\u6709\u60c5\u51b5\u4e0b\u90fd\u80fd\u6b63\u786e\u8fd0\u884c\uff0c\u5373\u4f7f\u67d0\u4e9b\u4e8b\u4ef6\u7684\u6301\u7eed\u65f6\u95f4\u5f88\u957f\u3002\u65e0\u9700\u62c5\u5fc3\u5076\u5c14\u4f1a\u9519\u8bef\u5730\u8fc7\u6ee4\u6389\u6301\u7eed\u65f6\u95f4\u8f83\u957f\u7684\u4e8b\u4ef6\u3002</p> <p>GiST \u7d22\u5f15\u5c06\u6211\u4eec\u539f\u6765\u7684\u4e8c\u6b21\u6027\u80fd\u67e5\u8be2\u8f6c\u6362\u4e3a\u7ebf\u6027\u6027\u80fd\u3002\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5c06\u6837\u672c\u6570\u636e\u884c\u6570\u589e\u52a0 10 \u500d\u6765\u770b\u5230\u8fd9\u4e00\u70b9\u3002\u5f53\u6709 100 \u4e07\u540d\u987e\u5ba2\u548c 25 \u4e07\u6b21\u4e2d\u65ad\u65f6\uff0c\u67e5\u8be2\u65f6\u95f4\u4f1a\u589e\u52a0\u76f8\u540c\u7684\u500d\u6570\uff0c\u5373 5 \u79d2\uff0c\u800c <code>OVERLAP()</code> \u67e5\u8be2\u8868\u5355\u5219\u9700\u8981\u51e0\u4e2a\u5c0f\u65f6\u3002\u4f46\u5bf9\u4e8e\u975e\u5e38\u5927\u7684\u8868\uff0c\u7ebf\u6027\u6027\u80fd\u53ef\u80fd\u4ecd\u7136\u592a\u6162\u3002</p> <p>\u5728\u672c\u6587\u7684\u7b2c\u4e8c\u90e8\u5206\u4e2d\uff0c\u6211\u4eec\u5c06\u63a2\u8ba8\u8fdb\u4e00\u6b65\u6539\u8fdb\u7684\u53ef\u80fd\u6027\u3002</p>"},{"location":"2024/11/14/solving-the-overlap-query-problem-in-postgresql/#_5","title":"\u7ed3\u8bba","text":"<p>SQL \u4e2d\u770b\u4f3c\u7b80\u5355\u7684\u64cd\u4f5c\uff08\u4f8b\u5982\u67e5\u627e\u91cd\u53e0\u503c\uff09\u5374\u5b58\u5728\u4e00\u4e9b\u4ee4\u4eba\u60ca\u8bb6\u7684\u9677\u9631\u3002\u4e86\u89e3\u5982\u4f55\u5f62\u6210\u548c\u4f18\u5316\u6b64\u7c7b\u67e5\u8be2\u662f\u6240\u6709 SQL \u5f00\u53d1\u4eba\u5458\u90fd\u5e94\u8be5\u77e5\u9053\u7684\u4e8b\u60c5\u3002\u4f7f\u7528\u4e0a\u8ff0\u6280\u672f\uff0c\u60a8\u53ef\u4ee5\u5b9e\u73b0\u5de8\u5927\u7684\u6027\u80fd\u63d0\u5347\uff0c\u5e76\u6ee1\u8db3\u5bf9\u6027\u80fd\u8981\u6c42\u9ad8\u7684\u7528\u6237\u3002</p>"},{"location":"2024/11/14/solving-the-overlap-query-problem-in-postgresql/#_6","title":"\u9644\u5f55\uff1a\u521b\u5efa\u521d\u59cb\u6570\u636e\u5e93\u5e76\u586b\u5145\u968f\u673a\u6570\u636e\u7684\u811a\u672c","text":"<pre><code>-- \n-- This creates 100,000 patron visits, with a maximum \n-- stay at four hours, and 25,000\n-- outages (the system is quite unreliable) each ranging \n-- from 1 to 30 minutes.\n-- \nINSERT INTO patrons (enter, leave)\nSELECT r, r + '1 minute'::INTERVAL * (1+RANDOM() * 120) \nFROM (SELECT NOW() \u2013 \n        '1 minute'::INTERVAL * ROUND(RANDOM() * 15768000) AS r \n      FROM generate_series(1,100000)) AS sub;\nINSERT INTO outages (start_time, end_time)\nSELECT r, r + '1 minute'::INTERVAL * (1+(RANDOM() * 30)) \n  FROM (SELECT NOW() \u2013 '1 minute'::INTERVAL \n                   * ROUND(RANDOM() * 15768000) AS r \n        FROM generate_series(1,25000)) AS sub;\n-- Delete any malformed random entries\nDELETE FROM patrons WHERE enter &gt; leave;\nDELETE FROM outages WHERE start_time &gt; end_time;\n</code></pre> <p>\u4f5c\u8005\uff1aLee Asher \u539f\u6587\uff1ahttps://www.red-gate.com/simple-talk/databases/postgresql/solving-the-overlap-query-problem-in-postgresql/</p>"},{"location":"2024/12/22/some-of-my-favorite-things-postgres-queries/","title":"\u6211\u6700\u559c\u6b22\u7684\u4e00\u4e9b\u4e1c\u897f - Postgres \u67e5\u8be2","text":"<p>\u672c\u7740\u8282\u65e5\u7684\u6c14\u6c1b\uff0c\u6211\u60f3\u5199\u4e00\u7bc7\u7b80\u77ed\u7684\u6587\u7ae0\uff0c\u4ecb\u7ecd\u6211\u5728\u65e5\u5e38\u4f7f\u7528 Postgres \u65f6\u6700\u559c\u6b22\u7684\u4e00\u4e9b\u67e5\u8be2\u3002\u5176\u4e2d\u4e00\u4e9b\u67e5\u8be2\u662f\u6211\u81ea\u5df1\u5f00\u53d1\u7684\uff0c\u5176\u4ed6\u4e00\u4e9b\u5219\u662f\u5728\u4e92\u8054\u7f51\u4e0a\u627e\u5230\u7684\uff08\u5411\u4e4b\u524d\u53d1\u5e03\u8fc7\u5e16\u5b50\u7684\u4eba\u81f4\u656c\uff09\uff0c\u5e76\u5f97\u5230\u4e86\u8fdb\u4e00\u6b65\u5b8c\u5584\u3002</p> <p>\u5728\u6211\u7684 github \u7f51\u7ad9\u4e0a\u8fd8\u53ef\u4ee5\u627e\u5230\u66f4\u591a\uff1a</p> <p>https://github.com/shane-borden/sqlScripts/tree/master/postgres</p> <p>\u5e0c\u671b\u8fd9\u4e9b\u67e5\u8be2\u4e5f\u80fd\u5e2e\u52a9\u60a8\u5728\u65e5\u5e38\u5de5\u4f5c\u4e2d\u8ba9 Postgres \u8fd0\u884c\u5f97\u66f4\u597d\uff01</p> <p>\u524d\u4e09\u4e2a\u67e5\u8be2\u6839\u636e\u6267\u884c\u6b21\u6570\u3001<code>mean_exec_time</code> \u548c <code>total_exec_time</code> \u5bf9 <code>pg_stat_statements</code> \u4e2d\u7684 TOP SQL \u8fdb\u884c\u6392\u540d\u3002\u6211\u559c\u6b22\u4f7f\u7528\u8fd9\u4e9b\u67e5\u8be2\u6765\u5feb\u901f\u4e86\u89e3\u6211\u5e94\u8be5\u91cd\u70b9\u8c03\u6574\u7684\u5185\u5bb9\u3002\u9274\u4e8e <code>pg_stat_statements</code> \u8ddf\u8e2a\u5f88\u591a\u5185\u5bb9\uff0c\u60a8\u53ef\u4ee5\u6839\u636e\u9700\u8981\u8fc7\u6ee4\u6389\u67d0\u4e9b\u201c\u67e5\u8be2\u6587\u672c\u201d\uff0c\u8fd9\u6837\u5b83\u4eec\u5c31\u4e0d\u4f1a\u5f71\u54cd\u6392\u540d\u3002</p>"},{"location":"2024/12/22/some-of-my-favorite-things-postgres-queries/#top-sql","title":"\u6309\u5e73\u5747\u6267\u884c\u65f6\u95f4\u6392\u5e8f\u7684 TOP SQL","text":"<pre><code>WITH\nhist AS (\nSELECT queryid::text,\n       SUBSTRING(query from 1 for 1000) query,\n       ROW_NUMBER () OVER (ORDER BY mean_exec_time::numeric DESC) rn,\n       SUM(mean_exec_time::numeric) mean_exec_time\n  FROM pg_stat_statements\n WHERE queryid IS NOT NULL\n        AND query::text not like '%pg_%'\n        AND query::text not like '%g_%'\n        /* Add more filters here */\n GROUP BY\n       queryid,\n       SUBSTRING(query from 1 for 1000),\n       mean_exec_time::numeric\n),\ntotal AS (\nSELECT SUM(mean_exec_time::numeric) mean_exec_time FROM hist\n)\nSELECT DISTINCT\n       h.queryid::text,\n       ROUND(h.mean_exec_time::numeric,3) mean_exec_time,\n       ROUND(100 * h.mean_exec_time / t.mean_exec_time, 1) percent,\n       h.query\n  FROM hist h,\n       total t\n WHERE h.mean_exec_time &gt;= t.mean_exec_time / 1000 AND rn &lt;= 14\n UNION ALL\nSELECT 'Others',\n       ROUND(COALESCE(SUM(h.mean_exec_time), 0), 3) mean_exec_time,\n       COALESCE(ROUND(100 * SUM(h.mean_exec_time) / AVG(t.mean_exec_time), 1), 0) percent,\n       NULL sql_text\n  FROM hist h,\n       total t\n WHERE h.mean_exec_time &lt; t.mean_exec_time / 1000 OR rn &gt; 14\n ORDER BY 3 DESC NULLS LAST;\n</code></pre>"},{"location":"2024/12/22/some-of-my-favorite-things-postgres-queries/#top-sql_1","title":"\u6309\u603b\u6267\u884c\u65f6\u95f4\u6392\u5e8f\u7684 TOP SQL","text":"<pre><code>WITH\nhist AS (\nSELECT queryid::text,\n       SUBSTRING(query from 1 for 100) query,\n       ROW_NUMBER () OVER (ORDER BY total_exec_time::numeric DESC) rn,\n       SUM(total_exec_time::numeric) total_exec_time\n  FROM pg_stat_statements\n WHERE queryid IS NOT NULL\n        AND query::text not like '%pg_%'\n        AND query::text not like '%g_%'\n        /* Add more filters here */\n GROUP BY\n       queryid,\n       SUBSTRING(query from 1 for 100),\n       total_exec_time::numeric\n),\ntotal AS (\nSELECT SUM(total_exec_time::numeric) total_exec_time FROM hist\n)\nSELECT DISTINCT\n       h.queryid::text,\n       ROUND(h.total_exec_time::numeric,3) total_exec_time,\n       ROUND(100 * h.total_exec_time / t.total_exec_time, 1) percent,\n       h.query\n  FROM hist h,\n       total t\n WHERE h.total_exec_time &gt;= t.total_exec_time / 1000 AND rn &lt;= 14\n UNION ALL\nSELECT 'Others',\n       ROUND(COALESCE(SUM(h.total_exec_time::numeric), 0), 3) total_exec_time,\n       COALESCE(ROUND(100 * SUM(h.total_exec_time) / AVG(t.total_exec_time), 1), 0) percent,\n       NULL sql_text\n  FROM hist h,\n       total t\n WHERE h.total_exec_time &lt; t.total_exec_time / 1000 OR rn &gt; 14\n ORDER BY 3 DESC NULLS LAST;\n</code></pre>"},{"location":"2024/12/22/some-of-my-favorite-things-postgres-queries/#top-sql_2","title":"\u6309\u6267\u884c\u6b21\u6570\u6392\u540d\u7684 TOP SQL","text":"<pre><code>WITH\nhist AS (\nSELECT queryid::text,\n       SUBSTRING(query from 1 for 100) query,\n       ROW_NUMBER () OVER (ORDER BY calls DESC) rn,\n       calls\n  FROM pg_stat_statements \n WHERE queryid IS NOT NULL\n        AND query::text not like '%pg_%'\n        AND query::text not like '%g_%'\n        /* Add more filters here */\n GROUP BY\n       queryid,\n       SUBSTRING(query from 1 for 100),\n       calls\n),\ntotal AS (\nSELECT SUM(calls) calls FROM hist\n)\nSELECT DISTINCT\n       h.queryid::text,\n       h.calls,\n       ROUND(100 * h.calls / t.calls, 1) percent,\n       h.query\n  FROM hist h,\n       total t\n WHERE h.calls &gt;= t.calls / 1000 AND rn &lt;= 14\n UNION ALL\nSELECT 'Others',\n       COALESCE(SUM(h.calls), 0) calls,\n       COALESCE(ROUND(100 * SUM(h.calls) / AVG(t.calls), 1), 0) percent,\n       NULL sql_text\n  FROM hist h,\n       total t\n WHERE h.calls &lt; t.calls / 1000 OR rn &gt; 14\n ORDER BY 2 DESC NULLS LAST;\n</code></pre>"},{"location":"2024/12/22/some-of-my-favorite-things-postgres-queries/#toast","title":"\u5305\u542b TOAST \u7684\u5bf9\u8c61\u5927\u5c0f","text":"<p>\u663e\u793a\u8868\u7684\u603b\u5927\u5c0f\uff0c\u5305\u62ec\u5176\u7d22\u5f15\u548c toast \u5927\u5c0f\u3002</p> <pre><code>SELECT\n  *,\n  pg_size_pretty(table_bytes) AS table,\n  pg_size_pretty(toast_bytes) AS toast,\n  pg_size_pretty(index_bytes) AS index,\n  pg_size_pretty(total_bytes) AS total\nFROM (\n  SELECT\n    *, total_bytes - index_bytes - COALESCE(toast_bytes, 0) AS table_bytes\n  FROM (\n    SELECT\n      c.oid,\n      nspname AS table_schema,\n      relname AS table_name,\n      c.reltuples AS row_estimate,\n      pg_total_relation_size(c.oid) AS total_bytes,\n      pg_indexes_size(c.oid) AS index_bytes,\n      pg_total_relation_size(reltoastrelid) AS toast_bytes\n    FROM\n      pg_class c\n      LEFT JOIN pg_namespace n ON n.oid = c.relnamespace\n    WHERE relkind = 'r'\n  ) a\n) a\nWHERE table_schema like '%'\nAND table_name like '%'\nAND total_bytes &gt; 0\nORDER BY total_bytes DESC;\n</code></pre>"},{"location":"2024/12/22/some-of-my-favorite-things-postgres-queries/#cpu-sql","title":"\u4f7f\u7528 CPU \u7684 SQL \u8bed\u53e5","text":"<p>\u4f7f\u7528 <code>pg_stat_statements</code>\uff0c\u6b64\u67e5\u8be2\u5c06\u628a\u603b\u65f6\u95f4\u5206\u914d\u4e3a CPU \u65f6\u95f4\u3002</p> <pre><code>SELECT\n    pss.userid,\n    pss.dbid,\n    pd.datname AS db_name,\n    pss.queryid,\n    round((pss.total_exec_time + pss.total_plan_time)::numeric, 2) AS total_time,\n    pss.calls,\n    round((pss.mean_exec_time + pss.mean_plan_time)::numeric, 2) AS mean,\n    round((100 * (pss.total_exec_time + pss.total_plan_time) / sum((pss.total_exec_time + pss.total_plan_time)::numeric) OVER ())::numeric, 2) AS cpu_portion_pctg,\n    substr(pss.query, 1, 200) short_query\nFROM\n    pg_stat_statements pss,\n    pg_database pd\nWHERE\n    pd.oid = pss.dbid\n    AND query::text NOT LIKE '%FOR UPDATE%'\n    /* Add more filters here */\nORDER BY\n    (pss.total_exec_time + pss.total_plan_time) DESC\nLIMIT 30;\n</code></pre>"},{"location":"2024/12/22/some-of-my-favorite-things-postgres-queries/#_1","title":"\u7edf\u8ba1/\u56de\u6536\u811a\u672c","text":"<p>\u6b64\u811a\u672c\u67e5\u770b\u4e3a vacuum \u548c analyze \u8bbe\u7f6e\u7684\u6570\u636e\u5e93\u548c\u8868\u9009\u9879\uff0c\u4ee5\u63d0\u4f9b\u8ba1\u5212\u8fd0\u884c vacuum/analyze \u7684\u65f6\u95f4\u4ee5\u53ca\u4e0a\u6b21\u8fd0\u884c\u65f6\u95f4\u7684\u62a5\u544a\u3002\u6b64\u811a\u672c\u5c06\u8ba9\u60a8\u5f88\u597d\u5730\u4e86\u89e3 vacuum \u548c analyze \u7684\u8fd0\u884c\u60c5\u51b5\uff1a</p> <pre><code>WITH tbl_reloptions AS (\nSELECT\n    oid,\n    oid::regclass table_name,\n    substr(unnest(reloptions), 1,  strpos(unnest(reloptions), '=') -1) option,\n    substr(unnest(reloptions), 1 + strpos(unnest(reloptions), '=')) value\nFROM\n    pg_class c\nWHERE reloptions is NOT null)\nSELECT\n    s.schemaname ||'.'|| s.relname as relname,\n    n_live_tup live_tup,\n    n_dead_tup dead_dup,\n    n_tup_hot_upd hot_upd,\n    n_mod_since_analyze mod_since_stats,\n    n_ins_since_vacuum ins_since_vac,\n    case\n      when avacinsscalefactor.value is not null and avacinsthresh.value is not null\n        then ROUND(((n_live_tup * avacinsscalefactor.value::numeric) + avacinsthresh.value::numeric),0)\n      when avacinsscalefactor.value is null and avacinsthresh.value is not null\n        then ROUND(((n_live_tup * (select setting::numeric from pg_settings where name = 'autovacuum_vacuum_insert_scale_factor')) + avacinsthresh.value::numeric),0)\n      when avacinsscalefactor.value is not null and avacinsthresh.value is null\n        then ROUND(((n_live_tup * avacinsscalefactor.value::numeric) + (select setting::numeric from pg_settings where name = 'autovacuum_vacuum_insert_threshold')),0)\n      else ROUND(((n_live_tup * (select setting::numeric from pg_settings where name = 'autovacuum_vacuum_insert_scale_factor')) + (select setting::numeric from pg_settings where name = 'autovacuum_vacuum_insert_threshold')),0) \n    end as ins_for_vac,\n    case\n      when avacscalefactor.value is not null and avacthresh.value is not null\n        then ROUND(((n_live_tup * avacscalefactor.value::numeric) + avacthresh.value::numeric),0)\n      when avacscalefactor.value is null and avacthresh.value is not null\n        then ROUND(((n_live_tup * (select setting::numeric from pg_settings where name = 'autovacuum_vacuum_scale_factor')) + avacthresh.value::numeric),0)\n      when avacscalefactor.value is not null and avacthresh.value is null\n        then ROUND(((n_live_tup * avacscalefactor.value::numeric) + (select setting::numeric from pg_settings where name = 'autovacuum_vacuum_threshold')),0)\n      else ROUND(((n_live_tup * (select setting::numeric from pg_settings where name = 'autovacuum_vacuum_scale_factor')) + (select setting::numeric from pg_settings where name = 'autovacuum_vacuum_threshold')),0) \n    end as mods_for_vac,\n    case\n      when avacanalyzescalefactor.value is not null and avacanalyzethresh.value is not null\n        then ROUND(((n_live_tup * avacanalyzescalefactor.value::numeric) + avacanalyzethresh.value::numeric),0)\n      when avacanalyzescalefactor.value is null and avacanalyzethresh.value is not null\n        then ROUND(((n_live_tup * (select setting::numeric from pg_settings where name = 'autovacuum_analyze_scale_factor')) + avacanalyzethresh.value::numeric),0)\n      when avacanalyzescalefactor.value is not null and avacanalyzethresh.value is null\n        then ROUND(((n_live_tup * avacanalyzescalefactor.value::numeric) + (select setting::numeric from pg_settings where name = 'autovacuum_analyze_threshold')),0)\n      else ROUND(((n_live_tup * (select setting::numeric from pg_settings where name = 'autovacuum_analyze_scale_factor')) + (select setting::numeric from pg_settings where name = 'autovacuum_analyze_threshold')),0) \n    end as mods_for_stats,\n    case\n      when avacfreezeage is not null\n        then ROUND((greatest(age(c.relfrozenxid),age(t.relfrozenxid))::numeric / avacfreezeage.value::numeric * 100),2) \n      else ROUND((greatest(age(c.relfrozenxid),age(t.relfrozenxid))::numeric / (select setting::numeric from pg_settings where name = 'autovacuum_freeze_max_age') * 100),2) \n      end as avac_pct_frz,\n    greatest(age(c.relfrozenxid),age(t.relfrozenxid)) max_txid_age,\n    to_char(last_vacuum, 'YYYY-MM-DD HH24:MI') last_vac,\n    to_char(last_analyze, 'YYYY-MM-DD HH24:MI') last_stats,\n    to_char(last_autovacuum, 'YYYY-MM-DD HH24:MI') last_avac,\n    to_char(last_autoanalyze, 'YYYY-MM-DD HH24:MI') last_astats,\n    vacuum_count vac_cnt,\n    analyze_count stats_cnt,\n    autovacuum_count avac_cnt,\n    autoanalyze_count astats_cnt,\n    c.reloptions,\n    case\n      when avacenabled.value is not null\n        then avacenabled.value::text\n      when (select setting::text from pg_settings where name = 'autovacuum') = 'on'\n        then 'true'\n      else 'false'\n    end as autovac_enabled\nFROM\n    pg_stat_all_tables s\nJOIN pg_class c ON (s.relid = c.oid)\nLEFT JOIN pg_class t ON c.reltoastrelid = t.oid\nLEFT JOIN tbl_reloptions avacinsscalefactor on (s.relid = avacinsscalefactor.oid and avacinsscalefactor.option = 'autovacuum_vacuum_insert_scale_factor')\nLEFT JOIN tbl_reloptions avacinsthresh on (s.relid = avacinsthresh.oid and avacinsthresh.option = 'autovacuum_vacuum_insert_threshold')\nLEFT JOIN tbl_reloptions avacscalefactor on (s.relid = avacscalefactor.oid and avacscalefactor.option = 'autovacuum_vacuum_scale_factor')\nLEFT JOIN tbl_reloptions avacthresh on (s.relid = avacthresh.oid and avacthresh.option = 'autovacuum_vacuum_threshold')\nLEFT JOIN tbl_reloptions avacanalyzescalefactor on (s.relid = avacanalyzescalefactor.oid and avacanalyzescalefactor.option = 'autovacuum_analyze_scale_factor')\nLEFT JOIN tbl_reloptions avacanalyzethresh on (s.relid = avacanalyzethresh.oid and avacanalyzethresh.option = 'autovacuum_analyze_threshold')\nLEFT JOIN tbl_reloptions avacfreezeage on (s.relid = avacfreezeage.oid and avacfreezeage.option = 'autovacuum_freeze_max_age')\nLEFT JOIN tbl_reloptions avacenabled on (s.relid = avacenabled.oid and avacenabled.option = 'autovacuum_enabled')\nWHERE\n    s.relname IN (\n        SELECT\n            t.table_name\n        FROM\n            information_schema.tables t\n            JOIN pg_catalog.pg_class c ON (t.table_name = c.relname)\n            LEFT JOIN pg_catalog.pg_user u ON (c.relowner = u.usesysid)\n        WHERE\n            t.table_schema like '%'\n            AND (u.usename like '%' OR u.usename is null)\n            AND t.table_name like '%'\n            AND t.table_schema not in ('information_schema','pg_catalog')\n            AND t.table_type not in ('VIEW')\n            AND t.table_catalog = current_database())\n    AND n_dead_tup &gt;= 0\n    AND n_live_tup &gt; 0\nORDER BY 3;\n</code></pre>"},{"location":"2024/12/22/some-of-my-favorite-things-postgres-queries/#_2","title":"\u672a\u4f7f\u7528/\u5f88\u5c11\u4f7f\u7528\u7684\u7d22\u5f15","text":"<p>\u4e3a\u4e86\u4fdd\u6301\u7cfb\u7edf\u8fd0\u884c\u826f\u597d\uff0c\u7ef4\u62a4\u5c3d\u53ef\u80fd\u5c11\u7684\u7d22\u5f15\u975e\u5e38\u91cd\u8981\u3002\u8fd9\u5c06\u663e\u793a\u54ea\u4e9b\u7d22\u5f15\u6700\u8fd1\u6ca1\u6709\u88ab\u4f7f\u7528\u8fc7\u3002</p> <pre><code>WITH table_scans AS (\n    SELECT\n        relid,\n        tables.idx_scan + tables.seq_scan AS all_scans,\n        (tables.n_tup_ins + tables.n_tup_upd + tables.n_tup_del) AS writes,\n        pg_relation_size(relid) AS table_size\n    FROM\n        pg_stat_all_tables AS tables\n    WHERE\n        schemaname NOT IN ('pg_toast', 'pg_catalog', 'partman')\n),\nall_writes AS (\n    SELECT\n        sum(writes) AS total_writes\n    FROM\n        table_scans\n),\nindexes AS (\n    SELECT\n        idx_stat.relid,\n        idx_stat.indexrelid,\n        idx_stat.schemaname,\n        idx_stat.relname AS tablename,\n        idx_stat.indexrelname AS indexname,\n        idx_stat.idx_scan,\n        pg_relation_size(idx_stat.indexrelid) AS index_bytes,\n        indexdef ~* 'USING btree' AS idx_is_btree\n    FROM\n        pg_stat_user_indexes AS idx_stat\n        JOIN pg_index USING (indexrelid)\n        JOIN pg_indexes AS indexes ON idx_stat.schemaname = indexes.schemaname\n            AND idx_stat.relname = indexes.tablename\n            AND idx_stat.indexrelname = indexes.indexname\n    WHERE\n        pg_index.indisunique = FALSE\n),\nindex_ratios AS (\n    SELECT\n        schemaname,\n        tablename,\n        indexname,\n        idx_scan,\n        all_scans,\n        round((\n            CASE WHEN all_scans = 0 THEN\n                0.0::numeric\n            ELSE\n                idx_scan::numeric / all_scans * 100\n            END), 2) AS index_scan_pct,\n        writes,\n        round((\n            CASE WHEN writes = 0 THEN\n                idx_scan::numeric\n            ELSE\n                idx_scan::numeric / writes\n            END), 2) AS scans_per_write,\n        pg_size_pretty(index_bytes) AS index_size,\n        pg_size_pretty(table_size) AS table_size,\n        idx_is_btree,\n        index_bytes\n    FROM\n        indexes\n        JOIN table_scans USING (relid)\n),\nindex_groups AS (\n    SELECT\n        'Never Used Indexes' AS reason,\n        *,\n        1 AS grp\n    FROM\n        index_ratios\n    WHERE\n        idx_scan = 0\n        AND idx_is_btree\n    UNION ALL\n    SELECT\n        'Low Scans, High Writes' AS reason,\n        *,\n        2 AS grp\n    FROM\n        index_ratios\n    WHERE\n        scans_per_write &lt;= 1\n        AND index_scan_pct &lt; 10\n        AND idx_scan &gt; 0\n        AND writes &gt; 100\n        AND idx_is_btree\n    UNION ALL\n    SELECT\n        'Seldom Used Large Indexes' AS reason,\n        *,\n        3 AS grp\n    FROM\n        index_ratios\n    WHERE\n        index_scan_pct &lt; 5\n        AND scans_per_write &gt; 1\n        AND idx_scan &gt; 0\n        AND idx_is_btree\n        AND index_bytes &gt; 100000000\n    UNION ALL\n    SELECT\n        'High-Write Large Non-Btree' AS reason,\n        index_ratios.*,\n        4 AS grp\n    FROM\n        index_ratios,\n        all_writes\n    WHERE (writes::numeric / (total_writes + 1)) &gt; 0.02\n    AND NOT idx_is_btree\n    AND index_bytes &gt; 100000000\nORDER BY\n    grp,\n    index_bytes DESC\n)\nSELECT\n    reason,\n    schemaname,\n    tablename,\n    indexname,\n    index_scan_pct,\n    scans_per_write,\n    index_size,\n    table_size\nFROM\n    index_groups\nWHERE\n    tablename LIKE '%';\n</code></pre>"},{"location":"2024/12/22/some-of-my-favorite-things-postgres-queries/#_3","title":"\u6392\u540d\u7b49\u5f85\u4e8b\u4ef6","text":"<p>\u8fd9\u662f\u4e00\u9879\u5f88\u68d2\u7684\u67e5\u8be2\uff0c\u53ef\u4ee5\u5bf9 <code>pg_stat_activity</code> \u4e2d\u89c2\u5bdf\u5230\u7684\u7b49\u5f85\u4e8b\u4ef6\u4ece\u6700\u9891\u7e41\u5230\u6700\u4e0d\u9891\u7e41\u8fdb\u884c\u6392\u5e8f\u3002\u8fd9\u4e0d\u63d0\u4f9b\u5386\u53f2\u53c2\u8003\uff0c\u800c\u662f\u67e5\u770b\u5f53\u524d\u65f6\u523b\uff1a</p> <pre><code>WITH waits AS (\n    SELECT\n        wait_event,\n        rank() OVER (ORDER BY count(wait_event) DESC) rn\n    FROM pg_stat_activity\n    WHERE wait_event IS NOT NULL\nGROUP BY wait_event ORDER BY count(wait_event) ASC\n),\ntotal AS (\n    SELECT\n        SUM(rn) total_waits\n    FROM\n        waits\n)\nSELECT DISTINCT\n    h.wait_event,\n    h.rn,\n    ROUND(100 * h.rn / t.total_waits, 1) percent\nFROM\n    waits h,\n    total t\nWHERE\n    h.rn &gt;= t.total_waits / 1000\n    AND rn &lt;= 14\nUNION ALL\nSELECT\n    'Others',\n    COALESCE(SUM(h.rn), 0) rn,\n    COALESCE(ROUND(100 * SUM(h.rn) / AVG(t.total_waits), 1), 0) percent\nFROM\n    waits h,\n    total t\nWHERE\n    h.rn &lt; t.total_waits / 1000\n    OR rn &gt; 14\nORDER BY\n    2 DESC NULLS LAST;\n</code></pre>"},{"location":"2024/12/22/some-of-my-favorite-things-postgres-queries/#_4","title":"\u7f3a\u5c11\u5916\u952e\u7d22\u5f15\u7684\u8868","text":"<p>\u901a\u5e38\uff0c\u5f53\u5916\u952e\u6ca1\u6709\u7d22\u5f15\u652f\u6301\u65f6\uff0c\u67e5\u8be2\u7684\u8fd0\u884c\u65f6\u95f4\u4f1a\u5f88\u5dee\u3002\u4ee5\u4e0b\u67e5\u8be2\u53ef\u4ee5\u663e\u793a\u7f3a\u5c11\u7684\u7d22\u5f15\uff1a</p> <pre><code>WITH y AS (\n    SELECT\n        pg_catalog.format('%I.%I', n1.nspname, c1.relname) AS referencing_tbl,\n        pg_catalog.quote_ident(a1.attname) AS referencing_column,\n        t.conname AS existing_fk_on_referencing_tbl,\n        pg_catalog.format('%I.%I', n2.nspname, c2.relname) AS referenced_tbl,\n        pg_catalog.quote_ident(a2.attname) AS referenced_column,\n        pg_relation_size(pg_catalog.format('%I.%I', n1.nspname, c1.relname)) AS referencing_tbl_bytes,\n        pg_relation_size(pg_catalog.format('%I.%I', n2.nspname, c2.relname)) AS referenced_tbl_bytes,\n        pg_catalog.format($$CREATE INDEX ON %I.%I(%I);$$, n1.nspname, c1.relname, a1.attname) AS suggestion\n    FROM\n        pg_catalog.pg_constraint t\n        JOIN pg_catalog.pg_attribute a1 ON a1.attrelid = t.conrelid\n            AND a1.attnum = t.conkey[1]\n        JOIN pg_catalog.pg_class c1 ON c1.oid = t.conrelid\n        JOIN pg_catalog.pg_namespace n1 ON n1.oid = c1.relnamespace\n        JOIN pg_catalog.pg_class c2 ON c2.oid = t.confrelid\n        JOIN pg_catalog.pg_namespace n2 ON n2.oid = c2.relnamespace\n        JOIN pg_catalog.pg_attribute a2 ON a2.attrelid = t.confrelid\n            AND a2.attnum = t.confkey[1]\n    WHERE\n        t.contype = 'f'\n        AND NOT EXISTS (\n            SELECT\n                1\n            FROM\n                pg_catalog.pg_index i\n            WHERE\n                i.indrelid = t.conrelid\n                AND i.indkey[0] = t.conkey[1]))\nSELECT\n    referencing_tbl,\n    referencing_column,\n    existing_fk_on_referencing_tbl,\n    referenced_tbl,\n    referenced_column,\n    pg_size_pretty(referencing_tbl_bytes) AS referencing_tbl_size,\n    pg_size_pretty(referenced_tbl_bytes) AS referenced_tbl_size,\n    suggestion\nFROM\n    y\nORDER BY\n    referencing_tbl_bytes DESC,\n    referenced_tbl_bytes DESC,\n    referencing_tbl,\n    referenced_tbl,\n    referencing_column,\n    referenced_column;\n</code></pre>"},{"location":"2024/12/22/some-of-my-favorite-things-postgres-queries/#_5","title":"\u963b\u585e\u9501\u6811","text":"<p>postgres.ai \u662f\u83b7\u53d6\u4e00\u4e9b\u53ef\u89c2\u5bdf\u6027\u67e5\u8be2\u7684\u597d\u5730\u65b9\uff0c\u8fd9\u662f\u6211\u6700\u559c\u6b22\u7684\u67e5\u8be2\u4e4b\u4e00\uff1a</p> <pre><code>with recursive activity as (\n  select\n    pg_blocking_pids(pid) blocked_by,\n    *,\n    age(clock_timestamp(), xact_start)::interval(0) as tx_age,\n    -- \"pg_locks.waitstart\" \u2013 PG14+ only; for older versions:  age(clock_timestamp(), state_change) as wait_age,\n    age(clock_timestamp(), (select max(l.waitstart) from pg_locks l where a.pid = l.pid))::interval(0) as wait_age\n  from pg_stat_activity a\n  where state is distinct from 'idle'\n), blockers as (\n  select\n    array_agg(distinct c order by c) as pids\n  from (\n    select unnest(blocked_by)\n    from activity\n  ) as dt(c)\n), tree as (\n  select\n    activity.*,\n    1 as level,\n    activity.pid as top_blocker_pid,\n    array[activity.pid] as path,\n    array[activity.pid]::int[] as all_blockers_above\n  from activity, blockers\n  where\n    array[pid] &lt;@ blockers.pids\n    and blocked_by = '{}'::int[]\n  union all\n  select\n    activity.*,\n    tree.level + 1 as level,\n    tree.top_blocker_pid,\n    path || array[activity.pid] as path,\n    tree.all_blockers_above || array_agg(activity.pid) over () as all_blockers_above\n  from activity, tree\n  where\n    not array[activity.pid] &lt;@ tree.all_blockers_above\n    and activity.blocked_by &lt;&gt; '{}'::int[]\n    and activity.blocked_by &lt;@ tree.all_blockers_above\n)\nselect\n  pid,\n  blocked_by,\n  case when wait_event_type &lt;&gt; 'Lock' then replace(state, 'idle in transaction', 'idletx') else 'waiting' end as state,\n  wait_event_type || ':' || wait_event as wait,\n  wait_age,\n  tx_age,\n  to_char(age(backend_xid), 'FM999,999,999,990') as xid_age,\n  to_char(2147483647 - age(backend_xmin), 'FM999,999,999,990') as xmin_ttf,\n  datname,\n  usename,\n  (select count(distinct t1.pid) from tree t1 where array[tree.pid] &lt;@ t1.path and t1.pid &lt;&gt; tree.pid) as blkd,\n  format(\n    '%s %s%s',\n    lpad('[' || pid::text || ']', 9, ' '),\n    repeat('.', level - 1) || case when level &gt; 1 then ' ' end,\n    left(query, 1000)\n  ) as query\nfrom tree\norder by top_blocker_pid, level, pid;\n</code></pre> <p>\u4f5c\u8005\uff1aShane Borden \u539f\u6587\uff1ahttps://stborden.wordpress.com/2024/12/17/some-of-my-favorite-things-postgres-queries/</p>"},{"location":"2024/12/23/sql-query-optimization-guide/","title":"SQL \u67e5\u8be2\u4f18\u5316\uff1a\u5168\u9762\u7684\u5f00\u53d1\u8005\u6307\u5357","text":"<p>\u9762\u5411\u5f00\u53d1\u4eba\u5458\u7684 SQL \u4f18\u5316\u6307\u5357\u3002\u5176\u4e2d\u5305\u542b\u6700\u4f73\u5b9e\u8df5\u3001\u8b66\u544a\u548c\u4e13\u4e1a\u63d0\u793a\uff0c\u53ef\u52a0\u5feb SQL \u67e5\u8be2\u4f18\u5316\u3002</p> <p>\u5f53\u60a8\u6709\u4e00\u4e2a\u6570\u636e\u5e93\u65f6\uff0c\u60a8\u5c06\u5982\u4f55\u4f18\u5316 SQL \u6027\u80fd\uff1f\u8981\u56de\u7b54\u8fd9\u4e2a\u95ee\u9898\uff0c\u60a8\u9700\u8981\u6295\u5165\u5927\u91cf\u7684\u65f6\u95f4\u548c\u7cbe\u529b\u6765\u4e86\u89e3\u5de5\u4f5c\u8d1f\u8f7d\u548c\u6027\u80fd\u6a21\u5f0f\u3001\u8bc4\u4f30\u6027\u80fd\u4e0b\u964d\u60c5\u51b5\u5e76\u91c7\u53d6\u7ea0\u6b63\u63aa\u65bd\u3002\u4f46\u662f\uff0c\u60a8\u53ef\u4ee5\u5b9e\u65bd\u6807\u51c6\u5b9e\u8df5\u6765\u63d0\u9ad8\u6027\u80fd\u3002\u672c SQL \u4f18\u5316\u6307\u5357\u5c06\u5c55\u793a\u4e00\u4e9b\u9002\u7528\u4e8e\u51e0\u4e4e\u6240\u6709\u6570\u636e\u5e93\u7684\u6700\u4f73\u5b9e\u8df5\uff0c\u5e76\u4e14\u53ef\u4ee5\u4f5c\u4e3a\u4f18\u5316\u6570\u636e\u5e93\u5de5\u4f5c\u8d1f\u8f7d\u7684\u826f\u597d\u8d77\u70b9\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql","title":"\u5982\u4f55\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":""},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_1","title":"\u901a\u8fc7\u4e86\u89e3\u67e5\u8be2\u6267\u884c\u8ba1\u5212\u6765\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u6240\u6709\u73b0\u4ee3\u6570\u636e\u5e93\uff08\u4f8b\u5982 MySQL \u548c PostgreSQL\u00ae\uff09\u90fd\u4f1a\u6839\u636e\u6240\u6d89\u53ca\u7684\u5404\u4e2a\u8868\u7684\u57fa\u6570\u4ee5\u53ca\u53ef\u7528\u7684\u8f85\u52a9\u6570\u636e\u7ed3\u6784\uff08\u4f8b\u5982\u7d22\u5f15\u6216\u5206\u533a\uff09\u6765\u5b9a\u4e49\u6700\u4f73\u67e5\u8be2\u6267\u884c\u8ba1\u5212\u3002MySQL \u548c PostgreSQL \u90fd\u63d0\u4f9b\u4e86\u4e00\u4e2a\u540d\u4e3a <code>EXPLAIN</code> \u7684\u547d\u4ee4\u6765\u663e\u793a\u8bed\u53e5\u7684\u6267\u884c\u8ba1\u5212\u3002\u4ece\u6267\u884c\u8ba1\u5212\u4e2d\uff0c\u60a8\u53ef\u4ee5\u4e86\u89e3\u8868\u662f\u5982\u4f55\u8fde\u63a5\u7684\uff0c\u662f\u5426\u4f7f\u7528\u7d22\u5f15\uff0c\u662f\u5426\u4fee\u526a\u5206\u533a\u4ee5\u53ca\u53ef\u80fd\u5f71\u54cd\u67e5\u8be2\u6027\u80fd\u5176\u4ed6\u65b9\u9762\u3002\u67e5\u8be2\u8ba1\u5212\u63d0\u793a\u4e86\u6bcf\u4e2a\u64cd\u4f5c\u7684\u6210\u672c\uff0c\u5e76\u4e14\u53ef\u4ee5\u6807\u8bb0\u662f\u5426\u672a\u4f7f\u7528\u7d22\u5f15\u3002</p> <p>\u8981\u83b7\u53d6\u67e5\u8be2\u7684\u6267\u884c\u8ba1\u5212\uff0c\u60a8\u53ea\u9700\u8981\u5728\u67e5\u8be2\u524d\u52a0\u4e0a <code>EXPLAIN</code> \u5373\u53ef\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>EXPLAIN SELECT id\nFROM orders\nWHERE\norder_timestamp between '2024-02-01 00:00:00' and '2024-02-03 00:00:00' \nOR status = 'NEW';\n</code></pre> <p>\u5728\u6b64\u793a\u4f8b\u4e2d\uff0c\u6570\u636e\u5e93\u8fd4\u56de\u7684\u6267\u884c\u8ba1\u5212\u5c55\u793a\u4e86 <code>idx_order_date</code> \u548c <code>idx_order_status</code> \u4e24\u4e2a\u7d22\u5f15\u4ee5\u53ca\u4e24\u4e2a\u7ed3\u679c\u4e4b\u95f4\u7684 <code>BitmapOr</code> \u7684\u4f7f\u7528\u60c5\u51b5\u3002</p> <pre><code>                                                                                            QUERY PLAN\n---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n Bitmap Heap Scan on orders  (cost=687.35..7149.18 rows=60333 width=4)\n   Recheck Cond: (((order_timestamp &gt;= '2024-02-01 00:00:00'::timestamp without time zone) AND (order_timestamp &lt;= '2024-02-03 00:00:00'::timestamp without time zone)) OR (status = 'NEW'::text))\n   -&gt;  BitmapOr  (cost=687.35..687.35 rows=60333 width=0)\n         -&gt;  Bitmap Index Scan on idx_order_date  (cost=0.00..655.75 rows=60333 width=0)\n               Index Cond: ((order_timestamp &gt;= '2024-02-01 00:00:00'::timestamp without time zone) AND (order_timestamp &lt;= '2024-02-03 00:00:00'::timestamp without time zone))\n         -&gt;  Bitmap Index Scan on idx_order_status  (cost=0.00..1.43 rows=1 width=0)\n               Index Cond: (status = 'NEW'::text)\n(7 rows)\n</code></pre>"},{"location":"2024/12/23/sql-query-optimization-guide/#_1","title":"\u8b66\u544a","text":"<p>\u6570\u636e\u5e93\u4f18\u5316\u5668\u5c06\u6839\u636e\u57fa\u6570\u4f30\u8ba1\u751f\u6210\u6267\u884c\u8ba1\u5212\u3002\u8fd9\u4e9b\u4f30\u8ba1\u8d8a\u63a5\u8fd1\u8868\u4e2d\u7684\u6570\u636e\uff0c\u6570\u636e\u5e93\u5c31\u8d8a\u80fd\u591f\u5b9a\u4e49\u6700\u4f73\u8ba1\u5212\u3002\u8ba1\u5212\u4e5f\u4f1a\u968f\u7740\u65f6\u95f4\u800c\u6539\u53d8\uff0c\u56e0\u6b64\uff0c\u5f53\u67e5\u8be2\u6027\u80fd\u7a81\u7136\u4e0b\u964d\u65f6\uff0c\u8ba1\u5212\u7684\u6539\u53d8\u53ef\u80fd\u662f\u539f\u56e0\u4e4b\u4e00\u3002\u8be5\u8ba1\u5212\u8fd8\u5c06\u53d6\u51b3\u4e8e\u8868\u548c\u6570\u636e\u5e93\u4e2d\u521b\u5efa\u7684\u7d22\u5f15\u7b49\u5176\u4ed6\u8f85\u52a9\u7ed3\u6784\uff0c\u5728\u4e0b\u4e00\u8282\u4e2d\uff0c\u6211\u4eec\u5c06\u5206\u6790\u5176\u4ed6\u7ed3\u6784\u5982\u4f55\u5f71\u54cd\u6027\u80fd\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_2","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u82b1\u65f6\u95f4\u4e86\u89e3\u67e5\u8be2\u6267\u884c\u8ba1\u5212\u4ee5\u627e\u5230\u6f5c\u5728\u7684\u6027\u80fd\u74f6\u9888\u3002\u4f7f\u7528 <code>ANALYZE</code> \u547d\u4ee4\u81ea\u52a8\u6216\u624b\u52a8\u66f4\u65b0\u7edf\u8ba1\u6570\u636e\uff0c\u4e3a\u6570\u636e\u5e93\u63d0\u4f9b\u6709\u5173\u5404\u4e2a\u8868\u8d1f\u8f7d\u7684\u6700\u65b0\u4fe1\u606f\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_2","title":"\u901a\u8fc7\u4f7f\u7528\u7d22\u5f15\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u4e0a\u9762\u5b9a\u4e49\u7684\u51e0\u4e2a\u9009\u9879\u5efa\u8bae\u4f7f\u7528\u7d22\u5f15\uff0c\u4f46\u60a8\u5e94\u8be5\u5982\u4f55\u4f7f\u7528\u5b83\u4eec\u5462\uff1f\u5728\u6267\u884c\u8fc7\u6ee4\u3001\u8fde\u63a5\u548c\u6392\u5e8f\u65f6\uff0c\u7d22\u5f15\u662f\u5173\u952e\u7684\u6027\u80fd\u63d0\u5347\u5668\u3002\u56e0\u6b64\uff0c\u4e86\u89e3\u67e5\u8be2\u6a21\u5f0f\u5e76\u521b\u5efa\u6db5\u76d6\u6b63\u786e\u5b50\u53e5\u7684\u9002\u5f53\u7d22\u5f15\u81f3\u5173\u91cd\u8981\u3002PostgreSQL \u548c MySQL \u90fd\u63d0\u4f9b\u591a\u79cd\u7d22\u5f15\u7c7b\u578b\uff0c\u6bcf\u79cd\u7d22\u5f15\u7c7b\u578b\u90fd\u6709\u72ec\u7279\u7684\u7279\u6027\u5e76\u4e14\u975e\u5e38\u9002\u5408\u67d0\u4e9b\u7528\u4f8b\u3002</p> <p></p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_3","title":"\u8b66\u544a","text":"<p>\u6b63\u5982\u5728 <code>DELETE</code> \u548c <code>INSERT</code> \u90e8\u5206\u4e2d\u63d0\u5230\u7684\uff0c\u5728\u8868\u4e0a\u6dfb\u52a0\u7684\u4efb\u4f55\u7d22\u5f15\u90fd\u4f1a\u51cf\u6162\u5199\u5165\u64cd\u4f5c\u7684\u901f\u5ea6\u3002\u6b64\u5916\uff0c\u7d22\u5f15\u5360\u7528\u78c1\u76d8\u7a7a\u95f4\u5e76\u9700\u8981\u7ef4\u62a4\u3002\u56e0\u6b64\uff0c\u8bf7\u4ed4\u7ec6\u8003\u8651\u60a8\u60f3\u8981\u4f18\u5316\u54ea\u4e9b\u5de5\u4f5c\u8d1f\u8f7d\u4ee5\u53ca\u54ea\u7ec4\u7d22\u5f15\u53ef\u4ee5\u4e3a\u60a8\u5e26\u6765\u6700\u4f73\u7ed3\u679c\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_4","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u4e0e\u6570\u636e\u5e93\u8868\u4e0d\u540c\uff0c\u7d22\u5f15\u53ef\u4ee5\u88ab\u5220\u9664\u5e76\u91cd\u65b0\u521b\u5efa\u800c\u4e0d\u4f1a\u4e22\u5931\u6570\u636e\u3002\u56e0\u6b64\uff0c\u5b9a\u671f\u8bc4\u4f30\u6307\u6807\u96c6\u53ca\u5176\u72b6\u6001\u975e\u5e38\u91cd\u8981\u3002\u60a8\u53ef\u4ee5\u4f9d\u8d56\u6570\u636e\u5e93\u7cfb\u7edf\u8868\u68c0\u67e5\u7d22\u5f15\u4f7f\u7528\u60c5\u51b5\uff0c\u5982 PostgreSQL <code>pg_stat_user_indexes</code> \u6216 MySQL <code>table_io_waits_summary_by_index_usage</code>\uff0c\u63d0\u4f9b\u6709\u5173\u5f71\u54cd\u7d22\u5f15\u67e5\u8be2\u7684\u6700\u65b0\u7edf\u8ba1\u4fe1\u606f\u3002\u4e00\u65e6\u786e\u5b9a\u4e86\u5df2\u4f7f\u7528\u548c\u672a\u4f7f\u7528\u7684\u7d22\u5f15\uff0c\u8bf7\u8bc4\u4f30\u5728\u5de5\u4f5c\u8d1f\u8f7d\u53d1\u751f\u53d8\u5316\u7684\u60c5\u51b5\u4e0b\u91cd\u7ec4\u5b83\u4eec\u7684\u5fc5\u8981\u6027\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_5","title":"\u4e13\u4e1a\u63d0\u793a","text":"<p>\u7d22\u5f15\u53ef\u7528\u4e8e\u5355\u5217\u3001\u591a\u5217\u751a\u81f3\u51fd\u6570\u3002\u5982\u679c\u60a8\u5e0c\u671b\u4f7f\u7528 <code>upper(name)</code> \u51fd\u6570\u7b49\u6765\u8fc7\u6ee4\u6570\u636e\uff0c\u5219\u53ef\u4ee5\u7d22\u5f15\u8be5\u51fd\u6570\u7684\u8f93\u51fa\u4ee5\u83b7\u5f97\u66f4\u597d\u7684\u6027\u80fd\uff08\u51fd\u6570\u7d22\u5f15\uff09\u3002</p> <p>Aiven AI \u6570\u636e\u5e93\u4f18\u5316\u5668\u53ef\u4ee5\u6839\u636e\u60a8\u7684\u6570\u636e\u5e93\u5de5\u4f5c\u8d1f\u8f7d\u4e3a\u60a8\u63d0\u4f9b\u7d22\u5f15\u5efa\u8bae\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_3","title":"\u901a\u8fc7\u6539\u8fdb\u8fde\u63a5\u6765\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u5728\u5173\u7cfb\u6570\u636e\u5e93\u4e2d\uff0c\u7ecf\u5e38\u4f7f\u7528\u8fde\u63a5\u6765\u9009\u62e9\u6765\u81ea\u4e0d\u540c\u8868\u7684\u6570\u636e\u3002\u4e86\u89e3\u53ef\u7528\u7684\u8fde\u63a5\u7c7b\u578b\u53ca\u5176\u542b\u4e49\u5bf9\u4e8e\u5b9e\u73b0\u6700\u4f73\u6027\u80fd\u81f3\u5173\u91cd\u8981\u3002\u4ee5\u4e0b\u5efa\u8bae\u5c06\u5e2e\u52a9\u60a8\u786e\u5b9a\u6b63\u786e\u7684\u8fde\u63a5\u7c7b\u578b\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_4","title":"\u901a\u8fc7\u9009\u62e9\u5185\u8fde\u63a5\u6765\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>MySQL \u548c PostgreSQL \u90fd\u63d0\u4f9b\u4e86\u591a\u79cd\u8fde\u63a5\u7c7b\u578b\uff0c\u5141\u8bb8\u60a8\u7cbe\u786e\u5b9a\u4e49\u4ece\u8fde\u63a5\u4e24\u4fa7\u68c0\u7d22\u7684\u884c\u96c6\u3002\u7531\u4e8e\u5404\u79cd\u539f\u56e0\uff0c\u5b83\u4eec\u90fd\u662f\u6709\u7528\u7684\uff0c\u4f46\u5e76\u975e\u6240\u6709\u5b83\u4eec\u90fd\u5177\u6709\u76f8\u540c\u7684\u6027\u80fd\u3002<code>INNER JOIN</code> \u4ec5\u68c0\u7d22\u6570\u636e\u96c6\u4e24\u4fa7\u5305\u542b\u7684\u884c\u901a\u5e38\u5177\u6709\u6700\u4f73\u6027\u80fd\u3002\u53e6\u4e00\u65b9\u9762\uff0c\u4e0e <code>INNER JOIN</code> \u76f8\u6bd4\uff0c<code>LEFT</code>\u3001<code>RIGHT</code> \u548c <code>OUTER</code> \u8fde\u63a5\u9700\u8981\u6267\u884c\u4e00\u4e9b\u989d\u5916\u7684\u5de5\u4f5c\uff0c\u56e0\u6b64\u4ec5\u5728\u771f\u6b63\u5fc5\u8981\u65f6\u624d\u5e94\u4f7f\u7528\u3002</p> <p></p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_6","title":"\u8b66\u544a","text":"<p>\u4ed4\u7ec6\u68c0\u67e5\u60a8\u7684\u67e5\u8be2\uff0c\u6709\u65f6\u5982\u4e0b\u7684\u67e5\u8be2\u4f3c\u4e4e\u662f\u5408\u6cd5\u7684\uff1a</p> <pre><code>SELECT * \nFROM ORDERS LEFT JOIN USERS ON ORDERS.NAME = USERS.NAME\nWHERE USERS.NAME IS NOT NULL \n</code></pre> <p>\u4e0a\u9762\u4f7f\u7528 <code>LEFT JOIN</code> \u4ece <code>ORDERS</code> \u4e2d\u68c0\u7d22\u6240\u6709\u884c\uff0c\u7136\u540e\u7b5b\u9009\u51fa\u5177\u6709 <code>USERS.NAME IS NOT NULL</code> \u7684\u884c\u3002\u56e0\u6b64\u76f8\u5f53\u4e8e <code>INNER JOIN</code>\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_7","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u8bc4\u4f30 <code>JOIN</code> \u8bed\u53e5\u7684\u786e\u5207\u8981\u6c42\uff0c\u5e76\u5206\u6790\u73b0\u6709\u7684 <code>WHERE</code> \u6761\u4ef6\u3002\u5982\u679c\u4e0d\u662f\u7edd\u5bf9\u5fc5\u8981\uff0c\u6700\u597d\u4f7f\u7528 <code>INNER JOIN</code>\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_8","title":"\u4e13\u4e1a\u63d0\u793a","text":"<p>\u8fd8\u8bf7\u68c0\u67e5\u662f\u5426\u53ef\u4ee5\u5b8c\u5168\u907f\u514d\u8fde\u63a5\u3002\u4f8b\u5982\uff0c\u5982\u679c\u6211\u4eec\u8fde\u63a5\u6570\u636e\u53ea\u662f\u4e3a\u4e86\u9a8c\u8bc1\u53e6\u4e00\u4e2a\u8868\u4e2d\u662f\u5426\u5b58\u5728\u4e00\u884c\uff0c\u4f7f\u7528 <code>EXISTS</code> \u7684\u5b50\u67e5\u8be2\u53ef\u80fd\u6bd4\u8fde\u63a5\u5feb\u5f97\u591a\u3002\u67e5\u770b\u5982\u4f55\u52a0\u901f <code>COUNT(DISTINCT)</code> \u535a\u5ba2\u4e2d\u7684\u8be6\u7ec6\u793a\u4f8b\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_5","title":"\u901a\u8fc7\u5bf9\u8fde\u63a5\u4f7f\u7528\u76f8\u540c\u7684\u5217\u7c7b\u578b\u6765\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u5f53\u8fde\u63a5\u4e24\u4e2a\u8868\u65f6\uff0c\u786e\u4fdd\u8fde\u63a5\u6761\u4ef6\u4e2d\u7684\u5217\u5c5e\u4e8e\u540c\u4e00\u7c7b\u578b\u3002\u5c06\u4e00\u4e2a\u8868\u4e2d\u7684\u6574\u6570 <code>Id</code> \u5217\u4e0e\u53e6\u4e00\u4e2a\u8868\u4e2d\u5b9a\u4e49\u4e3a <code>VARCHAR</code> \u7684\u53e6\u4e00\u4e2a <code>customerId</code> \u5217\u8fde\u63a5\u8d77\u6765\uff0c\u5c06\u5f3a\u5236\u6570\u636e\u5e93\u5728\u6bd4\u8f83\u7ed3\u679c\u4e4b\u524d\u5c06\u6bcf\u4e2a <code>Id</code> \u8f6c\u6362\u4e3a\u5b57\u7b26\u4e32\uff0c\u4ece\u800c\u964d\u4f4e\u6027\u80fd\u3002</p> <p></p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_9","title":"\u8b66\u544a","text":"<p>\u60a8\u65e0\u6cd5\u5728\u67e5\u8be2\u65f6\u66f4\u6539\u6e90\u5b57\u6bb5\u7c7b\u578b\uff0c\u4f46\u60a8\u53ef\u4ee5\u66b4\u9732\u6570\u636e\u7c7b\u578b\u4e0d\u4e00\u81f4\u95ee\u9898\u5e76\u5728\u6570\u636e\u5e93\u8868\u4e2d\u4fee\u590d\u5b83\u3002\u5728\u5206\u6790 <code>CustomerId</code> \u5b57\u6bb5\u662f\u5426\u53ef\u4ee5\u4ece <code>VARCHAR</code> \u8fc1\u79fb\u5230 <code>INT</code> \u65f6\uff0c\u8bf7\u68c0\u67e5\u5217\u4e2d\u7684\u6240\u6709\u503c\u662f\u5426\u786e\u5b9e\u90fd\u662f\u6574\u6570\u3002\u5982\u679c\u67d0\u4e9b\u503c\u4e0d\u662f\u6574\u6570\uff0c\u5219\u53ef\u80fd\u5b58\u5728\u6570\u636e\u8d28\u91cf\u95ee\u9898\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_10","title":"\u4e13\u4e1a\u63d0\u793a","text":"<p>\u5982\u6709\u7591\u95ee\uff0c\u8bf7\u9009\u62e9\u66f4\u7d27\u51d1\u7684\u8fde\u63a5\u952e\u8868\u793a\u5f62\u5f0f\u3002\u5982\u679c\u60a8\u5b58\u50a8\u7684\u5185\u5bb9\u53ef\u4ee5\u660e\u786e\u5730\u5b9a\u4e49\u4e3a\u6570\u5b57\uff08\u4f8b\u5982\u4ea7\u54c1\u4ee3\u7801 <code>1234-678-234</code>\uff09\uff0c\u5219\u6700\u597d\u4f7f\u7528\u6570\u5b57\u8868\u793a\uff0c\u56e0\u4e3a\u5b83\u53ef\u4ee5\uff1a</p> <ul> <li>\u4f7f\u7528\u66f4\u5c11\u7684\u78c1\u76d8\u7a7a\u95f4</li> <li>\u83b7\u53d6\u901f\u5ea6\u66f4\u5feb</li> <li>\u7531\u4e8e\u6574\u6570\u6bd4\u8f83\u6bd4\u5b57\u7b26\u4e32\u7248\u672c\u66f4\u5feb\uff0c\u56e0\u6b64\u8fde\u63a5\u901f\u5ea6\u66f4\u5feb</li> </ul> <p>\u7136\u800c\uff0c\u8981\u5c0f\u5fc3\u90a3\u4e9b\u770b\u8d77\u6765\u50cf\u6570\u5b57\u4f46\u884c\u4e3a\u5374\u4e0d\u50cf\u6570\u5b57\u7684\u4e1c\u897f--\u4f8b\u5982\uff0c\u7535\u8bdd\u53f7\u7801 <code>015555555</code> \u5176\u4e2d\u524d\u5bfc\u96f6\u5f88\u91cd\u8981\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_6","title":"\u901a\u8fc7\u907f\u514d\u4f7f\u7528\u8fde\u63a5\u51fd\u6570\u6765\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u4e0e\u4e0a\u4e00\u8282\u7c7b\u4f3c\uff0c\u907f\u514d\u5728\u8fde\u63a5\u4e2d\u4f7f\u7528\u4e0d\u5fc5\u8981\u7684\u51fd\u6570\u3002\u51fd\u6570\u53ef\u4ee5\u963b\u6b62\u6570\u636e\u5e93\u4f7f\u7528\u6027\u80fd\u4f18\u5316\uff08\u4f8b\u5982\u5229\u7528\u7d22\u5f15\uff09\u3002\u8003\u8651\u4ee5\u4e0b\u67e5\u8be2\uff1a</p> <pre><code>SELECT * \nFROM users \nJOIN orders ON UPPER(users.user_name) = orders.user_name\n</code></pre> <p>\u4ee5\u4e0a\u4ee3\u7801\u4f7f\u7528\u51fd\u6570\u5c06 <code>user_name</code> \u5b57\u6bb5\u8f6c\u6362\u4e3a\u5927\u5199\u3002\u7136\u800c\uff0c\u8fd9\u53ef\u80fd\u8868\u660e\u8ba2\u5355\u8868\u4e2d\u7684\u6570\u636e\u8d28\u91cf\u8f83\u5dee\uff08\u7f3a\u5c11\u5916\u952e\uff09\uff0c\u9700\u8981\u89e3\u51b3\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_11","title":"\u8b66\u544a","text":"<p>\u7c7b\u4f3c\u4e0a\u8ff0\u7684\u67e5\u8be2\u53ef\u4ee5\u5c55\u793a\u67e5\u8be2\u65f6\u89e3\u51b3\u7684\u6570\u636e\u8d28\u91cf\u95ee\u9898\uff0c\u8fd9\u53ea\u662f\u4e00\u4e2a\u77ed\u671f\u89e3\u51b3\u65b9\u6848\u3002\u5728\u8bbe\u8ba1\u6570\u636e\u540e\u7aef\u7cfb\u7edf\u65f6\uff0c\u5e94\u4f18\u5148\u8003\u8651\u6b63\u786e\u5904\u7406\u6570\u636e\u7c7b\u578b\u548c\u8d28\u91cf\u7ea6\u675f\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_12","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5728\u5173\u7cfb\u6570\u636e\u5e93\u4e2d\uff0c\u8868\u4e4b\u95f4\u7684\u8fde\u63a5\u5e94\u8be5\u53ef\u4ee5\u4f7f\u7528\u952e\u548c\u5916\u952e\u6765\u5b8c\u6210\uff0c\u800c\u65e0\u9700\u4efb\u4f55\u9644\u52a0\u529f\u80fd\u3002\u5982\u679c\u60a8\u53d1\u73b0\u81ea\u5df1\u9700\u8981\u4f7f\u7528\u67d0\u4e2a\u51fd\u6570\uff0c\u8bf7\u4fee\u590d\u8868\u4e2d\u7684\u6570\u636e\u8d28\u91cf\u95ee\u9898\u3002\u5728\u67d0\u4e9b\u8fb9\u7f18\u60c5\u51b5\u4e0b\uff0c\u4f7f\u7528\u51fd\u6570\u4e0e\u7d22\u5f15\u53ef\u4ee5\u5e2e\u52a9\u52a0\u5feb\u590d\u6742\u6216\u5197\u957f\u6570\u636e\u7c7b\u578b\u4e4b\u95f4\u7684\u6bd4\u8f83\u3002\u4f8b\u5982\uff0c\u4f7f\u7528\u8fde\u63a5\u51fd\u6570 <code>UPPER(SUBSTR(users.user_name, 1, 50))</code> \u548c\u540c\u4e00\u51fd\u6570\u4e0a\u7684\u7d22\u5f15\uff0c\u4ec5\u6bd4\u8f83\u524d 50 \u4e2a\u5b57\u7b26\uff0c\u53ef\u4ee5\u52a0\u901f\u68c0\u67e5\u4e24\u4e2a\u957f\u5b57\u7b26\u4e32\u4e4b\u95f4\u7684\u76f8\u7b49\u6027\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_7","title":"\u901a\u8fc7\u907f\u514d\u8fde\u63a5\u6765\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u67e5\u8be2\u53ef\u4ee5\u7531\u4e0d\u540c\u7684\u4eba\u968f\u7740\u65f6\u95f4\u7684\u63a8\u79fb\u800c\u6784\u5efa\uff0c\u5e76\u4e14\u5177\u6709 CTE\uff08\u516c\u5171\u8868\u8868\u8fbe\u5f0f\uff09\u5f62\u5f0f\u7684\u8bb8\u591a\u8fde\u7eed\u6b65\u9aa4\u3002\u56e0\u6b64\uff0c\u53ef\u80fd\u5f88\u96be\u4e86\u89e3\u6570\u636e\u8f93\u5165\u548c\u8f93\u51fa\u65b9\u9762\u7684\u5b9e\u9645\u9700\u6c42\u3002\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u5728\u7f16\u5199\u67e5\u8be2\u65f6\uff0c\u60a8\u53ef\u4ee5\u5728\u7a0d\u540e\u6dfb\u52a0\u4e00\u4e2a\u989d\u5916\u7684\u5b57\u6bb5\u201c\u4ee5\u9632\u4e07\u4e00\u201d\u3002\u4f46\u662f\uff0c\u5982\u679c\u8be5\u5b57\u6bb5\u6765\u81ea\u9700\u8981\u8fde\u63a5\u7684\u65b0\u8868\uff0c\u8fd9\u53ef\u80fd\u4f1a\u5bf9\u6027\u80fd\u4ea7\u751f\u5de8\u5927\u5f71\u54cd\u3002</p> <p>\u59cb\u7ec8\u8bc4\u4f30\u67e5\u8be2\u7684\u4e25\u683c\u6570\u636e\u9700\u6c42\uff0c\u5e76\u4e14\u4ec5\u5305\u542b\u5305\u542b\u6b64\u4fe1\u606f\u7684\u5217\u548c\u8868\u3002</p> <p></p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_13","title":"\u8b66\u544a","text":"<p>\u4ed4\u7ec6\u68c0\u67e5\u662f\u5426\u9700\u8981\u8fde\u63a5\u6765\u8fc7\u6ee4\u4e24\u4e2a\u8868\u4e2d\u5b58\u5728\u7684\u884c\u3002\u5728\u4e0a\u9762\u7684\u4f8b\u5b50\u4e2d\uff0c\u5982\u679c\u8ba2\u5355\u8868\u4e2d\u5b58\u5728\u672a\u5b58\u50a8\u5728\u7528\u6237\u8868\u7684 <code>id</code> \u5217\u4e2d\u7684 <code>user_id</code>\uff0c\u6211\u4eec\u6700\u7ec8\u53ef\u80fd\u4f1a\u5f97\u5230\u4e0d\u6b63\u786e\u7684\u7ed3\u679c\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_14","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5220\u9664\u4e0d\u5fc5\u8981\u7684\u8fde\u63a5\u3002\u751f\u6210\u66f4\u7cbe\u7b80\u7684\u67e5\u8be2\u6765\u68c0\u7d22\u6574\u4f53\u6570\u636e\u96c6\uff0c\u7136\u540e\u4ec5\u5728\u5fc5\u8981\u65f6\u67e5\u627e\u66f4\u591a\u4fe1\u606f\uff0c\u8fd9\u6837\u6027\u80fd\u4f1a\u66f4\u9ad8\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_15","title":"\u4e13\u4e1a\u63d0\u793a","text":"<p>\u4e0a\u9762\u89e3\u91ca\u7684\u4f8b\u5b50\u53ea\u662f <code>JOIN</code> \u8fc7\u5ea6\u4f7f\u7528\u7684\u4e00\u4e2a\u4f8b\u5b50\u3002\u53e6\u4e00\u4e2a\u4f8b\u5b50\u662f\uff0c\u6211\u4eec\u8fde\u63a5\u6570\u636e\u53ea\u662f\u4e3a\u4e86\u9a8c\u8bc1\u53e6\u4e00\u4e2a\u8868\u4e2d\u67d0\u4e00\u884c\u7684\u5b58\u5728\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4f7f\u7528 <code>EXISTS</code> \u7684\u5b50\u67e5\u8be2\u53ef\u80fd\u6bd4\u8fde\u63a5\u5feb\u5f97\u591a\u3002\u67e5\u770b\u5982\u4f55\u52a0\u901f COUNT(DISTINCT) \u535a\u5ba2\u4e2d\u7684\u8be6\u7ec6\u793a\u4f8b\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_8","title":"\u901a\u8fc7\u6539\u8fdb\u8fc7\u6ee4\u6765\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u5206\u6790\u5b8c <code>JOIN</code> \u8fde\u63a5\u4e4b\u540e\uff0c\u73b0\u5728\u662f\u65f6\u5019\u8bc4\u4f30\u548c\u6539\u8fdb\u67e5\u8be2\u7684 <code>WHERE</code> \u90e8\u5206\u4e86\u3002\u4e0e\u4e0a\u9762\u7684\u90e8\u5206\u4e00\u6837\uff0c\u5bf9\u8fc7\u6ee4\u8bed\u53e5\u7684\u7ec6\u5fae\u6539\u53d8\u53ef\u80fd\u4f1a\u5bf9\u67e5\u8be2\u6027\u80fd\u4ea7\u751f\u5de8\u5927\u5f71\u54cd\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_9","title":"\u901a\u8fc7\u907f\u514d\u5728\u8fc7\u6ee4\u4e2d\u4f7f\u7528\u51fd\u6570\u6765\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u5728\u8fc7\u6ee4\u9636\u6bb5\u5bf9\u5217\u4f7f\u7528\u51fd\u6570\u4f1a\u964d\u4f4e\u6027\u80fd\u3002\u6570\u636e\u5e93\u9700\u8981\u5728\u8fc7\u6ee4\u4e4b\u524d\u5c06\u51fd\u6570\u5e94\u7528\u4e8e\u6570\u636e\u96c6\u3002\u8ba9\u6211\u4eec\u770b\u4e00\u4e2a\u6839\u636e\u65f6\u95f4\u6233\u5b57\u6bb5\u8fdb\u884c\u8fc7\u6ee4\u7684\u7b80\u5355\u793a\u4f8b\uff1a</p> <pre><code>SELECT count(*) \nFROM orders\nWHERE CAST(order_timestamp AS DATE) &gt; '2024-02-01';\n</code></pre> <p>\u4e0a\u8ff0\u67e5\u8be2\u5728 100,000,000 \u884c\u6570\u636e\u96c6\u4e0a\u9700\u8981\u6267\u884c 01 \u5206 53 \u79d2\uff0c\u56e0\u4e3a\u5b83\u9700\u8981\u5728\u5e94\u7528\u8fc7\u6ee4\u5668\u4e4b\u524d\u5c06 <code>order_timestamp</code> \u5217\u7684\u6570\u636e\u7c7b\u578b\u4ece\u65f6\u95f4\u6233\u66f4\u6539\u4e3a\u65e5\u671f\u3002\u4f46\u8fd9\u4e0d\u662f\u5fc5\u9700\u7684\uff01\u6b63\u5982 Aiven \u7684 EverSQL \u6240\u5efa\u8bae\u7684\u90a3\u6837\uff0c\u5982\u679c\u60a8\u4e3a\u5176\u63d0\u4f9b\u4e0a\u8ff0\u67e5\u8be2\u548c\u8868\u5143\u6570\u636e\uff0c\u5219\u53ef\u4ee5\u5c06\u5176\u91cd\u5199\u4e3a\uff1a</p> <pre><code>SELECT count(*) \nFROM orders\nWHERE order_timestamp &gt; '2024-02-01 00:00:00';\n</code></pre> <p>\u91cd\u5199\u7684\u67e5\u8be2\u4f7f\u7528\u672c\u673a\u65f6\u95f4\u6233\u5b57\u6bb5\uff0c\u65e0\u9700\u8fdb\u884c\u5f3a\u5236\u8f6c\u6362\u3002\u8fd9\u79cd\u5fae\u5c0f\u53d8\u5316\u7684\u7ed3\u679c\u662f\uff0c\u67e5\u8be2\u73b0\u5728\u53ea\u9700 20 \u79d2\u5373\u53ef\u8fd0\u884c\uff0c\u6bd4\u539f\u6765\u5feb\u8fd1 6 \u500d\u3002</p> <p></p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_16","title":"\u8b66\u544a","text":"<p>\u5e76\u975e\u6240\u6709\u51fd\u6570\u90fd\u53ef\u4ee5\u907f\u514d\uff0c\u56e0\u4e3a\u6709\u4e9b\u51fd\u6570\u53ef\u80fd\u9700\u8981\u68c0\u7d22\u5217\u7684\u90e8\u5206\u5185\u5bb9\uff08\u5982\u4e0a\u9762\u7684 <code>substring</code> \u793a\u4f8b\uff09\u6216\u91cd\u5199\u5b83\u3002\u5c3d\u7ba1\u5982\u6b64\uff0c\u6bcf\u6b21\u60a8\u8981\u5728\u8fc7\u6ee4\u5668\u4e2d\u6dfb\u52a0\u51fd\u6570\u65f6\uff0c\u8bf7\u8003\u8651\u4f7f\u7528\u672c\u673a\u6570\u636e\u7c7b\u578b\u8fd0\u7b97\u7b26\u7684\u5176\u4ed6\u65b9\u6cd5\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_17","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5c06\u8fc7\u6ee4\u5668\u5e94\u7528\u5230\u5217\u65f6\uff0c\u8bf7\u5c1d\u8bd5\u6539\u5199\u8fc7\u6ee4\u5668\u683c\u5f0f\u800c\u4e0d\u662f\u5217\u683c\u5f0f\u3002\u4e0a\u9762\u662f\u4e00\u4e2a\u5b8c\u7f8e\u7684\u4f8b\u5b50\uff1a\u5c06\u8fc7\u6ee4\u5668\u683c\u5f0f\u4ece\u65e5\u671f <code>2024-02-01</code> \u8f6c\u6362\u4e3a\u65f6\u95f4\u6233 <code>2024-02-01 00:00:00</code> \u4f7f\u6211\u4eec\u80fd\u591f\u4f7f\u7528\u672c\u673a\u65f6\u95f4\u6233\u6570\u636e\u683c\u5f0f\u548c\u8fd0\u7b97\u7b26\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_18","title":"\u4e13\u4e1a\u63d0\u793a","text":"<p>\u5982\u679c\u60a8\u5fc5\u987b\u4f7f\u7528\u51fd\u6570\uff0c\u8bf7\u8003\u8651\u4ee5\u4e0b\u4e24\u70b9\u5efa\u8bae\uff1a</p> <ul> <li>\u5728\u8868\u8fbe\u5f0f\u4e0a\u521b\u5efa\u7d22\u5f15\uff0cPostgreSQL \u548c MySQL \u90fd\u652f\u6301</li> <li>\u4f7f\u7528\u6570\u636e\u5e93\u7684\u89e6\u53d1\u5668\u6765\u751f\u6210\u989d\u5916\u7684\u5217\uff0c\u5e76\u4e14\u5217\u5df2\u7ecf\u5b8c\u6210\u4e86\u6570\u636e\u8f6c\u6362</li> </ul>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_10","title":"\u901a\u8fc7\u6539\u8fdb\u5b50\u67e5\u8be2\u6765\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u5b50\u67e5\u8be2\u901a\u5e38\u7528\u4e8e\u8fc7\u6ee4\u5668\u4e2d\uff0c\u4ee5\u68c0\u7d22\u8981\u4f5c\u4e3a\u8fc7\u6ee4\u5668\u5e94\u7528\u7684\u503c\u96c6\u3002\u4e00\u4e2a\u5e38\u89c1\u7684\u4f8b\u5b50\u662f\u68c0\u7d22\u6700\u8fd1\u6d3b\u52a8\u7684\u7528\u6237\u5217\u8868\u3002</p> <pre><code>SELECT *\nFROM users\nWHERE id IN (\nSELECT DISTINCT user_id \nFROM sessions \nWHERE session_date = '2024-02-01');\n</code></pre> <p>\u4e0a\u8ff0\u67e5\u8be2\u4ece <code>SESSIONS</code> \u8868\u4e2d\u68c0\u7d22\u4e0d\u540c\u7684\u7528\u6237\u5217\u8868\uff0c\u7136\u540e\u8fc7\u6ee4 <code>USERS</code> \u8868\u4e0a\u7684\u6570\u636e\u3002</p> <p>\u4f46\u662f\uff0c\u6709\u51e0\u79cd\u66f4\u9ad8\u6548\u7684\u65b9\u6cd5\u53ef\u4ee5\u5b9e\u73b0\u76f8\u540c\u7684\u7ed3\u679c\u3002\u4f8b\u5982\u4f7f\u7528 <code>EXISTS</code>\uff1a</p> <pre><code>SELECT * \nFROM users\nWHERE EXISTS (\nSELECT user_id \nFROM sessions \nWHERE user_id = id and session_date = '2024-02-01'\n);\n</code></pre> <p><code>EXISTS</code> \u901f\u5ea6\u66f4\u5feb\uff0c\u56e0\u4e3a\u5b83\u4e0d\u9700\u8981\u4ece <code>SESSION</code> \u8868\u4e2d\u68c0\u7d22\u4e0d\u540c\u7528\u6237\u7684\u5217\u8868\uff0c\u800c\u53ea\u662f\u9a8c\u8bc1\u8868\u4e2d\u662f\u5426\u5b58\u5728\u7279\u5b9a\u7528\u6237\u7684\u81f3\u5c11\u4e00\u884c\u3002</p> <p>\u4e0a\u8ff0\u7528\u4f8b\u4ec5\u901a\u8fc7\u66f4\u6539\u5b50\u67e5\u8be2\u90e8\u5206\u5c31\u4ece 02 \u5206 08 \u79d2\u7684\u6027\u80fd\u7f29\u77ed\u5230\u4e86 18 \u79d2\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_19","title":"\u8b66\u544a","text":"<p>\u5b50\u67e5\u8be2\u4e2d\u7684\u7ec6\u5fae\u53d8\u5316\u53ef\u80fd\u4f1a\u5728\u6781\u7aef\u60c5\u51b5\u4e0b\u4ea7\u751f\u4e0d\u540c\u7684\u7ed3\u679c\u3002\u6709\u5173\u6267\u884c\u548c\u7ed3\u679c\u96c6\u7ec6\u5fae\u5dee\u522b\u7684\u793a\u4f8b\uff0c\u8bf7\u67e5\u770b\u5728 PostgreSQL \u4e2d\u5b9e\u73b0 <code>NOT EXISTS</code> \u7684 5 \u79cd\u65b9\u6cd5\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_20","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5f53\u9700\u8981\u4f7f\u7528\u5b50\u67e5\u8be2\u65f6\uff0c\u82b1\u70b9\u65f6\u95f4\u5b66\u4e60\u548c\u4e86\u89e3\u6709\u54ea\u4e9b\u9009\u9879\u4ee5\u53ca\u5b83\u4eec\u5141\u8bb8\u60a8\u5b9e\u73b0\u4ec0\u4e48\u3002\u5f88\u591a\u65f6\u5019\uff0c\u9009\u9879\u4e0d\u6b62\u4e00\u4e2a\uff0c\u800c\u4e14\u6709\u4e9b\u529f\u80fd\u53ef\u4ee5\u63d0\u4f9b\u66f4\u597d\u7684\u54cd\u5e94\u65f6\u95f4\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_11","title":"\u901a\u8fc7\u5bf9\u7ed3\u679c\u96c6\u8fdb\u884c\u5206\u9875\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u5f53\u9700\u8981\u663e\u793a\u4e00\u957f\u4e32\u884c\u65f6\uff0c\u5bf9\u4ece\u6570\u636e\u5e93\u68c0\u7d22\u7684\u7ed3\u679c\u96c6\u8fdb\u884c\u5206\u9875\u5f88\u6709\u7528\u3002PostgreSQL \u548c MySQL \u90fd\u63d0\u4f9b\u4e86 <code>LIMIT</code> \u9650\u5236\u8f93\u51fa\u7ed3\u679c\u96c6\u7684\u529f\u80fd\uff0c\u4ee5\u4ec5\u68c0\u7d22\u4e00\u5b9a\u6570\u91cf\u7684\u884c\uff0c\u5e76\u4e14\u53ef\u4ee5\u901a\u8fc7 <code>OFFSET</code> \u7ed3\u5408\u6392\u5e8f\u83b7\u53d6\u7279\u5b9a\u504f\u79fb\u8303\u56f4\u7684\u7ed3\u679c\u96c6\u3002\u4f7f\u7528 <code>LIMIT</code> \u548c <code>OFFSET</code> \u662f\u5c06\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\u7684\u6570\u636e\u6700\u5c0f\u5316\u4e3a\u4ec5\u9700\u8981\u663e\u793a\u7684\u6570\u636e\u7684\u597d\u65b9\u6cd5\u3002</p> <p></p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_21","title":"\u8b66\u544a","text":"<p>\u4f7f\u7528 <code>LIMIT</code> \u548c <code>OFFSET</code> \u7684\u7f3a\u70b9\u662f\u60a8\u9700\u8981\u5bf9\u6bcf\u4e2a\u201c\u9875\u9762\u201d\u8fdb\u884c\u67e5\u8be2\u5e76\u5c06\u5176\u53d1\u9001\u81f3\u6570\u636e\u5e93\u5e76\u6267\u884c\u3002\u5982\u679c\u603b\u884c\u6570\u4e0e\u9875\u9762\u5927\u5c0f\u76f8\u5dee\u4e0d\u5927\uff0c\u8fd9\u53ef\u80fd\u4f1a\u5e26\u6765\u4e0d\u4fbf\u3002\u4e3e\u4f8b\u6765\u8bf4\uff0c\u5982\u679c\u60a8\u4ee5\u6bcf\u9875 10 \u884c\u663e\u793a\u7ed3\u679c\uff0c\u4f46\u5e73\u5747\u6709 15 \u884c\u9700\u8981\u663e\u793a\uff0c\u90a3\u4e48\u4e00\u6b21\u6027\u68c0\u7d22\u6574\u4e2a\u6570\u636e\u96c6\u53ef\u80fd\u4f1a\u66f4\u597d\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_22","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5982\u679c\u7ed3\u679c\u96c6\u7684\u5927\u5c0f\u6bd4\u9875\u9762\u5927\u5c0f\u5927\u4e00\u4e2a\u6570\u91cf\u7ea7\uff0c\u5219\u4f7f\u7528\u5206\u9875\u53ef\u4ee5\u6709\u6548\u5730\u786e\u4fdd\u66f4\u597d\u7684\u6027\u80fd\uff0c\u56e0\u4e3a\u53ea\u4f1a\u4ece\u6570\u636e\u5e93\u4e2d\u68c0\u7d22\u53ef\u89c1\u7684\u6570\u636e\u96c6\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_23","title":"\u4e13\u4e1a\u63d0\u793a","text":"<p><code>LIMIT</code> \u548c <code>OFFSET</code> \u5b50\u53e5\u662f\u5927\u591a\u6570\u6570\u636e\u5e93\u4e2d\u7684\u9ed8\u8ba4\u5206\u9875\u65b9\u6cd5\u3002\u7136\u800c\uff0c\u901a\u8fc7\u5728\u5ba2\u6237\u7aef\u5b58\u50a8\u5f53\u524d\u9875\u9762\u7684\u8d77\u59cb\u548c\u7ed3\u675f\u504f\u79fb\u91cf\u5e76\u5c06\u4e0b\u4e00\u9875\u7684\u8fc7\u6ee4\u63a8\u9001\u5230 SQL \u8bed\u53e5\u7684 <code>WHERE</code> \u5b50\u53e5\u4e2d\uff0c\u53ef\u4ee5\u5b9e\u73b0\u66f4\u6709\u6548\u7684\u5206\u9875\u5b9e\u73b0\u3002\u5728 Markus Winand \u7684 PostgreSQL \u65b9\u5f0f\u5206\u9875\u6f14\u793a\u4e2d\u4ee5\u53ca MySQL \u66f4\u5feb\u5206\u9875\u535a\u5ba2\u4e2d\u63d0\u4f9b\u4e86\u6b64\u5b9e\u73b0\u7684\u51e0\u4e2a\u793a\u4f8b\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#having-where-select-sql","title":"\u901a\u8fc7\u5c06\u8fc7\u6ee4\u5668\u4ece <code>HAVING</code> \u79fb\u81f3 <code>WHERE</code> \u5b50\u53e5\u6765\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u8fd0\u884c\u67e5\u8be2\u65f6\uff0c<code>WHERE</code> \u548c <code>HAVING</code> \u5b50\u53e5\u4e2d\u5b9a\u4e49\u7684\u8fc7\u6ee4\u5668\u4f1a\u5728\u4e0d\u540c\u65f6\u95f4\u5e94\u7528\uff1a</p> <ul> <li><code>WHERE</code> \u8fc7\u6ee4\u5668\u5c06\u5e94\u7528\u4e8e\u539f\u59cb\u6570\u636e\u96c6\uff0c\u5728 <code>SELECT</code> \u8bed\u53e5\u4e2d\u5b9a\u4e49\u7684\u4efb\u4f55\u6570\u636e\u8f6c\u6362\u4e4b\u524d</li> <li><code>HAVING</code> \u8fc7\u6ee4\u5668\u5728\u805a\u5408\u540e\u5e94\u7528\uff0c\u56e0\u6b64\u662f\u5728\u68c0\u7d22\u3001\u8f6c\u6362\u548c\u6c47\u603b\u6240\u6709\u884c\u4e4b\u540e\u5e94\u7528\u7684</li> </ul> <p>\u56e0\u6b64\uff0c\u5c06\u8fc7\u6ee4\u5668\u79fb\u52a8\u5230 <code>WHERE</code> \u4e2d\u5e94\u8be5\u662f\u4e00\u4e2a\u4f18\u5148\u4e8b\u9879\uff0c\u56e0\u4e3a\u5b83\u5141\u8bb8\u60a8\u5904\u7406\u8f83\u5c0f\u7684\u6570\u636e\u96c6\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5982\u679c\u6211\u4eec\u5c1d\u8bd5\u83b7\u53d6\u5177\u6709\u8ddf\u8e2a <code>user_id</code> \u7684\u4f1a\u8bdd\u7684\u65e5\u671f\u5217\u8868\uff08<code>user_id</code> \u5b57\u6bb5\u4e0d\u4e3a\u7a7a\uff0c\u8981\u4e86\u89e3\u6709\u5173\u5dee\u5f02\u7684\u66f4\u591a\u4fe1\u606f\uff0c\u8bf7\u67e5\u770b COUNT DISTINCT \u535a\u5ba2\u6587\u7ae0\uff09\uff1a</p> <pre><code>SELECT session_date, count(user_id) nr_sessions\nFROM sessions\nGROUP BY session_date\nHAVING count(user_id) &gt; 0;\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5c06\u8fc7\u6ee4\u5668\u63a8\u9001\u5230 <code>WHERE</code> \u5b50\u53e5\u6765\u91cd\u5199\u4e0a\u8ff0\u67e5\u8be2\uff1a</p> <pre><code>SELECT session_date, count(user_id) nr_sessions\nFROM sessions\nWHERE user_id is not null\nGROUP BY session_date;\n</code></pre> <p>\u53ea\u9700\u66f4\u6539\u8fc7\u6ee4\u8bed\u53e5\uff0c100,000,000 \u884c\u6570\u636e\u96c6\u7684\u67e5\u8be2\u6027\u80fd\u5c31\u4ece 21 \u79d2\u7f29\u77ed\u5230 18 \u79d2\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_24","title":"\u8b66\u544a","text":"<p>\u4ec5\u5f53\u6211\u4eec\u80fd\u591f\u786e\u5b9a\u9002\u7528\u4e8e\u884c\u7ea7\u522b\u800c\u4e0d\u662f\u9002\u7528\u4e8e\u805a\u5408\u7ea7\u522b\u7684\u7c7b\u4f3c\u6761\u4ef6\u65f6\uff0c\u624d\u53ef\u4ee5\u5c06\u8fc7\u6ee4\u5668\u4ece <code>HAVING</code> \u79fb\u81f3 <code>WHERE</code> \u5b50\u53e5\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_25","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u59cb\u7ec8\u5c1d\u8bd5\u5728 <code>WHERE</code> \u5b50\u53e5\u4e2d\u8fdb\u884c\u8fc7\u6ee4\uff0c\u56e0\u4e3a\u8fc7\u6ee4\u5728\u6570\u636e\u901a\u8fc7 <code>SELECT</code> \u8bed\u53e5\u8f6c\u6362/\u805a\u5408\u4e4b\u524d\u5e94\u7528\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_12","title":"\u901a\u8fc7\u5b9a\u4e49\u8981\u68c0\u7d22\u7684\u5217\u6765\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u67e5\u8be2\u8868\u65f6\uff0c\u786e\u5b9a\u9700\u8981\u68c0\u7d22\u54ea\u4e9b\u5217\u662f\u5173\u952e\u3002<code>SELECT * FROM TBL</code> \u901a\u5e38\u7528\u4f5c\u68c0\u7d22\u6240\u6709\u5217\u7684\u5feb\u6377\u65b9\u5f0f\uff0c\u7136\u540e\u5b9a\u4e49\u7a0d\u540e\u9700\u8981\u663e\u793a\u54ea\u4e9b\u5217\uff0c\u4f46\u662f\u8fd9\u6837\u505a\u65f6\uff0c\u9700\u8981\u4ece\u6570\u636e\u5e93\u4e2d\u68c0\u7d22\u5e76\u4f20\u8f93\u66f4\u591a\u6570\u636e\uff0c\u4ece\u800c\u5f71\u54cd\u6027\u80fd\u3002</p> <p></p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_26","title":"\u8b66\u544a","text":"<p>\u4f7f\u7528 <code>SELECT * FROM TBL</code> \u4e0d\u4ec5\u7ecf\u5e38\u4f1a\u68c0\u7d22\u6bd4\u5fc5\u8981\u66f4\u591a\u7684\u6570\u636e\uff0c\u800c\u4e14\u8fd8\u5bb9\u6613\u51fa\u73b0\u9519\u8bef\u3002\u8bd5\u60f3\u4e00\u4e0b\uff0c\u6dfb\u52a0\u4e00\u4e2a\u65b0\u5217\uff0c\u5b83\u4f1a\u7acb\u5373\u663e\u793a\u5728\u5e94\u7528\u7a0b\u5e8f\u4e2d\uff0c\u6216\u8005\u4ece\u6570\u636e\u5e93\u4e2d\u5220\u9664\u4e00\u4e2a\u5217\uff0c\u4ece\u800c\u7834\u574f\u524d\u7aef\u89e3\u6790\u3002\u901a\u8fc7\u8c28\u614e\u5b9a\u4e49\u8981\u68c0\u7d22\u7684\u5217\u7684\u5217\u8868\uff0c\u60a8\u53ef\u4ee5\u51c6\u786e\u5730\u9648\u8ff0\u67e5\u8be2\u7684\u6570\u636e\u9700\u6c42\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_27","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u6bcf\u4e2a <code>SELECT</code> \u8bed\u53e5\u5e94\u8be5\u4ec5\u5b9a\u4e49\u5b8c\u6210\u4f5c\u4e1a\u6240\u9700\u7684\u5217\u7684\u5217\u8868\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_13","title":"\u4f7f\u7528\u805a\u5408\u51fd\u6570\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u6709\u65f6\u76ee\u6807\u662f\u67e5\u8be2\u8868\u4ee5\u83b7\u53d6\u884c\u7684\u603b\u6570\u6216\u67d0\u7ec4\u5217\u7684\u603b\u503c\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4ece\u6570\u636e\u5e93\u4e2d\u63d0\u53d6\u6240\u6709\u6570\u636e\u5e76\u5728\u5176\u4ed6\u5730\u65b9\u6267\u884c\u8ba1\u7b97\u662f\u4e00\u4e2a\u574f\u4e3b\u610f\u3002\u6211\u4eec\u53ef\u4ee5\u5229\u7528\u672c\u673a\u6570\u636e\u5e93\u805a\u5408\u529f\u80fd\u5728\u6570\u636e\u6240\u5728\u7684\u4f4d\u7f6e\u8fdb\u884c\u8ba1\u7b97\uff0c\u79fb\u52a8\u66f4\u5c11\u7684\u6570\u636e\u5e76\u5b9e\u73b0\u66f4\u597d\u7684\u6574\u4f53\u6027\u80fd\u3002</p> <p></p> <p>\u5982\u679c\u60a8\u5c1d\u8bd5\u8ba1\u7b97\u5217\u5185\u7684\u4e0d\u540c\u503c\uff0c\u6211\u4eec\u6709\u4e00\u7bc7\u4e13\u95e8\u4ecb\u7ecd\u5982\u4f55\u63d0\u9ad8 <code>COUNT DISTINCT</code> \u67e5\u8be2\u901f\u5ea6\u7684\u6587\u7ae0\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_28","title":"\u8b66\u544a","text":"<p>\u867d\u7136\u6570\u636e\u5e93\u805a\u5408\u51fd\u6570\u6ee1\u8db3\u4e86\u5e7f\u6cdb\u7684\u9700\u6c42\uff08\u53c2\u89c1 PostgreSQL \u548c MySQL\uff09\uff0c\u4f46\u5b83\u4eec\u53ef\u80fd\u4e0d\u5305\u542b\u60a8\u9700\u8981\u6267\u884c\u7684\u7cbe\u786e\u8ba1\u7b97\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u60a8\u9700\u8981\u4e86\u89e3\u5728\u8be5\u7ea7\u522b\u63d0\u53d6\u548c\u805a\u5408\u6240\u9700\u7684\u6700\u5c0f\u7c92\u5ea6\u662f\u4ec0\u4e48\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_29","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5f53\u9700\u8981\u6267\u884c\u805a\u5408\u65f6\uff0c\u8bf7\u68c0\u67e5\u53ef\u7528\u7684\u6570\u636e\u5e93\u51fd\u6570\u3002\u5c3d\u7ba1\u6570\u636e\u5e93\u6269\u5c55\u89c4\u5219\u4e4b\u4e00\u662f\u805a\u5408\u64cd\u4f5c\u63a8\u5411\u504f\u5411\u5ba2\u6237\u7aef\uff0c\u4f46\u901a\u5e38\u503c\u5f97\u4f7f\u7528\u6570\u636e\u5e93\u670d\u52a1\u5668\u63d0\u4f9b\u7684\u805a\u5408\u51fd\u6570\u6765\u51cf\u5c11\u4f20\u8f93\u5230\u5ba2\u6237\u7aef\u7684\u6570\u636e\u91cf\u3002\u6b64\u5916\uff0c\u6570\u636e\u5e93\u53ef\u4ee5\u5b9e\u73b0\u5148\u8fdb\u7684\u6280\u672f\u6765\u4f18\u5316\u805a\u5408\u8ba1\u7b97\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_14","title":"\u4f7f\u7528\u7a97\u53e3\u51fd\u6570\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>PostgreSQL \u548c MySQL \u4e2d\u63d0\u4f9b\u7684\u7a97\u53e3\u51fd\u6570\u63d0\u4f9b\u4e86\u4e00\u79cd\u8ba1\u7b97\u805a\u5408\u503c\u5e76\u5c06\u5176\u4e0e\u5f53\u524d\u884c\u503c\u8fdb\u884c\u6bd4\u8f83\u7684\u65b9\u6cd5\u3002\u4f8b\u5982\uff0c\u5f53\u9700\u8981\u8ba1\u7b97\u67d0\u6b21\u9500\u552e\u5bf9\u6574\u4e2a\u56fd\u5bb6\u9500\u552e\u989d\u7684\u603b\u4f53\u8d21\u732e\u65f6\uff0c\u5b83\u4eec\u771f\u7684\u5f88\u6709\u7528\u3002\u4f7f\u7528\u7a97\u53e3\u51fd\u6570\u53ef\u4ee5\u7b80\u5316\u67e5\u8be2 SQL\uff0c\u5e76\u5229\u7528\u6570\u636e\u5e93\u4f18\u5316\u5668\u6765\u51b3\u5b9a\u68c0\u7d22\u6570\u636e\u6240\u9700\u7684\u6700\u4f73\u64cd\u4f5c\u96c6\u3002</p> <p></p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_30","title":"\u8b66\u544a","text":"<p>\u7a97\u53e3\u51fd\u6570\u4e0d\u4f1a\u6539\u53d8\u6570\u636e\u96c6\u7684\u57fa\u6570\u3002\u4f8b\u5982\uff0c\u5982\u679c\u60a8\u5728 <code>ORDER</code> \u7ea7\u522b\u68c0\u7d22\u6570\u636e\uff0c\u7a97\u53e3\u51fd\u6570\u4ecd\u5c06\u4e3a\u6bcf\u4e2a\u8ba2\u5355\u4ea7\u751f\u4e00\u884c\u3002\u8bc4\u4f30\u8f93\u51fa\u4e2d\u6240\u9700\u6570\u636e\u7684\u57fa\u6570\uff0c\u7136\u540e\u51b3\u5b9a\u662f\u5426\u4f7f\u7528\u7a97\u53e3\u6216\u805a\u5408\u51fd\u6570\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_31","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u4e0e\u4e0a\u8ff0\u7c7b\u4f3c\uff0c\u91c7\u7528\u7a97\u53e3\u51fd\u6570\u53ef\u4ee5\u6210\u4e3a\u5728\u5c06\u6570\u636e\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\u4e4b\u524d\u8fdb\u884c\u9884\u5148\u8ba1\u7b97\u7684\u6709\u6548\u65b9\u6cd5\u3002\u4f46\u662f\u751f\u6210\u5b83\u4eec\u7684\u4ee3\u7801\u76f8\u5f53\u5197\u957f\u3002\u8bf7\u5728\u5b8c\u6574\u67e5\u8be2 SQL \u4f18\u5316\u548c\u4ee3\u7801\u53ef\u8bfb\u6027\u548c\u53ef\u7ef4\u62a4\u6027\u4e4b\u95f4\u786e\u5b9a\u4f18\u5148\u7ea7\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_32","title":"\u4e13\u4e1a\u63d0\u793a","text":"<p>\u7a97\u53e3\u51fd\u6570\u4e0d\u4ec5\u53ef\u7528\u4e8e\u5728\u67d0\u4e2a\u7ea7\u522b\u805a\u5408\u5185\u5bb9\uff0c\u800c\u4e14\u8fd8\u516c\u5f00\u4e86 <code>ORDER BY</code> \u8bed\u53e5\uff0c\u5141\u8bb8\u60a8\u6267\u884c\u6b63\u5728\u8fd0\u884c\u7684\u8ba1\u7b97\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_15","title":"\u4f7f\u7528\u5206\u533a\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>\u63d0\u9ad8 <code>SELECT</code> \u6027\u80fd\u7684\u53e6\u4e00\u79cd\u6280\u672f\u662f\u5c06\u6570\u636e\u5206\u6210\u591a\u4e2a\u5b50\u8868\uff08\u79f0\u4e3a\u5206\u533a\uff09\u3002PostgreSQL \u548c MySQL \u4e2d\u63d0\u4f9b\u5206\u533a\u529f\u80fd\uff0c\u53ef\u6839\u636e\u8c13\u8bcd\u5c06\u6570\u636e\u62c6\u5206\u5230\u591a\u4e2a\u8868\u4e2d\u3002\u5982\u679c\u60a8\u7ecf\u5e38\u9700\u8981\u4f7f\u7528\u7279\u5b9a\u8fc7\u6ee4\u5668\uff08\u4f8b\u5982\u65e5\u671f\uff09\u68c0\u7d22\u6570\u636e\uff0c\u5219\u53ef\u80fd\u9700\u8981\u5c06\u5176\u7ec4\u7ec7\u5728\u4e0d\u540c\u7684\u5206\u533a\u4e2d\uff0c\u6bcf\u5929\u4e00\u4e2a\uff0c\u8fd9\u6837\u5927\u591a\u6570\u67e5\u8be2\u53ea\u4f1a\u626b\u63cf\u4e00\u4e2a\u5206\u533a\u800c\u4e0d\u662f\u6574\u4e2a\u6570\u636e\u96c6\u3002</p> <p></p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_33","title":"\u8b66\u544a","text":"<p>\u5c3d\u7ba1\u5206\u533a\u5bf9\u4e8e\u7528\u6237\u6765\u8bf4\u662f\u201c\u4e0d\u53ef\u89c1\u7684\u201d\uff08\u67d0\u4e2a\u7528\u6237\u53ef\u4ee5\u67e5\u8be2\u539f\u59cb\u8868\u5e76\u4ece\u6240\u6709\u5206\u533a\u4e2d\u9009\u62e9\u6570\u636e\uff09\uff0c\u4f46\u60a8\u9700\u8981\u8003\u8651\u5b83\u7684\u7ba1\u7406\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u5bf9\u4e8e LIST \u5206\u533a\uff0c\u5f53\u63d2\u5165\u65b0\u952e\u65f6\uff0c\u9700\u8981\u9884\u5148\u521b\u5efa\u9002\u5f53\u7684\u5206\u533a\uff0c\u5426\u5219\u63d2\u5165\u5c06\u5931\u8d25\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_34","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5728\u4f7f\u7528\u76f8\u540c\u952e\u8fc7\u6ee4\u6570\u636e\u96c6\u7684\u4e00\u81f4\u67e5\u8be2\u6a21\u5f0f\u7684\u60c5\u51b5\u4e0b\uff0c\u5206\u533a\u975e\u5e38\u6709\u7528\u3002\u5728\u6ca1\u6709\u660e\u786e\u8fc7\u6ee4\u6807\u51c6\u7684\u60c5\u51b5\u4e0b\u5bf9\u8868\u8fdb\u884c\u5206\u533a\u53ea\u4f1a\u589e\u52a0\u6570\u636e\u5e93\u7684\u8d1f\u8f7d\uff0c\u4f7f\u6bcf\u4e2a\u67e5\u8be2\u53d8\u5f97\u66f4\u6162\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#select-sql_16","title":"\u4f7f\u7528\u7269\u5316\u89c6\u56fe\u4f18\u5316 <code>SELECT</code> SQL \u67e5\u8be2","text":"<p>PostgreSQL \u4e2d\u63d0\u4f9b\u7684\u7269\u5316\u89c6\u56fe\u662f\u4e00\u79cd\u901a\u8fc7\u9884\u5148\u8ba1\u7b97\u7ed3\u679c\u6765\u52a0\u901f <code>SELECT</code> \u8bed\u53e5\u7684\u597d\u65b9\u6cd5\u3002\u7269\u5316\u89c6\u56fe\u4e0e\u6807\u51c6\u89c6\u56fe\u4e0d\u540c\uff0c\u56e0\u4e3a\uff1a</p> <ul> <li>\u5b83\u4eec\u5c06\u67e5\u8be2\u7ed3\u679c\u5b58\u50a8\u5728\u8868\u4e2d</li> <li>\u5b83\u4eec\u9700\u8981\u66f4\u65b0\u4ee5\u63d0\u4f9b\u6700\u65b0\u7684\u7ed3\u679c</li> </ul> <p>\u4e0d\u8fc7\uff0c\u5982\u679c\u60a8\u8bfb\u53d6\u4e86\u5199\u5165\u6b21\u6570\u5f88\u5c11\u7684\u5bc6\u96c6\u73af\u5883\uff0c\u90a3\u4e48\u4e3a\u53ef\u4f9b\u591a\u6b21\u8bfb\u53d6\u4f7f\u7528\u7684\u7269\u5316\u89c6\u56fe\u5237\u65b0\u4ed8\u51fa\u4ee3\u4ef7\u53ef\u80fd\u662f\u63d0\u9ad8\u67e5\u8be2\u6027\u80fd\u7684\u6700\u4f73\u65b9\u6cd5\u3002</p> <p></p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_35","title":"\u8b66\u544a","text":"<p>\u5982\u4e0a\u6240\u8ff0\uff0c\u7269\u5316\u89c6\u56fe\u662f\u9759\u6001\u5bf9\u8c61\uff0c\u5b83\u4eec\u4e0d\u4f1a\u5728\u6bcf\u6b21\u63d2\u5165\u3001\u66f4\u65b0\u6216\u5220\u9664\u5e95\u5c42\u8868\u96c6\u65f6\u81ea\u52a8\u66f4\u65b0\u3002\u56e0\u6b64\uff0c\u52a1\u5fc5\u8bb0\u4f4f\uff0c\u67e5\u8be2\u7269\u5316\u89c6\u56fe\u53ef\u80fd\u4f1a\u63d0\u4f9b\u4e0e\u67e5\u8be2\u539f\u59cb\u8868\u4e0d\u540c\u7684\u7ed3\u679c\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_36","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5982\u679c\u60a8\u7684\u4e3b\u8981\u76ee\u6807\u662f\u4ee5\u4e0d\u68c0\u7d22\u6700\u65b0\u7ed3\u679c\u4e3a\u4ee3\u4ef7\u83b7\u5f97\u66f4\u597d\u7684\u6027\u80fd\uff0c\u90a3\u4e48\u7269\u5316\u89c6\u56fe\u662f\u4e00\u4e2a\u5b8c\u7f8e\u7684\u89e3\u51b3\u65b9\u6848\u3002\u8bf7\u8bb0\u4f4f\uff0c\u7269\u5316\u89c6\u56fe\u4f1a\u5360\u7528\u78c1\u76d8\u7a7a\u95f4\uff0c\u5e76\u4e14\u5176\u521b\u5efa\u6216\u5237\u65b0\u4f1a\u6d88\u8017\u65f6\u95f4\u548c\u6027\u80fd\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_37","title":"\u4e13\u4e1a\u63d0\u793a","text":"<p>\u5f53\u590d\u6742\u67e5\u8be2\u626b\u63cf\u8fc7\u53bb\u65e0\u6cd5\u66f4\u65b0\u7684\u6570\u636e\u65f6\uff0c\u7269\u5316\u89c6\u56fe\u975e\u5e38\u6709\u7528\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u4e3a\u65e7\u6570\u636e\u521b\u5efa\u7269\u5316\u89c6\u56fe\u5e76\u5b9e\u65f6\u67e5\u8be2\u6e90\u8868\u4ee5\u83b7\u53d6\u65b0\u6570\u636e\u53ef\u4ee5\u5f88\u597d\u5730\u63d0\u4f9b\u6700\u4f73\u6027\u80fd\u800c\u65e0\u9700\u62a5\u544a\u9648\u65e7\u6570\u636e\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#insert-sql","title":"\u5982\u4f55\u4f18\u5316 <code>INSERT</code> SQL \u67e5\u8be2","text":""},{"location":"2024/12/23/sql-query-optimization-guide/#insert-sql_1","title":"\u4f7f\u7528\u4e13\u7528\u529f\u80fd\u4f18\u5316 <code>INSERT</code> SQL \u67e5\u8be2","text":"<p>\u5728\u6570\u636e\u5e93\u4e2d\u52a0\u8f7d\u6570\u636e\u7684\u6807\u51c6\u505a\u6cd5\u662f\u4f7f\u7528 <code>INSERT</code> \u8bed\u53e5\u3002\u7136\u800c\uff0c\u4e00\u4e9b\u6570\u636e\u5e93\u6709\u4e13\u95e8\u7684\u5de5\u5177\u53ef\u4ee5\u4ece\u5404\u79cd\u683c\u5f0f\uff08\u5982\u4e8c\u8fdb\u5236\u6216 CSV\uff09\u7684\u6e90\u6587\u4ef6\u76f4\u63a5\u63d2\u5165\u5927\u5757\u6570\u636e\u3002</p> <p>PostgreSQL <code>COPY</code> \u6216 MySQL <code>LOAD DATA</code> \u7b49\u5de5\u5177\u5141\u8bb8\u60a8\u76f4\u63a5\u6307\u5411 CSV \u6216\u4e8c\u8fdb\u5236\u6587\u4ef6\uff0c\u5e76\u9488\u5bf9\u52a0\u8f7d\u5927\u91cf\u6570\u636e\u8fdb\u884c\u4e86\u4f18\u5316\uff0c\u4e0e\u4e00\u7cfb\u5217 <code>INSERT</code> \u8bed\u53e5\u76f8\u6bd4\uff0c\u901a\u5e38\u53ef\u4ee5\u7f29\u77ed\u52a0\u8f7d\u65f6\u95f4\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_38","title":"\u8b66\u544a","text":"<p>\u867d\u7136 PostgreSQL <code>COPY</code> \u6216 MySQL <code>LOAD DATA</code> \u90fd\u6bd4\u5728\u5355\u72ec\u7684 INSERT \u8bed\u53e5\u4e2d\u52a0\u8f7d\u6bcf\u4e00\u884c\u66f4\u5feb\uff0c\u4f46\u5b83\u4eec\u90fd\u4f1a\u5728\u4e00\u4e2a\u5927\u4e8b\u52a1\u4e2d\u52a0\u8f7d\u6570\u636e\uff0c\u4ece\u800c\u7ed9\u6570\u636e\u5e93\u5e26\u6765\u538b\u529b\u3002\u6b64\u5916\uff0c\u957f\u4e8b\u52a1\u4e5f\u5c06\u6210\u4e3a\u590d\u5236\u8fc7\u7a0b\u4e2d\u7684\u74f6\u9888\uff0c\u5bfc\u81f4\u526f\u672c\u91cd\u653e\u6ede\u540e\u3002\u518d\u8005\uff0c\u5982\u679c\u5728\u53d1\u751f\u5927\u4e8b\u52a1\u65f6\u8fdb\u884c\u5907\u4efd\uff0c\u5219\u6062\u590d\u5c06\u88ab\u8feb\u56de\u6eda\u5907\u4efd\u4e2d\u5df2\u5b58\u50a8\u7684\u6240\u6709\u66f4\u6539\uff0c\u4ece\u800c\u4f7f\u6062\u590d\u8fc7\u7a0b\u53d8\u5f97\u66f4\u6162\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_39","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5c1d\u8bd5\u5728\u63d0\u53d6\u541e\u5410\u91cf\u548c\u4e8b\u52a1\u5927\u5c0f\u4e4b\u95f4\u627e\u5230\u6700\u4f73\u70b9\u3002\u5c06\u6d77\u91cf\u6570\u636e\u6587\u4ef6\u5206\u5272\u6210\u8f83\u5c0f\u7684\u5757\uff0c\u7136\u540e\u4f7f\u7528 PostgreSQL <code>COPY</code> \u6216 MySQL <code>LOAD DATA</code> \u52a0\u8f7d\u5b83\u53ef\u80fd\u662f\u4e00\u79cd\u5b8c\u7f8e\u7684\u4e2d\u95f4\u65b9\u6848\uff0c\u65e2\u80fd\u63d0\u4f9b\u6240\u9700\u7684\u901f\u5ea6\uff0c\u53c8\u4e0d\u4f1a\u7ed9\u6570\u636e\u5e93\u589e\u52a0\u592a\u5927\u538b\u529b\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_40","title":"\u4e13\u4e1a\u63d0\u793a","text":"<p>\u5982\u679c\u6e90\u6587\u4ef6\u4e2d\u7684\u6570\u636e\u4e0e\u76ee\u6807\u8868\u7684\u683c\u5f0f\u4e0d\u5339\u914d\uff0c\u5219\u4f7f\u7528\u5916\u90e8\u811a\u672c\u6b63\u786e\u5730\u91cd\u5851\u6e90\u6570\u636e\u53ef\u80fd\u6bd4\u5c06\u6570\u636e\u52a0\u8f7d\u5230\u4e34\u65f6\u8868\u4e2d\u7136\u540e\u5728\u6570\u636e\u5e93\u4e2d\u91cd\u5851\u6570\u636e\u66f4\u5feb\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#insert-sql_2","title":"\u901a\u8fc7\u5220\u9664\u4e0d\u5fc5\u8981\u7684\u7d22\u5f15\u6765\u4f18\u5316 <code>INSERT</code> SQL \u67e5\u8be2","text":"<p>\u7d22\u5f15\u88ab\u5e7f\u6cdb\u91c7\u7528\u6765\u52a0\u901f\u6570\u636e\u5e93\u8bfb\u53d6\u6a21\u5f0f\uff0c\u4f46\u662f\u7531\u4e8e\u6570\u636e\u5e93\u9700\u8981\u540c\u65f6\u66f4\u65b0\u6e90\u8868\u548c\u7d22\u5f15\uff0c\u56e0\u6b64\u5b83\u4eec\u4f1a\u5bf9\u6bcf\u4e2a\u5199\u5165\u64cd\u4f5c\uff08<code>INSERT</code>/<code>UPDATE</code>/<code>DELETE</code>\uff09\u9020\u6210\u635f\u5931\u3002</p> <p></p> <p>\u56e0\u6b64\uff0c\u4e3a\u4e86\u4f18\u5316\u5199\u5165\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u68c0\u67e5\u8868\u4e2d\u7684\u6240\u6709\u7d22\u5f15\u662f\u5426\u90fd\u662f\u5fc5\u8981\u7684\uff0c\u5e76\u5728\u8bfb\u53d6\u65f6\u7ecf\u5e38\u88ab\u4f7f\u7528\u3002\u8981\u68c0\u67e5\u7d22\u5f15\u4f7f\u7528\u60c5\u51b5\uff0c\u60a8\u53ef\u4ee5\u4f9d\u8d56\u6570\u636e\u5e93\u7cfb\u7edf\u8868\uff0c\u5982 PostgreSQL <code>pg_stat_user_indexes</code> \u6216 MySQL <code>table_io_waits_summary_by_index_usage</code>\uff0c\u63d0\u4f9b\u6709\u5173\u5f71\u54cd\u7d22\u5f15\u7684\u67e5\u8be2\u7684\u6700\u65b0\u7edf\u8ba1\u4fe1\u606f\u3002PostgreSQL 16 <code>pg_stat_user_indexes</code> \u8f93\u51fa\u7684\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code> relid | indexrelid | schemaname | relname |   indexrelname   | idx_scan |         last_idx_scan         | idx_tup_read | idx_tup_fetch\n-------+------------+------------+---------+------------------+----------+-------------------------------+--------------+---------------\n 16460 |      16466 | public     | orders  | idx_order_date   |        1 | 2024-01-01 11:15:10.410511+00 |           10 |            10\n 16460 |      16465 | public     | orders  | idx_order_status |        4 | 2024-02-08 11:16:00.471185+00 |            0 |             0\n(2 rows)\n</code></pre> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230 <code>idx_order_date</code> \u548c <code>idx_order_status</code> \u7d22\u5f15\u5206\u522b\u88ab\u626b\u63cf\u4e86\u4e00\u6b21\u548c\u56db\u6b21\uff0c\u5176\u4e2d <code>idx_order_date</code> \u6700\u540e\u4e00\u6b21\u88ab\u626b\u63cf\u662f\u5728 <code>2024-01-01 11:15:10.410511+00</code>\u3002\u7531\u4e8e\u8be5\u7d22\u5f15\u81ea\u4e00\u6708\u4efd\u4ee5\u6765\u5c31\u6ca1\u6709\u88ab\u4f7f\u7528\u8fc7\uff0c\u56e0\u6b64\u5b83\u53ef\u80fd\u662f\u4e00\u4e2a\u503c\u5f97\u5220\u9664\u7684\u7d22\u5f15\u3002</p> <p>Aiven \u7684 EverSQL \u63d0\u4f9b\u4e86\u5197\u4f59\u7d22\u5f15\u68c0\u6d4b\u529f\u80fd\uff0c\u53ef\u4ee5\u81ea\u52a8\u53d1\u73b0\u672a\u4f7f\u7528\u7684\u7d22\u5f15\u3002</p> <p></p> <p>\u4e00\u65e6\u60a8\u786e\u5b9a\u672a\u4f7f\u7528\u7684\u7d22\u5f15\uff0c\u5220\u9664\u5b83\u4eec\u5c06\u4f1a\u5728\u5199\u5165\u6027\u80fd\u548c\u51cf\u5c11\u78c1\u76d8\u7a7a\u95f4\u4f7f\u7528\u65b9\u9762\u5e26\u6765\u597d\u5904\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_41","title":"\u8b66\u544a","text":"<p>\u7d22\u5f15\u662f\u52a0\u5feb\u8bfb\u53d6\u64cd\u4f5c\u7684\u5173\u952e\uff0c\u5220\u9664\u5b83\u4eec\u53ef\u80fd\u4f1a\u5bf9\u6240\u6709 <code>SELECT</code> \u67e5\u8be2\u4ea7\u751f\u5f71\u54cd\u3002\u4e86\u89e3\u6570\u636e\u5e93\u4e2d\u7684\u8bfb/\u5199\u6a21\u5f0f\u5bf9\u4e8e\u4f18\u5316\u6574\u4f53\u4f53\u9a8c\u800c\u4e0d\u662f\u4ec5\u4ec5\u4e00\u4e2a\u8bed\u53e5\u81f3\u5173\u91cd\u8981\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_42","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5206\u6790\u6574\u4f53\u6570\u636e\u5e93\u5de5\u4f5c\u8d1f\u8f7d\u5e76\u5b9a\u4e49\u6027\u80fd\u4f18\u5316\u4f18\u5148\u7ea7\u3002\u5728\u6b64\u57fa\u7840\u4e0a\uff0c\u8bc4\u4f30\u53ef\u7528\u7684\u6574\u4f53\u7d22\u5f15\u96c6\u5e76\u786e\u5b9a\u54ea\u4e9b\u7d22\u5f15\u9700\u8981\u4fdd\u7559\u6216\u53ef\u4ee5\u5220\u9664\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_43","title":"\u4e13\u4e1a\u63d0\u793a","text":"<p>\u5982\u679c\u60a8\u7684\u6570\u636e\u52a0\u8f7d\u8bed\u53e5\u53d1\u751f\u5728\u8bfb\u53d6\u8d1f\u8d23\u8f83\u4f4e\u7684\u65f6\u6bb5\uff0c\u4f8b\u5982\u5728\u591c\u95f4\u52a0\u8f7d\u6570\u636e\u4ed3\u5e93\u65f6\uff0c\u60a8\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u83b7\u5f97\u66f4\u597d\u7684\u63d0\u53d6\u6027\u80fd\uff1a</p> <ul> <li>\u7981\u7528\u7d22\u5f15</li> <li>\u52a0\u8f7d\u6570\u636e</li> <li>\u91cd\u65b0\u542f\u7528\u7d22\u5f15</li> </ul>"},{"location":"2024/12/23/sql-query-optimization-guide/#insert-sql-select","title":"\u4f18\u5316 <code>INSERT</code> SQL \u67e5\u8be2\uff0c\u5c31\u50cf\u5b83\u662f <code>SELECT</code> \u8bed\u53e5\u4e00\u6837","text":"<p>\u5728\u8bb8\u591a\u60c5\u51b5\u4e0b\uff0c<code>INSERT</code> \u8bed\u53e5\u5305\u542b\u4e1a\u52a1\u903b\u8f91\u90e8\u5206\uff0c\u4e0e <code>SELECT</code> \u67e5\u8be2\u5b8c\u5168\u4e00\u6837\uff0c\u8fd9\u610f\u5473\u7740\u5b83\u4eec\u53ef\u4ee5\u5305\u542b <code>WHERE</code> \u5b50\u53e5\u3001\u5b50\u67e5\u8be2\u7b49\u3002</p> <p>\u63d0\u53d6\u67e5\u8be2\u7684\u5185\u90e8\u90e8\u5206\u5e76\u5bf9\u5176\u8fdb\u884c\u4f18\u5316\uff08\u901a\u8fc7\u7d22\u5f15\u3001\u5206\u533a\u3001\u67e5\u8be2\u91cd\u5199\u7b49\uff09\uff0c\u5c31\u597d\u50cf\u5b83\u662f\u4e00\u4e2a <code>SELECT</code> \u67e5\u8be2\u4e00\u6837\uff0c\u53ef\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_44","title":"\u8b66\u544a","text":"<p><code>INSERT</code> \u662f\u6570\u636e\u5e93\u7684\u5199\u5165\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u56e0\u6b64\u60a8\u9700\u8981\u8c28\u614e\u5730\u627e\u5230\u53ef\u4ee5\u52a0\u901f <code>INSERT</code> \u8bed\u53e5\u4e2d\u7684\u4e1a\u52a1\u903b\u8f91\u7684\u786e\u5207\u8fb9\u754c\uff0c\u540c\u65f6\u53c8\u4e0d\u5f71\u54cd\u8bfb\u53d6\u5de5\u4f5c\u8d1f\u8f7d\u7684\u6027\u80fd\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_45","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5982\u679c\u60a8\u7684 <code>INSERT</code> \u8bed\u53e5\u6b63\u5728\u4ece\u6570\u636e\u5e93\u4e2d\u7684\u53e6\u4e00\u4e2a\u8868\u4e2d\u9009\u62e9\u6570\u636e\uff0c\u5219\u53ef\u4ee5\u9075\u5faa <code>SELECT</code> \u90e8\u5206\u4e2d\u8be6\u7ec6\u8bf4\u660e\u7684\u89c4\u5219\u3002\u5982\u679c\u5728 <code>INSERT</code> \u548c <code>SELECT</code> \u8bed\u53e5\uff08<code>WHERE</code> \u6761\u4ef6\uff09\u4e2d\u90fd\u4f7f\u7528\u4e86\u660e\u786e\u7684\u6570\u636e\u8fb9\u754c\uff0c\u90a3\u4e48\u5bf9\u8868\u8fdb\u884c\u5206\u533a\u53ef\u4ee5\u52a0\u5feb\u8fd9\u4e24\u4e2a\u8fc7\u7a0b\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#delete-sql","title":"\u5982\u4f55\u4f18\u5316 <code>DELETE</code> SQL \u67e5\u8be2","text":""},{"location":"2024/12/23/sql-query-optimization-guide/#delete-sql_1","title":"\u901a\u8fc7\u5220\u9664\u4e0d\u5fc5\u8981\u7684\u7d22\u5f15\u6765\u4f18\u5316 <code>DELETE</code> SQL \u67e5\u8be2","text":"<p>\u540c\u6837\uff0c\u63d2\u5165\u548c\u5220\u9664\uff08\u548c\u66f4\u65b0\uff09\u6027\u80fd\u90fd\u53ef\u4ee5\u4ece\u5220\u9664\u4e0d\u5fc5\u8981\u7684\u7d22\u5f15\u4e2d\u83b7\u76ca\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_46","title":"\u8b66\u544a","text":"<p>\u6839\u636e\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u5220\u9664\u53ef\u80fd\u4e0d\u50cf\u63d2\u5165/\u66f4\u65b0\u90a3\u6837\u9891\u7e41\u3002\u8fc7\u5ea6\u4f18\u5316\u5220\u9664\u53ef\u80fd\u4f1a\u964d\u4f4e\u66f4\u5e38\u89c1\u7684\u8bfb/\u5199\u6a21\u5f0f\u7684\u6027\u80fd\u6216\u590d\u6742\u6027\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_47","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5206\u6790\u6574\u4f53\u6570\u636e\u5e93\u5de5\u4f5c\u8d1f\u8f7d\u5e76\u5b9a\u4e49\u6027\u80fd\u4f18\u5316\u4f18\u5148\u7ea7\u3002\u5728\u6b64\u57fa\u7840\u4e0a\uff0c\u8bc4\u4f30\u53ef\u7528\u7684\u6574\u4f53\u7d22\u5f15\u96c6\u5e76\u786e\u5b9a\u54ea\u4e9b\u7d22\u5f15\u9700\u8981\u4fdd\u7559\u6216\u53ef\u4ee5\u5220\u9664\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#truncate-delete-sql","title":"\u4f7f\u7528 <code>TRUNCATE</code> \u4f18\u5316 <code>DELETE</code> SQL \u67e5\u8be2","text":"<p>\u5982\u679c\u60a8\u7684\u76ee\u7684\u662f\u4ece\u8868\u4e2d\u5220\u9664\u6240\u6709\u884c\uff0c<code>TRUNCATE</code> \u5c31\u662f\u60a8\u7684\u597d\u5e2e\u624b\u3002<code>TRUNCATE</code> \u5728 PostgreSQL \u548c MySQL\uff08\u4ee5\u53ca\u5176\u4ed6\u6570\u636e\u5e93\uff09\u4e2d\u90fd\u53ef\u7528\uff0c\u5b83\u5e76\u4e0d\u6267\u884c\u9010\u4e2a\u5143\u7ec4\u7684\u5220\u9664\uff0c\u800c\u53ea\u662f\u544a\u8bc9\u6570\u636e\u5e93\u5c06\u6240\u6709\u65b0\u8868\u7684\u6570\u636e\u5b58\u50a8\u5230\u4e00\u4e2a\u65b0\u7684\u7a7a\u4f4d\u7f6e\u3002\u56e0\u6b64\uff0c\u4e0e <code>DELETE FROM TABLE</code> \u76f8\u6bd4\uff0c\u5b83\u8981\u5feb\u5f97\u591a\u3002</p> <p></p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_48","title":"\u8b66\u544a","text":"<p>\u4ec5\u5f53\u60a8\u9700\u8981\u4ece\u8868\u4e2d\u5220\u9664\u6240\u6709\u884c\u65f6\uff0c<code>TRUNCATE</code> \u624d\u6709\u6548\u3002\u5982\u679c\u60a8\u53ea\u9700\u8981\u5220\u9664\u4e00\u7ec4\u7279\u5b9a\u7684\u884c\uff0c\u90a3\u4e48\u8fd9\u4e0d\u662f\u4e00\u4e2a\u9009\u9879\uff0c\u60a8\u53ef\u80fd\u5e94\u8be5\u8003\u8651\u5206\u533a\u3002<code>TRUNCATE</code> \u548c <code>DELETE</code> \u5177\u6709\u4e0d\u540c\u7684\u6743\u9650\u3001\u9700\u6c42\u548c\u6267\u884c\uff0c\u7406\u89e3\u5b83\u4eec\uff08\u5728 MySQL \u548c PostgreSQL \u4e2d\uff09\u662f\u786e\u4fdd\u4f7f\u7528\u6b63\u786e\u64cd\u4f5c\u7684\u5173\u952e\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_49","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5728\u8bbe\u8ba1\u6570\u636e\u5e93\u8868\u65f6\uff0c\u8fd8\u8981\u5206\u6790\u6570\u636e\u4fdd\u7559\u65b9\u9762\u7684\u9700\u6c42\u3002\u5982\u679c\u4e00\u4e2a\u8868\u53ea\u9700\u8981\u5305\u542b\u201c\u6700\u65b0\u201d\u7684\u6570\u636e\uff0c\u5219\u5728\u8bbe\u8ba1\u65f6\u8981\u8003\u8651\u9891\u7e41\u63d2\u5165\u548c\u5220\u9664\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_50","title":"\u4e13\u4e1a\u63d0\u793a","text":"<p>\u4f7f\u7528\u5206\u533a\u6216\u521b\u5efa\u65f6\u95f4\u7ed1\u5b9a\u8868\uff08\u4f8b\u5982 <code>SALES_01_2024</code>\uff09\u53ef\u4ee5\u52a0\u5feb\u5220\u9664\u901f\u5ea6\uff0c\u56e0\u4e3a\u6574\u4e2a\u8868\u53ef\u4ee5\u88ab\u622a\u65ad\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#delete-sql_2","title":"\u4f7f\u7528\u8868\u5206\u533a\u4f18\u5316 <code>DELETE</code> SQL \u67e5\u8be2","text":"<p>\u5ef6\u7eed\u4e0a\u4e00\u8282\uff0c\u5982\u679c\u60a8\u7684\u76ee\u6807\u662f\u6839\u636e\u5df2\u77e5\u89c4\u5219\u5b9a\u671f\u5220\u9664\u6570\u636e\uff08\u4f8b\u5982\u6839\u636e\u65e5\u671f\u5b57\u6bb5\uff09\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u5206\u533a\u3002PostgreSQL \u548c MySQL \u4e2d\u63d0\u4f9b\u5206\u533a\u529f\u80fd\uff0c\u53ef\u6839\u636e\u8c13\u8bcd\u5c06\u6570\u636e\u62c6\u5206\u5230\u591a\u4e2a\u8868\u4e2d\u3002\u5982\u679c\u60a8\u9700\u8981\u5220\u9664\u5206\u533a\u4e2d\u5305\u542b\u7684\u6574\u4e2a\u6570\u636e\u5b50\u96c6\uff0c\u53ea\u9700\u622a\u65ad\u5206\u533a\u672c\u8eab\u5373\u53ef\u3002</p> <p></p> <p>\u5206\u533a\u8c13\u8bcd\u53ef\u4ee5\u662f\uff1a</p> <ul> <li>RANGE: \u5b9a\u4e49\u4e0e\u8868\u4e2d\u6bcf\u4e2a\u5206\u533a\u76f8\u5173\u7684\u4e00\u7ec4\u8303\u56f4</li> <li>LIST: \u5b9a\u4e49\u4e0e\u8868\u4e2d\u6bcf\u4e2a\u5206\u533a\u5173\u8054\u7684\u56fa\u5b9a\u503c\u5217\u8868</li> <li>HASH: \u6839\u636e\u7528\u6237\u5b9a\u4e49\u7684\u51fd\u6570\u5b9a\u4e49\u5206\u533a</li> <li>KEY: \u5728 MySQL \u4e2d\u53ef\u7528\uff0c\u4f7f\u7528 MySQL \u6563\u5217\u51fd\u6570\u63d0\u4f9b HASH \u5206\u533a</li> </ul>"},{"location":"2024/12/23/sql-query-optimization-guide/#_51","title":"\u8b66\u544a","text":"<p>\u5c3d\u7ba1\u5206\u533a\u5bf9\u4e8e\u7528\u6237\u6765\u8bf4\u662f\u201c\u4e0d\u53ef\u89c1\u7684\u201d\uff08\u67d0\u4e2a\u7528\u6237\u53ef\u4ee5\u67e5\u8be2\u539f\u59cb\u8868\u5e76\u4ece\u6240\u6709\u5206\u533a\u4e2d\u9009\u62e9\u6570\u636e\uff09\uff0c\u4f46\u4ecd\u9700\u8981\u8003\u8651\u5206\u533a\u8868\u7684\u7ba1\u7406\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u5bf9\u4e8e LIST \u5206\u533a\uff0c\u5f53\u63d2\u5165\u65b0\u952e\u65f6\uff0c\u9700\u8981\u9884\u5148\u521b\u5efa\u9002\u5f53\u7684\u5206\u533a\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_52","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5f53\u6570\u636e\u96c6\u5728\u65f6\u95f4\u6216\u5176\u4ed6\u5217\uff08\u4f8b\u5982\u56fd\u5bb6\uff09\u65b9\u9762\u5b58\u5728\u660e\u786e\u8fb9\u754c\u65f6\uff0c\u5206\u533a\u975e\u5e38\u6709\u7528\u3002\u5728\u6ca1\u6709\u660e\u786e\u8fc7\u6ee4\u6807\u51c6\u7684\u60c5\u51b5\u4e0b\u5bf9\u8868\u8fdb\u884c\u5206\u533a\u53ea\u4f1a\u589e\u52a0\u6570\u636e\u5e93\u7684\u8d1f\u8f7d\uff0c\u4f7f\u6bcf\u4e2a\u67e5\u8be2\u53d8\u5f97\u66f4\u6162</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#delete-sql_3","title":"\u901a\u8fc7\u5c06\u8bed\u53e5\u62c6\u5206\u6210\u5757\u6765\u4f18\u5316 <code>DELETE</code> SQL \u67e5\u8be2","text":"<p>\u6267\u884c\u5927\u89c4\u6a21 <code>DELETE</code> \u64cd\u4f5c\u65f6\uff0c\u901a\u8fc7\u5e94\u7528\u989d\u5916\u7684 <code>WHERE</code> \u6761\u4ef6\u5c06\u8981\u5220\u9664\u7684\u6570\u636e\u91cf\u5206\u6210\u66f4\u5c0f\u7684\u5757\u3002\u901a\u8fc7\u8fd9\u79cd\u6280\u672f\uff0c\u60a8\u53ef\u4ee5\u83b7\u5f97\u4e00\u4e2a\u66f4\u5bb9\u6613\u8ddf\u8e2a\u7684\u6d41\u7a0b\u3001\u5728\u53d1\u751f\u6545\u969c\u65f6\u66f4\u5feb\u5730\u56de\u6eda\uff0c\u5e76\u4e14\u901a\u5e38\u603b\u4f53\u4e0a\u5177\u6709\u66f4\u597d\u7684\u6027\u80fd\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_53","title":"\u8b66\u544a","text":"<p>\u5c06 <code>DELETE</code> \u64cd\u4f5c\u5206\u6210\u591a\u4e2a\u8f83\u5c0f\u7684\u8bed\u53e5\u4f1a\u4f7f\u60a8\u9762\u4e34\u7f3a\u4e4f\u4e00\u81f4\u6027\u7684\u98ce\u9669\uff0c\u5e76\u4e14\u7531\u4e8e\u6570\u636e\u5b50\u96c6\u4e0d\u91cd\u53e0\u800c\u4e22\u5931\u4e00\u4e9b\u884c\u3002\u56e0\u6b64\uff0c\u60a8\u9700\u8981\u786e\u4fdd\u6ee1\u8db3\u4e00\u81f4\u6027\u8981\u6c42\uff0c\u5e76\u4e14\u751f\u6210\u7684\u8bed\u53e5\u96c6\u5305\u542b\u539f\u59cb\u67e5\u8be2\u6240\u9488\u5bf9\u7684\u6574\u5957\u884c\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_54","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5c06 <code>DELETE</code> \u64cd\u4f5c\u62c6\u5206\u6210\u591a\u4e2a\u5757\u662f\u63d0\u9ad8\u6027\u80fd\u5e76\u51cf\u5c11\u5bf9\u6570\u636e\u5e93\u5f71\u54cd\u7684\u597d\u65b9\u6cd5\u3002\u5982\u679c\u60a8\u6709\u4e00\u7ec4\u7279\u5b9a\u7684\u6570\u636e\uff0c\u5e76\u4e14\u8be5\u6570\u636e\u5177\u6709\u660e\u786e\u7684\u5199\u5165\u548c\u8bfb\u53d6\u64cd\u4f5c\u8fb9\u754c\uff08\u4f8b\u5982 <code>COUNTRY</code> \u6216 <code>DATE</code>\uff09\uff0c\u60a8\u53ef\u4ee5\u5c06\u5176\u7528\u4f5c\u5206\u5272\u952e\uff0c\u5e76\u4f7f\u7528\u6b64\u65b9\u6cd5\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#delete-delete-sql","title":"\u901a\u8fc7\u51cf\u5c11\u6267\u884c <code>DELETE</code> \u7684\u9891\u7387\u6765\u4f18\u5316 <code>DELETE</code> SQL \u67e5\u8be2","text":"<p>\u5728\u67d0\u4e9b\u7528\u4f8b\u4e2d\uff0c\u60a8\u53ef\u80fd\u5e0c\u671b\u6bcf\u5929\u5220\u9664\u6570\u636e\uff0c\u4f8b\u5982\u9700\u8981\u5220\u9664\u8d85\u8fc7 30 \u5929\u7684\u65e7\u6570\u636e\u3002\u4f46\u662f\uff0c\u6b64\u64cd\u4f5c\u9700\u8981\u6bcf\u5929\u626b\u63cf\u6574\u4e2a\u8868\u3002\u5bf9\u4e8e\u6b64\u7c7b\u7528\u4f8b\uff0c\u60a8\u53ef\u4ee5\u5229\u7528\u4ee5\u4e0b\u7ec4\u5408\u903b\u8f91\uff1a</p> <ul> <li>\u4f7f\u7528\u66f4\u667a\u80fd\u7684 <code>SELECTS</code> \u4e0d\u663e\u793a\u65e7\u6570\u636e\u96c6\uff08\u4e0d\u68c0\u7d22\u8d85\u8fc7 30 \u5929\u7684\u6570\u636e\uff09</li> <li>\u4ec5\u5f53\u7a7a\u95f4\u56de\u6536\u6709\u7528\u65f6\u624d\u5220\u9664\u6570\u636e\uff08\u78c1\u76d8\u7a7a\u95f4\u4e0d\u8db3\u65f6\uff09</li> </ul> <p>\u6b64\u5916\uff0c\u5728 PostgreSQL \u548c MySQL \u4e2d\uff0c\u5220\u9664\u8868\u4e2d\u7684\u4e00\u5c0f\u90e8\u5206\u6570\u636e\u96c6\u4e0d\u4f1a\u8282\u7701\u5927\u91cf\u78c1\u76d8\u7a7a\u95f4\uff0c\u56e0\u4e3a\u5b83\u53ea\u4f1a\u5728\u6258\u7ba1\u8868\u6570\u636e\u7684\u9875\u9762\u4e2d\u4ea7\u751f\u53ef\u7528\u7a7a\u95f4\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_55","title":"\u8b66\u544a","text":"<p>\u60a8\u53ef\u80fd\u88ab\u6cd5\u5f8b\u5f3a\u5236\u6309\u65f6\u5220\u9664\u65e7\u6570\u636e\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u8bf7\u660e\u667a\u5730\u8bc4\u4f30\u60a8\u7684\u6570\u636e\u4fdd\u7559\u9700\u6c42\u5e76\u76f8\u5e94\u5730\u89c4\u5212\u6570\u636e\u5220\u9664\u3002\u667a\u80fd\u5206\u533a\u8bbe\u8ba1\u53ef\u4ee5\u5e2e\u52a9\u901a\u8fc7\u622a\u65ad\u63d0\u4f9b\u5feb\u901f\u5220\u9664\u8bed\u53e5\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_56","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u660e\u667a\u5730\u8bbe\u8ba1\u6570\u636e\u4fdd\u7559\u7b56\u7565\u548c\u76f8\u5173\u5220\u9664\u8bed\u53e5\u3002\u5982\u679c\u60a8\u4e0d\u6253\u7b97\u5220\u9664\u5927\u90e8\u5206\u6570\u636e\u96c6\uff0c\u5c31\u4e0d\u8981\u8ba1\u5212\u8282\u7701\u5927\u91cf\u7a7a\u95f4\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#delete-delete-sql_1","title":"\u901a\u8fc7\u4e0d\u6267\u884c <code>DELETE</code> \u6765\u4f18\u5316 <code>DELETE</code> SQL \u67e5\u8be2","text":"<p>\u5982\u679c\u8981\u5220\u9664\u5927\u578b\u8868\u4e2d\u7684\u5927\u90e8\u5206\u6570\u636e\uff0c\u5219\u4ee5\u4e0b\u65b9\u6cd5\u4f1a\u66f4\u5feb\uff1a</p> <ul> <li>\u521b\u5efa\u65b0\u8868</li> <li>\u590d\u5236\u4ecd\u7136\u9700\u8981\u7684\u4e00\u5c0f\u90e8\u5206</li> <li>\u5220\u9664\u65e7\u8868</li> <li>\u91cd\u547d\u540d\u8868</li> </ul> <p></p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_57","title":"\u8b66\u544a","text":"<p>\u867d\u7136\u8fd9\u79cd\u65b9\u6cd5\u53ef\u80fd\u66f4\u5feb\uff0c\u4f46\u5b83\u6d89\u53ca\u6570\u636e\u5e93\u4e2d\u7684\u51e0\u4e2a\u64cd\u4f5c\uff0c\u53ef\u80fd\u4f1a\u963b\u6b62\u5e95\u5c42\u8868\u7684\u6b63\u5e38\u529f\u80fd\u3002\u8bf7\u4ed4\u7ec6\u4e86\u89e3\u662f\u5426\u53ef\u4ee5\u6267\u884c\u6574\u4e2a\u8fc7\u7a0b\u540c\u65f6\u4fdd\u6301\u6b63\u5e38\u7684\u6570\u636e\u5e93\u529f\u80fd\u3002\u6b64\u5916\uff0c\u8bf7\u6ce8\u610f\uff0c\u5982\u679c\u60a8\u6709\u5f15\u7528\u7ea6\u675f\uff08\u4f8b\u5982\u5916\u952e\u6307\u5411\u8868\u4e2d\u67d0\u4e9b\u952e\uff09\uff0c\u5219\u6b64\u89e3\u51b3\u65b9\u6cd5\u5c06\u4e0d\u8d77\u4f5c\u7528\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_58","title":"\u9ec4\u91d1\u6cd5\u5219","text":"<p>\u5728\u6570\u636e\u5e93\u8d1f\u8f7d\u5177\u6709\u6613\u4e8e\u9884\u6d4b\u7684\u4f7f\u7528\u6a21\u5f0f\u7684\u60c5\u51b5\u4e0b\uff0c\u4e0a\u8ff0\u89e3\u51b3\u65b9\u6cd5\u662f\u7406\u60f3\u7684\u3002\u5728\u6d41\u91cf\u4f4e\u5cf0\u671f\u95f4\uff08\u6216\u6839\u672c\u6ca1\u6709\u6d41\u91cf\u65f6\uff09\u6267\u884c\u8be5\u8fc7\u7a0b\u5c06\u63d0\u4f9b\u6700\u4f73\u7684 <code>DELETE</code> \u6027\u80fd\uff0c\u540c\u65f6\u6700\u5927\u9650\u5ea6\u5730\u51cf\u5c11\u6574\u4e2a\u6570\u636e\u5e93\u529f\u80fd\u7684\u4e2d\u65ad\u3002</p>"},{"location":"2024/12/23/sql-query-optimization-guide/#_59","title":"\u603b\u7ed3","text":"<p>\u4f18\u5316 SQL \u8bed\u53e5\u53ef\u80fd\u662f\u4e00\u9879\u7e41\u7410\u7684\u4efb\u52a1\uff1a\u60a8\u9700\u8981\u6df1\u5165\u4e86\u89e3\u6570\u636e\u5e93\u7ed3\u6784\u548c\u8981\u4f18\u5316\u7684\u5de5\u4f5c\u8d1f\u8f7d\u7c7b\u578b\u624d\u80fd\u83b7\u5f97\u826f\u597d\u7684\u7ed3\u679c\u3002\u6b64\u5916\uff0c\u5728\u4f18\u5316\u7279\u5b9a\u5de5\u4f5c\u8d1f\u8f7d\uff08\u4f8b\u5982 <code>INSERT</code> \u8bed\u53e5\uff09\u65f6\uff0c\u60a8\u53ef\u80fd\u4f1a\u5f71\u54cd\u5177\u6709\u4e0d\u540c\u8bbf\u95ee\u6a21\u5f0f\uff08\u5982 <code>SELECT</code> \u6216 <code>DELETE</code>\uff09\u7684\u5176\u4ed6\u67e5\u8be2\u7684\u6027\u80fd\u3002</p> <p>\u8981\u5168\u9762\u4e86\u89e3\u60a8\u7684\u6570\u636e\u8d44\u4ea7\u548c\u652f\u6301\u7ed3\u6784\uff0c\u4e86\u89e3\u6027\u80fd\u53d8\u5316\u5e76\u83b7\u5f97\u81ea\u52a8\u7684\u3001AI \u8f85\u52a9\u7684 SQL \u4f18\u5316\u5efa\u8bae\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 Aiven \u7684 EverSQL\u3002EverSQL \u4f20\u611f\u5668\u53ef\u5b89\u88c5\u5728\u4efb\u4f55 PostgreSQL \u548c MySQL \u6570\u636e\u5e93\u4e0a\uff0c\u8ba9\u60a8\u76d1\u63a7\u7f13\u6162\u7684\u67e5\u8be2\u5e76\u83b7\u5f97\u6027\u80fd\u89c1\u89e3\u3002\u4eba\u5de5\u667a\u80fd\u9a71\u52a8\u7684\u5f15\u64ce\u4f1a\u5206\u6790\u7f13\u6162\u7684 SQL \u8bed\u53e5\u548c\u73b0\u6709\u7684\u652f\u6301\u6570\u636e\u7ed3\u6784\uff0c\u5e76\u63d0\u4f9b\u7d22\u5f15\u5efa\u8bae\u548c SQL \u91cd\u5199\u5efa\u8bae\uff0c\u4ee5\u63d0\u9ad8\u6027\u80fd\u3002</p> <p>\u4f5c\u8005\uff1aFrancesco Tisiot \u539f\u6587\uff1ahttps://aiven.io/developer/sql-query-optimization-guide</p>"},{"location":"2024/12/13/substring-%E5%87%BD%E6%95%B0%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/","title":"<code>substring</code> \u51fd\u6570\u6b63\u5219\u8868\u8fbe\u5f0f","text":"<p>\u5f53\u6211\u5728\u67e5\u770b\u4e00\u4e9b\u65e7\u4ee3\u7801\u65f6\uff0c\u6211\u5076\u7136\u53d1\u73b0\u4e86\u4e00\u4e9b\u6211\u5b8c\u5168\u5fd8\u8bb0\u4e86\uff0c\u6216\u8005\u522b\u4eba\u65e9\u5c31\u77e5\u9053\u7684\u4e1c\u897f\u2014\u2014\u53ef\u4ee5\u4f7f\u7528 <code>substring</code> \u51fd\u6570\u8fdb\u884c\u6b63\u5219\u8868\u8fbe\u5f0f\u5de5\u4f5c\u3002</p> <p>PostgreSQL \u4e2d\u5927\u591a\u6570\u6b63\u5219\u8868\u8fbe\u5f0f\u51fd\u6570\u901a\u5e38\u4ee5 <code>regexp</code> \u5f00\u5934\uff0c\u6216\u8005\u4f7f\u7528\u50cf <code>~</code> \u8fd9\u6837\u7684\u8fd0\u7b97\u7b26\u3002\u4f46\u662f\u6211\u5b8c\u5168\u5fd8\u8bb0\u4e86 <code>substring</code> \u51fd\u6570\uff0c\u5b83\u4e5f\u53ef\u4ee5\u7406\u89e3\u6b63\u5219\u8868\u8fbe\u5f0f\u3002\u5f53\u6211\u5fc5\u987b\u4f7f\u7528\u6b63\u5219\u8868\u8fbe\u5f0f\u89e3\u6790\u51fa\u4e00\u4e9b\u5c0f\u6bb5\u6587\u672c\u65f6\uff0c\u6211\u901a\u5e38\u4f1a\u4f7f\u7528 <code>regexp_*</code> \u51fd\u6570\u4e4b\u4e00\uff0c\u5982 <code>regexp_replace</code>\u3001<code>regexp_match</code> \u6216 <code>regexp_matches</code>\uff0c\u5e76\u4e14\u4ec5\u5f53\u6211\u60f3\u901a\u8fc7\u7d22\u5f15\u53f7\u4ece\u5b57\u7b26\u4e32\u4e2d\u63d0\u53d6\u4e00\u7cfb\u5217\u5b57\u7b26\u65f6\u624d\u4f7f\u7528 <code>substring</code>\u3002\u4f46\u90a3\u91cc\u7684\u4ee3\u7801\u544a\u8bc9\u6211\uff0c\u4e5f\u8bb8\u6211\u6216\u5176\u4ed6\u4eba\u5f53\u65f6\u8981\u806a\u660e\u5f97\u591a\u3002\u6240\u6709\u8fd9\u4e9b\u51fd\u6570\u90fd\u603b\u7ed3\u5728Documentation: PostgreSQL string functions\u3002</p> <p>\u5927\u591a\u6570\u4eba\u4f7f\u7528\u7684\u5e38\u89c1 <code>substring</code> \u51fd\u6570\u65f6\uff1a</p> <pre><code>substring(string, start_position, length)\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u5199\u6210\uff1a</p> <pre><code>substring(string FROM start_position FOR length)\n</code></pre> <p><code>length</code> \u548c <code>FOR length</code> \u5b50\u53e5\u662f\u53ef\u9009\u7684\uff0c\u5982\u679c\u7701\u7565\uff0c\u5219\u8fd4\u56de\u4ece <code>start_position</code> \u4f4d\u7f6e\u5230\u5b57\u7b26\u4e32\u672b\u5c3e\u7684\u5b57\u7b26\u4e32\u3002</p> <p>\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>SELECT substring('Jill lugs 5 pails', 11, 7);\n</code></pre> <p>\u8fd4\u56de\uff1a<code>5 pails</code></p> <p>\u8fd9\u4e9b\u666e\u901a\u5f62\u5f0f\u7684 <code>substring</code> \u751a\u81f3\u5b58\u5728\u4e8e\u5b8c\u5168\u4e0d\u64c5\u957f\u6267\u884c\u6b63\u5219\u8868\u8fbe\u5f0f\u7684\u6570\u636e\u5e93\u4e2d\u3002\u6211\u4e0d\u4f1a\u8bf4\u51fa\u8fd9\u4e9b\u6570\u636e\u5e93\u7684\u540d\u5b57\u3002\u53ea\u8981\u77e5\u9053\u4ed6\u4eec\u5b58\u5728\u3002PostgreSQL \u8fd8\u6709\u53e6\u4e00\u79cd\u5f62\u5f0f\uff0c\u6211\u53d1\u73b0\u6709\u65f6\u6bd4\u4e0a\u8ff0 <code>regexp_*</code> \u51fd\u6570\u505a\u540c\u6837\u7684\u4e8b\u60c5\u66f4\u5bb9\u6613\u7406\u89e3\u548c\u7f16\u5199\u3002</p> <p>\u8ba9\u6211\u4eec\u91cd\u590d\u4e0a\u9762\u7684\u4f8b\u5b50\uff0c\u4f46\u8981\u660e\u767d\u6211\u4eec\u9700\u8981\u6311\u9009\u51fa Jill \u5230\u5e95\u62d6\u7740\u4ec0\u4e48\u4ee5\u53ca\u5979\u62d6\u4e86\u591a\u5c11\u3002</p> <pre><code>SELECT substring('Jill lugs 5 pails', '[0-9]+\\s[A-Za-z]+');\n</code></pre> <p>\u5b83\u8fd4\u56de\u76f8\u540c\u7684\u5185\u5bb9\uff0c\u4f46\u65e0\u9700\u77e5\u9053\u4f4d\u7f6e\uff0c\u800c\u53ea\u9700\u5173\u5fc3\u63aa\u8f9e\u3002</p> <p>\u73b0\u5728\u53ef\u4ee5\u80af\u5b9a\u7684\u662f\uff0c\u5728\u8bb8\u591a\u60c5\u51b5\u4e0b\uff0c\u60a8\u6700\u597d\u4f7f\u7528\u66f4\u5f3a\u5927\u7684 <code>regexp_match</code> \u6216 <code>regexp_matches</code>\uff0c\u5c31\u50cf\u5f53\u60a8\u8bd5\u56fe\u4e00\u6b21\u6027\u5206\u79bb\u8bed\u53e5\u7684\u5404\u4e2a\u90e8\u5206\u65f6\u4e00\u6837\u3002\u5c31\u50cf\u4e5f\u8bb8\u6211\u5e0c\u671b\u5c06\u6876\u7684\u6570\u91cf\u4e0e\u7269\u54c1\u6876\u7684\u6570\u91cf\u5206\u5f00\uff0c\u90a3\u4e48\u6211\u5f53\u7136\u4f1a\u8fd9\u6837\u505a\u3002</p> <p><pre><code>SELECT r[1] AS who, r[2] AS action, r[3] AS how_many, r[4] AS what\nFROM regexp_match('Jill lugs 5 pails',\n                  '([A-Za-z]+)\\s+([A-Za-z]+)\\s+([0-9]+)\\s+([A-Za-z]+)') AS r;\n who  | action | how_many | what\n------+--------+----------+-------\n Jill | lugs   | 5        | pails\n(1 row)\n</code></pre> \u800c\u5f53\u6211\u9700\u8981\u6709\u70b9\u8d2a\u5fc3\u5e76\u8fd4\u56de\u591a\u6761\u8bb0\u5f55\u65f6\uff0c\u56e0\u4e3a\u6211\u8981\u5728\u4e00\u5806\u8bcd\u6c47\u4e2d\u6293\u53d6\u6bcf\u4e2a\u53e5\u5b50\u4e2d\u7b26\u5408\u6211\u7684\u63aa\u8f9e\u7684\u90e8\u5206\uff0c\u6211\u4f1a\u4f7f\u7528 <code>regexp_matches</code>\u3002</p> <pre><code>SELECT r[1] AS who, r[2] AS action, r[3] AS how_many, r[4] AS what\nFROM regexp_matches('Jill lugs 5 pails. Jack lugs 10 pails',\n                    '([A-Za-z]+)\\s+([A-Za-z]+)\\s+([0-9]+)\\s+([A-Za-z]+)',\n                    'g') AS r;\n who  | action | how_many | what\n------+--------+----------+-------\n Jill | lugs   | 5        | pails\n Jack | lugs   | 10       | pails\n(2 rows)\n</code></pre> <p>\u867d\u7136\u8fd9\u4e24\u8005\u90fd\u5f88\u68d2\uff0c\u4f46\u5b83\u4eec\u603b\u662f\u8fd4\u56de\u6570\u7ec4\u6216\u6570\u7ec4\u96c6\u3002</p> <p><code>regexp_matches</code> \u597d\u7684\u4e00\u9762\u662f\u8fd4\u56de\u7ed3\u679c\u96c6\uff0c\u56e0\u6b64\u5982\u679c\u60a8\u9700\u8981\u591a\u4e2a\u4e0e\u60a8\u7684\u6a21\u5f0f\u5339\u914d\u7684\u7b54\u6848\uff0c\u5b83\u53ef\u4ee5\u89e3\u51b3\u95ee\u9898\uff0c\u4f46\u662f\u5f53\u6ca1\u6709\u4efb\u4f55\u5339\u914d\u9879\u65f6\uff0c\u60a8\u7684\u67e5\u8be2\u5c31\u4f1a\u5931\u8d25\uff0c\u4e0d\u4f1a\u8fd4\u56de\u4efb\u4f55\u8bb0\u5f55\u3002\u8fd9\u4f7f\u5f97\u5728 <code>FROM</code> \u5b50\u53e5\u4e2d\u4f7f\u7528\u6709\u70b9\u5371\u9669\uff0c\u9664\u975e\u60a8\u77e5\u9053\u8fd9\u4e00\u70b9\u5e76\u4e14\u4e0d\u5728\u4e4e\u6216\u5df2\u7ecf\u60f3\u51fa\u4e86\u907f\u514d\u7684\u65b9\u6cd5\uff0c\u4f8b\u5982\u4f7f\u7528 <code>LEFT JOIN</code>\u3002</p> <p><code>regexp_match</code> \u603b\u662f\u8fd4\u56de\uff0c\u56e0\u4e3a\u5b83\u4e0d\u8fd4\u56de\u4e00\u4e2a\u96c6\u5408\uff0c\u4f46\u5f88\u70e6\u4eba\uff0c\u56e0\u4e3a\u60a8\u603b\u662f\u8fd4\u56de\u4e00\u4e2a\u6570\u7ec4\uff0c\u60a8\u5fc5\u987b\u6311\u9009\u503c\u3002\u56e0\u6b64\uff0c\u539f\u59cb\u95ee\u9898\u53d8\u6210\u4e86\u989d\u5916\u7684 <code>()[]</code> \u566a\u97f3\uff0c\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>SELECT (regexp_match('Jill lugs 5 pails', '[0-9]+\\s[A-Za-z]+'))[1];\n</code></pre> <p>\u968f\u7740\u5e74\u9f84\u7684\u589e\u957f\uff0c\u90a3\u4e9b\u989d\u5916\u7684\u5b57\u7b26\u8ba9\u6211\u5f88\u70e6\u607c\uff0c\u56e0\u4e3a\u5b83\u9700\u8981\u66f4\u591a\u952e\u76d8\u6572\u51fb\u548c\u66f4\u591a\u65e0\u7528\u7684\u5b57\u7b26\u6765\u67e5\u770b\u3002\u867d\u7136\u6211\u8fd8\u6ca1\u6709\u6d4b\u8bd5\u8fc7\uff0c\u4f46\u6211\u6000\u7591\u5b83\u4e5f\u6162\u4e86\u3002</p> <p>\u4f5c\u8005\uff1aLeo Hsu, Regina Obe \u539f\u6587\uff1ahttps://www.postgresonline.com/journal/index.php?/archives/415-Substring-function-Regex-style.html</p>"},{"location":"2025/04/25/type-alignment-padding-bytes-no-space-waste-in-postgresql/","title":"\u7c7b\u578b\u5bf9\u9f50\u4e0e\u586b\u5145\u5b57\u8282\uff1a\u5982\u4f55\u907f\u514d\u6d6a\u8d39 PostgreSQL \u8868\u5b58\u50a8\u7a7a\u95f4","text":"<p>\u8282\u7701\u5b58\u50a8\u7a7a\u95f4\u4e0d\u5e94\u8be5\u662f PostgreSQL \u6570\u636e\u5e93\u7684\u9996\u8981\u76ee\u6807\u3002\u5f88\u591a\u65f6\u5019\uff0c\u4e3a\u4e86\u8282\u7701\u7a7a\u95f4\uff0c\u4eba\u4eec\u5f80\u5f80\u4f1a\u727a\u7272\u6027\u80fd\u3002\u4f46\u4e5f\u6ca1\u6709\u7406\u7531\u65e0\u8c13\u5730\u6d6a\u8d39\u7a7a\u95f4\u3002\u56e0\u6b64\uff0c\u6211\u4eec\u6709\u5fc5\u8981\u638c\u63e1 PostgreSQL \u4e2d\u7684\u6570\u636e\u7c7b\u578b\u5bf9\u9f50\u548c\u586b\u5145\u5b57\u8282\u7684\u6982\u5ff5\u3002</p>"},{"location":"2025/04/25/type-alignment-padding-bytes-no-space-waste-in-postgresql/#_1","title":"\u4ec0\u4e48\u662f\u6570\u636e\u7c7b\u578b\u5bf9\u9f50\uff1f","text":"<p>\u5f53 CPU \u4ece\u5185\u5b58\u8bfb\u53d6\u6216\u5199\u5165\u503c\u65f6\uff0c\u5982\u679c\u503c\u7684\u5730\u5740\u662f\u503c\u5b58\u50a8\u7a7a\u95f4\u5927\u5c0f\u7684\u500d\u6570\uff0c\u5219\u6027\u80fd\u6700\u4f73\u3002\u4f8b\u5982\uff0c4 \u5b57\u8282\u6574\u6570\u5e94\u4ece\u56db\u7684\u500d\u6570\u7684\u5730\u5740\u5f00\u59cb\u3002PostgreSQL \u81f4\u529b\u4e8e\u4f18\u5316\u6027\u80fd\u3002\u56e0\u6b64\uff0c\u5b83\u786e\u4fdd\u6240\u6709\u503c\u5728\u5185\u5b58\u4e2d\u6b63\u786e\u5bf9\u9f50\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5bf9\u9f50\u4ec5\u4e0e\u5177\u6709\u56fa\u5b9a\u957f\u5ea6\u7684\u6570\u636e\u7c7b\u578b\u76f8\u5173\uff1aPostgreSQL \u5b58\u50a8\u53ef\u53d8\u957f\u5ea6\u6570\u636e\u7c7b\u578b\uff08\u5982 <code>text</code>\u3001<code>varchar</code> \u548c <code>numeric</code>\uff09\u4e0d\u5fc5\u8003\u8651\u7c7b\u578b\u5bf9\u9f50\u3002</p> <p>\u6bcf\u5f53 PostgreSQL \u5c06\u6570\u636e\u6301\u4e45\u5316\u5230\u78c1\u76d8\u4e0a\u65f6\uff0c\u5b83\u90fd\u4f1a\u5c06\u8fd9\u4e9b\u6570\u636e\u7ec4\u7ec7\u6210 8kB \u5927\u5c0f\u7684\u9875\u9762\uff08<code>pages</code>\uff09\uff08\u4e5f\u79f0\u4e3a\u7f13\u51b2\u533a\uff08<code>buffers</code>\uff09\uff0c\u5728\u78c1\u76d8\u4e0a\u5219\u79f0\u4e3a\u5757\uff08<code>blocks</code>\uff09\uff09\u3002\u4e3a\u4e86\u4fdd\u6301\u7b80\u5355\u9ad8\u6548\uff0c\u78c1\u76d8\u4e0a\u5757\u7684\u5e03\u5c40\u4e0e\u5185\u5b58\u4e2d\u7684\u9875\u5b8c\u5168\u76f8\u540c\u3002\u56e0\u6b64\uff0cPostgreSQL \u4e5f\u9075\u5faa\u78c1\u76d8\u4e0a\u7684\u7c7b\u578b\u5bf9\u9f50\u3002</p> <p>PostgreSQL \u6570\u636e\u7c7b\u578b\u7684\u5bf9\u9f50\u65b9\u5f0f\u53ef\u4ee5\u662f 1\u30012\u30014 \u6216 8 \u4e2a\u5b57\u8282\u3002\u60a8\u53ef\u4ee5\u5728\u7cfb\u7edf\u76ee\u5f55 <code>pg_type</code> \u7684 <code>typalign</code> \u5217\u4e2d\u67e5\u770b\u6570\u636e\u7c7b\u578b\u7684\u5bf9\u9f50\u65b9\u5f0f\uff1a</p> <pre><code>SELECT typalign,\n       string_agg(typname, ', ' ORDER BY length(typname)) AS types\nFROM pg_type\nWHERE typtype = 'b'            -- base type\n  AND typelem = 0              -- no array\n  AND typlen &lt;&gt; -1             -- fixed length\n  AND typnamespace = 'pg_catalog'::regnamespace  -- system type\n  AND typname NOT LIKE 'reg%'  -- no object identifier type\nGROUP BY typalign;\n</code></pre> \u8f93\u51fa<pre><code> typalign \u2502                                               types\n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u256a\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n c        \u2502 bool, char, uuid\n d        \u2502 xid8, time, int8, money, pg_lsn, float8, circle, timetz, aclitem, interval, timestamp, timestamptz\n i        \u2502 cid, xid, oid, int4, date, float4, macaddr, macaddr8\n s        \u2502 tid, int2\n(4 rows)\n</code></pre> <p>\u4e0a\u9762\u7684 <code>c</code>\uff08\u7c7b\u4f3c <code>char</code>\uff09\u4ee3\u8868\u4e00\u4e2a\u5b57\u8282\u7684\u5bf9\u9f50\uff0c<code>s</code>\uff08\u7c7b\u4f3c <code>short</code>\uff09\u4ee3\u8868\u4e24\u4e2a\u5b57\u8282\u7684\u5bf9\u9f50\uff0c<code>i</code>\uff08\u7c7b\u4f3c <code>int</code>\uff09\u4ee3\u8868\u56db\u4e2a\u5b57\u8282\uff0c<code>d</code>\uff08\u7c7b\u4f3c <code>double</code>\uff09\u4ee3\u8868\u516b\u4e2a\u5b57\u8282\u7684\u5bf9\u9f50\u3002\u4e3a\u4e86\u7b80\u6d01\u8d77\u89c1\uff0c\u6211\u6392\u9664\u4e86\u5bf9\u8c61\u6807\u8bc6\u7b26\u7c7b\u578b\uff0c\u56e0\u4e3a\u60a8\u901a\u5e38\u4e0d\u4f1a\u5728\u8868\u5b9a\u4e49\u4e2d\u4f7f\u7528\u5b83\u4eec\u3002</p>"},{"location":"2025/04/25/type-alignment-padding-bytes-no-space-waste-in-postgresql/#_2","title":"\u4ec0\u4e48\u662f\u586b\u5145\u5b57\u8282\uff1f","text":"<p>PostgreSQL \u662f\u4e00\u79cd\u201c\u884c\u5b58\u50a8\uff08row store\uff09\u201d\u2014\u2014\u5b83\u5c06\u8868\u884c\u5b58\u50a8\u4e3a\u4e00\u4e2a\u6570\u636e\u5757\uff0c\u4e00\u5217\u63a5\u4e00\u5217\u3002\u884c\u6570\u636e\u4ece 8 \u7684\u500d\u6570\u7684\u5730\u5740\u5f00\u59cb\u3002\u56e0\u6b64\uff0c\u5982\u679c\u7b2c\u4e00\u5217\u662f <code>smallint</code>\uff08\u5927\u5c0f\u548c\u5bf9\u9f50\u65b9\u5f0f\u4e3a 2\uff09\uff0c\u7b2c\u4e8c\u5217\u662f <code>timestamp</code>\uff08\u5927\u5c0f\u548c\u5bf9\u9f50\u65b9\u5f0f\u4e3a 8\uff09\uff0c\u5219 PostgreSQL \u5fc5\u987b\u5728\u7b2c\u4e00\u5217\u548c\u7b2c\u4e8c\u5217\u4e4b\u95f4\u6dfb\u52a0 6 \u4e2a\u201c\u586b\u5145\u5b57\u8282\u201d\u4ee5\u6b63\u786e\u5bf9\u9f50\u65f6\u95f4\u6233\u3002\u8fd9 6 \u4e2a\u5b57\u8282\u53ea\u662f\u6d6a\u8d39\u7684\u7a7a\u95f4\uff01\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7 <code>pageinspect</code> \u6269\u5c55\u7a0b\u5e8f\u89c2\u5bdf\u5230\u8fd9\u4e00\u70b9\uff1a</p> <pre><code>CREATE EXTENSION pageinspect;\n\nCREATE TABLE tab (\n   col1 smallint,\n   col2 timestamp,\n   col3 integer,\n   col4 double precision\n);\n\nINSERT INTO tab VALUES (1, '2025-01-11 12:55:32.123456', 2, pi());\n\nSELECT t_data FROM heap_page_items(get_raw_page('tab', 0));\n</code></pre> \u8f93\u51fa<pre><code>                               t_data                               \n\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\n \\x0100000000000000401bc67e6cce02000200000000000000182d4454fb210940\n(1 row)\n</code></pre> <p>\u7b2c\u4e00\u4e2a <code>0100</code> \u662f <code>smallint</code> \u7c7b\u578b\uff08\u6211\u4f7f\u7528\u7684\u662f\u5c0f\u7aef\u67b6\u6784\uff09\u3002\u63a5\u4e0b\u6765\u7684 <code>000000000000</code> \u662f 6 \u4e2a\u586b\u5145\u5b57\u8282\u3002<code>401bc67e6cce0200</code> \u662f\u65f6\u95f4\u6233\uff0c\u540e\u9762\u7d27\u8ddf\u7740\u6574\u6570 <code>02000000</code>\u3002\u518d\u586b\u5145 4 \u4e2a\u5b57\u8282\u540e\uff0c\u6211\u4eec\u53d1\u73b0\u53cc\u7cbe\u5ea6\u503c <code>182d4454fb210940</code>\u3002</p> <p>\u603b\u800c\u8a00\u4e4b\uff0c\u6211\u4eec\u6d6a\u8d39\u4e86 10 \u4e2a\u5b57\u8282\uff01\u5982\u679c\u8003\u8651\u884c\u5934\u7684 24 \u4e2a\u5b57\u8282\uff0c\u8fd9 10 \u4e2a\u6d6a\u8d39\u7684\u5b57\u8282\u51e0\u4e4e\u5360\u4e86\u8868\u683c\u884c\u7684 22%\u3002</p> \u63d0\u793a <p>\u539f\u59cb\u6570\u636e\u53ea\u6709 <code>22</code> \u5b57\u8282\uff0c\u5373 <code>sizeof(smallint) + sizeof(timestamp) + sizeof(integer) + sizeof(double precision)</code>\uff0c\u6309\u6b64\u8ba1\u7b97\u6d6a\u8d39\u7684\u7a7a\u95f4\u4e3a <code>10 / (22 + 24) = 0.2174</code>\u3002</p> <p>\u5982\u679c\u6211\u4eec\u6309\u7167\u5b9e\u9645\u7684\u5b58\u50a8\u6765\u7b97\uff0c\u5728\u8fd9 32 \u5b57\u8282\u4e2d\u6d6a\u8d39\u4e86 10 \u5b57\u8282\uff0c\u56e0\u6b64\uff0c\u8ba1\u7b97\u7ed3\u679c\u4e3a <code>10 / (32 + 24) = 0.1786</code>\u3002</p>"},{"location":"2025/04/25/type-alignment-padding-bytes-no-space-waste-in-postgresql/#_3","title":"\u901a\u8fc7\u907f\u514d\u586b\u5145\u5b57\u8282\u6765\u8282\u7701\u5b58\u50a8\u7a7a\u95f4","text":"<p>\u8868\u4e2d\u5217\u7684\u987a\u5e8f\u662f\u56fa\u5b9a\u7684\uff0c\u4f46\u901a\u5e38\u60c5\u51b5\u4e0b\u65e0\u5173\u7d27\u8981\u3002\u5982\u679c\u6309\u4ee5\u4e0b\u987a\u5e8f\u5b9a\u4e49\u8868\u7684\u5217\uff0c\u5219\u53ef\u4ee5\u907f\u514d\u4efb\u4f55\u586b\u5145\uff1a</p> <ul> <li>\u9996\u5148\uff0c\u5b9a\u4e49\u6240\u6709\u7ecf\u5e38\u8bbf\u95ee\u7684 <code>uuid</code> \u7c7b\u578b\u7684\u5217\uff1a\u8be5\u6570\u636e\u7c7b\u578b\u5177\u6709 1 \u5b57\u8282\u7684\u5bf9\u9f50\uff0c\u4f46\u56fa\u5b9a\u5927\u5c0f\u4e3a 16 \u4e2a\u5b57\u8282\uff0c\u56e0\u6b64\u4e0d\u9700\u8981\u586b\u5145\u5b57\u8282</li> <li>\u63a5\u4e0b\u6765\uff0c\u5b9a\u4e49\u5177\u6709 8 \u4e2a\u5b57\u8282\u5bf9\u9f50\u7684\u6570\u636e\u7c7b\u578b\u7684\u5217\uff08<code>bigint</code>\u3001<code>timestamp</code>\u3001<code>timestamp with time zone</code>\u3001<code>double precision</code> \u7b49\uff09</li> <li>\u7136\u540e\uff0c\u4f7f\u7528 4 \u5b57\u8282\u5bf9\u9f50\u7684\u6570\u636e\u7c7b\u578b\u5b9a\u4e49\u5217\uff08<code>integer</code>\u3001<code>date</code>\u3001<code>real</code> \u7b49\uff09</li> <li>\u7136\u540e\uff0c\u4f7f\u7528 2 \u5b57\u8282\u5bf9\u9f50\u7684\u6570\u636e\u7c7b\u578b\u5b9a\u4e49\u5217\uff08\u672c\u8d28\u4e0a\u662f <code>smallint</code>\uff09</li> <li>\u6700\u540e\uff0c\u5b9a\u4e49\u5177\u6709\u5355\u5b57\u8282\u5bf9\u9f50\u6216\u53ef\u53d8\u957f\u5ea6\u7684\u6570\u636e\u7c7b\u578b\u7684\u5217\uff08<code>boolean</code>\u3001<code>text</code>\u3001<code>varchar</code>\u3001<code>character</code>\u3001<code>numeric</code>\u3001\u5176\u4ed6 <code>uuid</code> \u5217\u7b49\uff09</li> </ul> <p>\u8bf7\u6ce8\u610f\uff0c<code>character</code> \u662f char \u7684\u522b\u540d\uff08\u56fa\u5b9a\u957f\u5ea6\uff08\u7a7a\u767d\u586b\u5145\uff09\u5b57\u7b26\u4e32\u6570\u636e\u7c7b\u578b\uff09\u662f\u4e00\u79cd\u957f\u5ea6\u53ef\u53d8\u7684\u6570\u636e\u7c7b\u578b\uff1a\u9996\u5148\uff0c\u5b9e\u9645\u957f\u5ea6\u9650\u5236\u53d6\u51b3\u4e8e\u7c7b\u578b\u4fee\u9970\u7b26\uff0c\u5176\u6b21\uff0c\u4e00\u4e2a\u5b57\u7b26\u53ef\u4ee5\u6709\u591a\u4e2a\u5b57\u8282\u3002</p> <p>\u6309\u7167\u4e0a\u8ff0\u89c4\u5219\uff0c\u4e0a\u4f8b\u4e2d\u7684\u8868\u683c\u5c06\u5982\u4e0b\u6240\u793a\uff1a</p> <pre><code>CREATE TABLE tab (\n   col2 timestamp,\n   col4 double precision,\n   col3 integer,\n   col1 smallint\n);\n</code></pre> \u8bd1\u8005\u6ce8 <p>\u7ecf\u8fc7\u4e0a\u8ff0\u4fee\u6539\u4e4b\u540e\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u5982\u4e0b\u6240\u793a\u7684\u5b58\u50a8\u7ed3\u6784\uff1a</p> <p><pre><code>INSERT INTO tab values ('2025-01-11 12:55:32.123456', pi(), 2, 1);\nSELECT t_data FROM heap_page_items(get_raw_page('tab', 0));\n</code></pre> \u8f93\u51fa<pre><code>                     t_data\n------------------------------------------------\n \\x401bc67e6cce0200182d4454fb210940020000000100\n(1 row)\n</code></pre></p>"},{"location":"2025/04/25/type-alignment-padding-bytes-no-space-waste-in-postgresql/#_4","title":"\u901a\u8fc7\u907f\u514d\u586b\u5145\u5b57\u8282\u6765\u8282\u7701\u7a7a\u95f4\u5bf9\u6027\u80fd\u7684\u5f71\u54cd","text":"<p>\u5982\u4e0a\u6240\u8ff0\u91cd\u65b0\u6392\u5217\u5217\u987a\u5e8f\u51e0\u4e4e\u6ca1\u6709\u4efb\u4f55\u7f3a\u70b9\u3002\u53ea\u9700\u8003\u8651\u4e00\u70b9\uff1a\u4e3a\u4e86\u8bbf\u95ee\u8868\u884c\u7684\u7b2c 20 \u5217\uff0cPostgreSQL \u5fc5\u987b\u8df3\u8fc7\u524d 19 \u5217\u3002\u8fd9\u79cd\u64cd\u4f5c\u79f0\u4e3a\u5143\u7ec4\u89e3\u6784\uff08<code>tuple deforming</code>\uff09\uff0c\u5e76\u4e0d\u662f\u514d\u8d39\u7684\u3002\u63d0\u53d6\u8868\u4e2d\u8f83\u65e9\u7684\u5217\u4f1a\u66f4\u5feb\u3002\u6b64\u5916\uff0c\u8df3\u8fc7\u56fa\u5b9a\u957f\u5ea6\u7684\u5217\u6bd4\u8df3\u8fc7\u53ef\u53d8\u957f\u5ea6\u7684\u5217\u66f4\u4fbf\u5b9c\uff1a\u5bf9\u4e8e\u540e\u8005\uff0cPostgreSQL \u5fc5\u987b\u8bfb\u53d6\u503c\u7684 <code>varlena</code> \u6807\u5934\u3002\u56e0\u6b64\uff0c\u5982\u679c\u5728\u6240\u6709\u5217\u4e4b\u540e\u5b9a\u4e49\u4e00\u4e2a\u7ecf\u5e38\u8bbf\u95ee\u7684\u6574\u6570\u5217\uff0c\u5e76\u4ee5\u516b\u4e2a\u5b57\u8282\u5bf9\u9f50\uff0c\u5219\u53ef\u80fd\u4f1a\u5bf9\u6027\u80fd\u9020\u6210\u8f7b\u5fae\u5f71\u54cd\u3002</p> <p>\u53e6\u4e00\u65b9\u9762\uff0c\u5982\u679c PostgreSQL \u5fc5\u987b\u89e3\u6784\u5927\u91cf\u5143\u7ec4\uff0c\u5b83\u53ef\u80fd\u4f1a\u8c03\u7528\u5185\u7f6e\u7684 JIT \u7f16\u8bd1\u5668\u3002\u7531\u4e8e\u4e0a\u4e00\u8282\u4e2d\u7684\u89c4\u5219\u9996\u5148\u6392\u5217\u6240\u6709\u56fa\u5b9a\u957f\u5ea6\u7684\u5217\uff0c\u56e0\u6b64\u8fd9\u4e9b\u5217\u7684\u504f\u79fb\u91cf\u59cb\u7ec8\u76f8\u540c\u3002\u8fd9\u4f7f\u5f97 JIT \u7f16\u8bd1\u5668\u751f\u6210\u7684\u53ef\u6267\u884c\u4ee3\u7801\u53ef\u4ee5\u4e00\u6b65\u8df3\u8f6c\u5230\u6240\u9700\u7684\u5217\u3002</p> <p>\u6b64\u5916\uff0c\u8282\u7701\u7a7a\u95f4\u672c\u8eab\u4e5f\u80fd\u63d0\u5347\u6027\u80fd\uff1a\u8f83\u5c0f\u8868\u7684\u987a\u5e8f\u626b\u63cf\u901f\u5ea6\u66f4\u5feb\u3002\u5982\u679c\u4e0d\u7f13\u5b58\u586b\u5145\u5b57\u8282\uff0c\u5219\u53ef\u4ee5\u5728\u5171\u4eab\u7f13\u51b2\u533a\u4e2d\u7f13\u5b58\u66f4\u591a\u7528\u6237\u6570\u636e\u3002</p> <p>\u603b\u800c\u8a00\u4e4b\uff0c\u6211\u4e0d\u4f1a\u592a\u62c5\u5fc3\u6f5c\u5728\u7684\u6027\u80fd\u5f71\u54cd\u3002</p>"},{"location":"2025/04/25/type-alignment-padding-bytes-no-space-waste-in-postgresql/#_5","title":"\u603b\u7ed3","text":"<p>\u901a\u8fc7\u7cbe\u5fc3\u8bbe\u8ba1\u8868\u5217\u7684\u987a\u5e8f\uff0c\u53ef\u4ee5\u907f\u514d\u586b\u5145\u5b57\u8282\uff0c\u4ece\u800c\u907f\u514d\u6d6a\u8d39\u5b58\u50a8\u7a7a\u95f4\u3002\u8fd9\u79cd\u4f18\u5316\u4e0d\u592a\u53ef\u80fd\u635f\u5bb3\u67e5\u8be2\u6027\u80fd\uff0c\u751a\u81f3\u53ef\u80fd\u63d0\u9ad8\u67e5\u8be2\u6027\u80fd\u3002</p> <p>\u4f5c\u8005\uff1aLaurenz Albe \u539f\u6587\uff1ahttps://www.cybertec-postgresql.com/en/type-alignment-padding-bytes-no-space-waste-in-postgresql/</p>"},{"location":"2024/10/18/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E5%9C%A8-postgresql-%E4%B8%AD%E7%9A%84-commit-%E5%BE%88%E6%85%A2/","title":"\u4e3a\u4ec0\u4e48\u6211\u5728 PostgreSQL \u4e2d\u7684 COMMIT \u5f88\u6162\uff1f","text":"<p>\u6709\u65f6\uff0c\u6211\u4eec\u7684\u67d0\u4e2a\u5ba2\u6237\u67e5\u770b\u6570\u636e\u5e93\u4e2d\u6700\u8017\u65f6\u7684\u8bed\u53e5\uff08\u4f7f\u7528 <code>pg_stat_statements</code> \u6216 <code>pgBadger</code>\uff09\uff0c\u5e76\u53d1\u73b0 <code>COMMIT</code> \u6392\u540d\u9760\u524d\u3002\u901a\u5e38\uff0c<code>COMMIT</code> \u662f PostgreSQL \u4e2d\u975e\u5e38\u5feb\u7684\u8bed\u53e5\uff0c\u56e0\u6b64\u503c\u5f97\u7814\u7a76\u3002\u5728\u672c\u6587\u4e2d\uff0c\u6211\u5c06\u63a2\u8ba8 <code>COMMIT</code> \u7f13\u6162\u7684\u53ef\u80fd\u539f\u56e0\u5e76\u8ba8\u8bba\u60a8\u53ef\u4ee5\u91c7\u53d6\u7684\u63aa\u65bd\u3002</p>"},{"location":"2024/10/18/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E5%9C%A8-postgresql-%E4%B8%AD%E7%9A%84-commit-%E5%BE%88%E6%85%A2/#postgresql-commit_1","title":"PostgreSQL \u4e2d\u7684\u57fa\u672c <code>COMMIT</code> \u6d3b\u52a8","text":"<p>\u7f13\u6162\u7684 <code>COMMIT</code> \u662f\u4e00\u4e2a\u4ee4\u4eba\u60ca\u8bb6\u7684\u89c2\u5bdf\uff0c\u56e0\u4e3a\u5728 PostgreSQL \u4e2d\u63d0\u4ea4\u4e8b\u52a1\u662f\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u6d3b\u52a8\u3002\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c<code>COMMIT</code> \u8981\u505a\u7684\u5c31\u662f\uff1a</p> <ul> <li>\u5c06\u63d0\u4ea4\u65e5\u5fd7\u4e2d\u4e8b\u52a1\u7684\u4e24\u4f4d\u8bbe\u7f6e\u4e3a <code>TRANSACTION_STATUS_COMMITTED (0b01)</code>\uff08\u4fdd\u5b58\u5728 <code>pg_xact</code> \u4e2d\uff09\u3002</li> <li>\u5982\u679c <code>track_commit_timestamp</code> \u8bbe\u7f6e\u4e3a <code>on</code>\uff0c\u5219\u8bb0\u5f55\u63d0\u4ea4\u65f6\u95f4\u6233\uff08\u4fdd\u5b58\u5728 <code>pg_commit_ts</code> \u4e2d\uff09\u3002</li> <li>\u5c06\u9884\u5199\u65e5\u5fd7 (WAL)\uff08\u4fdd\u5b58\u5728 <code>pg_wal</code> \u4e2d\uff09\u5237\u65b0\u5230\u78c1\u76d8\uff0c\u9664\u975e <code>synchronous_commit</code> \u8bbe\u7f6e\u4e3a <code>off</code>\u3002</li> </ul> <p>\u8bf7\u6ce8\u610f\uff0c\u7531\u4e8e PostgreSQL \u7684\u591a\u7248\u672c\u67b6\u6784\uff0c<code>COMMIT</code> \u548c <code>ROLLBACK</code> \u901a\u5e38\u90fd\u662f\u975e\u5e38\u5feb\u7684\u64cd\u4f5c\uff1a\u5b83\u4eec\u90fd\u4e0d\u9700\u8981\u89e6\u78b0\u8868\uff0c\u5b83\u4eec\u53ea\u9700\u8981\u5728\u63d0\u4ea4\u65e5\u5fd7\u4e2d\u6ce8\u518c\u4e8b\u52a1\u7684\u72b6\u6001\u3002</p>"},{"location":"2024/10/18/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E5%9C%A8-postgresql-%E4%B8%AD%E7%9A%84-commit-%E5%BE%88%E6%85%A2/#commit","title":"<code>COMMIT</code> \u7f13\u6162\u7684\u6700\u5e38\u89c1\u539f\u56e0\uff1a\u78c1\u76d8\u95ee\u9898","text":"<p>\u4ece\u4e0a\u9762\u53ef\u4ee5\u6e05\u695a\u5730\u770b\u51fa\uff0c\u5bfc\u81f4\u901f\u5ea6\u7f13\u6162\u7684\u4e00\u4e2a\u6f5c\u5728\u539f\u56e0\u662f\u78c1\u76d8 I/O\u3002\u6bd5\u7adf\uff0c\u5c06 WAL \u5237\u65b0\u5230\u78c1\u76d8\u4f1a\u5bfc\u81f4 I/O \u8bf7\u6c42\u3002\u56e0\u6b64\uff0c\u60a8\u5e94\u8be5\u9996\u5148\u68c0\u67e5\u78c1\u76d8\u662f\u5426\u6709\u95ee\u9898\u6216\u8d1f\u8f7d\u8fc7\u5927\uff1a</p> <ul> <li>\u5728 Linux \u4e0a\uff0c\u60a8\u53ef\u4ee5\u4f7f\u7528 <code>vmstat 1</code> \u6216 <code>sar -p 1</code> \u7b49\u547d\u4ee4\u6765\u6d4b\u91cf\u7b49\u5f85 I/O \u7684 CPU \u65f6\u95f4\u767e\u5206\u6bd4\uff08<code>vmstat</code> \u4e2d\u7684 <code>wa</code> \u548c <code>sar</code> \u4e2d\u7684 <code>%iowait</code>\uff09\u3002</li> <li>\u4f7f\u7528 NAS \u65f6\uff0c\u60a8\u5e94\u8be5\u68c0\u67e5 TCP \u7f51\u7edc\u662f\u5426\u8fc7\u8f7d\u3002</li> <li>\u5982\u679c\u5b58\u50a8\u662f\u5171\u4eab SAN \u6216 NAS\uff0c\u5219\u78c1\u76d8\u53ef\u80fd\u4f1a\u4e0e\u5176\u4ed6\u673a\u5668\u5171\u4eab\uff0c\u60a8\u5e94\u8be5\u68c0\u67e5\u5b58\u50a8\u7cfb\u7edf\u4e0a\u662f\u5426\u5b58\u5728\u4e89\u7528\u3002</li> <li>\u78c1\u76d8\u6545\u969c\u3001\u5176\u4ed6\u786c\u4ef6\u95ee\u9898\u6216\u64cd\u4f5c\u7cfb\u7edf\u95ee\u9898\u53ef\u80fd\u4f1a\u5bfc\u81f4\u95f4\u6b47\u6027\u6027\u80fd\u95ee\u9898\u3002\u68c0\u67e5\u5185\u6838\u65e5\u5fd7\u4ee5\u83b7\u53d6\u6d88\u606f\u3002</li> </ul> <p>\u5982\u679c\u6211\u4eec\u53ef\u4ee5\u6392\u9664\u78c1\u76d8\u95ee\u9898\u662f\u5bfc\u81f4 <code>COMMIT</code> \u7f13\u6162\u7684\u539f\u56e0\uff0c\u6211\u4eec\u5c31\u5fc5\u987b\u8fdb\u884c\u8fdb\u4e00\u6b65\u8c03\u67e5\u3002</p>"},{"location":"2024/10/18/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E5%9C%A8-postgresql-%E4%B8%AD%E7%9A%84-commit-%E5%BE%88%E6%85%A2/#_1","title":"\u9605\u8bfb\u6e90\u7801\u4ee5\u4e86\u89e3\u66f4\u591a\u4fe1\u606f","text":"<p>\u5982\u679c\u6211\u4eec\u60f3\u4e86\u89e3\u4e8b\u52a1 <code>COMMIT</code> \u671f\u95f4\u53d1\u751f\u4e86\u4ec0\u4e48\uff0c\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u5c31\u662f\u9605\u8bfb\u6e90\u4ee3\u7801\u3002\u8bb8\u591a\u4eba\u6ca1\u6709\u610f\u8bc6\u5230\u5f00\u6e90\u7684\u771f\u6b63\u529b\u91cf\uff1a\u60a8\u4e0d\u5fc5\u731c\u6d4b\u6216\u8d2d\u4e70\u8f6f\u4ef6\u4f9b\u5e94\u5546\u7684\u652f\u6301\uff0c\u800c\u662f\u53ef\u4ee5\u4eb2\u81ea\u89c1\u8bc1\u3002PostgreSQL \u6e90\u4ee3\u7801\u5199\u5f97\u5f88\u597d\u5e76\u4e14\u6709\u5145\u8db3\u7684\u6587\u6863\uff0c\u8bb8\u591a\u90e8\u5206\u4e0d\u9700\u8981\u4e13\u5bb6 C \u6280\u80fd\u5c31\u53ef\u4ee5\u7406\u89e3\u3002\u76f8\u5173\u4ee3\u7801\u5728 <code>src/backend/access/transam/xact.c</code> \u6587\u4ef6\u4e2d\u7684 <code>CommitTransaction()</code> \u51fd\u6570\u4e2d\u3002</p> <p>\u5728\u7279\u6b8a\u60c5\u51b5\u4e0b\uff0c<code>COMMIT</code> \u901f\u5ea6\u6162\u7684\u539f\u56e0\u6709\u591a\u79cd\uff0c\u6bd4\u5982\u8bb8\u591a\u5e76\u53d1 <code>NOTIFY</code> \u8bed\u53e5\u7684\u4e89\u7528\uff08\u60a8\u53ef\u4ee5\u4ece <code>pg_locks</code> \u4e2d\u6570\u636e\u5e93 <code>0</code> \u4e0a\u7684\u9501\u6765\u8bca\u65ad\u8fd9\u79cd\u60c5\u51b5\uff09\u3002\u7136\u800c\uff0c\u7f6a\u9b41\u7978\u9996\u901a\u5e38\u662f\u4e0b\u9762\u63cf\u8ff0\u7684\u4e09\u79cd\u60c5\u51b5\u4e4b\u4e00\u3002</p>"},{"location":"2024/10/18/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E5%9C%A8-postgresql-%E4%B8%AD%E7%9A%84-commit-%E5%BE%88%E6%85%A2/#commit_1","title":"\u5ef6\u8fdf\u7ea6\u675f\u548c\u89e6\u53d1\u5668\u5bfc\u81f4 <code>COMMIT</code> \u7f13\u6162","text":"<p>\u901a\u5e38\uff0cPostgreSQL \u5c06\u68c0\u67e5\u7ea6\u675f\u4f5c\u4e3a\u4fee\u6539\u53d7\u7ea6\u675f\u8868\u7684\u8bed\u53e5\u7684\u4e00\u90e8\u5206\u3002\u901a\u8fc7\u5ef6\u8fdf\u7ea6\u675f <code>deferred constraints</code>\uff0cPostgreSQL \u4f1a\u5728\u4e8b\u52a1\u7ed3\u675f\u65f6\u6267\u884c\u7ea6\u675f\u68c0\u67e5\u3002\u4e00\u4e2a\u7528\u4f8b\u662f\u5c06\u6570\u636e\u63d2\u5165\u5177\u6709\u5faa\u73af\u5916\u952e\u7ea6\u675f\u7684\u8868\u4e2d\uff1a</p> <pre><code>CREATE TABLE department (\n  department_id bigint PRIMARY KEY,\n  name text NOT NULL,\n  manager bigint NOT NULL\n);\n\nCREATE TABLE employee (\n  employee_id bigint PRIMARY KEY,\n  name text NOT NULL,\n  department_id bigint\n    REFERENCES department NOT NULL\n);\n\n-- deferred foreign key\nALTER TABLE department\n  ADD FOREIGN KEY (manager) REFERENCES employee\n    DEFERRABLE INITIALLY DEFERRED;\n</code></pre> <p>\u5ef6\u8fdf\u5916\u952e\u53ef\u4ee5\u8f7b\u677e\u521b\u5efa\u65b0\u90e8\u95e8\uff1a</p> <pre><code>BEGIN;\n\n-- won't raise a foreign key violation yet\nINSERT INTO department (department_id, name, manager)\nVALUES (12, 'Flower Picking', 123);\n\nINSERT INTO employee (employee_id, name, department_id)\nVALUES (123, 'John Wurzelrupfer', 12);\n\n-- deferred constraint is valid now\nCOMMIT;\n</code></pre> <p>\u7531\u4e8e PostgreSQL \u5728\u63d0\u4ea4\u65f6\u68c0\u67e5\u5ef6\u8fdf\u7ea6\u675f\uff0c\u5b83\u4eec\u53ef\u80fd\u4f1a\u51cf\u6162 <code>COMMIT</code> \u5904\u7406\u901f\u5ea6\u3002\u901a\u5e38\uff0c\u68c0\u67e5\u7ea6\u675f\u975e\u5e38\u5feb\u2014\u2014\u5b83\u662f\u4e00\u4e2a\u7d22\u5f15\u67e5\u627e\u3002\u7136\u800c\uff0c\u8bb8\u591a\u8fd9\u6837\u7684\u68c0\u67e5\u4f1a\u5728\u8f83\u5927\u7684\u4e8b\u52a1\u4e2d\u7d2f\u79ef\uff0c\u5e76\u4e14\u96c6\u4f53\u6267\u884c\u65f6\u95f4\u4f1a\u5927\u5927\u51cf\u6162 <code>COMMIT</code> \u7684\u901f\u5ea6\u3002</p> <p>PostgreSQL \u8fd8\u5177\u6709\u53ef\u5ef6\u8fdf\u7684\u7ea6\u675f\u89e6\u53d1\u5668 <code>constraint triggers</code>\uff0c\u5e76\u4e14\u53ef\u4ee5\u50cf\u5ef6\u8fdf\u7ea6\u675f\u4e00\u6837\u51cf\u6162 <code>COMMIT</code> \u7684\u901f\u5ea6\u3002\u6709\u5173\u7ea6\u675f\u89e6\u53d1\u5668\u7684\u7528\u4f8b\u7684\u8fdb\u4e00\u6b65\u8ba8\u8bba\uff0c\u8bf7\u53c2\u9605\u672c\u6587\u3002</p> <p>\u5982\u679c\u60a8\u80fd\u786e\u5b9a\u5ef6\u8fdf\u7ea6\u675f\u6216\u89e6\u53d1\u5668\u662f\u5bfc\u81f4 <code>COMMIT</code> \u7f13\u6162\u7684\u539f\u56e0\uff0c\u90a3\u4e48\u53ef\u80fd\u5c31\u6ca1\u95ee\u9898\uff0c\u65e0\u9700\u62c5\u5fc3\u3002\u6bd5\u7adf\uff0c\u60a8\u5fc5\u987b\u5728\u67d0\u4e2a\u65f6\u5019\u68c0\u67e5\u8fd9\u4e9b\u7ea6\u675f\u3002</p>"},{"location":"2024/10/18/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E5%9C%A8-postgresql-%E4%B8%AD%E7%9A%84-commit-%E5%BE%88%E6%85%A2/#commit_2","title":"\u6e38\u6807\u4fdd\u6301\u5bfc\u81f4 <code>COMMIT</code> \u7f13\u6162","text":"<p>\u6e38\u6807 <code>cursor</code> \u5141\u8bb8\u5ba2\u6237\u7aef\u5206\u5757\u83b7\u53d6\u67e5\u8be2\u7ed3\u679c\u96c6\uff0c\u8fd9\u53ef\u4ee5\u7b80\u5316\u5904\u7406\u5e76\u907f\u514d\u5ba2\u6237\u7aef\u5185\u5b58\u4e0d\u8db3\u3002\u4f46\u662f\uff0c\u5e38\u89c4\u6e38\u6807\u53ea\u80fd\u5b58\u5728\u4e8e\u6570\u636e\u5e93\u4e8b\u52a1\u7684\u4e0a\u4e0b\u6587\u4e2d\u3002\u56e0\u6b64\uff0c\u5f53\u6d89\u53ca\u7528\u6237\u4ea4\u4e92\u65f6\uff0c\u60a8\u4e0d\u80fd\u4f7f\u7528\u6e38\u6807\uff1a\u6e38\u6807\u6301\u6709\u7684\u5feb\u7167\u4f1a\u963b\u788d <code>VACUUM</code> \u7684\u8fdb\u5ea6\u5e76\u5bfc\u81f4\u8868\u81a8\u80c0\u548c\u66f4\u4e25\u91cd\u7684\u95ee\u9898\u3002\u6b64\u5916\uff0c\u5728\u4e8b\u52a1\u6301\u7eed\u671f\u95f4\u6301\u6709\u7684 <code>ACCESS SHARE</code> \u9501\u5c06\u5bfc\u81f4\u5e76\u53d1 <code>ALTER TABLE</code> \u6216 <code>TRUNCATE</code> \u51fa\u73b0\u95ee\u9898\u3002</p> <p>\u4e3a\u4e86\u907f\u514d\u53d7\u9650\u4e8e\u4e8b\u52a1\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>WITH HOLD</code> \u6e38\u6807\u3002\u8fd9\u6837\u7684\u6e38\u6807\u53ef\u4ee5\u6bd4\u521b\u5efa\u5b83\u7684\u4e8b\u52a1\u5b58\u6d3b\u66f4\u957f\u65f6\u95f4\uff0c\u4f8b\u5982\uff0c\u5bf9\u4e8e\u5b9e\u73b0\u5206\u9875\u5f88\u6709\u7528\u3002PostgreSQL \u901a\u8fc7\u5728\u63d0\u4ea4\u65f6\u5177\u4f53\u5316\u7ed3\u679c\u96c6\u6765\u5b9e\u73b0 <code>WITH HOLD</code> \u6e38\u6807\u3002\u5982\u679c\u6e38\u6807\u540e\u9762\u7684\u67e5\u8be2\u5f88\u6602\u8d35\uff0c\u90a3\u4e48 <code>COMMIT</code> \u53ef\u80fd\u4f1a\u53d8\u5f97\u975e\u5e38\u6162\u3002\u53e6\u5916\uff0c\u5b8c\u6210\u540e\u4e00\u5b9a\u4e0d\u8981\u5fd8\u8bb0\u5173\u95ed\u8fd9\u4e9b\u6e38\u6807\uff0c\u5426\u5219\u7269\u5316\u7ed3\u679c\u96c6\u5c06\u5360\u7528\u670d\u52a1\u5668\u8d44\u6e90\uff0c\u76f4\u5230\u6570\u636e\u5e93\u4f1a\u8bdd\u7ed3\u675f\u3002</p> <p>\u5982\u679c\u60a8\u53ef\u4ee5\u5c06 <code>WITH HOLD</code> \u6e38\u6807\u786e\u5b9a\u4e3a <code>COMMIT</code> \u7f13\u6162\u7684\u539f\u56e0\uff0c\u90a3\u4e48\u60a8\u53ef\u4ee5\u901a\u8fc7\u8c03\u6574\u6e38\u6807\u5b9a\u4e49\u4e2d\u7684\u67e5\u8be2\u6765\u63d0\u9ad8\u8fd0\u884c\u901f\u5ea6\uff0c\u4ece\u800c\u6539\u5584\u8fd9\u79cd\u60c5\u51b5\u3002\u7531\u4e8e PostgreSQL \u6ca1\u6709\u4f18\u5316\u6e38\u6807\u4e2d\u7684\u67e5\u8be2\u6765\u52a0\u5feb\u8ba1\u7b97\u5b8c\u6574\u7ed3\u679c\u96c6\u7684\u901f\u5ea6\uff0c\u56e0\u6b64\u6709\u65f6\u5c06 <code>cursor_tuple_fraction</code> \u8bbe\u7f6e\u4e3a <code>1.0</code> \u53ef\u4ee5\u5e2e\u52a9\u52a0\u5feb <code>COMMIT</code> \u7684\u5904\u7406\u3002</p>"},{"location":"2024/10/18/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E5%9C%A8-postgresql-%E4%B8%AD%E7%9A%84-commit-%E5%BE%88%E6%85%A2/#commit_3","title":"\u540c\u6b65\u590d\u5236\u5bfc\u81f4 <code>COMMIT</code> \u7f13\u6162","text":"<p>\u7269\u7406\u6d41\u590d\u5236\u548c\u903b\u8f91\u590d\u5236\u9ed8\u8ba4\u90fd\u662f\u5f02\u6b65\u7684\u3002\u5982\u679c\u60a8\u4f7f\u7528\u590d\u5236\u6765\u5b9e\u73b0\u9ad8\u53ef\u7528\u6027\uff0c\u5e76\u4e14\u4e0d\u60f3\u5192\u4e22\u5931\u5df2\u63d0\u4ea4\u4e8b\u52a1\u7684\u98ce\u9669\uff0c\u5219\u53ef\u4ee5\u4f7f\u7528\u540c\u6b65\u590d\u5236\u3002\u4f7f\u7528\u540c\u6b65\u590d\u5236\uff0c<code>COMMIT</code> \u65f6\u7684\u64cd\u4f5c\u987a\u5e8f\u4e3a\uff1a</p> <ul> <li>\u5c06 <code>COMMIT</code> \u8bb0\u5f55\u5199\u5165 WAL \u5e76\u5237\u65b0\uff08\u8fd9\u662f\u5b9e\u9645\u7684\u6301\u4e45\u63d0\u4ea4\uff09\u3002</li> <li>\u7b49\u5f85\u540c\u6b65\u5907\u7528\u6570\u636e\u5e93\u62a5\u544a\u5df2\u83b7\u53d6\u6240\u6709 WAL \u4fe1\u606f\u3002</li> <li>\u4f7f\u4e8b\u52a1\u5728\u4e3b\u670d\u52a1\u5668\u4e0a\u53ef\u89c1\u3002</li> <li>\u5411\u5ba2\u6237\u62a5\u544a\u6210\u529f\u3002</li> </ul> <p>\u5982\u679c\u4e3b\u670d\u52a1\u5668\u548c\u540c\u6b65\u5907\u670d\u52a1\u5668\u4e4b\u95f4\u7684\u7f51\u7edc\u5ef6\u8fdf\u8f83\u9ad8\uff0c\u5219 <code>COMMIT</code> \u5c06\u9700\u8981\u5f88\u957f\u65f6\u95f4\u3002\u60a8\u53ef\u4ee5\u901a\u8fc7\u68c0\u67e5 <code>pg_stat_activity</code> \u6765\u8bca\u65ad\u662f\u5426\u5b58\u5728\u9891\u7e41\u6216\u957f\u65f6\u95f4\u7684 <code>SyncRep</code> \u7b49\u5f85\u4e8b\u4ef6\u3002\u901a\u5e38\uff0c\u60a8\u53ea\u60f3\u5728\u7f51\u7edc\u5ef6\u8fdf\u8f83\u4f4e\u7684\u673a\u5668\uff08\u5373\u7269\u7406\u4e0a\u9760\u8fd1\u7684\u673a\u5668\uff09\u4e4b\u95f4\u4f7f\u7528\u540c\u6b65\u590d\u5236\u3002</p>"},{"location":"2024/10/18/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E5%9C%A8-postgresql-%E4%B8%AD%E7%9A%84-commit-%E5%BE%88%E6%85%A2/#commit_4","title":"\u7b2c\u4e09\u65b9\u6269\u5c55\u5bfc\u81f4 <code>COMMIT</code> \u7f13\u6162","text":"<p>PostgreSQL \u6700\u51fa\u8272\u7684\u7279\u6027\u4e4b\u4e00\u662f\u5b83\u7684\u53ef\u6269\u5c55\u6027\u3002\u5b83\u5141\u8bb8\u60a8\u7f16\u5199\u4e0e PostgreSQL \u6838\u5fc3\u4ea4\u4e92\u7684\u6269\u5c55\uff0c\u800c\u65e0\u9700\u4fee\u6539\u670d\u52a1\u5668\u4ee3\u7801\u3002\u7b2c\u4e09\u65b9\u4ee3\u7801\u53ef\u4ee5\u201c\u6302\u8f7d\u201d\u5230 PostgreSQL \u4e2d\u6765\u4fee\u6539\u5176\u884c\u4e3a\u3002\u9664\u4e86\u8bb8\u591a\u5176\u4ed6\u9009\u9879\u4e4b\u5916\uff0c\u60a8\u8fd8\u53ef\u4ee5\u4f7f\u7528 C \u51fd\u6570 <code>RegisterXactCallback()</code> \u6765\u6ce8\u518c PostgreSQL \u5728 <code>COMMIT</code> \u65f6\u6267\u884c\u7684\u56de\u8c03\u3002\u56e0\u6b64\uff0c\u5982\u679c\u60a8\u5bfb\u627e <code>COMMIT</code> \u7f13\u6162\u7684\u539f\u56e0\uff0c\u60a8\u8fd8\u5e94\u8be5\u67e5\u770b\u6570\u636e\u5e93\u4e2d\u5b89\u88c5\u7684\u6269\u5c55\u3002\u4f8b\u5982\uff0c\u5728\u8fdc\u7a0b\u6570\u636e\u6e90\u5b9e\u73b0\u4e8b\u52a1\u5904\u7406\u7684\u5916\u90e8\u6570\u636e\u5305\u88c5\u5668\u53ef\u80fd\u5e0c\u671b\u5728 PostgreSQL \u63d0\u4ea4\u672c\u5730\u4e8b\u52a1\u65f6\u63d0\u4ea4\u8fdc\u7a0b\u4e8b\u52a1\u3002\u7136\u540e\uff0c\u8fdc\u7a0b\u7aef\u7684\u9ad8\u7f51\u7edc\u5ef6\u8fdf\u6216\u7f13\u6162\u7684\u4e8b\u52a1\u5904\u7406\u5c06\u4f1a\u51cf\u6162 PostgreSQL \u7684 <code>COMMIT</code> \u901f\u5ea6\u3002</p>"},{"location":"2024/10/18/%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E5%9C%A8-postgresql-%E4%B8%AD%E7%9A%84-commit-%E5%BE%88%E6%85%A2/#_2","title":"\u603b\u7ed3","text":"<p>\u901a\u8fc7\u67e5\u770b\u6e90\u4ee3\u7801\uff0c\u6211\u4eec\u53ef\u4ee5\u5f88\u5bb9\u6613\u5730\u627e\u5230\u5bfc\u81f4 <code>COMMIT</code> \u7f13\u6162\u7684\u53ef\u80fd\u539f\u56e0\uff1a\u9664\u4e86\u78c1\u76d8\u95ee\u9898\u7684\u660e\u663e\u539f\u56e0\u4e4b\u5916\uff0c\u60a8\u8fd8\u5e94\u8be5\u8003\u8651\u5ef6\u8fdf\u7ea6\u675f\u3001<code>WITH HOLD</code> \u6e38\u6807\u548c\u540c\u6b65\u590d\u5236\u7b49\u53ef\u80fd\u7684\u539f\u56e0\u3002</p> <p>\u4f5c\u8005\uff1aLaurenz Albe \u539f\u6587\uff1ahttps://www.cybertec-postgresql.com/en/why-do-i-have-a-slow-commit-in-postgresql/</p>"},{"location":"archive/2025/","title":"2025","text":""},{"location":"archive/2024/","title":"2024","text":""},{"location":"category/tuning/","title":"Tuning","text":""},{"location":"category/","title":"Index","text":""},{"location":"category/performance/","title":"Performance","text":""},{"location":"category/locks/","title":"Locks","text":""},{"location":"category/aggregation/","title":"Aggregation","text":""},{"location":"category/idle-transaction/","title":"Idle Transaction","text":""},{"location":"category/table-bloat/","title":"Table Bloat","text":""},{"location":"category/bgwriter/","title":"Bgwriter","text":""},{"location":"category/checkpointer/","title":"Checkpointer","text":""},{"location":"category/settings/","title":"Settings","text":""},{"location":"category/function/","title":"Function","text":""},{"location":"category/regexp/","title":"Regexp","text":""},{"location":"category/overlaps/","title":"Overlaps","text":""},{"location":"category/commit/","title":"Commit","text":""},{"location":"category/log/","title":"Log","text":""},{"location":"page/2/","title":"\u4e3b\u9875","text":""}]}